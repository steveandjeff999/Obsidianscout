{% extends "base.html" %}

{% block title %}Edit Alliance Game Configuration - {{ alliance.alliance_name }}{% endblock %}

{% block head %}
<style>
    .mode-toggle {
        margin-bottom: 20px;
    }
    .config-editor {
        margin-top: 20px;
    }
    #simple-mode .form-group {
        margin-bottom: 15px;
    }
    #json-mode textarea {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 12px;
        min-height: 400px;
    }
    .json-valid {
        border-color: #28a745 !important;
    }
    .json-invalid {
        border-color: #dc3545 !important;
    }
    .template-import {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .template-dropdown {
        max-width: 300px;
        margin-right: 10px;
    }
    .form-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }
    .form-section h5 {
        margin-bottom: 15px;
        color: #495057;
    }
    .nav-tabs .nav-link.active {
        background-color: #17a2b8;
        color: white;
        border-color: #17a2b8;
    }
    .tab-content {
        border: 1px solid #dee2e6;
        border-top: 0;
        padding: 20px;
        border-radius: 0 0 8px 8px;
    }
    .add-section, .add-element {
        margin-top: 15px;
    }
    .scoring-element {
        border: 1px solid #dee2e6;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #fff;
    }
    .game-piece {
        border: 1px solid #dee2e6;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #fff;
    }
    .rating-element, .text-element {
        border: 1px solid #dee2e6;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> 
                        Edit Alliance Game Configuration
                        <small class="text-light">({{ alliance.alliance_name }})</small>
                    </h5>
                    <div>
                        <a href="{{ url_for('scouting_alliances.view_alliance', alliance_id=alliance.id) }}" 
                           class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i> Back to Alliance
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> This configuration will be used by all alliance members when alliance mode is active. 
                        Changes will affect all alliance members' game scouting forms.
                    </div>

                    <!-- Copy Scouting Team Config Section -->
                    <div class="template-import">
                        <h5><i class="fas fa-copy"></i> Copy from Scouting Team Configuration</h5>
                        <p class="text-muted">Copy your scouting team's game configuration as the alliance starting point.</p>
                        <div class="d-flex align-items-center">
                            <button type="button" id="copy-scouting-team-btn" class="btn btn-primary">
                                <i class="fas fa-copy"></i> Copy from Scouting Team
                            </button>
                            <span class="ml-2 text-muted">This will copy the configuration from the alliance admin team.</span>
                        </div>
                    </div>

                    <!-- Mode Toggle -->
                    <div class="mode-toggle">
                        <div class="btn-group btn-group-toggle" data-toggle="buttons">
                            <label class="btn btn-outline-primary active" id="simple-mode-btn">
                                <input type="radio" name="editMode" id="simple-mode-radio" checked> 
                                <i class="fas fa-edit"></i> Simple Mode
                            </label>
                            <label class="btn btn-outline-primary" id="json-mode-btn">
                                <input type="radio" name="editMode" id="json-mode-radio"> 
                                <i class="fas fa-code"></i> JSON Mode
                            </label>
                        </div>
                    </div>

                    <!-- Simple Mode Editor -->
                    <div id="simple-mode" class="config-editor">
                        <form id="game-config-form" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="simple_edit" value="true">
                            
                            <!-- Navigation Tabs -->
                            <ul class="nav nav-tabs" id="configTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="basic-tab" data-bs-toggle="tab" href="#basic" role="tab">Basic Settings</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="periods-tab" data-bs-toggle="tab" href="#periods" role="tab">Game Periods</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="gamepieces-tab" data-bs-toggle="tab" href="#gamepieces" role="tab">Game Pieces</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="postmatch-tab" data-bs-toggle="tab" href="#postmatch" role="tab">Post Match</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="configTabsContent">
                                <!-- Basic Settings Tab -->
                                <div class="tab-pane fade show active" id="basic" role="tabpanel">
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <h4>Game Information</h4>
                                            <div class="form-group mb-3">
                                                <label for="game_name">Game Name</label>
                                                <input type="text" class="form-control" id="game_name" name="game_name" 
                                                       value="{{ config.game_name or '' }}" required>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="season">Season</label>
                                                <input type="number" class="form-control" id="season" name="season" 
                                                       value="{{ config.season or 2025 }}" min="2020" max="2030" required>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="version">Version</label>
                                                <input type="text" class="form-control" id="version" name="version" 
                                                       value="{{ config.version or '1.0.0' }}" placeholder="e.g., 1.0.0">
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="alliance_size">Alliance Size</label>
                                                <input type="number" class="form-control" id="alliance_size" name="alliance_size" 
                                                       value="{{ config.alliance_size or 3 }}" min="1" max="6" required>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="scouting_stations">Scouting Stations</label>
                                                <input type="number" class="form-control" id="scouting_stations" name="scouting_stations" 
                                                       value="{{ config.scouting_stations or 6 }}" min="1" max="12" required>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="current_event_code">Current Event Code</label>
                                                <input type="text" class="form-control" id="current_event_code" name="current_event_code" 
                                                       value="{{ config.current_event_code or '' }}" placeholder="e.g., ARLI">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h4>Match Types</h4>
                                            <div class="form-group mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="match_type_practice" 
                                                           name="match_type_practice" value="1"
                                                           {{ 'checked' if 'Practice' in (config.match_types or []) }}>
                                                    <label class="form-check-label" for="match_type_practice">Practice</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="match_type_qualification" 
                                                           name="match_type_qualification" value="1"
                                                           {{ 'checked' if 'Qualification' in (config.match_types or []) }}>
                                                    <label class="form-check-label" for="match_type_qualification">Qualification</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="match_type_playoff" 
                                                           name="match_type_playoff" value="1"
                                                           {{ 'checked' if 'Playoff' in (config.match_types or []) }}>
                                                    <label class="form-check-label" for="match_type_playoff">Playoff</label>
                                                </div>
                                            </div>
                                            
                                            <h5>Period Durations</h5>
                                            <div class="form-group mb-3">
                                                <label for="auto_duration">Auto Period (seconds)</label>
                                                <input type="number" class="form-control" id="auto_duration" name="auto_duration" 
                                                       value="{{ config.get('auto_period', {}).get('duration_seconds', 15) }}" min="0" max="60" required>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="teleop_duration">Teleop Period (seconds)</label>
                                                <input type="number" class="form-control" id="teleop_duration" name="teleop_duration" 
                                                       value="{{ config.get('teleop_period', {}).get('duration_seconds', 135) }}" min="60" max="180" required>
                                            </div>
                                            <div class="form-group mb-3">
                                                <label for="endgame_duration">Endgame Period (seconds)</label>
                                                <input type="number" class="form-control" id="endgame_duration" name="endgame_duration" 
                                                       value="{{ config.get('endgame_period', {}).get('duration_seconds', 30) }}" min="0" max="60" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Game Periods Tab -->
                                <div class="tab-pane fade" id="periods" role="tabpanel">
                                    <div class="mt-3">
                                        <!-- Auto Period -->
                                        <div class="card mb-3">
                                            <div class="card-header">
                                                <h5>Auto Period Scoring Elements</h5>
                                                <small class="text-muted">Duration: {{ config.get('auto_period', {}).get('duration_seconds', 15) }} seconds</small>
                                            </div>
                                            <div class="card-body">
                                                <div id="auto-elements">
                                                    {% if config.get('auto_period', {}).get('scoring_elements') %}
                                                        {% for element in config.auto_period.scoring_elements %}
                                                        <div class="scoring-element" data-period="auto" data-index="{{ loop.index0 }}">
                                                            <h6>{{ element.name or element.id }}</h6>
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <label>Element ID</label>
                                                                    <input type="text" class="form-control" name="auto_element_id_{{ loop.index0 }}" 
                                                                           value="{{ element.id }}" required>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <label>Name</label>
                                                                    <input type="text" class="form-control" name="auto_element_name_{{ loop.index0 }}" 
                                                                           value="{{ element.name }}" required>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Type</label>
                                                                    <select class="form-control element-type" name="auto_element_type_{{ loop.index0 }}">
                                                                        <option value="boolean" {{ 'selected' if element.type == 'boolean' }}>Boolean</option>
                                                                        <option value="counter" {{ 'selected' if element.type == 'counter' }}>Counter</option>
                                                                        <option value="select" {{ 'selected' if element.type == 'select' }}>Select</option>
                                                                        <option value="rating" {{ 'selected' if element.type == 'rating' }}>Rating</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Points</label>
                                                                    <input type="number" class="form-control" name="auto_element_points_{{ loop.index0 }}" 
                                                                           value="{{ element.get('points', 0) if element.get('points') is number else 0 }}" step="0.1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-sm btn-danger remove-element">Remove</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <button type="button" class="btn btn-success add-element" data-period="auto">Add Auto Element</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Teleop Period -->
                                        <div class="card mb-3">
                                            <div class="card-header">
                                                <h5>Teleop Period Scoring Elements</h5>
                                                <small class="text-muted">Duration: {{ config.get('teleop_period', {}).get('duration_seconds', 120) }} seconds</small>
                                            </div>
                                            <div class="card-body">
                                                <div id="teleop-elements">
                                                    {% if config.get('teleop_period', {}).get('scoring_elements') %}
                                                        {% for element in config.teleop_period.scoring_elements %}
                                                        <div class="scoring-element" data-period="teleop" data-index="{{ loop.index0 }}">
                                                            <h6>{{ element.name or element.id }}</h6>
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <label>Element ID</label>
                                                                    <input type="text" class="form-control" name="teleop_element_id_{{ loop.index0 }}" 
                                                                           value="{{ element.id }}" required>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <label>Name</label>
                                                                    <input type="text" class="form-control" name="teleop_element_name_{{ loop.index0 }}" 
                                                                           value="{{ element.name }}" required>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Type</label>
                                                                    <select class="form-control element-type" name="teleop_element_type_{{ loop.index0 }}">
                                                                        <option value="boolean" {{ 'selected' if element.type == 'boolean' }}>Boolean</option>
                                                                        <option value="counter" {{ 'selected' if element.type == 'counter' }}>Counter</option>
                                                                        <option value="select" {{ 'selected' if element.type == 'select' }}>Select</option>
                                                                        <option value="rating" {{ 'selected' if element.type == 'rating' }}>Rating</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Points</label>
                                                                    <input type="number" class="form-control" name="teleop_element_points_{{ loop.index0 }}" 
                                                                           value="{{ element.get('points', 0) if element.get('points') is number else 0 }}" step="0.1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-sm btn-danger remove-element">Remove</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <button type="button" class="btn btn-success add-element" data-period="teleop">Add Teleop Element</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Endgame Period -->
                                        <div class="card mb-3">
                                            <div class="card-header">
                                                <h5>Endgame Period Scoring Elements</h5>
                                                <small class="text-muted">Duration: {{ config.get('endgame_period', {}).get('duration_seconds', 30) }} seconds</small>
                                            </div>
                                            <div class="card-body">
                                                <div id="endgame-elements">
                                                    {% if config.get('endgame_period', {}).get('scoring_elements') %}
                                                        {% for element in config.endgame_period.scoring_elements %}
                                                        <div class="scoring-element" data-period="endgame" data-index="{{ loop.index0 }}">
                                                            <h6>{{ element.name or element.id }}</h6>
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <label>Element ID</label>
                                                                    <input type="text" class="form-control" name="endgame_element_id_{{ loop.index0 }}" 
                                                                           value="{{ element.id }}" required>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <label>Name</label>
                                                                    <input type="text" class="form-control" name="endgame_element_name_{{ loop.index0 }}" 
                                                                           value="{{ element.name }}" required>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Type</label>
                                                                    <select class="form-control element-type" name="endgame_element_type_{{ loop.index0 }}">
                                                                        <option value="boolean" {{ 'selected' if element.type == 'boolean' }}>Boolean</option>
                                                                        <option value="counter" {{ 'selected' if element.type == 'counter' }}>Counter</option>
                                                                        <option value="select" {{ 'selected' if element.type == 'select' }}>Select</option>
                                                                        <option value="rating" {{ 'selected' if element.type == 'rating' }}>Rating</option>
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Points</label>
                                                                    <input type="number" class="form-control" name="endgame_element_points_{{ loop.index0 }}" 
                                                                           value="{{ element.get('points', 0) if element.get('points') is number else 0 }}" step="0.1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-sm btn-danger remove-element">Remove</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <button type="button" class="btn btn-success add-element" data-period="endgame">Add Endgame Element</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Game Pieces Tab -->
                                <div class="tab-pane fade" id="gamepieces" role="tabpanel">
                                    <div class="mt-3">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Game Pieces</h5>
                                            </div>
                                            <div class="card-body">
                                                <div id="game-pieces">
                                                    {% if config.get('game_pieces') %}
                                                        {% for piece in config.game_pieces %}
                                                        <div class="game-piece" data-index="{{ loop.index0 }}">
                                                            <h6>{{ piece.name or piece.id }}</h6>
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <label>ID</label>
                                                                    <input type="text" class="form-control" name="game_piece_id_{{ loop.index0 }}" 
                                                                           value="{{ piece.id }}" required>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <label>Name</label>
                                                                    <input type="text" class="form-control" name="game_piece_name_{{ loop.index0 }}" 
                                                                           value="{{ piece.name }}" required>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Auto Points</label>
                                                                    <input type="number" class="form-control" name="game_piece_auto_points_{{ loop.index0 }}" 
                                                                           value="{{ piece.get('auto_points', 0) }}" step="0.1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <label>Teleop Points</label>
                                                                    <input type="number" class="form-control" name="game_piece_teleop_points_{{ loop.index0 }}" 
                                                                           value="{{ piece.get('teleop_points', 0) }}" step="0.1">
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-sm btn-danger remove-game-piece">Remove</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <button type="button" class="btn btn-success add-game-piece">Add Game Piece</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Post Match Tab -->
                                <div class="tab-pane fade" id="postmatch" role="tabpanel">
                                    <div class="mt-3">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>Post Match Elements</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6>Rating Elements</h6>
                                                        <div id="rating-elements">
                                                            {% if config.get('post_match', {}).get('rating_elements') %}
                                                                {% for element in config.post_match.rating_elements %}
                                                                <div class="rating-element" data-index="{{ loop.index0 }}">
                                                                    <div class="row">
                                                                        <div class="col-md-6">
                                                                            <label>Name</label>
                                                                            <input type="text" class="form-control" name="rating_element_name_{{ loop.index0 }}" 
                                                                                   value="{{ element.name }}" required>
                                                                        </div>
                                                                        <div class="col-md-3">
                                                                            <label>Min</label>
                                                                            <input type="number" class="form-control" name="rating_element_min_{{ loop.index0 }}" 
                                                                                   value="{{ element.get('min', 1) }}">
                                                                        </div>
                                                                        <div class="col-md-3">
                                                                            <label>Max</label>
                                                                            <input type="number" class="form-control" name="rating_element_max_{{ loop.index0 }}" 
                                                                                   value="{{ element.get('max', 5) }}">
                                                                        </div>
                                                                    </div>
                                                                    <button type="button" class="btn btn-sm btn-danger remove-rating-element mt-2">Remove</button>
                                                                </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                        <button type="button" class="btn btn-success add-rating-element">Add Rating Element</button>
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <h6>Text Elements</h6>
                                                        <div id="text-elements">
                                                            {% if config.get('post_match', {}).get('text_elements') %}
                                                                {% for element in config.post_match.text_elements %}
                                                                <div class="text-element" data-index="{{ loop.index0 }}">
                                                                    <div class="row">
                                                                        <div class="col-md-8">
                                                                            <label>Name</label>
                                                                            <input type="text" class="form-control" name="text_element_name_{{ loop.index0 }}" 
                                                                                   value="{{ element.name }}" required>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <label>Multiline</label>
                                                                            <div class="form-check">
                                                                                <input class="form-check-input" type="checkbox" name="text_element_multiline_{{ loop.index0 }}"
                                                                                       {{ 'checked' if element.get('multiline') }}>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <button type="button" class="btn btn-sm btn-danger remove-text-element mt-2">Remove</button>
                                                                </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                        <button type="button" class="btn btn-success add-text-element">Add Text Element</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mt-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Configuration
                                </button>
                                <a href="{{ url_for('scouting_alliances.view_alliance', alliance_id=alliance.id) }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Alliance
                                </a>
                            </div>
                        </form>
                    </div>

                    <!-- JSON Mode Editor -->
                    <div id="json-mode" class="config-editor" style="display: none;">
                        <form id="json-config-form" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <div class="form-group">
                                <label for="json-editor">JSON Configuration:</label>
                                <textarea id="json-editor" name="json_config" class="form-control" rows="20" placeholder="Enter JSON configuration..."></textarea>
                                <small class="form-text text-muted">Edit the configuration as JSON. The editor will validate your JSON syntax.</small>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary" id="save-json-btn">
                                    <i class="fas fa-save"></i> Save JSON Configuration
                                </button>
                                <a href="{{ url_for('scouting_alliances.view_alliance', alliance_id=alliance.id) }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Alliance
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentConfig = {{ config|tojson|safe }};

    // Mode toggle functionality
    const simpleModeBtn = document.getElementById('simple-mode-btn');
    const jsonModeBtn = document.getElementById('json-mode-btn');
    const simpleModeDiv = document.getElementById('simple-mode');
    const jsonModeDiv = document.getElementById('json-mode');
    const jsonEditor = document.getElementById('json-editor');

    simpleModeBtn.addEventListener('click', function() {
        simpleModeDiv.style.display = 'block';
        jsonModeDiv.style.display = 'none';
        this.classList.add('active');
        jsonModeBtn.classList.remove('active');
    });

    jsonModeBtn.addEventListener('click', function() {
        simpleModeDiv.style.display = 'none';
        jsonModeDiv.style.display = 'block';
        this.classList.add('active');
        simpleModeBtn.classList.remove('active');
        
        // Populate JSON editor with current config
        jsonEditor.value = JSON.stringify(currentConfig, null, 2);
        validateJson();
    });

    // Copy from scouting team functionality
    document.getElementById('copy-scouting-team-btn').addEventListener('click', function() {
        if (confirm('This will replace the current alliance game configuration with your scouting team\'s configuration. Are you sure?')) {
            fetch(`{{ url_for('scouting_alliances.copy_scouting_team_config', alliance_id=alliance.id, config_type='game') }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration copied successfully! Reloading page...');
                    location.reload();
                } else {
                    alert('Error copying configuration: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error copying configuration');
            });
        }
    });

    // JSON validation
    function validateJson() {
        try {
            JSON.parse(jsonEditor.value);
            jsonEditor.classList.remove('json-invalid');
            jsonEditor.classList.add('json-valid');
            return true;
        } catch (e) {
            jsonEditor.classList.remove('json-valid');
            jsonEditor.classList.add('json-invalid');
            return false;
        }
    }

    if (jsonEditor) {
        jsonEditor.addEventListener('input', validateJson);
    }

    // Form submissions
    const gameConfigForm = document.getElementById('game-config-form');
    if (gameConfigForm) {
        gameConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch(`{{ url_for('scouting_alliances.save_game_config', alliance_id=alliance.id) }}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    location.reload();
                } else {
                    alert('Error saving configuration: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration');
            });
        });
    }

    const jsonConfigForm = document.getElementById('json-config-form');
    if (jsonConfigForm) {
        jsonConfigForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!validateJson()) {
                alert('Invalid JSON syntax. Please fix errors before saving.');
                return;
            }
            
            const formData = new FormData();
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            formData.append('json_config', jsonEditor.value);
            
            fetch(`{{ url_for('scouting_alliances.save_game_config', alliance_id=alliance.id) }}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                    location.reload();
                } else {
                    alert('Error saving configuration: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration');
            });
        });
    }

    // Initialize the JSON editor with current config
    if (jsonEditor) {
        jsonEditor.value = JSON.stringify(currentConfig, null, 2);
        validateJson();
    }

    // Add element functionality for game periods
    document.querySelectorAll('.add-element').forEach(button => {
        button.addEventListener('click', function() {
            const period = this.getAttribute('data-period');
            const container = document.getElementById(`${period}-elements`);
            if (container) {
                const index = container.querySelectorAll('.scoring-element').length;
                
                const elementDiv = document.createElement('div');
                elementDiv.className = 'scoring-element';
                elementDiv.setAttribute('data-period', period);
                elementDiv.setAttribute('data-index', index);
                
                elementDiv.innerHTML = `
                    <h6>New Element ${index + 1}</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <label>Element ID</label>
                            <input type="text" class="form-control" name="${period}_element_id_${index}" 
                                   value="new_element_${index}" required>
                        </div>
                        <div class="col-md-3">
                            <label>Name</label>
                            <input type="text" class="form-control" name="${period}_element_name_${index}" 
                                   value="New Element ${index + 1}" required>
                        </div>
                        <div class="col-md-2">
                            <label>Type</label>
                            <select class="form-control element-type" name="${period}_element_type_${index}">
                                <option value="boolean">Boolean</option>
                                <option value="counter" selected>Counter</option>
                                <option value="select">Select</option>
                                <option value="rating">Rating</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label>Points</label>
                            <input type="number" class="form-control" name="${period}_element_points_${index}" 
                                   value="0" step="0.1">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-danger remove-element">Remove</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(elementDiv);
            }
        });
    });

    // Add game piece functionality
    const addGamePieceBtn = document.querySelector('.add-game-piece');
    if (addGamePieceBtn) {
        addGamePieceBtn.addEventListener('click', function() {
            const container = document.getElementById('game-pieces');
            if (container) {
                const index = container.querySelectorAll('.game-piece').length;
                
                const pieceDiv = document.createElement('div');
                pieceDiv.className = 'game-piece';
                pieceDiv.setAttribute('data-index', index);
                
                pieceDiv.innerHTML = `
                    <h6>New Game Piece ${index + 1}</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <label>ID</label>
                            <input type="text" class="form-control" name="game_piece_id_${index}" 
                                   value="piece_${index}" required>
                        </div>
                        <div class="col-md-3">
                            <label>Name</label>
                            <input type="text" class="form-control" name="game_piece_name_${index}" 
                                   value="Game Piece ${index + 1}" required>
                        </div>
                        <div class="col-md-2">
                            <label>Auto Points</label>
                            <input type="number" class="form-control" name="game_piece_auto_points_${index}" 
                                   value="0" step="0.1">
                        </div>
                        <div class="col-md-2">
                            <label>Teleop Points</label>
                            <input type="number" class="form-control" name="game_piece_teleop_points_${index}" 
                                   value="0" step="0.1">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-danger remove-game-piece">Remove</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(pieceDiv);
            }
        });
    }

    // Add rating element functionality
    const addRatingElementBtn = document.querySelector('.add-rating-element');
    if (addRatingElementBtn) {
        addRatingElementBtn.addEventListener('click', function() {
            const container = document.getElementById('rating-elements');
            if (container) {
                const index = container.querySelectorAll('.rating-element').length;
                
                const ratingDiv = document.createElement('div');
                ratingDiv.className = 'rating-element';
                ratingDiv.setAttribute('data-index', index);
                
                ratingDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <label>Name</label>
                            <input type="text" class="form-control" name="rating_element_name_${index}" 
                                   value="Rating ${index + 1}" required>
                        </div>
                        <div class="col-md-3">
                            <label>Min</label>
                            <input type="number" class="form-control" name="rating_element_min_${index}" 
                                   value="1">
                        </div>
                        <div class="col-md-3">
                            <label>Max</label>
                            <input type="number" class="form-control" name="rating_element_max_${index}" 
                                   value="5">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-rating-element mt-2">Remove</button>
                `;
                
                container.appendChild(ratingDiv);
            }
        });
    }

    // Add text element functionality
    const addTextElementBtn = document.querySelector('.add-text-element');
    if (addTextElementBtn) {
        addTextElementBtn.addEventListener('click', function() {
            const container = document.getElementById('text-elements');
            if (container) {
                const index = container.querySelectorAll('.text-element').length;
                
                const textDiv = document.createElement('div');
                textDiv.className = 'text-element';
                textDiv.setAttribute('data-index', index);
                
                textDiv.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <label>Name</label>
                            <input type="text" class="form-control" name="text_element_name_${index}" 
                                   value="Text Field ${index + 1}" required>
                        </div>
                        <div class="col-md-4">
                            <label>Multiline</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="text_element_multiline_${index}">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-text-element mt-2">Remove</button>
                `;
                
                container.appendChild(textDiv);
            }
        });
    }
    
    // Remove element functionality using event delegation
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-element')) {
            const elementDiv = e.target.closest('.scoring-element');
            if (elementDiv) {
                elementDiv.remove();
            }
        } else if (e.target.classList.contains('remove-game-piece')) {
            const pieceDiv = e.target.closest('.game-piece');
            if (pieceDiv) {
                pieceDiv.remove();
            }
        } else if (e.target.classList.contains('remove-rating-element')) {
            const ratingDiv = e.target.closest('.rating-element');
            if (ratingDiv) {
                ratingDiv.remove();
            }
        } else if (e.target.classList.contains('remove-text-element')) {
            const textDiv = e.target.closest('.text-element');
            if (textDiv) {
                textDiv.remove();
            }
        }
    });
});
</script>
{% endblock %}
