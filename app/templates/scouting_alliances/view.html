{% extends "base.html" %}
{% import '_help_icon.html' as help %}
{% block title %}{{ alliance.alliance_name }} - Scouting Alliance{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>
                        <i class="fas fa-handshake"></i> {{ alliance.alliance_name }}
                    </h2>
                    <p class="text-muted">{{ alliance.description or 'No description provided.' }}</p>
                </div>
                <div>
                    <a href="{{ url_for('scouting_alliances.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    {% if member.role == 'admin' %}
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
                        <i class="fas fa-user-plus"></i> Invite Team
                    </button>
                    {% endif %}
                    <button class="btn btn-outline-danger" onclick="leaveAlliance({{ alliance.id }})">
                        <i class="fas fa-sign-out-alt"></i> Leave Alliance
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Alliance Information -->
        <div class="col-md-8">
            <!-- Members Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Alliance Members ({{ members|length }}) {{ help.help_icon('List of teams currently in the alliance. Admins can invite, promote, or remove teams.', 'Alliance members') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for member_obj in members %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 {% if member_obj.role == 'admin' %}border-warning{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="card-title mb-2">
                                                Team {{ member_obj.team_number }}
                                                {% if member_obj.role == 'admin' %}
                                                <span class="badge bg-warning text-dark">Admin</span>
                                                {% endif %}
                                            </h6>
                                            <p class="card-text mb-0">
                                                <small class="text-muted">
                                                    Joined: {{ member_obj.joined_at.strftime('%m/%d/%Y') }}
                                                    {% if member_obj.invited_by %}
                                                    <br>Invited by: Team {{ member_obj.invited_by }}
                                                    {% endif %}
                                                </small>
                                            </p>
                                        </div>
                                        {% if member.role == 'admin' and member_obj.team_number != current_team %}
                                        <div class="btn-group-vertical" role="group">
                                            {% if member_obj.role == 'admin' %}
                                            <button class="btn btn-sm btn-outline-warning" 
                                                    onclick="demoteMember({{ alliance.id }}, {{ member_obj.id }}, {{ member_obj.team_number }})"
                                                    title="Demote to member">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-success" 
                                                    onclick="promoteMember({{ alliance.id }}, {{ member_obj.id }}, {{ member_obj.team_number }})"
                                                    title="Promote to admin">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="removeMember({{ alliance.id }}, {{ member_obj.id }}, {{ member_obj.team_number }})"
                                                    title="Remove from alliance">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Alliance Configuration {{ help.help_icon('Shared settings for game and pit scouting forms that can be applied across the entire alliance. When Alliance Mode is active for your team, these settings override your individual team settings.', 'Alliance configuration') }}
                    </h5> 
                    {% if member.role == 'admin' %}
                    <div class="dropdown">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="configDropdown" 
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-edit me-1"></i>Edit Configuration
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="configDropdown">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('scouting_alliances.edit_game_config', alliance_id=alliance.id) }}">
                                    <i class="fas fa-gamepad me-1"></i>Game Configuration
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('scouting_alliances.edit_pit_config', alliance_id=alliance.id) }}">
                                    <i class="fas fa-tools me-1"></i>Pit Configuration
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <!-- Alliance Mode Toggle -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-toggle-on me-2"></i>Alliance Mode Control {{ help.help_icon('Toggle whether your team uses the alliance-wide shared configurations. This setting is per-team and does not affect other teams.', 'Alliance mode control') }}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <div class="mb-2">
                                                <strong>Your Team's Alliance Mode:</strong>
                                                <span id="allianceModeStatus" class="badge bg-secondary ms-1">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>Checking...
                                                </span>
                                            </div>
                                            <p class="text-muted small mb-0">
                                                <strong>Active:</strong> Your team uses alliance's shared configurations site-wide<br>
                                                <strong>Inactive:</strong> Your team uses individual configurations<br>
                                                <em>Note: Each team can control their own alliance mode independently</em>
                                            </p>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" 
                                                       id="allianceModeToggle" style="transform: scale(1.5);">
                                                <label class="form-check-label" for="allianceModeToggle">
                                                    <strong>Alliance Mode</strong>
                                                </label>
                                            </div>
                                            <small class="text-muted">Controls your team's alliance mode</small>
                                        </div>
                                    </div>
                                    
                                    <div id="allianceModeInfo" class="alert alert-info mt-3" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <span id="allianceModeInfoText"></span>
                                    </div>
                                    
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Important:</strong> Your team can only be active in one alliance at a time. 
                                        Activating this alliance will automatically deactivate any other active alliance.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Details -->
                    {% set config_summary = alliance.get_config_summary() %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-gamepad me-2 text-primary"></i>Game Configuration {{ help.help_icon('The shared game scouting form used by alliance members when Alliance Mode is active.', 'Game configuration') }}
                                    </h6>
                                    {% if alliance.game_config_team %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>
                                            Team {{ alliance.game_config_team }}
                                        </span>
                                        <p class="small text-muted mt-2 mb-0">
                                            All members use Team {{ alliance.game_config_team }}'s game scouting configuration
                                        </p>
                                    {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-cog me-1"></i>
                                            Default Configuration
                                        </span>
                                        <p class="small text-muted mt-2 mb-0">
                                            Using system default game configuration - you can customize this in the alliance settings
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-tools me-2 text-info"></i>Pit Configuration {{ help.help_icon('The shared pit scouting form used by alliance members when Alliance Mode is active.', 'Pit configuration') }}
                                    </h6>
                                    {% if alliance.pit_config_team %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>
                                            Team {{ alliance.pit_config_team }}
                                        </span>
                                        <p class="small text-muted mt-2 mb-0">
                                            All members use Team {{ alliance.pit_config_team }}'s pit scouting configuration
                                        </p>
                                    {% else %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-cog me-1"></i>
                                            Default Configuration
                                        </span>
                                        <p class="small text-muted mt-2 mb-0">
                                            Using system default pit configuration - you can customize this in the alliance settings
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <strong>Overall Status:</strong>
                                {% if alliance.is_config_complete() %}
                                    <span class="badge bg-success ms-1">
                                        <i class="fas fa-check me-1"></i>Configuration Complete
                                    </span>
                                {% elif alliance.has_config_conflicts() %}
                                    <span class="badge bg-danger ms-1">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Conflicts Detected
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning ms-1">
                                        <i class="fas fa-clock me-1"></i>Configuration Pending
                                    </span>
                                {% endif %}
                            </div>
                            
                            {% if not alliance.is_config_complete() and member.role == 'admin' %}
                                <div class="dropdown">
                                    <button class="btn btn-warning btn-sm dropdown-toggle" type="button" id="configureDropdown" 
                                            data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-cogs me-1"></i>Configure Now
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="configureDropdown">
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('scouting_alliances.edit_game_config', alliance_id=alliance.id) }}">
                                                <i class="fas fa-gamepad me-1"></i>Game Configuration
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('scouting_alliances.edit_pit_config', alliance_id=alliance.id) }}">
                                                <i class="fas fa-tools me-1"></i>Pit Configuration
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Configuration warning removed since default configurations are always available -->
                </div>
            </div>

            <!-- Alliance Configuration Management -->
            {% if member.role == 'admin' %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Alliance Configuration Management
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        As an alliance administrator, you can create and edit shared configurations that all alliance members will use.
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-gamepad fa-3x text-primary mb-3"></i>
                                    <h6>Game Configuration</h6>
                                    <p class="text-muted small">
                                        Edit the shared game scouting form configuration for all alliance members.
                                    </p>
                                    <!-- Always show as configured since defaults are available -->
                                    <span class="badge bg-success mb-2">
                                        <i class="fas fa-check"></i> Configured
                                    </span>
                                    <div>
                                        <a href="{{ url_for('scouting_alliances.edit_game_config', alliance_id=alliance.id) }}" 
                                           class="btn btn-primary btn-sm">
                                            <i class="fas fa-edit"></i> Edit Game Config
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-tools fa-3x text-info mb-3"></i>
                                    <h6>Pit Configuration</h6>
                                    <p class="text-muted small">
                                        Edit the shared pit scouting form configuration for all alliance members.
                                    </p>
                                    <!-- Always show as configured since defaults are available -->
                                    <span class="badge bg-success mb-2">
                                        <i class="fas fa-check"></i> Configured
                                    </span>
                                    <div>
                                        <a href="{{ url_for('scouting_alliances.edit_pit_config', alliance_id=alliance.id) }}" 
                                           class="btn btn-info btn-sm">
                                            <i class="fas fa-edit"></i> Edit Pit Config
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> These configurations will override individual team configurations when alliance mode is active. 
                        Changes will be automatically applied to all alliance members.
                    </div>
                </div>
            </div>

            <!-- Alliance Data Management -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-database"></i> Alliance Data Management
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Manage teams, events, and matches that will be shared with all alliance members.
                    </p>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card border-primary h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                                    <h6>Teams</h6>
                                    <p class="text-muted small">
                                        Sync and manage teams from FIRST API. Teams will be available to all alliance members.
                                    </p>
                                    <a href="{{ url_for('scouting_alliances.manage_alliance_teams', alliance_id=alliance.id) }}" 
                                       class="btn btn-primary btn-sm">
                                        <i class="fas fa-users-cog"></i> Manage Teams
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!-- Events card hidden (managed automatically by backend) -->
                        <div class="col-md-3">
                            <div class="card border-success h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-trophy fa-3x text-success mb-3"></i>
                                    <h6>Matches</h6>
                                    <p class="text-muted small">
                                        Sync and view match schedules for alliance events.
                                    </p>
                                    <a href="{{ url_for('scouting_alliances.manage_alliance_matches', alliance_id=alliance.id) }}" 
                                       class="btn btn-success btn-sm">
                                        <i class="fas fa-list-ol"></i> Manage Matches
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-import fa-3x text-warning mb-3"></i>
                                    <h6>Import Data</h6>
                                    <p class="text-muted small">
                                        Import scouting data from alliance member teams into the shared storage.
                                    </p>
                                    <a href="{{ url_for('scouting_alliances.import_data_page', alliance_id=alliance.id) }}" 
                                       class="btn btn-warning btn-sm">
                                        <i class="fas fa-download"></i> Import Data
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Important:</strong> Data synced here is stored centrally for the alliance. 
                        All alliance members will automatically have access to this data when alliance mode is active.
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Events Section removed from UI: events are managed automatically by the backend. (Hidden per request) -->

            <!-- Data Sync Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-sync"></i> Data Synchronization {{ help.help_icon('When Alliance Mode is active, scouting and pit data syncs automatically between members. Use Manual Sync to force an immediate update.', 'Data synchronization') }}
                        <span class="badge bg-success ms-2">Auto-Sync Active</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Automatic Sync Enabled:</strong> When alliance mode is active, scouting and pit data automatically syncs to alliance members in real-time when saved.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-primary">{{ sync_stats.total_syncs }}</h4>
                                    <p class="mb-0">Total Syncs</p>
                                </div>
                            </div>
                        </div>
                        <!-- Success Rate card removed per request -->
                    </div>
                    
                    {% if sync_stats.last_sync %}
                    <div class="mt-3">
                        <small class="text-muted">
                            Last sync: {{ sync_stats.last_sync.strftime('%m/%d/%Y %I:%M %p') }}
                        </small>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="syncAllianceData({{ alliance.id }})">
                            <i class="fas fa-sync"></i> Manual Sync Data
                        </button>
                        <small class="text-muted ms-2">
                            Force sync all current data with alliance members
                        </small>
                    </div>
                </div>
            </div>

            <!-- Alliance Data Management (Admins Only) -->
            {% if member.role == 'admin' %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-database"></i> Alliance Shared Data {{ help.help_icon('Central shared storage for events, teams, and match data used by alliance members. Admins can sync and populate data here.', 'Shared data') }}
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success" onclick="syncAndPopulateData()" id="syncPopulateBtn">
                            <i class="fas fa-sync"></i> Sync & Populate
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadAllianceSharedData()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        As an alliance administrator, you can view and edit all scouting data shared within the alliance.
                        Use "Sync & Populate" to import data from all member teams into the shared storage.
                    </p>
                    
                    <!-- Data Stats -->
                    <div class="row mb-3" id="allianceDataStats">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-primary" id="sharedScoutingCount">-</h4>
                                    <p class="mb-0">Match Scouting Entries</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h4 class="text-info" id="sharedPitCount">-</h4>
                                    <p class="mb-0">Pit Scouting Entries</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Tables -->
                    <ul class="nav nav-tabs" id="dataTabsNav" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="scouting-tab" data-bs-toggle="tab" data-bs-target="#scoutingData" type="button" role="tab">
                                <i class="fas fa-clipboard-list me-1"></i> Match Scouting
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pit-tab" data-bs-toggle="tab" data-bs-target="#pitData" type="button" role="tab">
                                <i class="fas fa-tools me-1"></i> Pit Scouting
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="dataTabsContent">
                        <!-- Match Scouting Data Tab -->
                        <div class="tab-pane fade show active" id="scoutingData" role="tabpanel">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th>Team</th>
                                            <th>Match</th>
                                            <th>Event</th>
                                            <th>Scout</th>
                                            <th>Source Team</th>
                                            <th>Shared</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scoutingDataTable">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Pit Scouting Data Tab -->
                        <div class="tab-pane fade" id="pitData" role="tabpanel">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th>Team</th>
                                            <th>Scout</th>
                                            <th>Source Team</th>
                                            <th>Shared</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pitDataTable">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> Editing shared data will update the alliance copy. Use "Include Original" to also update the source team's copy.
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Chat Sidebar -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-comments"></i> Alliance Chat
                    </h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3" style="max-height: 400px;">
                        {% for chat in recent_chats %}
                        <div class="mb-2 {% if chat.from_team_number == current_team %}text-end{% endif %}">
                            <div class="d-inline-block p-2 rounded {% if chat.from_team_number == current_team %}bg-primary text-white{% else %}bg-light{% endif %}" 
                                 style="max-width: 85%;">
                                <div class="fw-bold small">{{ chat.from_username }} (Team {{ chat.from_team_number }})</div>
                                <div>{{ chat.message }}</div>
                                <div class="small opacity-75">{{ chat.created_at.strftime('%I:%M %p') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" 
                               placeholder="Type your message...">
                        <button class="btn btn-primary" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invite Modal -->
<div class="modal fade" id="inviteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invite Team to Alliance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('scouting_alliances.send_invitation', alliance_id=alliance.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="teamNumber" class="form-label">Team Number</label>
                        <input type="number" class="form-control" id="teamNumber" name="team_number" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Event to Alliance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('scouting_alliances.add_event', alliance_id=alliance.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="eventCode" class="form-label">Event Code</label>
                        <input type="text" class="form-control" id="eventCode" name="event_code" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventName" class="form-label">Event Name</label>
                        <input type="text" class="form-control" id="eventName" name="event_name" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Event</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Deactivate Alliance Modal -->
<div class="modal fade" id="deactivateAllianceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-warning me-2"></i>Deactivate Alliance Mode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>You are about to deactivate alliance mode for <strong>{{ alliance.alliance_name }}</strong>.</p>
                <p>Your team's data will no longer be shared with alliance members while inactive.</p>
                
                <div class="alert alert-info" id="deactivateDataInfo">
                    <i class="fas fa-spinner fa-spin me-2"></i>Checking your shared data...
                </div>
                
                <h6 class="mt-3 mb-2"><i class="fas fa-download me-1"></i>Data Copy Options:</h6>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="copyDataOption" id="copyNoneRadio" value="none" checked>
                    <label class="form-check-label" for="copyNoneRadio">
                        <strong>Don't copy any data</strong>
                    </label>
                    <div class="form-text">
                        Just deactivate - no data will be copied.
                    </div>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="copyDataOption" id="copyMyDataRadio" value="my_data">
                    <label class="form-check-label" for="copyMyDataRadio">
                        <strong>Copy only MY team's data back</strong>
                    </label>
                    <div class="form-text text-primary">
                        <i class="fas fa-user me-1"></i>This will copy only the scouting data YOUR team contributed to the alliance back to your private team storage. Useful if you want to keep your own work.
                    </div>
                </div>
                
                <div class="form-check mt-2">
                    <input class="form-check-input" type="radio" name="copyDataOption" id="copyAllDataRadio" value="all_data">
                    <label class="form-check-label" for="copyAllDataRadio">
                        <strong>Copy ALL alliance data to my team</strong>
                    </label>
                    <div class="form-text text-success">
                        <i class="fas fa-copy me-1"></i>This will copy ALL scouting data from the alliance (including data from other teams) to your team's local storage. Data from other teams will be prefixed with [Alliance-TEAM#].
                    </div>
                </div>
                
                <hr>
                
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="removeSharedDataCheckbox">
                    <label class="form-check-label" for="removeSharedDataCheckbox">
                        <strong>Remove my team's scouting data from the alliance</strong>
                    </label>
                    <div class="form-text text-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>This is irreversible! Other teams will lose access to your shared data.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelDeactivation()">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmDeactivateBtn" onclick="confirmDeactivateAlliance()">
                    <i class="fas fa-power-off me-1"></i>Deactivate Alliance Mode
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Initialize socket connection and alliance room
if (typeof window.socket !== 'undefined') {
    window.socket.emit('join_alliance_room', {alliance_id: {{ alliance.id }}});
}

// Alliance Mode Toggle Functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting alliance mode check...');
    
    // Give a small delay to ensure all elements are ready
    setTimeout(function() {
        checkAllianceModeStatus();
    }, 500);
    
    const toggle = document.getElementById('allianceModeToggle');
    if (toggle) {
        console.log('Alliance mode toggle found, adding event listener');
        toggle.addEventListener('change', function() {
            toggleAllianceMode(this.checked);
        });
    } else {
        console.error('Alliance mode toggle element not found!');
    }
});

function checkAllianceModeStatus() {
    console.log('Checking alliance mode status for alliance {{ alliance.id }}...');
    
    // Get CSRF token if available
    let headers = {};
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch('/alliances/scouting/api/alliance-mode-status/{{ alliance.id }}', {
        headers: headers
    })
        .then(response => {
            console.log('Alliance mode status response:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Alliance mode status data:', data);
            const statusElement = document.getElementById('allianceModeStatus');
            const toggle = document.getElementById('allianceModeToggle');
            const infoElement = document.getElementById('allianceModeInfo');
            const infoText = document.getElementById('allianceModeInfoText');
            
            if (statusElement && toggle) {
                toggle.checked = data.is_active;
                
                if (data.is_active) {
                    statusElement.innerHTML = '<i class="fas fa-check-circle me-1"></i>Active';
                    statusElement.className = 'badge bg-success ms-1';
                    if (infoElement && infoText) {
                        infoText.textContent = 'This alliance is active. Your team is using shared alliance configurations.';
                        infoElement.style.display = 'block';
                    }
                } else if (data.alliance_mode_on && data.active_alliance_id && data.active_alliance_id !== {{ alliance.id }}) {
                    statusElement.innerHTML = '<i class="fas fa-times-circle me-1"></i>Inactive';
                    statusElement.className = 'badge bg-warning ms-1';
                    if (infoElement && infoText) {
                        infoText.textContent = 'Another alliance is currently active. This alliance is inactive.';
                        infoElement.style.display = 'block';
                    }
                } else {
                    statusElement.innerHTML = '<i class="fas fa-times-circle me-1"></i>Inactive';
                    statusElement.className = 'badge bg-secondary ms-1';
                    if (infoElement && infoText) {
                        infoText.textContent = 'Alliance mode is inactive. Your team is using individual configurations.';
                        infoElement.style.display = 'block';
                    }
                }
            } else {
                console.error('Alliance mode status elements not found:', {
                    statusElement: !!statusElement,
                    toggle: !!toggle
                });
            }
        })
        .catch(error => {
            console.error('Error checking alliance mode status:', error);
            const statusElement = document.getElementById('allianceModeStatus');
            const toggle = document.getElementById('allianceModeToggle');
            
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error';
                statusElement.className = 'badge bg-danger ms-1';
            }
            
            // Set default state if API fails
            if (toggle) {
                toggle.checked = false; // Default to inactive
                console.log('Set default alliance mode to inactive due to API error');
            }
        });
}

function toggleAllianceMode(isActive) {
    // If deactivating, show confirmation modal
    if (!isActive) {
        showDeactivateModal();
        return;
    }
    
    // If activating, proceed directly
    performAllianceModeToggle(true);
}

function showDeactivateModal() {
    const modal = new bootstrap.Modal(document.getElementById('deactivateAllianceModal'));
    const dataInfoEl = document.getElementById('deactivateDataInfo');
    const removeCheckbox = document.getElementById('removeSharedDataCheckbox');
    
    // Reset radio buttons to default (none)
    const copyNoneRadio = document.getElementById('copyNoneRadio');
    if (copyNoneRadio) copyNoneRadio.checked = true;
    
    // Reset remove checkbox to unchecked
    if (removeCheckbox) removeCheckbox.checked = false;
    
    // Check how much data is shared
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch(`/alliances/scouting/api/{{ alliance.id }}/team-data-counts`, {
        method: 'GET',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const totalCount = data.match_data_count + data.pit_data_count;
            if (totalCount > 0) {
                dataInfoEl.className = 'alert alert-warning';
                dataInfoEl.innerHTML = `<i class="fas fa-database me-2"></i>Your team has shared <strong>${data.match_data_count}</strong> match scouting entries and <strong>${data.pit_data_count}</strong> pit scouting entries with this alliance.`;
            } else {
                dataInfoEl.className = 'alert alert-info';
                dataInfoEl.innerHTML = `<i class="fas fa-info-circle me-2"></i>Your team has not shared any scouting data with this alliance yet.`;
            }
        } else {
            dataInfoEl.className = 'alert alert-secondary';
            dataInfoEl.innerHTML = `<i class="fas fa-info-circle me-2"></i>Could not retrieve data count.`;
        }
    })
    .catch(error => {
        console.error('Error fetching data counts:', error);
        dataInfoEl.className = 'alert alert-secondary';
        dataInfoEl.innerHTML = `<i class="fas fa-info-circle me-2"></i>Could not retrieve data count.`;
    });
    
    modal.show();
}

function cancelDeactivation() {
    // Revert toggle switch to active state
    const toggle = document.getElementById('allianceModeToggle');
    if (toggle) {
        toggle.checked = true;
    }
}

function confirmDeactivateAlliance() {
    const removeData = document.getElementById('removeSharedDataCheckbox').checked;
    // Get the selected copy option from radio buttons
    const copyDataOption = document.querySelector('input[name="copyDataOption"]:checked')?.value || 'none';
    const modal = bootstrap.Modal.getInstance(document.getElementById('deactivateAllianceModal'));
    const btn = document.getElementById('confirmDeactivateBtn');
    
    // Get CSRF token
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    // Disable button during operation
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
    
    // Function to continue with deactivation after optional copy
    function proceedWithDeactivation() {
        if (removeData) {
            // Use the deactivate-with-data endpoint to remove data first
            fetch('/alliances/scouting/api/deactivate-alliance-with-data', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    alliance_id: {{ alliance.id }},
                    remove_data: true
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    modal.hide();
                    showNotification(data.message || 'Alliance deactivated and your data has been removed.', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-power-off me-1"></i>Deactivate Alliance Mode';
                    showNotification('Failed to deactivate: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-power-off me-1"></i>Deactivate Alliance Mode';
                showNotification('Error deactivating alliance', 'danger');
            });
        } else {
            // Just deactivate without removing data
            modal.hide();
            performAllianceModeToggle(false);
        }
    }
    
    // Handle copy data options
    if (copyDataOption === 'all_data') {
        // Copy ALL alliance data
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Copying All Alliance Data...';
        
        fetch(`/alliances/scouting/{{ alliance.id }}/copy-all-data`, {
            method: 'POST',
            headers: headers
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message || 'All alliance data copied to your team!', 'success');
                // Now proceed with deactivation
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deactivating...';
                proceedWithDeactivation();
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-power-off me-1"></i>Deactivate Alliance Mode';
                showNotification('Failed to copy data: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error copying data:', error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-power-off me-1"></i>Deactivate Alliance Mode';
            showNotification('Error copying alliance data', 'danger');
        });
    } else if (copyDataOption === 'my_data') {
        // Copy only MY team's data
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Copying Your Team\'s Data...';
        
        fetch(`/alliances/scouting/{{ alliance.id }}/copy-my-data`, {
            method: 'POST',
            headers: headers
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message || 'Your team\'s data copied back to your private storage!', 'success');
                // Now proceed with deactivation
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deactivating...';
                proceedWithDeactivation();
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-power-off me-1"></i>Deactivate Alliance Mode';
                showNotification('Failed to copy data: ' + (data.error || 'Unknown error'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error copying data:', error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-power-off me-1"></i>Deactivate Alliance Mode';
            showNotification('Error copying your team\'s data', 'danger');
        });
    } else {
        // No copy needed, proceed directly
        proceedWithDeactivation();
    }
}

function performAllianceModeToggle(isActive) {
    const statusElement = document.getElementById('allianceModeStatus');
    if (statusElement) {
        statusElement.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
        statusElement.className = 'badge bg-warning ms-1';
    }
    
    // Get CSRF token if available
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch('/alliances/scouting/api/toggle-alliance-mode', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
            alliance_id: {{ alliance.id }},
            is_active: isActive
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            checkAllianceModeStatus();
            
            // Show success notification
            showNotification(
                isActive ? 'Alliance mode activated successfully!' : 'Alliance mode deactivated successfully!',
                'success'
            );
            
            // Reload page after a short delay to reflect changes
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            console.error('Failed to toggle alliance mode:', data.error);
            checkAllianceModeStatus(); // Revert toggle if failed
            showNotification('Failed to update alliance mode: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error toggling alliance mode:', error);
        checkAllianceModeStatus(); // Revert toggle if failed
        showNotification('Error updating alliance mode', 'danger');
    });
}

// Sync functionality
function syncAllianceData(allianceId) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    button.disabled = true;
    
    // Get CSRF token if available
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch(`/alliances/scouting/${allianceId}/sync/data`, {
        method: 'POST',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message || `Sync complete! Imported ${data.imported_count} entries, shared ${data.shared_count} entries with ${data.synced_to} teams.`, 'success');
        } else {
            showNotification('Sync failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Sync error:', error);
        showNotification('Sync error occurred', 'danger');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Chat functionality
function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (typeof window.socket !== 'undefined') {
        window.socket.emit('alliance_chat', {
            alliance_id: {{ alliance.id }},
            message: message
        });
        input.value = '';
    }
}

// Enter key support for chat
const chatInput = document.getElementById('chatInput');
if (chatInput) {
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    });
}

// Socket event listeners for chat
if (typeof window.socket !== 'undefined') {
    window.socket.on('alliance_chat_message', function(data) {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-2 ${data.from_team_number == {{ current_team }} ? 'text-end' : ''}`;
            messageDiv.innerHTML = `
                <div class="d-inline-block p-2 rounded ${data.from_team_number == {{ current_team }} ? 'bg-primary text-white' : 'bg-light'}" 
                     style="max-width: 85%;">
                    <div class="fw-bold small">${data.from_username} (Team ${data.from_team_number})</div>
                    <div>${data.message}</div>
                    <div class="small opacity-75">Just now</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
    
    // Listen for when members leave the alliance
    window.socket.on('alliance_member_left', function(data) {
        if (data.alliance_id === {{ alliance.id }}) {
            showNotification(`${data.team_name} left the alliance`, 'warning');
            // Reload page after a short delay to update member list
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    });
}

// Utility function for notifications
function showNotification(message, type) {
    // Normalize notification type
    let normalizedType = type;
    if (!type || type === 'info' || type === 'message' || type === 'default') normalizedType = 'success';
    if (type === 'error' || type === 'err') normalizedType = 'danger';
    if (type === 'warn') normalizedType = 'warning';

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${normalizedType} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Leave Alliance function
function leaveAlliance(allianceId) {
    // Show confirmation dialog
    const allianceName = '{{ alliance.alliance_name }}';
    const confirmMessage = `Are you sure you want to leave the alliance "${allianceName}"?\n\n` +
                          `This will:\n` +
                          ` Remove you from the alliance\n` +
                          ` Deactivate alliance mode if currently active\n` +
                          ` Stop sharing scouting data with alliance members\n\n` +
                          `This action cannot be undone.`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // Get CSRF token if available
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch('/alliances/scouting/api/leave-alliance', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
            alliance_id: allianceId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Redirect to dashboard after a short delay
            setTimeout(() => {
                window.location.href = '{{ url_for("scouting_alliances.dashboard") }}';
            }, 2000);
        } else {
            showNotification('Error leaving alliance: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error leaving alliance:', error);
        showNotification('Network error occurred while leaving alliance', 'danger');
    });
}

function promoteMember(allianceId, memberId, teamNumber) {
    if (!confirm(`Promote Team ${teamNumber} to alliance admin?\n\nAdmins can:\n Edit alliance configurations\n Manage members\n Control alliance settings`)) {
        return;
    }
    
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch(`/alliances/scouting/api/${allianceId}/member/${memberId}/promote`, {
        method: 'POST',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message || 'Error promoting member', 'danger');
        }
    })
    .catch(error => {
        console.error('Error promoting member:', error);
        showNotification('Network error occurred', 'danger');
    });
}

function demoteMember(allianceId, memberId, teamNumber) {
    if (!confirm(`Demote Team ${teamNumber} to regular member?\n\nThey will lose admin privileges.`)) {
        return;
    }
    
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch(`/alliances/scouting/api/${allianceId}/member/${memberId}/demote`, {
        method: 'POST',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message || 'Error demoting member', 'danger');
        }
    })
    .catch(error => {
        console.error('Error demoting member:', error);
        showNotification('Network error occurred', 'danger');
    });
}

function removeMember(allianceId, memberId, teamNumber) {
    if (!confirm(`Remove Team ${teamNumber} from the alliance?\n\nThis will:\n Remove them from the alliance\n Deactivate their alliance mode\n Stop data sharing with them\n\nThis action cannot be undone.`)) {
        return;
    }
    
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch(`/alliances/scouting/api/${allianceId}/member/${memberId}/remove`, {
        method: 'POST',
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.message || 'Error removing member', 'danger');
        }
    })
    .catch(error => {
        console.error('Error removing member:', error);
        showNotification('Network error occurred', 'danger');
    });
}

// ======== ALLIANCE DATA MANAGEMENT FUNCTIONS ========

// Store alliance shared data globally
let allianceScoutingData = [];
let alliancePitData = [];

// Load alliance shared data on page load (for admins)
document.addEventListener('DOMContentLoaded', function() {
    {% if member.role == 'admin' %}
    setTimeout(loadAllianceSharedData, 1000);
    {% endif %}
});

async function syncAndPopulateData() {
    const btn = document.getElementById('syncPopulateBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    btn.disabled = true;
    
    let headers = { 'Content-Type': 'application/json' };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    try {
        // Step 1: Sync data between teams
        const syncResponse = await fetch('/alliances/scouting/{{ alliance.id }}/sync/data', {
            method: 'POST',
            headers: headers
        });
        const syncData = await syncResponse.json();
        
        // Step 2: Populate shared data tables
        const populateResponse = await fetch('/alliances/scouting/{{ alliance.id }}/populate-shared-data', {
            method: 'POST',
            headers: headers
        });
        const populateData = await populateResponse.json();
        
        // Build result message
        let message = '';
        if (syncData.success) {
            message += `Sync: Imported ${syncData.imported_count} entries, created ${syncData.shared_copies_created || 0} shared copies. `;
        }
        if (populateData.success) {
            message += `Populate: Created ${populateData.scouting_copies_created} scouting + ${populateData.pit_copies_created} pit shared copies.`;
        }
        
        showNotification(message || 'Data synchronized successfully!', 'success');
        
        // Refresh the data display
        loadAllianceSharedData();
        
    } catch (error) {
        console.error('Error syncing data:', error);
        showNotification('Error syncing data: ' + error.message, 'danger');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function loadAllianceSharedData() {
    let headers = {};
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch('/alliances/scouting/api/{{ alliance.id }}/shared-data', {
        headers: headers
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            allianceScoutingData = data.scouting_data || [];
            alliancePitData = data.pit_data || [];
            
            // Update stats
            document.getElementById('sharedScoutingCount').textContent = allianceScoutingData.length;
            document.getElementById('sharedPitCount').textContent = alliancePitData.length;
            
            // Render tables
            renderScoutingDataTable();
            renderPitDataTable();
        } else {
            console.error('Failed to load alliance data:', data.error);
            showNotification('Failed to load alliance data: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading alliance data:', error);
    });
}

function renderScoutingDataTable() {
    const tbody = document.getElementById('scoutingDataTable');
    if (!tbody) return;
    
    if (allianceScoutingData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No match scouting data shared in this alliance yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = allianceScoutingData.map(item => `
        <tr>
            <td><strong>${item.team_number || 'N/A'}</strong></td>
            <td>${item.match_type || ''} ${item.match_number || ''}</td>
            <td>${item.event_code || 'N/A'}</td>
            <td>${item.scout_name || 'Unknown'}</td>
            <td>Team ${item.source_team}</td>
            <td><small>${item.shared_at ? new Date(item.shared_at).toLocaleDateString() : 'N/A'}</small></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewSharedData('scouting', ${item.id})" title="View">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editSharedData('scouting', ${item.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSharedData('scouting', ${item.id})" title="Remove from Alliance">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function renderPitDataTable() {
    const tbody = document.getElementById('pitDataTable');
    if (!tbody) return;
    
    if (alliancePitData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No pit scouting data shared in this alliance yet.</td></tr>';
        return;
    }
    
    tbody.innerHTML = alliancePitData.map(item => `
        <tr>
            <td><strong>${item.team_number || 'N/A'}</strong></td>
            <td>${item.scout_name || 'Unknown'}</td>
            <td>Team ${item.source_team}</td>
            <td><small>${item.shared_at ? new Date(item.shared_at).toLocaleDateString() : 'N/A'}</small></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewSharedData('pit', ${item.id})" title="View">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editSharedData('pit', ${item.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteSharedData('pit', ${item.id})" title="Remove from Alliance">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function viewSharedData(dataType, sharedId) {
    const dataArray = dataType === 'scouting' ? allianceScoutingData : alliancePitData;
    const item = dataArray.find(d => d.id === sharedId);
    
    if (!item) {
        showNotification('Data not found', 'danger');
        return;
    }
    
    // Create a formatted view of the data
    let content = `<div class="mb-3">
        <h6>Data Details</h6>
        <p><strong>Team:</strong> ${item.team_number || 'N/A'}</p>
        <p><strong>Source Team:</strong> ${item.source_team}</p>
        <p><strong>Scout:</strong> ${item.scout_name || 'Unknown'}</p>
        ${dataType === 'scouting' ? `<p><strong>Match:</strong> ${item.match_type || ''} ${item.match_number || ''}</p>` : ''}
        <p><strong>Shared:</strong> ${item.shared_at ? new Date(item.shared_at).toLocaleString() : 'N/A'}</p>
        ${item.last_edited_by_team ? `<p><strong>Last edited by:</strong> Team ${item.last_edited_by_team} on ${new Date(item.last_edited_at).toLocaleString()}</p>` : ''}
    </div>
    <div class="mb-3">
        <h6>Scouting Data</h6>
        <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">${JSON.stringify(item.data, null, 2)}</pre>
    </div>`;
    
    // Show in modal
    showDataModal('View Shared Data', content, false);
}

function editSharedData(dataType, sharedId) {
    const dataArray = dataType === 'scouting' ? allianceScoutingData : alliancePitData;
    const item = dataArray.find(d => d.id === sharedId);
    
    if (!item) {
        showNotification('Data not found', 'danger');
        return;
    }
    
    // Create an editable form
    let content = `<div class="mb-3">
        <h6>Editing ${dataType === 'scouting' ? 'Match' : 'Pit'} Scouting Data</h6>
        <p class="text-muted small">Team ${item.team_number || 'N/A'} ${dataType === 'scouting' ? `- ${item.match_type || ''} ${item.match_number || ''}` : ''}</p>
    </div>
    <div class="mb-3">
        <label class="form-label">Scouting Data (JSON)</label>
        <textarea id="editDataJson" class="form-control font-monospace" rows="12" style="font-size: 0.85rem;">${JSON.stringify(item.data, null, 2)}</textarea>
        <div class="form-text">Edit the JSON data directly. Be careful to maintain valid JSON format.</div>
    </div>
    <div class="mb-3">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="includeOriginalCheck">
            <label class="form-check-label" for="includeOriginalCheck">
                <strong>Also update source team's original data</strong>
                <br><small class="text-muted">Check this to propagate changes back to Team ${item.source_team}'s original entry</small>
            </label>
        </div>
    </div>`;
    
    showDataModal('Edit Shared Data', content, true, () => {
        saveSharedData(dataType, sharedId);
    });
}

function saveSharedData(dataType, sharedId) {
    const jsonText = document.getElementById('editDataJson').value;
    const includeOriginal = document.getElementById('includeOriginalCheck').checked;
    
    let newData;
    try {
        newData = JSON.parse(jsonText);
    } catch (e) {
        showNotification('Invalid JSON format: ' + e.message, 'danger');
        return;
    }
    
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    fetch('/alliances/scouting/api/{{ alliance.id }}/edit-shared-data', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
            data_type: dataType,
            shared_id: sharedId,
            new_data: newData,
            include_original: includeOriginal
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Data updated successfully!' + (data.include_original ? ' (including original)' : ''), 'success');
            hideDataModal();
            loadAllianceSharedData(); // Refresh
        } else {
            showNotification('Failed to save: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving data:', error);
        showNotification('Network error occurred', 'danger');
    });
}

function deleteSharedData(dataType, sharedId) {
    const dataArray = dataType === 'scouting' ? allianceScoutingData : alliancePitData;
    const item = dataArray.find(d => d.id === sharedId);
    
    if (!item) {
        showNotification('Data not found', 'danger');
        return;
    }
    
    const confirmMsg = `Remove this ${dataType === 'scouting' ? 'match' : 'pit'} scouting entry from the alliance?\n\n` +
                       `Team: ${item.team_number || 'N/A'}\n` +
                       (dataType === 'scouting' ? `Match: ${item.match_type || ''} ${item.match_number || ''}\n` : '') +
                       `Source: Team ${item.source_team}\n\n` +
                       `This will:\n` +
                       `- Remove from alliance shared data\n` +
                       `- Remove synced copies from other alliance members\n` +
                       `- Keep the original team's (${item.source_team}) private copy`;
    
    if (!confirm(confirmMsg)) return;
    
    let headers = {
        'Content-Type': 'application/json',
    };
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        headers['X-CSRFToken'] = csrfMeta.getAttribute('content');
    }
    
    // Use the shared_id directly for admin delete
    fetch('/alliances/scouting/api/delete-from-alliance', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
            data_type: dataType,
            shared_id: sharedId,
            alliance_id: {{ alliance.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const msg = `Removed from alliance: ${data.deleted_count} shared entries, ${data.synced_copies_deleted || 0} synced copies from members`;
            showNotification(msg, 'success');
            loadAllianceSharedData(); // Refresh
        } else {
            showNotification('Failed to delete: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting data:', error);
        showNotification('Network error occurred', 'danger');
    });
}

// Helper functions for modals
let currentDataModal = null;

function showDataModal(title, content, showSave = false, onSave = null) {
    // Remove existing modal if any
    hideDataModal();
    
    const modalHtml = `
    <div class="modal fade" id="dataViewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${title}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    ${showSave ? '<button type="button" class="btn btn-primary" id="modalSaveBtn">Save Changes</button>' : ''}
                </div>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modalEl = document.getElementById('dataViewModal');
    currentDataModal = new bootstrap.Modal(modalEl);
    
    if (showSave && onSave) {
        document.getElementById('modalSaveBtn').addEventListener('click', onSave);
    }
    
    modalEl.addEventListener('hidden.bs.modal', function() {
        modalEl.remove();
        currentDataModal = null;
    });
    
    currentDataModal.show();
}

function hideDataModal() {
    if (currentDataModal) {
        currentDataModal.hide();
    }
    const existing = document.getElementById('dataViewModal');
    if (existing) {
        existing.remove();
    }
}
</script>
{% endblock %}
