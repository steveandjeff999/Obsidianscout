{% extends 'base.html' %}

{% block title %}Dashboard - {{ game_config.game_name }} {{ game_config.season }}{% endblock %}

{% block heading %}Dashboard{% endblock %}
{% block subheading %}
<div class="text-muted mb-4">{{ game_config.game_name }} {{ game_config.season }} ObsidianScout</div>
{% endblock %}

{% block content %}
<!-- Modern KPI row -->
<div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="flex-shrink-0 display-6 text-primary"><i class="fas fa-users"></i></div>
                <div class="flex-grow-1">
                    <div class="small text-muted">Teams</div>
                    <div class="h4 mb-1">{{ teams|length if teams else '0' }}</div>
                    <canvas data-kpi-history='{{ teams_history|tojson|safe if teams_history is defined else "[]" }}' class="kpi-sparkline" width="120" height="40" aria-hidden="true"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="flex-shrink-0 display-6 text-success"><i class="fas fa-gamepad"></i></div>
                <div class="flex-grow-1">
                    <div class="small text-muted">Matches</div>
                    <div class="h4 mb-1">{{ matches|length if matches else '0' }}</div>
                    <canvas data-kpi-history='{{ matches_history|tojson|safe if matches_history is defined else "[]" }}' class="kpi-sparkline" width="120" height="40" aria-hidden="true"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="flex-shrink-0 display-6 text-danger"><i class="fas fa-clipboard-check"></i></div>
                <div class="flex-grow-1">
                    <div class="small text-muted">Scouting Entries</div>
                    <div class="h4 mb-1">{{ total_scout_entries if total_scout_entries is defined else '0' }}</div>
                    <canvas data-kpi-history='{{ entries_history|tojson|safe if entries_history is defined else "[]" }}' class="kpi-sparkline" width="120" height="40" aria-hidden="true"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body d-flex align-items-center gap-3">
                <div class="flex-shrink-0 display-6 text-info"><i class="fas fa-calendar-day"></i></div>
                <div class="flex-grow-1">
                    <div class="small text-muted">Current Event</div>
                    <div class="h5 mb-1 text-truncate">
                        {% if game_config.current_event_code %}
                            {{ game_config.current_event_code }}
                        {% else %}
                            <span class="text-muted">Not configured</span>
                        {% endif %}
                    </div>
                    <div class="small text-muted">{{ game_config.get('current_event_name','') }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bolt me-2 text-warning"></i> Quick Actions</h5>
                <small class="text-muted">Common tasks</small>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-6 col-md-4">
                        <a href="{{ url_for('scouting.index') }}" class="btn btn-primary w-100 py-3 d-flex flex-column align-items-center justify-content-center">
                            <i class="fas fa-clipboard-list fa-2x mb-1"></i>
                            <div>Scout Match</div>
                        </a>
                    </div>
                    <div class="col-6 col-md-4">
                        <a href="{{ url_for('graphs.index') }}" class="btn btn-success w-100 py-3 d-flex flex-column align-items-center justify-content-center">
                            <i class="fas fa-chart-bar fa-2x mb-1"></i>
                            <div>View Analytics</div>
                        </a>
                    </div>
                    <div class="col-12 col-md-4">
                        <button id="syncEventBtn" class="btn btn-outline-primary w-100 py-3 d-flex align-items-center justify-content-center" aria-live="polite">
                            <i class="fas fa-sync-alt fa-lg me-2"></i>
                            <span>Sync Teams & Matches</span>
                            <div id="syncSpinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display:none;"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Event management and charts -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-sync-alt me-2 text-primary"></i> Event Data Management</h5>
                <a href="{{ url_for('main.edit_config') }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-cog me-1"></i> Configure Event</a>
            </div>
            <div class="card-body">
                {% if game_config.current_event_code %}
                    <div class="alert alert-info">Current event: <strong>{{ game_config.current_event_code }}</strong></div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100 border">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-users me-2 text-primary"></i> Teams</h6>
                                    <p class="text-muted small">Sync teams registered for this event</p>
                                    <div class="d-flex align-items-center gap-2">
                                        <a href="{{ url_for('teams.sync_from_config') }}" class="btn btn-primary btn-sm">Sync Teams</a>
                                        <span class="badge bg-primary rounded-pill">{{ teams|length }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-gamepad me-2 text-success"></i> Matches</h6>
                                    <p class="text-muted small">Sync match schedule</p>
                                    <div class="d-flex align-items-center gap-2">
                                        <a href="{{ url_for('matches.sync_from_config') }}" class="btn btn-success btn-sm">Sync Matches</a>
                                        <span class="badge bg-success rounded-pill">{{ matches|length }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">No event code configured. <a href="{{ url_for('main.simple_edit_config') }}">Set event code</a> to enable automatic syncs.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-cog me-2"></i> Game Configuration</h5>
                <div class="dropdown">
                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">Edit</button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{{ url_for('main.simple_edit_config') }}"><i class="fas fa-edit me-2"></i>Simple</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.edit_config') }}"><i class="fas fa-code me-2"></i>Advanced</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.config') }}"><i class="fas fa-eye me-2"></i>View full</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-gamepad me-2 text-primary"></i> Game Name</span>
                        <span class="fw-bold">{{ game_config.game_name }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-calendar me-2 text-success"></i> Season</span>
                        <span class="fw-bold">{{ game_config.season }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-hourglass-start me-2 text-warning"></i> Auto</span>
                        <span class="fw-bold">{{ game_config.get('auto_period', {}).get('duration_seconds', 15) }}s</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-hourglass-half me-2 text-primary"></i> Teleop</span>
                        <span class="fw-bold">{{ game_config.get('teleop_period', {}).get('duration_seconds', 135) }}s</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-hourglass-end me-2 text-danger"></i> Endgame</span>
                        <span class="fw-bold">{{ game_config.get('endgame_period', {}).get('duration_seconds', 30) }}s</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-gradient-info text-white"><h6 class="mb-0"><i class="fas fa-tools me-2"></i> Data Tools</h6></div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('data.index') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="fas fa-database text-primary me-3"></i>
                        <div>
                            <div class="fw-medium">Data Management</div>
                            <small class="text-muted">Import & export scouting data</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto"></i>
                    </a>
                    <a href="{{ url_for('data.import_qr') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="fas fa-qrcode text-success me-3"></i>
                        <div>
                            <div class="fw-medium">Scan QR Code</div>
                            <small class="text-muted">Import via QR</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto"></i>
                    </a>
                    <a href="{{ url_for('graphs.index') }}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <i class="fas fa-chart-line text-danger me-3"></i>
                        <div>
                            <div class="fw-medium">Advanced Graphs</div>
                            <small class="text-muted">Custom visualizations</small>
                        </div>
                        <i class="fas fa-chevron-right ms-auto"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Render KPI sparklines using Chart.js if available
    function renderSparklines(){
        if (typeof Chart === 'undefined') return;
        document.querySelectorAll('canvas.kpi-sparkline').forEach((cnv)=>{
            try{
                const raw = cnv.getAttribute('data-kpi-history') || '[]';
                const arr = JSON.parse(raw);
                const data = (Array.isArray(arr) && arr.length>0) ? arr : [parseInt(cnv.closest('.card').querySelector('.h4, .h5, .h6')?.textContent || '0') || 0];
                // Simple sparkline config
                new Chart(cnv.getContext('2d'), {
                    type: 'line',
                    data: { labels: data.map((_,i)=>i+1), datasets:[{ data: data, borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bs-primary') || '#0d6efd', backgroundColor: 'transparent', tension: 0.35, borderWidth: 2, pointRadius:0 }]},
                    options: { responsive:false, maintainAspectRatio:true, scales:{ x:{ display:false }, y:{ display:false } }, plugins:{ legend:{ display:false }, tooltip:{ enabled:false } } }
                });
            }catch(e){ console.warn('sparkline render error', e); }
        });
    }

    try{ renderSparklines(); }catch(e){}

    // Re-use existing sync button logic (keeps compatibility with backend)
    const syncBtn = document.getElementById('syncEventBtn');
    const syncSpinner = document.getElementById('syncSpinner');
    if (syncBtn){
        syncBtn.addEventListener('click', function(evt){
            evt.preventDefault();
            syncBtn.disabled = true; syncSpinner.style.display = '';
            fetch('/api/sync-event', { method:'POST', credentials:'same-origin' })
            .then(r=>r.json()).then(data=>{
                if (data && data.success) {
                    // show a simple toast (base template has toasts)
                    const t = document.createElement('div'); t.className='toast show'; t.innerHTML=`<div class="toast-header"><strong class="me-auto">Sync</strong><small>Now</small><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body">Sync started/completed.</div>`; document.body.appendChild(t); setTimeout(()=>{ try{ t.remove(); }catch(e){} },4000);
                } else {
                    const err = (data && data.error) ? data.error : 'Sync failed';
                    const t = document.createElement('div'); t.className='toast show'; t.innerHTML=`<div class="toast-header"><strong class="me-auto">Sync</strong><small>Now</small><button type="button" class="btn-close" data-bs-dismiss="toast"></button></div><div class="toast-body">${err}</div>`; document.body.appendChild(t); setTimeout(()=>{ try{ t.remove(); }catch(e){} },5000);
                }
            }).catch(err=>{ console.error(err); }).finally(()=>{ syncBtn.disabled=false; syncSpinner.style.display='none'; });
        });
    }
});
</script>
{% endblock %}