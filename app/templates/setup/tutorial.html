{% extends 'base.html' %}

{% block title %}Interactive Tutorial{% endblock %}

{% block heading %}ObsidianScout Tutorial{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Tutorial Header -->
            <div class="text-center mb-4">
                <h2><i class="fas fa-graduation-cap me-2"></i>Interactive Tutorial</h2>
                <p class="lead text-muted">Learn how to use ObsidianScout effectively</p>
                <div class="text-center mt-3 d-flex justify-content-center align-items-center gap-3">
                    <div class="btn-group" role="group" aria-label="Tutorial mode">
                        <button id="mode-guided" class="btn btn-outline-primary btn-sm active" aria-pressed="true">Guided Mode</button>
                        <button id="mode-compact" class="btn btn-outline-secondary btn-sm" aria-pressed="false">Compact Mode</button>
                    </div>
                    <div>
                        <a href="{{ url_for('setup.index') }}" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="fas fa-home me-1"></i>Setup Home
                        </a>
                        <a href="{{ url_for('main.help_page') }}" class="btn btn-outline-info btn-sm me-2">
                            <i class="fas fa-question-circle me-1"></i>Help Center
                        </a>
                        <a href="{{ url_for('setup.features') }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-star me-1"></i>Features Overview
                        </a>
                    </div>
                </div>

                <!-- Hub: Split tutorials -->
                <div class="d-flex gap-2 justify-content-center my-3">
                    <a href="{{ url_for('setup.tutorial_scout') }}" class="btn btn-lg btn-success">Scouting Tutorial</a>
                    <a href="{{ url_for('setup.tutorial_analytics') }}" class="btn btn-lg btn-warning">Analytics Tutorial</a>
                </div>
            </div>

            <!-- Quick Navigation: Where to go and what each page does -->
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="fas fa-compass me-2"></i>Quick Navigation</h6>
                </div>
                <div class="card-body p-3">
                    <p class="small text-muted mb-3">This panel shows the common pages scouts and data users will need and how to access them. Use <strong>Open</strong> to open the full page in a new tab, or <strong>Show</strong> to jump to the related tutorial step for a short explanation.</p>
                    <div class="row g-2 align-items-stretch">
                        <div class="col-sm-6 col-md-4">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-fill small">
                                    <strong>Start Scouting</strong>
                                    <div class="text-muted small">Open the match scouting form to record match observations quickly.</div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-success" onclick="window.open('{{ url_for('scouting.scouting_form') }}','_blank','noopener')">Open</button>
                                    <button class="btn btn-sm btn-outline-primary tutorial-nav-show" data-step="#step-2">Show</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-md-4">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-fill small">
                                    <strong>Scouting Dashboard</strong>
                                    <div class="text-muted small">View assignments, recent submissions, and access tools to review your data.</div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="window.open('{{ url_for('scouting.index') }}','_blank','noopener')">Open</button>
                                    <button class="btn btn-sm btn-outline-primary tutorial-nav-show" data-step="#step-3">Show</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-md-4">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-fill small">
                                    <strong>Pit Scouting</strong>
                                    <div class="text-muted small">Record robot specs and team notes to enrich your scouting dataset.</div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="window.open('{{ url_for('pit_scouting.index') }}','_blank','noopener')">Open</button>
                                    <button class="btn btn-sm btn-outline-primary tutorial-nav-show" data-step="#step-2">Show</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-md-4">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-fill small">
                                    <strong>Analytics</strong>
                                    <div class="text-muted small">Use charts and filters to compare teams and identify trends.</div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-warning" onclick="window.open('{{ url_for('graphs.index') }}','_blank','noopener')">Open</button>
                                    <button class="btn btn-sm btn-outline-primary tutorial-nav-show" data-step="#step-4">Show</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-md-4">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-fill small">
                                    <strong>Game Configuration</strong>
                                    <div class="text-muted small">Edit game-specific scoring, counters, and map elements (admin-level).</div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-info" onclick="window.open('{{ url_for('main.config') }}','_blank','noopener')">Open</button>
                                    <button class="btn btn-sm btn-outline-primary tutorial-nav-show" data-step="#step-5">Show</button>
                                </div>
                            </div>
                        </div>

                        <div class="col-sm-6 col-md-4">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="flex-fill small">
                                    <strong>Team & Match Lists</strong>
                                    <div class="text-muted small">Quick access to teams, matches, and other lists used during scouting and analysis.</div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="window.open('{{ url_for('teams.index') }}','_blank','noopener')">Open</button>
                                    <button class="btn btn-sm btn-outline-primary tutorial-nav-show" data-step="#step-4">Show</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Tutorial Steps (Intro, Basic, Practice, Analytics, Config, Wrap) -->
            <div id="tutorial-container">
                <!-- Step: Intro -->
                <div class="tutorial-step d-block active-step" id="step-1">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><span class="badge bg-light text-primary me-2">1</span>Welcome to ObsidianScout</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>Friendly quick start</h6>
                                    <p class="small">This guided tutorial covers Scouting basics (quick form practice) and Advanced topics (Analytics preview and Configuration). Switch between <strong>Guided</strong> and <strong>Compact</strong> modes using the buttons above.</p>
                                    <div class="mt-3">
                                        <a href="{{ url_for('main.index') }}" class="btn btn-success btn-sm me-2"><i class="fas fa-rocket me-1"></i>Start Scouting</a>
                                        <a href="{{ url_for('main.help_page') }}" class="btn btn-outline-info btn-sm">Help Center</a>
                                    </div>
                                </div>
                                <div class="col-md-4 text-center">
                                    <img src="{{ url_for('static', filename='img/obsidian.png') }}" alt="Obsidian" class="img-fluid" style="max-height:70px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step: Basic Scouting -->
                <div class="tutorial-step d-none" id="step-2">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white"><h5 class="mb-0"><span class="badge bg-light text-success me-2">2</span>Basic: Scouting</h5></div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-lg-7">
                                    <h6>Record match data quickly</h6>
                                    <p class="small">Use the sample form on the right to practice entering a team, match, and a short note. This is preview-only and won't affect your database.</p>
                                    <div class="mt-3">
                                        <button id="basicOpenBtn" class="btn btn-outline-secondary btn-sm me-2" type="button" onclick="window.open('{{ url_for('scouting.scouting_form') }}','_blank','noopener')"><i class="fas fa-up-right-from-square me-1"></i>Open full Scouting page</button>
                                        <button id="basicJump" class="btn btn-primary btn-sm">Practice Now</button>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div id="basicScoutingPreview" class="border rounded bg-body-secondary p-3 demo-preview" role="region" aria-label="Scouting preview">
                                        <div class="preview-placeholder text-muted small text-center">Click <strong>Practice Now</strong> to open the sample form here.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step: Practice -->
                <div class="tutorial-step d-none" id="step-3">
                    <div class="card shadow">
                        <div class="card-header bg-info text-white"><h5 class="mb-0"><span class="badge bg-light text-info me-2">3</span>Practice</h5></div>
                        <div class="card-body p-4">
                            <h6>Small practice challenge</h6>
                            <p class="small">Complete the sample form and click <strong>Save Sample</strong>.</p>
                            <div class="d-flex justify-content-center mt-3">
                                <button id="practice-complete" class="btn btn-success btn-sm">I finished the practice</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step: Analytics -->
                <div class="tutorial-step d-none" id="step-4">
                    <div class="card shadow">
                        <div class="card-header bg-warning text-white"><h5 class="mb-0"><span class="badge bg-light text-warning me-2">4</span>Advanced: Analytics</h5></div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-lg-7">
                                    <h6>Visualize trends</h6>
                                    <p class="small">Use the sample chart preview to understand filtering and team comparisons. Open the full analytics page to use real filters.</p>
                                    <div class="mt-3">
                                        <button id="analyticsOpenBtn" class="btn btn-outline-secondary btn-sm me-2" type="button" onclick="window.open('{{ url_for('graphs.index') }}','_blank','noopener')"><i class="fas fa-up-right-from-square me-1"></i>Open full Analytics</button>
                                        <button id="analyticsSample" class="btn btn-warning btn-sm">Show Sample Chart</button>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div id="analyticsPreview" class="border rounded bg-body-secondary p-3 demo-preview" role="region" aria-label="Analytics preview">
                                        <div class="preview-placeholder text-muted small text-center">Click <strong>Show Sample Chart</strong> to display an example.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step: Config -->
                <div class="tutorial-step d-none" id="step-5">
                    <div class="card shadow">
                        <div class="card-header bg-info text-white"><h5 class="mb-0"><span class="badge bg-light text-info me-2">5</span>Advanced: Configuration</h5></div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-lg-7">
                                    <h6>Customize your setup</h6>
                                    <p class="small">Preview simple configuration toggles and learn where to make changes in the full page.</p>
                                    <div class="mt-3">
                                        <button id="configOpenBtn" class="btn btn-outline-secondary btn-sm me-2" type="button" onclick="window.open('{{ url_for('main.config') }}','_blank','noopener')"><i class="fas fa-up-right-from-square me-1"></i>Open full Configuration</button>
                                        <button id="configSample" class="btn btn-info btn-sm">Show Config Preview</button>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div id="configPreview" class="border rounded bg-body-secondary p-3 demo-preview" role="region" aria-label="Configuration preview">
                                        <div class="preview-placeholder text-muted small text-center">Click <strong>Show Config Preview</strong> to try simple toggles.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step: Wrap Up -->
                <div class="tutorial-step d-none" id="step-6">
                    <div class="card shadow">
                        <div class="card-header bg-dark text-white"><h5 class="mb-0"><span class="badge bg-light text-dark me-2">6</span>You're Ready!</h5></div>
                        <div class="card-body p-4">
                            <h6>Next Steps</h6>
                            <p class="small">You're all set. Use the links below to jump to real pages and keep practicing with the tutorial whenever you need a refresher.</p>
                            <div class="d-flex gap-2 mt-3">
                                <a href="{{ url_for('scouting.scouting_form') }}" class="btn btn-success btn-sm">Start Scouting</a>
                                <a href="{{ url_for('graphs.index') }}" class="btn btn-warning btn-sm">Explore Analytics</a>
                                <a href="{{ url_for('main.config') }}" class="btn btn-info btn-sm">Open Configuration</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Step 3: Scouting -->
                <div class="tutorial-step d-none" id="step-3">
                    <div class="card shadow">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <span class="badge bg-light text-success me-2">3</span>
                                Scouting Matches
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <h6>How to Scout a Match</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <ol>
                                        <li><strong>Go to Scouting:</strong> Click "Match Scouting" in the navigation</li>
                                        <li><strong>Select Match:</strong> Choose the match you're observing</li>
                                        <li><strong>Pick Team:</strong> Select which team you'll be scouting</li>
                                        <li><strong>Record Data:</strong> Fill in the scouting form during the match</li>
                                        <li><strong>Submit:</strong> Save your data when the match ends</li>
                                    </ol>
                                    
                                    <h6 class="mt-4">Match Phases</h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <span class="badge bg-primary">Autonomous</span>
                                            <p class="small text-muted mb-0">First 15 seconds</p>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <span class="badge bg-info">Teleop</span>
                                            <p class="small text-muted mb-0">Main 2:15 period</p>
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <span class="badge bg-warning">Endgame</span>
                                            <p class="small text-muted mb-0">Final 30 seconds</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- Live Demo: Scouting -->
                                    <div class="card border-success h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <div><i class="fas fa-clipboard-list text-success me-2"></i>Try Scouting Live</div>
                                            <a id="scoutOpenBtn" class="btn btn-sm btn-outline-secondary" href="#" target="_blank" rel="noopener">
                                                <i class="fas fa-up-right-from-square me-1"></i>Open in new tab
                                            </a>
                                        </div>
                                        <div class="card-body">
                                            <!-- Scouting Instructions -->
                                            <div class="alert alert-light border-success mb-3">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-play-circle text-success me-2 fa-lg mt-1"></i>
                                                    <div>
                                                        <strong> Your Task:</strong> Try entering sample match data!
                                                        <ol class="small mb-0 mt-1">
                                                            <li>Click <span class="highlight-hint">Match Scouting</span> below</li>
                                                            <li>Select any team and match</li>
                                                            <li>Fill in some scoring data</li>
                                                            <li>Submit to see it in analytics</li>
                                                        </ol>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="scoutDemoButtons" class="btn-group flex-wrap mb-3" role="group">
                                                <button type="button" class="btn btn-outline-success btn-sm me-1 demo-highlight" data-url="{{ url_for('scouting.scouting_form') }}"
                                                        data-hint="Start here! This is where you record what happens during matches.">Match Scouting</button>
                                                <button type="button" class="btn btn-outline-primary btn-sm me-1" data-url="{{ url_for('pit_scouting.index') }}"
                                                        data-hint="Record robot specifications and team interview data.">Pit Scouting</button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" data-url="{{ url_for('scouting.index') }}"
                                                        data-hint="Overview of your scouting assignments and recent data.">Scouting Dashboard</button>
                                            </div>
                                            
                                            <!-- Dynamic Hint Display -->
                                            <div id="scoutHintDisplay" class="alert alert-info mb-3 d-none">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <span id="scoutHintText">Hover over buttons to learn more!</span>
                                            </div>
                                            
                                            <div class="border rounded bg-body-secondary demo-frame demo-frame-large">
                                                <div id="scoutDemoPreview" class="demo-preview p-3">
                                                    <div class="preview-placeholder text-center text-muted">
                                                        Try filling a small sample scouting form here. Use the buttons above to pick the area to preview, or open the full form in a new tab.
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-text mt-2">
                                                <strong> Pro Tip:</strong> Use the sample form to practice; full data entry is available on the real scouting pages.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Analytics -->
                <div class="tutorial-step d-none" id="step-4">
                    <div class="card shadow">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <span class="badge bg-light text-warning me-2">4</span>
                                Data Analysis
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <h6>Analyzing Your Data</h6>
                            <div class="row g-3">
                                <div class="col-lg-5">
                                    <div class="card border-primary mb-3">
                                        <div class="card-body">
                                            <h6><i class="fas fa-chart-bar text-primary me-2"></i>Graphs</h6>
                                            <ul class="small">
                                                <li>Team performance over time</li>
                                                <li>Scoring averages by game piece</li>
                                                <li>Autonomous success rates</li>
                                                <li>Custom comparisons</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="card border-success">
                                        <div class="card-body">
                                            <h6><i class="fas fa-trophy text-success me-2"></i>Rankings</h6>
                                            <ul class="small">
                                                <li>Teams ranked by metrics</li>
                                                <li>Filter by capabilities</li>
                                                <li>Alliance selection insights</li>
                                                <li>Export to Excel</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-share-alt me-2"></i>
                                        <strong>Sharing:</strong> You can share graphs and rankings with your team using public links!
                                    </div>
                                </div>
                                <div class="col-lg-7">
                                    <!-- Live Demo: Analytics -->
                                    <div class="card border-warning h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <div><i class="fas fa-chart-line text-warning me-2"></i>Try Analytics Live</div>
                                            <a id="analyticsOpenBtn" class="btn btn-sm btn-outline-secondary" href="#" target="_blank" rel="noopener">
                                                <i class="fas fa-up-right-from-square me-1"></i>Open in new tab
                                            </a>
                                        </div>
                                        <div class="card-body">
                                            <!-- Analytics Instructions -->
                                            <div class="alert alert-light border-warning mb-3">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-chart-bar text-warning me-2 fa-lg mt-1"></i>
                                                    <div>
                                                        <strong> Explore Analytics:</strong> See your data come to life!
                                                        <div class="small mt-1">
                                                            Try: <span class="highlight-hint">Graphs</span> → Select teams → View performance charts
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="analyticsDemoButtons" class="btn-group flex-wrap mb-3" role="group">
                                                <button type="button" class="btn btn-outline-warning btn-sm me-1 demo-highlight" data-url="{{ url_for('graphs.index') }}"
                                                        data-hint="Start here! Create visual charts of team performance and trends.">Graphs</button>
                                                <button type="button" class="btn btn-outline-purple btn-sm me-1" data-url="{{ url_for('teams.ranks') }}"
                                                        data-hint="See which teams are ranked highest based on your data.">Team Rankings</button>
                                                <button type="button" class="btn btn-outline-primary btn-sm me-1" data-url="{{ url_for('teams.index') }}"
                                                        data-hint="Browse individual team profiles and detailed statistics.">Teams</button>
                                                <button type="button" class="btn btn-outline-info btn-sm me-1" data-url="{{ url_for('alliances.index') }}"
                                                        data-hint="Plan your strategy for alliance selection in playoffs.">Alliances</button>
                                                <button type="button" class="btn btn-outline-danger btn-sm me-1" data-url="{{ url_for('matches.index') }}"
                                                        data-hint="View match results, schedules, and predictions.">Matches</button>
                                            </div>
                                            
                                            <!-- Dynamic Hint Display -->
                                            <div id="analyticsHintDisplay" class="alert alert-info mb-3 d-none">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <span id="analyticsHintText">Hover over buttons to learn what each tool does!</span>
                                            </div>
                                            
                                            <div class="border rounded bg-body-secondary demo-frame demo-frame-large">
                                                <div id="analyticsDemoPreview" class="demo-preview p-3">
                                                    <div class="preview-placeholder text-center text-muted">Preview charts and filters will appear here when you select a demo option.</div>
                                                </div>
                                            </div>
                                            <div class="form-text mt-2">
                                                <strong> Try This:</strong> Use the preview to see example charts. Open the full analytics page to interact with filters and team selectors.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Configuration -->
                <div class="tutorial-step d-none" id="step-5">
                    <div class="card shadow">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <span class="badge bg-light text-warning me-2">5</span>
                                Configuration & Customization
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <h6><i class="fas fa-cogs text-warning me-2"></i>System Configuration</h6>
                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <div class="card border-primary mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-gamepad text-primary me-2"></i>Game Settings</h6>
                                            <ul class="small">
                                                <li><strong>Scoring Elements:</strong> Configure game pieces and points</li>
                                                <li><strong>Match Phases:</strong> Set autonomous and endgame timers</li>
                                                <li><strong>Custom Fields:</strong> Add team-specific tracking</li>
                                                <li><strong>Field Layout:</strong> Adapt to yearly game changes</li>
                                                <li><strong>Validation Rules:</strong> Prevent invalid data entry</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="card border-success mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-calendar text-success me-2"></i>Event Setup</h6>
                                            <ul class="small">
                                                <li><strong>Event Selection:</strong> Connect to FRC events API</li>
                                                <li><strong>Team Lists:</strong> Auto-import participating teams</li>
                                                <li><strong>Match Schedules:</strong> Sync qualification matches</li>
                                                <li><strong>Alliance Data:</strong> Real-time playoff brackets</li>
                                                <li><strong>Pit Assignments:</strong> Track team locations</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-tools me-2"></i>
                                        <strong>Configuration Access:</strong> Some settings require appropriate user permissions. Contact your team's system administrator for access to advanced configurations.
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <!-- Live Demo: Configuration -->
                                    <div class="card border-info h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <div><i class="fas fa-sliders text-info me-2"></i>Try Configuration Live</div>
                                            <a id="configOpenBtn" class="btn btn-sm btn-outline-secondary" href="#" target="_blank" rel="noopener">
                                                <i class="fas fa-up-right-from-square me-1"></i>Open in new tab
                                            </a>
                                        </div>
                                        <div class="card-body">
                                            <!-- Configuration Instructions -->
                                            <div class="alert alert-light border-info mb-3">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-cogs text-info me-2 fa-lg mt-1"></i>
                                                    <div>
                                                        <strong>️ Customize Your Setup:</strong> 
                                                        <div class="small mt-1">
                                                            Start with <span class="highlight-hint">Game Config</span> to set up scoring for your season!
                                                        </div>
                                                        <div class="small text-muted">
                                                            <i class="fas fa-lock me-1"></i>Admin permissions may be required
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div id="configDemoButtons" class="btn-group flex-wrap mb-3" role="group">
                                                <button type="button" class="btn btn-outline-primary btn-sm me-1 demo-highlight" data-url="{{ url_for('main.config') }}"
                                                        data-hint="Configure game elements, scoring, and match phases for your season.">Game Config</button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm me-1" data-url="{{ url_for('setup.system_check') }}"
                                                        data-hint="Check your system health, database status, and configuration files.">System Check</button>
                                                <button type="button" class="btn btn-outline-warning btn-sm" data-url="{{ url_for('setup.features') }}"
                                                        data-hint="Overview of all ObsidianScout features and capabilities.">Features</button>
                                            </div>
                                            
                                            <!-- Dynamic Hint Display -->
                                            <div id="configHintDisplay" class="alert alert-info mb-3 d-none">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <span id="configHintText">Hover over buttons to see what each configuration area covers!</span>
                                            </div>
                                            
                                            <div class="border rounded bg-body-secondary demo-frame demo-frame-large">
                                                <div id="configDemoPreview" class="demo-preview p-3">
                                                    <div class="preview-placeholder text-center text-muted">Configuration previews will appear here. Use the buttons to explore settings topics or open the full page to make changes.</div>
                                                </div>
                                            </div>
                                            <div class="form-text mt-2">
                                                <strong>️ Note:</strong> Some configuration options require admin permissions for your team. Open the full configuration page to make changes.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 6: User Roles -->
                <div class="tutorial-step d-none" id="step-6">
                    <div class="card shadow">
                        <div class="card-header bg-purple text-white">
                            <h5 class="mb-0">
                                <span class="badge bg-light text-purple me-2">6</span>
                                User Roles & Permissions
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <h6>Understanding User Roles</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card border-warning h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user-cog fa-2x text-warning mb-2"></i>
                                            <h6>Admin</h6>
                                            <ul class="list-unstyled small">
                                                <li> Game settings</li>
                                                <li> Team preferences</li>
                                                <li> Event setup</li>
                                                <li> Theme customization</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card border-info h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                            <h6>Analytics</h6>
                                            <ul class="list-unstyled small">
                                                <li> View all data</li>
                                                <li> Create graphs</li>
                                                <li> Team rankings</li>
                                                <li> User management</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card border-success h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-clipboard-list fa-2x text-success mb-2"></i>
                                            <h6>Scout</h6>
                                            <ul class="list-unstyled small">
                                                <li> Enter match data</li>
                                                <li> Pit scouting</li>
                                                <li> Analytics</li>
                                                <li> Configuration</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 7: Tips -->
                <div class="tutorial-step d-none" id="step-7">
                    <div class="card shadow">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">
                                <span class="badge bg-light text-dark me-2">7</span>
                                Pro Tips & Best Practices
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-lightbulb text-warning me-2"></i>Scouting Tips</h6>
                                    <ul class="small">
                                        <li>Practice using the form before competition</li>
                                        <li>Focus on one robot at a time</li>
                                        <li>Use the notes field for special observations</li>
                                        <li>Don't worry about perfect data - consistency matters more</li>
                                    </ul>
                                    
                                    <h6 class="mt-3"><i class="fas fa-mobile-alt text-info me-2"></i>Device Tips</h6>
                                    <ul class="small">
                                        <li>Works on phones, tablets, and computers</li>
                                        <li>Data saves automatically as you type</li>
                                        <li>Can work offline (syncs when connected)</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-users text-success me-2"></i>Team Collaboration</h6>
                                    <ul class="small">
                                        <li>Share analysis graphs with your team</li>
                                        <li>Use rankings for alliance selection</li>
                                        <li>Export data to spreadsheets if needed</li>
                                        <li>Multiple scouts can work simultaneously</li>
                                    </ul>
                                    
                                    <h6 class="mt-3"><i class="fas fa-cog text-warning me-2"></i>Configuration</h6>
                                    <ul class="small">
                                        <li>Customize game scoring elements for each season</li>
                                        <li>Adjust scouting forms and data fields</li>
                                        <li>Set up API connections for event data</li>
                                        <li>Configure themes and display preferences</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="alert alert-success mt-3">
                                <i class="fas fa-rocket me-2"></i>
                                <strong>Ready to start?</strong> You now know the basics of ObsidianScout. Jump in and start scouting!
                            </div>
                            
                            <!-- Final Call-to-Action -->
                            <div class="card border-success mt-4">
                                <div class="card-header bg-success text-white">
                                    <i class="fas fa-flag-checkered me-2"></i>You're Ready to Scout!
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h6> Next Steps:</h6>
                                            <ol>
                                                <li><strong>Start with the Dashboard</strong> - Get familiar with the layout</li>
                                                <li><strong>Try Match Scouting</strong> - Enter some practice data</li>
                                                <li><strong>Explore Analytics</strong> - See your data visualized</li>
                                                <li><strong>Customize Settings</strong> - Configure for your team's needs</li>
                                            </ol>
                                            
                                            <div class="alert alert-light border-success mt-3">
                                                <i class="fas fa-users me-2 text-success"></i>
                                                <strong>Team Tip:</strong> Get your whole scouting team to go through this tutorial together!
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <div class="p-3">
                                                <i class="fas fa-trophy fa-4x text-warning mb-3"></i>
                                                <h6 class="text-success">Tutorial Complete!</h6>
                                                <p class="small text-muted">You're now ready to use ObsidianScout effectively</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tutorial Controls -->
            <div class="card mt-4">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <button id="t-prev-btn" class="btn btn-secondary" onclick="previousTStep()" disabled>
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                    </div>

                    <div class="text-center">
                        <span id="t-step-indicator" class="text-muted">Step 1</span>
                    </div>

                    <div>
                        <button id="t-next-btn" class="btn btn-primary" onclick="nextTStep()">Next<i class="fas fa-arrow-right ms-2"></i></button>
                        <a href="{{ url_for('main.index') }}" id="t-finish-btn" class="btn btn-success" style="display:none;"><i class="fas fa-check me-2"></i>Finish</a>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="progress">
                        <div id="t-progress-bar" class="progress-bar bg-success" style="width: 16.66%"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Quick Actions</h6>
                            <a href="{{ url_for('setup.index') }}" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="fas fa-home me-1"></i>Setup Home
                            </a>
                            <a href="{{ url_for('main.help_page') }}" class="btn btn-outline-info btn-sm me-2">
                                <i class="fas fa-question-circle me-1"></i>Help Center
                            </a>
                            <a href="{{ url_for('setup.features') }}" class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-star me-1"></i>Features Overview
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js (used for analytics preview) -->
<script src="{{ url_for('static', filename='js/vendor/chart.umd.min.js') }}"></script>
<script>
// Data provided from server
const DEFAULT_TUTORIAL_CONFIG = {{ default_config|tojson|safe }};
const TEAM_TUTORIAL_CONFIG = {{ team_config|tojson|safe }};
const SAMPLE_CHART = {{ sample_chart|tojson|safe }};

// Guided/Compact tutorial controller
let tutorialMode = 'guided'; // 'guided' or 'compact'
let currentTStep = 1;
let steps = ['intro','basic','practice','analytics','config','wrap'];

function setMode(mode) {
    tutorialMode = mode;
    document.getElementById('mode-guided').classList.toggle('active', mode === 'guided');
    document.getElementById('mode-compact').classList.toggle('active', mode === 'compact');
    document.getElementById('mode-guided').setAttribute('aria-pressed', mode === 'guided');
    document.getElementById('mode-compact').setAttribute('aria-pressed', mode === 'compact');

    if (mode === 'compact') {
        steps = ['intro','basic','analytics','wrap'];
    } else {
        steps = ['intro','basic','practice','analytics','config','wrap'];
    }
    currentTStep = 1;
    showTStep(currentTStep);
}

function showTStep(index) {
    // hide all existing step cards
    document.querySelectorAll('.tutorial-step').forEach(el => el.classList.add('d-none'));

    // map our step names to card ids
    const stepName = steps[index-1];
    const mapping = {
        'intro': 'step-1',
        'basic': 'step-2',
        'practice': 'step-3',
        'analytics': 'step-4',
        'config': 'step-5',
        'wrap': 'step-6'
    };
    const el = document.getElementById(mapping[stepName]);
    if (el) {
        el.classList.remove('d-none');
        el.classList.add('active-step');
    }

    // update controls
    document.getElementById('t-prev-btn').disabled = (index === 1);
    document.getElementById('t-next-btn').style.display = (index === steps.length) ? 'none' : 'inline-block';
    document.getElementById('t-finish-btn').style.display = (index === steps.length) ? 'inline-block' : 'none';

    // indicator
    document.getElementById('t-step-indicator').textContent = `Step ${index} of ${steps.length}`;

    // progress
    document.getElementById('t-progress-bar').style.width = ((index / steps.length) * 100) + '%';
}

function nextTStep() {
    if (currentTStep < steps.length) { currentTStep++; showTStep(currentTStep); }
}
function previousTStep() { if (currentTStep > 1) { currentTStep--; showTStep(currentTStep); } }

// Simple helper to show previews in lightweight panels (no iframes)
function initPreview(id, defaultUrl, sampleBtnId) {
    const container = document.getElementById(id);
    const sampleBtn = document.getElementById(sampleBtnId);

    function renderPreview(type) {
        if (!container) return;
        if (type === 'scouting') {
            // Build a sample form based on TEAM_TUTORIAL_CONFIG (if present)
            let html = '<h6 class="mb-2"><i class="fas fa-clipboard-list text-success me-2"></i>Scouting Sample</h6>';
            html += '<form class="preview-sample" aria-label="Scouting sample form">';
            html += '<input class="form-control form-control-sm mb-2" placeholder="Team #" aria-label="Team number">';
            html += '<input class="form-control form-control-sm mb-2" placeholder="Match #" aria-label="Match number">';

            function addElementInput(el) {
                // Normalize id/name and ensure it's a valid id attribute
                const rawId = (el.id || el.name || 'field').toString();
                const id = rawId.replace(/[^a-zA-Z0-9_\-]/g, '_');
                const label = el.label || el.name || rawId;
                const type = (el.type || 'number');
                const inputId = `preview_${id}`;

                if (type === 'bool' || type === 'checkbox') {
                    return `<div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox" id="${inputId}" name="${inputId}"> <label class="form-check-label small" for="${inputId}">${label}</label></div>`;
                }

                // Render counters like the real scouting form when numeric or explicit counter
                const numericTypes = ['number','counter','int','float','numeric','count','counts','score','quantity'];
                const isNumeric = numericTypes.includes(String(type).toLowerCase()) || (el.default !== undefined && typeof el.default === 'number');
                if (isNumeric) {
                    const step = (el.step !== undefined) ? el.step : (String(type).toLowerCase() === 'float' ? 0.1 : 1);
                    const minAttr = (el.min !== undefined) ? `min="${el.min}"` : 'min="0"';
                    const value = (el.default !== undefined) ? el.default : 0;
                    return `<div class="mb-2"><label for="${inputId}" class="form-label fw-medium">${label}</label>` +
                           `${ el.description ? `<small class="text-muted d-block mb-2">${el.description}</small>` : '' }` +
                           `<div class="counter-container" role="group" aria-label="${label} counter">` +
                           `<button type="button" class="btn btn-lg btn-outline-danger btn-counter btn-decrement" data-target="${inputId}" data-step="${step}" aria-label="Decrease ${label}"><i class="fas fa-minus" aria-hidden="true"></i></button>` +
                           `<input id="${inputId}" name="${inputId}" class="form-control counter-input text-center" value="${value}" type="number" step="${step}" ${minAttr}>` +
                           `<button type="button" class="btn btn-lg btn-outline-success btn-counter btn-increment" data-target="${inputId}" data-step="${step}" aria-label="Increase ${label}"><i class="fas fa-plus" aria-hidden="true"></i></button>` +
                           `</div></div>`;
                }

                return `<div class="mb-2"><label class="small d-block mb-1" for="${inputId}">${label}</label><input id="${inputId}" name="${inputId}" class="form-control form-control-sm" placeholder="${label}" data-field="${id}" tabindex="0"></div>`;
            }

            // prefer auto/teleop/endgame periods if available
            const cfg = (typeof TEAM_TUTORIAL_CONFIG !== 'undefined' && TEAM_TUTORIAL_CONFIG) ? TEAM_TUTORIAL_CONFIG : DEFAULT_TUTORIAL_CONFIG;
            if (cfg && (cfg.auto_period || cfg.teleop_period || cfg.endgame_period)) {
                ['auto_period','teleop_period','endgame_period'].forEach(period => {
                    const p = cfg[period];
                    if (p && Array.isArray(p.scoring_elements)) {
                        html += `<div class="mb-2"><strong class="small text-muted">${period.replace('_',' ')}:</strong></div>`;
                        p.scoring_elements.forEach(el => { html += addElementInput(el); });
                    }
                });
            } else if (cfg && Array.isArray(cfg.scoring_elements)) {
                cfg.scoring_elements.forEach(el => { html += addElementInput(el); });
            } else {
                // fallback simple notes field
                html += '<textarea class="form-control form-control-sm mb-2" rows="3" placeholder="Notes"></textarea>';
            }

            html += '<div class="d-flex justify-content-between"><button type="button" class="btn btn-sm btn-success" id="preview-scout-save">Save Sample</button><small class="text-muted align-self-center">Preview only — not saved</small></div>';
            html += '<div id="preview-scout-feedback" class="mt-2" aria-live="polite"></div>';
            html += '</form>';
            container.innerHTML = html;
            // Retheme any newly-inserted controls (selects, inputs, charts)
            setTimeout(() => { try { if (window.updateSelect2DarkMode) window.updateSelect2DarkMode(); if (window.updateChartJsTheme) window.updateChartJsTheme(); } catch(e) { } }, 20);
        } else if (type === 'analytics') {
            container.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0"><i class="fas fa-chart-bar text-warning me-2"></i>Analytics Sample</h6>
                    <div class="d-flex gap-2 align-items-center">
                        <label class="small mb-0">Chart type</label>
                        <select id="chartTypeSelect" class="form-select form-select-sm" style="width:130px;">
                            <option value="line">Line</option>
                            <option value="bar">Bar</option>
                            <option value="radar">Radar</option>
                        </select>
                    </div>
                </div>
                <canvas id="analyticsChart" aria-label="Sample analytics chart"></canvas>
                <div class="mt-2 small text-muted">Open the full page to interact with filters and team selectors.</div>`;

            // instantiate chart after insertion
            setTimeout(() => {
                try {
                    const ctx = document.getElementById('analyticsChart').getContext('2d');
                    // Clean up any existing chart on this canvas
                    if (window._tutorialChart) {
                        window._tutorialChart.destroy();
                    }
                    const cfg = {
                        type: document.getElementById('chartTypeSelect').value || 'line',
                        data: SAMPLE_CHART,
                        options: { responsive: true, maintainAspectRatio: true }
                    };
                    // ensure canvas has a constrained height so it doesn't push the page indefinitely
                    try { document.getElementById('analyticsChart').style.height = '180px'; document.getElementById('analyticsChart').style.maxHeight = '360px'; } catch(e) {}
                    window._tutorialChart = new Chart(ctx, cfg);
                    // Apply theme immediately (in case dark mode is already active)
                    try { if (window.updateChartJsTheme) window.updateChartJsTheme(); } catch(e) { console.warn('Immediate chart theme update failed', e); }

                    document.getElementById('chartTypeSelect').addEventListener('change', (e) => {
                        const newType = e.target.value;
                        if (window._tutorialChart) {
                            window._tutorialChart.config.type = newType;
                            window._tutorialChart.update();
                        }
                    });
                } catch (e) {
                    console.warn('Chart init failed', e);
                }
            }, 20);

        } else if (type === 'config') {
            const defaultJson = (typeof DEFAULT_TUTORIAL_CONFIG !== 'undefined') ? JSON.stringify(DEFAULT_TUTORIAL_CONFIG, null, 2) : '{}';
            container.innerHTML = `
                <h6 class="mb-2"><i class="fas fa-cogs text-info me-2"></i>Configuration Sample</h6>
                <div class="mb-2 d-flex gap-2">
                    <button id="preview-load-default" class="btn btn-sm btn-outline-primary">Load Team Config</button>
                    <button id="preview-show-form" class="btn btn-sm btn-outline-secondary">Show Form</button>
                    <button id="preview-config-save" class="btn btn-sm btn-info">Save Sample</button>
                    <button id="preview-config-reset" class="btn btn-sm btn-outline-warning">Reset</button>
                </div>
                <div id="configFormPreview" class="mb-2"></div>
                <textarea id="configJsonPreview" class="form-control" rows="8" style="max-height:260px;overflow:auto;">${defaultJson}</textarea>
                <div class="mt-2 small text-muted">Use <strong>Show Form</strong> to view interactive fields generated from the JSON (preview-only).</div>
                <div id="preview-config-feedback" class="mt-2" aria-live="polite"></div>`;

            // Auto-load the team/default config into the preview when the panel is rendered
            (async function autoLoadConfig(){
                const ta = document.getElementById('configJsonPreview');
                const fb = document.getElementById('preview-config-feedback');
                try {
                    // Prefer injected team config if present
                    if (typeof TEAM_TUTORIAL_CONFIG !== 'undefined' && TEAM_TUTORIAL_CONFIG && Object.keys(TEAM_TUTORIAL_CONFIG).length) {
                        if (ta) ta.value = JSON.stringify(TEAM_TUTORIAL_CONFIG, null, 2);
                        renderFormFromJson(TEAM_TUTORIAL_CONFIG);
                        if (fb) fb.innerHTML = '<div class="alert alert-success py-1 px-2">Team config loaded (preview)</div>';
                        setTimeout(()=>{ if (fb) fb.innerHTML=''; }, 1500);
                        return;
                    }

                    // Fallback: fetch from server endpoint
                    const resp = await fetch('{{ url_for('setup.tutorial_team_config') }}', { credentials: 'same-origin' });
                    if (resp.ok) {
                        const data = await resp.json();
                        if (ta) ta.value = JSON.stringify(data || {}, null, 2);
                        renderFormFromJson(data || {});
                        if (fb) fb.innerHTML = '<div class="alert alert-success py-1 px-2">Team config loaded (preview)</div>';
                        setTimeout(()=>{ if (fb) fb.innerHTML=''; }, 1500);
                    } else {
                        // use default config as last resort
                        if (ta) ta.value = defaultJson;
                    }
                } catch (e) {
                    console.warn('Auto-load config failed for tutorial preview', e);
                    if (ta) ta.value = defaultJson;
                }
            })();

            // Move focus to the JSON editor to make it obvious content loaded
            setTimeout(()=>{ try { document.getElementById('configJsonPreview')?.focus(); } catch(e){} }, 50);

            // Retheme newly-added preview controls in case dark mode is active
            setTimeout(() => { try { if (window.updateSelect2DarkMode) window.updateSelect2DarkMode(); if (window.updateChartJsTheme) window.updateChartJsTheme(); } catch(e) { } }, 20);

            function createFieldInput(el) {
                const rawId = (el.id || el.name || 'field').toString();
                const fid = rawId.replace(/[^a-zA-Z0-9_\-]/g, '_');
                const label = el.label || el.name || rawId;
                const type = (el.type || el.input_type || el.datatype || 'number');

                if (Array.isArray(el.options) && el.options.length) {
                    let optionsHtml = '';
                    el.options.forEach(opt => {
                        const val = (typeof opt === 'object') ? (opt.value ?? opt) : opt;
                        const lab = (typeof opt === 'object') ? (opt.label ?? opt.value ?? opt) : opt;
                        const selected = (el.default !== undefined && String(el.default) === String(val)) ? ' selected' : '';
                        optionsHtml += `<option value="${String(val)}"${selected}>${String(lab)}</option>`;
                    });
                    return `<div class="mb-2"><label class="small d-block mb-1">${label}</label><select id="cfg_${fid}" class="form-select form-select-sm">${optionsHtml}</select></div>`;
                }

                // Treat numeric types as counters by default (better UX)
                const isNumericType = ['number','int','float','numeric'].includes(String(type).toLowerCase()) || (typeof el.default === 'number');
                if (type === 'counter' || fid.toLowerCase().includes('count') || fid.toLowerCase().includes('counter') || isNumericType) {
                    const step = (el.step !== undefined) ? el.step : (type === 'float' ? 0.1 : 1);
                    const minAttr = (el.min !== undefined) ? `min="${el.min}"` : '';
                    const maxAttr = (el.max !== undefined) ? `max="${el.max}"` : '';
                    const defaultVal = (el.default !== undefined) ? el.default : 0;
                    return `<div class="mb-2"><label class="small d-block mb-1">${label}</label><div class="input-group input-group-sm"><button type="button" class="btn btn-sm btn-outline-secondary cfg-decr" data-step="${step}" data-target="cfg_${fid}">-</button><input id="cfg_${fid}" class="form-control form-control-sm text-center" value="${defaultVal}" type="number" step="${step}" ${minAttr} ${maxAttr}><button type="button" class="btn btn-sm btn-outline-secondary cfg-incr" data-step="${step}" data-target="cfg_${fid}">+</button></div></div>`;
                }

                if (type === 'bool' || type === 'checkbox' || type === 'switch') {
                    const checked = el.default ? 'checked' : '';
                    return `<div class="form-check form-switch mb-2"><input id="cfg_${fid}" class="form-check-input" type="checkbox" ${checked}><label class="form-check-label small" for="cfg_${fid}">${label}</label></div>`;
                }

                // fallback: text/number
                const inputType = (type === 'number' || type === 'int' || type === 'float') ? 'number' : 'text';
                const defaultVal = el.default ?? '';
                return `<div class="mb-2"><label class="small d-block mb-1">${label}</label><input id="cfg_${fid}" class="form-control form-control-sm" value="${String(defaultVal)}" type="${inputType}"></div>`;
            }

            function renderFormFromJson(jsonObj) {
                const target = document.getElementById('configFormPreview');
                if (!target) return;
                target.innerHTML = '';
                // find scoring elements in common places
                let elems = [];
                ['auto_period','teleop_period','endgame_period'].forEach(p => {
                    if (jsonObj && jsonObj[p] && Array.isArray(jsonObj[p].scoring_elements)) {
                        elems = elems.concat(jsonObj[p].scoring_elements);
                    }
                });
                if (elems.length === 0 && Array.isArray(jsonObj.scoring_elements)) elems = jsonObj.scoring_elements;

                if (elems.length === 0) {
                    // Try additional common locations for fields
                    if (jsonObj.scouting_form && Array.isArray(jsonObj.scouting_form.sections)) {
                        jsonObj.scouting_form.sections.forEach(s => { if (Array.isArray(s.elements)) elems = elems.concat(s.elements); });
                    }
                    if (jsonObj.form && Array.isArray(jsonObj.form.scoring_elements)) elems = elems.concat(jsonObj.form.scoring_elements);
                    if (jsonObj.pit_scouting && Array.isArray(jsonObj.pit_scouting.sections)) {
                        jsonObj.pit_scouting.sections.forEach(s => { if (Array.isArray(s.elements)) elems = elems.concat(s.elements); });
                    }
                }

                if (elems.length === 0) {
                    // As a fallback, render simple inputs for top-level primitive keys so users can see something
                    const fb = document.getElementById('preview-config-feedback');
                    let fallbackHtml = '<div class="small text-muted">No configurable scoring elements found. Showing top-level keys below for preview:</div>';
                    fallbackHtml += '<div class="mt-2">';
                    Object.keys(jsonObj || {}).forEach(k => {
                        const v = jsonObj[k];
                        if (typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean') {
                            const inpType = (typeof v === 'number') ? 'number' : 'text';
                            fallbackHtml += `<div class="mb-2"><label class="small d-block mb-1">${k}</label><input class="form-control form-control-sm" value="${String(v)}" type="${inpType}"></div>`;
                        }
                    });
                    fallbackHtml += '</div>';
                    target.innerHTML = fallbackHtml;
                    if (fb) fb.innerHTML = '<div class="alert alert-info py-1 px-2">Config loaded (preview) — no scoring elements found, showing top-level keys.</div>';
                    setTimeout(()=>{ if (fb) fb.innerHTML=''; }, 3000);
                    return;
                }

                elems.forEach(el => {
                    const html = createFieldInput(el);
                    target.insertAdjacentHTML('beforeend', html);
                });

                // Add handlers for +/- buttons
                target.querySelectorAll('.cfg-incr').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tid = btn.getAttribute('data-target');
                        const step = parseFloat(btn.getAttribute('data-step') || '1');
                        const inp = document.getElementById(tid);
                        if (inp) {
                            const cur = inp.value === '' ? 0 : Number(inp.value);
                            const next = ((Math.round((cur + step) / step) * step) + 0) ;
                            inp.value = Number((cur + step).toFixed( (String(step).includes('.') ? step.toString().split('.')[1].length : 0)));
                            updateJsonFromForm();
                        }
                    });
                });
                target.querySelectorAll('.cfg-decr').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tid = btn.getAttribute('data-target');
                        const step = parseFloat(btn.getAttribute('data-step') || '1');
                        const inp = document.getElementById(tid);
                        if (inp) {
                            const cur = inp.value === '' ? 0 : Number(inp.value);
                            const next = cur - step;
                            inp.value = Number(Math.max((inp.min ? Number(inp.min) : -Infinity), next).toFixed( (String(step).includes('.') ? step.toString().split('.')[1].length : 0)));
                            updateJsonFromForm();
                        }
                    });
                });

                // Sync changes back to JSON textarea
                target.querySelectorAll('input,textarea,select').forEach(el => {
                    el.addEventListener('change', updateJsonFromForm);
                    el.addEventListener('input', updateJsonFromForm);
                });
            }

            function updateJsonFromForm() {
                const ta = document.getElementById('configJsonPreview');
                const target = document.getElementById('configFormPreview');
                if (!ta || !target) return;
                const values = {};
                target.querySelectorAll('input,select,textarea').forEach(el => {
                    const key = el.id ? el.id.replace(/^cfg_/, '') : (el.dataset.field || el.name || el.placeholder || 'field');
                    let val;
                    if (el.type === 'checkbox') val = el.checked;
                    else if (el.type === 'number') val = (el.value === '' ? null : Number(el.value));
                    else val = el.value;
                    values[key] = val;
                });
                // For demo purposes, we just show a mapping of values
                ta.value = JSON.stringify({ preview_values: values }, null, 2);
            }

            // load team default into the preview when requested
            setTimeout(() => {
                const loadBtn = document.getElementById('preview-load-default');
                const showFormBtn = document.getElementById('preview-show-form');
                const resetBtn = document.getElementById('preview-config-reset');
                if (loadBtn) {
                    loadBtn.addEventListener('click', async () => {
                        const ta = document.getElementById('configJsonPreview');
                        // If we already have a team config in JS, use it first
                        if (typeof TEAM_TUTORIAL_CONFIG !== 'undefined' && TEAM_TUTORIAL_CONFIG && Object.keys(TEAM_TUTORIAL_CONFIG).length) {
                            if (ta) ta.value = JSON.stringify(TEAM_TUTORIAL_CONFIG, null, 2);
                            renderFormFromJson(TEAM_TUTORIAL_CONFIG);
                            const fb = document.getElementById('preview-config-feedback'); if (fb) fb.innerHTML = '<div class="alert alert-success py-1 px-2">Team config loaded (preview)</div>'; setTimeout(()=>{ if (fb) fb.innerHTML=''; }, 1800);
                            return;
                        }

                        // Otherwise fetch from server endpoint
                        try {
                            const resp = await fetch('{{ url_for('setup.tutorial_team_config') }}', { credentials: 'same-origin' });
                            if (!resp.ok) throw new Error('Network response not ok');
                            const data = await resp.json();
                            if (ta) ta.value = JSON.stringify(data || {}, null, 2);
                            renderFormFromJson(data || {});
                            const fb = document.getElementById('preview-config-feedback'); if (fb) fb.innerHTML = '<div class="alert alert-success py-1 px-2">Team config loaded (preview)</div>'; setTimeout(()=>{ if (fb) fb.innerHTML=''; }, 1800);
                        } catch (e) {
                            console.warn('Failed to fetch team config for tutorial:', e);
                            if (ta) ta.value = defaultJson;
                            // show a gentle user-visible message
                            const fb = document.getElementById('preview-config-feedback');
                            if (fb) fb.innerHTML = '<div class="alert alert-warning py-1 px-2">Unable to load team config (preview). Using default.</div>';
                            setTimeout(()=>{ if (fb) fb.innerHTML = ''; }, 2500);
                        }
                    });
                }
                if (showFormBtn) {
                    showFormBtn.addEventListener('click', () => {
                        const ta = document.getElementById('configJsonPreview');
                        try {
                            const data = JSON.parse(ta.value || '{}');
                            renderFormFromJson(data);
                            // Scroll to and highlight the rendered form
                            const target = document.getElementById('configFormPreview');
                            if (target) { try { target.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e) { target.scrollIntoView(); } target.classList.add('tutorial-highlight'); setTimeout(()=>target.classList.remove('tutorial-highlight'), 2200); }
                        } catch (e) {
                            const fb = document.getElementById('preview-config-feedback');
                            if (fb) fb.innerHTML = '<div class="alert alert-danger py-1 px-2">Invalid JSON - cannot render form</div>';
                            setTimeout(()=>{ if (fb) fb.innerHTML = ''; }, 2500);
                        }
                    });
                }
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => { document.getElementById('configJsonPreview').value = defaultJson; document.getElementById('configFormPreview').innerHTML = ''; });
                }
            }, 10);
        }
    }

    if (sampleBtn) sampleBtn.addEventListener('click', () => {
        const key = id.indexOf('basic') !== -1 ? 'scouting' : id.indexOf('analytics') !== -1 ? 'analytics' : 'config';
        renderPreview(key);
    });
}

// Small interactions for preview save buttons
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'preview-scout-save') {
        const fb = document.getElementById('preview-scout-feedback');
        // collect values from the form surrounding the button
        const form = e.target.closest('form');
        if (form) {
            const data = {};
            form.querySelectorAll('input, textarea, select').forEach(el => {
                const key = el.name || el.id || el.dataset.field || el.placeholder || 'field';
                if (el.type === 'checkbox') data[key] = el.checked;
                else if (el.type === 'number') data[key] = (el.value === '' ? null : Number(el.value));
                else data[key] = el.value;
            });
            if (fb) { fb.innerHTML = '<div class="small"><strong>Preview values:</strong><pre class="mb-0">'+JSON.stringify(data, null, 2)+'</pre></div>'; setTimeout(()=>{ if (fb) fb.innerHTML=''; }, 4000); }
        } else {
            if (fb) { fb.innerHTML = '<div class="alert alert-success py-1 px-2">Sample saved (preview)</div>'; setTimeout(()=>fb.innerHTML='','1600'); }
        }
    }

    // Handle increment/decrement buttons in scouting preview and config form
    if (e.target && (e.target.closest('.btn-increment') || e.target.closest('.btn-decrement'))) {
        const btn = e.target.closest('.btn-increment') || e.target.closest('.btn-decrement');
        if (btn) {
            const targetId = btn.getAttribute('data-target');
            const step = parseFloat(btn.getAttribute('data-step') || '1');
            const inp = document.getElementById(targetId);
            if (inp) {
                const cur = inp.value === '' ? 0 : Number(inp.value);
                if (btn.classList.contains('btn-increment')) {
                    inp.value = Number((cur + step).toFixed((String(step).includes('.') ? step.toString().split('.')[1].length : 0)));
                } else {
                    const next = cur - step;
                    inp.value = Number(Math.max((inp.min ? Number(inp.min) : -Infinity), next).toFixed((String(step).includes('.') ? step.toString().split('.')[1].length : 0)));
                }
                // trigger input event
                inp.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
    }

    // Quick navigation in the tutorial: 'Show' buttons scroll to and briefly highlight the step
    if (e.target && (e.target.classList.contains('tutorial-nav-show') || e.target.closest('.tutorial-nav-show'))) {
        const btn = e.target.classList.contains('tutorial-nav-show') ? e.target : e.target.closest('.tutorial-nav-show');
        const stepSel = btn.getAttribute('data-step');
        if (stepSel) {
            const stepEl = document.querySelector(stepSel);
            if (stepEl) {
                try { stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e) { stepEl.scrollIntoView(); }
                stepEl.classList.add('tutorial-highlight');
                setTimeout(()=>{ try { stepEl.classList.remove('tutorial-highlight'); } catch(e) {} }, 2500);
            }
        }
    }
    if (e.target && e.target.id === 'preview-config-save') {
        // validate JSON in editor; do not save to server
        const ta = document.getElementById('configJsonPreview');
        const fb = document.getElementById('preview-config-feedback');
        try {
            const parsed = JSON.parse(ta.value);
            if (fb) { fb.innerHTML = '<div class="alert alert-success py-1 px-2">Sample config validated (preview only)</div>'; setTimeout(()=>fb.innerHTML='','1800'); }
        } catch (err) {
            if (fb) { fb.innerHTML = '<div class="alert alert-danger py-1 px-2">Invalid JSON: ' + (err.message || '') + '</div>'; }
        }
    }
    if (e.target && e.target.id === 'practice-complete') {
        e.target.classList.add('btn-outline-success'); e.target.textContent = 'Completed'; setTimeout(()=>{ e.target.classList.remove('btn-outline-success'); }, 1200);
    }
});

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight' || e.key === ' ') {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); nextTStep(); }
    } else if (e.key === 'ArrowLeft') {
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); previousTStep(); }
    }
});

// Initialize UI and preview bindings
document.addEventListener('DOMContentLoaded', function() {
    // set default mode
    setMode('guided');

    // Bind mode buttons
    document.getElementById('mode-guided').addEventListener('click', () => setMode('guided'));
    document.getElementById('mode-compact').addEventListener('click', () => setMode('compact'));

    // Bind preview helpers
    initPreview('basicScoutingPreview', '{{ url_for("scouting.scouting_form") }}', 'basicJump');
    initPreview('analyticsPreview', '{{ url_for("graphs.index") }}', 'analyticsSample');
    initPreview('configPreview', '{{ url_for("main.config") }}', 'configSample');

    // small convenience
    document.getElementById('basicJump').addEventListener('click', function() { document.getElementById('basicScoutingPreview').querySelector('input')?.focus(); });
    document.getElementById('analyticsSample').addEventListener('click', function() { document.getElementById('analyticsPreview').querySelector('.sample-chart')?.scrollIntoView({behavior:'smooth'}); });
    document.getElementById('configSample').addEventListener('click', function() { document.getElementById('configPreview').querySelector('.form-check')?.scrollIntoView({behavior:'smooth'}); });

    // Show initial step
    showTStep(1);
});
</script>

<style>
/* Tutorial v2 styles */
.tutorial-v2 .demo-preview { min-height: 160px; display:flex; align-items:center; justify-content:center; padding:1rem; }
.tutorial-v2 .preview-sample { width:100%; }
.tutorial-v2 .sample-chart { height:180px; background:linear-gradient(180deg,#fff,#f8f9fa); border:1px dashed #ced4da; display:flex; align-items:center; justify-content:center; }
#analyticsChart { width:100% !important; height:220px !important; }
#analyticsChart + .chartjs-render-monitor { width:100% !important; }
.tutorial-v2 .card-header { font-weight:700; }
.tutorial-v2 .btn.active { box-shadow:0 0 0 0.15rem rgba(13,110,253,0.15); }
@media (max-width:768px) { .tutorial-v2 .demo-preview { min-height: 140px; } }

/* Dark mode preview styling */
body.dark-mode .tutorial-v2 .demo-preview { background: rgba(255,255,255,0.02); color: #e6e6e6; border-color: rgba(255,255,255,0.06); }
body.dark-mode .tutorial-v2 .preview-placeholder, body.dark-mode .tutorial-v2 .preview-sample { color: #e6e6e6; }
body.dark-mode #configJsonPreview { background:#0f1112; color:#e6e6e6; border-color:#222; }
body.dark-mode .sample-chart { border-color: rgba(255,255,255,0.06); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); }

/* Ensure inputs/selects are readable in dark mode */
body.dark-mode .tutorial-v2 .demo-preview input,
body.dark-mode .tutorial-v2 .demo-preview textarea,
body.dark-mode .tutorial-v2 .demo-preview select,
body.dark-mode .tutorial-v2 .demo-preview .form-control,
body.dark-mode .tutorial-v2 .demo-preview .form-select {
    background: #121213 !important;
    color: #e6e6e6 !important;
    border-color: #2b2b2b !important;
}

/* Buttons and outlines */
body.dark-mode .tutorial-v2 .demo-preview .btn,
body.dark-mode .tutorial-v2 .demo-preview .btn-outline-secondary,
body.dark-mode .tutorial-v2 .demo-preview .btn-outline-info,
body.dark-mode .tutorial-v2 .demo-preview .btn-outline-primary {
    color: #e6e6e6 !important;
    border-color: rgba(255,255,255,0.08) !important;
    background-color: transparent !important;
}

/* Make sure focused inputs have visible outline in dark mode */
body.dark-mode .tutorial-v2 .demo-preview input:focus,
body.dark-mode .tutorial-v2 .demo-preview textarea:focus,
body.dark-mode .tutorial-v2 .demo-preview select:focus,
body.dark-mode .tutorial-v2 .demo-preview .btn:focus {
    outline: 2px solid rgba(13,110,253,0.25);
    outline-offset: 2px;
}

/* Select2 dropdowns inside preview */
body.dark-mode .tutorial-v2 .demo-preview .select2-container--bootstrap-5 .select2-selection,
body.dark-mode .tutorial-v2 .demo-preview .select2-container--bootstrap-5 .select2-results__option {
    background: #121213 !important; color: #e6e6e6 !important; border-color:#2b2b2b !important;
}

body.dark-mode .tutorial-v2 .demo-preview .form-check-input {
    filter: none; /* keep switch visible */
}

/* Reduce contrast in sample chart background for dark mode */
body.dark-mode .tutorial-v2 .sample-chart { border-color: rgba(255,255,255,0.06); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00)); }

/* Ensure legends and tooltips are readable (Chart.js defaults will also be applied in JS)
   but add a fallback in CSS */
body.dark-mode .tutorial-v2 canvas { background: transparent; }
body.dark-mode .tutorial-v2 .chartjs-tooltip { background: rgba(17,17,18,0.95); color: #e6e6e6; }

/* Keep dark-mode buttons readable generally */
body.dark-mode .tutorial-v2 .btn { color: #e6e6e6; }


</style>
{% endblock %}
