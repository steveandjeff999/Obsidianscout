{% extends "base_modern.html" %}

{% block title %}SQLite3 Sync Reliability Report{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        SQLite3 Sync Reliability Report
                    </h4>
                    <small>Server: {{ server.name }} ({{ server.host }}:{{ server.port }})</small>
                </div>
                
                <div class="card-body">
                    <!-- Overall Reliability Score -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-{% if report.overall_reliability >= 0.9 %}success{% elif report.overall_reliability >= 0.7 %}warning{% else %}danger{% endif %}">
                                <h5 class="alert-heading">
                                    <i class="fas fa-tachometer-alt"></i>
                                    Overall Reliability Score
                                </h5>
                                <div class="progress mb-2" style="height: 25px;">
                                    <div class="progress-bar 
                                        {% if report.overall_reliability >= 0.9 %}bg-success
                                        {% elif report.overall_reliability >= 0.7 %}bg-warning
                                        {% else %}bg-danger{% endif %}"
                                        role="progressbar" 
                                        style="width: {{ (report.overall_reliability * 100)|round(1) }}%"
                                        aria-valuenow="{{ (report.overall_reliability * 100)|round(1) }}" 
                                        aria-valuemin="0" 
                                        aria-valuemax="100">
                                        {{ (report.overall_reliability * 100)|round(1) }}%
                                    </div>
                                </div>
                                <p class="mb-0">
                                    {% if report.overall_reliability >= 0.9 %}
                                        <i class="fas fa-check-circle text-success"></i> Excellent reliability
                                    {% elif report.overall_reliability >= 0.7 %}
                                        <i class="fas fa-exclamation-triangle text-warning"></i> Good reliability with some issues
                                    {% else %}
                                        <i class="fas fa-times-circle text-danger"></i> Poor reliability - attention needed
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Operation Details -->
                    <div class="row">
                        {% for operation_type, metrics in report.operations.items() %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 {% if metrics.success_rate >= 0.9 %}border-success{% elif metrics.success_rate >= 0.7 %}border-warning{% else %}border-danger{% endif %}">
                                <div class="card-header 
                                    {% if metrics.success_rate >= 0.9 %}bg-success text-white
                                    {% elif metrics.success_rate >= 0.7 %}bg-warning text-dark
                                    {% else %}bg-danger text-white{% endif %}">
                                    <h6 class="mb-0">
                                        <i class="fas fa-{% if operation_type == 'connection' %}plug{% elif operation_type == 'sync' %}sync-alt{% elif operation_type == 'fetch_changes' %}download{% elif operation_type == 'send_changes' %}upload{% else %}cog{% endif %}"></i>
                                        {{ operation_type.replace('_', ' ').title() }}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- Success Rate -->
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>Success Rate</span>
                                            <strong>{{ (metrics.success_rate * 100)|round(1) }}%</strong>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar 
                                                {% if metrics.success_rate >= 0.9 %}bg-success
                                                {% elif metrics.success_rate >= 0.7 %}bg-warning
                                                {% else %}bg-danger{% endif %}"
                                                style="width: {{ (metrics.success_rate * 100)|round(1) }}%"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Statistics -->
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <div class="text-success">
                                                <i class="fas fa-check-circle"></i>
                                                <br>
                                                <strong>{{ metrics.success_count }}</strong>
                                                <br>
                                                <small>Successes</small>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-danger">
                                                <i class="fas fa-times-circle"></i>
                                                <br>
                                                <strong>{{ metrics.failure_count }}</strong>
                                                <br>
                                                <small>Failures</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Average Duration -->
                                    <div class="mt-3 text-center">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i>
                                            Avg Duration: {{ metrics.avg_duration|round(2) }}s
                                        </small>
                                    </div>
                                    
                                    <!-- Last Operations -->
                                    <div class="mt-3">
                                        {% if metrics.last_success %}
                                        <div class="small text-success">
                                            <i class="fas fa-check"></i>
                                            Last Success: {{ metrics.last_success }}
                                        </div>
                                        {% endif %}
                                        {% if metrics.last_failure %}
                                        <div class="small text-danger">
                                            <i class="fas fa-times"></i>
                                            Last Failure: {{ metrics.last_failure }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if not report.operations %}
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                No reliability data available yet. The server will accumulate metrics as sync operations are performed.
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="fas fa-tools"></i> Actions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="btn-group me-2" role="group">
                                        <a href="{{ url_for('sync_routes.sqlite3_sync_server', server_id=server.id) }}" 
                                           class="btn btn-primary">
                                            <i class="fas fa-sync"></i> Run SQLite3 Sync
                                        </a>
                                        <button onclick="refreshReport()" class="btn btn-outline-primary">
                                            <i class="fas fa-refresh"></i> Refresh Report
                                        </button>
                                    </div>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('sync_routes.dashboard') }}" class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                                        </a>
                                        {% if report.overall_reliability < 0.7 %}
                                        <button onclick="showTroubleshooting()" class="btn btn-outline-warning">
                                            <i class="fas fa-question-circle"></i> Troubleshooting
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Troubleshooting Modal -->
<div class="modal fade" id="troubleshootingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-tools"></i> Troubleshooting Low Reliability
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Common Issues and Solutions:</h6>
                <ul>
                    <li><strong>Network Connectivity:</strong> Check if the server is reachable and ports are open</li>
                    <li><strong>Server Load:</strong> High server load can cause sync timeouts</li>
                    <li><strong>Database Locks:</strong> Concurrent operations may cause temporary failures</li>
                    <li><strong>Configuration:</strong> Verify server settings and credentials</li>
                </ul>
                
                <h6>Recommended Actions:</h6>
                <ol>
                    <li>Test network connectivity to {{ server.host }}:{{ server.port }}</li>
                    <li>Check server logs for error messages</li>
                    <li>Verify server has adequate resources (CPU, memory, disk)</li>
                    <li>Consider adjusting sync intervals if network is unstable</li>
                    <li>Contact system administrator if problems persist</li>
                </ol>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function refreshReport() {
    window.location.reload();
}

function showTroubleshooting() {
    new bootstrap.Modal(document.getElementById('troubleshootingModal')).show();
}

// Auto-refresh every 30 seconds
setInterval(function() {
    // Only refresh if user is still on the page
    if (!document.hidden) {
        // Update the reliability scores via AJAX
        fetch(`/sync/api/sqlite3/status/{{ server.id }}`)
            .then(response => response.json())
            .then(data => {
                if (data.overall_reliability !== undefined) {
                    // Update the overall reliability display
                    const progressBar = document.querySelector('.progress-bar');
                    const percentage = Math.round(data.overall_reliability * 100);
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = percentage + '%';
                    progressBar.setAttribute('aria-valuenow', percentage);
                    
                    // Update color classes
                    progressBar.className = 'progress-bar ' + 
                        (percentage >= 90 ? 'bg-success' : 
                         percentage >= 70 ? 'bg-warning' : 'bg-danger');
                }
            })
            .catch(error => console.log('Auto-refresh error:', error));
    }
}, 30000);
</script>
{% endblock %}
