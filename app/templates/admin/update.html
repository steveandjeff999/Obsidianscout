{% extends 'base.html' %}

{% block title %}Application Update{% endblock %}

{% block heading %}Application Update{% endblock %}
{% block subheading %}Update the application from the Git repository{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-sync-alt me-2"></i> Application Update
                </h5>
                <small class="text-light">Current Version: {{ current_version }}</small>
            </div>
            <div class="card-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>⚠️ BETA FEATURE - USE WITH CAUTION ⚠️</strong>
                    <br><br>
                    This update feature is currently in <strong>BETA</strong> and may not work as expected. 
                    <strong>BACKUP YOUR DATA</strong> before proceeding, including:
                    <ul class="mt-2 mb-0">
                        <li>Database files (instance/scouting.db)</li>
                        <li>Configuration files (config/ folder)</li>
                        <li>Any custom modifications</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Update Method:</strong> 
                    {% if update_method_info.method == 'git' %}
                        This will update the application from the Git repository. 
                        Please make sure you have committed any local changes before proceeding.
                    {% elif update_method_info.method == 'direct_download' %}
                        This will download and install the latest version from the configured download URL.
                    {% elif update_method_info.method == 'manual' %}
                        This will install updates from the manual_updates directory. 
                        Please place update files in the manual_updates folder before proceeding.
                    {% endif %}
                    A server restart will be required after the update.
                </div>

                <!-- Version Status -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="card-title">Version Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Current Version:</strong> {{ current_version }}
                            </div>
                            <div class="col-md-6">
                                {% if update_available %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Update Available
                                    </span>
                                {% else %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>
                                        Up to Date
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mt-2" id="latestVersionRow" style="display: none;">
                            <div class="col-md-12">
                                <small class="text-muted">Latest Version: <span id="latestVersionText"></span></small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="checkUpdatesBtn" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-search me-2"></i> Check for Updates
                            </button>
                        </div>
                    </div>
                </div>

                <p class="mb-4">
                    This process will:
                </p>
                <ul class="mb-4">
                    <li>Pull the latest code from the Git repository</li>
                    <li>Install/update Python dependencies</li>
                    <li>Run database migrations</li>
                </ul>

                <!-- Update Method Configuration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cog me-2"></i> Update Method Configuration
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Current Method:</strong> 
                                <span class="badge bg-info">{{ update_method_info.method|title }}</span>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#updateMethodModal">
                                    <i class="fas fa-edit me-1"></i> Change Method
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">{{ update_method_info.description }}</small>
                        </div>
                        {% if update_method_info.method == 'git' and update_method_info.repository_url %}
                            <div class="mt-2">
                                <small><strong>Repository:</strong> {{ update_method_info.repository_url }}</small>
                            </div>
                        {% elif update_method_info.method == 'direct_download' and update_method_info.download_url %}
                            <div class="mt-2">
                                <small><strong>Download URL:</strong> {{ update_method_info.download_url }}</small>
                            </div>
                        {% elif update_method_info.method == 'manual' %}
                            <div class="mt-2">
                                <small><strong>Manual Updates Directory:</strong> {{ update_method_info.manual_dir }}</small>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
                    <button id="startUpdateBtn" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i> Start Update
                    </button>
                    <a href="{{ url_for('auth.admin_settings') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Back to Admin Settings
                    </a>
                </div>

                <div id="updateStatus" class="alert alert-info d-none">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Update in progress...</div>
                    </div>
                </div>

                <div id="updateSuccess" class="alert alert-success d-none">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Success!</strong> Update completed. A server restart is required to apply all changes.
                </div>

                <div id="updateError" class="alert alert-danger d-none">
                    <i class="fas fa-times-circle me-2"></i>
                    <strong>Error!</strong> An error occurred during the update process.
                </div>

                <div class="card bg-dark text-white">
                    <div class="card-header py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-terminal me-2"></i> Update Console</span>
                            <button id="clearConsoleBtn" class="btn btn-sm btn-outline-light" disabled>
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <pre id="console" class="mb-0 p-3 bg-dark text-light" style="height: 350px; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9rem;">Waiting for update to start...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Changelog Section -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-book me-2"></i> Changelog
                </h5>
            </div>
            <div class="card-body">
                <pre>{{ changelog_txt }}</pre>
            </div>
        </div>
    </div>
</div>

<!-- Update Method Configuration Modal -->
<div class="modal fade" id="updateMethodModal" tabindex="-1" aria-labelledby="updateMethodModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateMethodModalLabel">
                    <i class="fas fa-cog me-2"></i> Configure Update Method
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateMethodForm">
                    <div class="mb-3">
                        <label for="updateMethod" class="form-label">Update Method</label>
                        <select class="form-select" id="updateMethod" name="updateMethod" required>
                            <option value="git" {% if update_method_info.method == 'git' %}selected{% endif %}>Git Repository</option>
                            <option value="direct_download" {% if update_method_info.method == 'direct_download' %}selected{% endif %}>Direct Download</option>
                            <option value="manual" {% if update_method_info.method == 'manual' %}selected{% endif %}>Manual Updates</option>
                        </select>
                        <div class="form-text">Choose how the application should check for and install updates.</div>
                    </div>

                    <!-- Git Configuration -->
                    <div id="gitConfig" class="update-config-section" {% if update_method_info.method != 'git' %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label for="repositoryUrl" class="form-label">Repository URL</label>
                            <input type="url" class="form-control" id="repositoryUrl" name="repositoryUrl" 
                                   value="{{ update_method_info.repository_url or '' }}" 
                                   placeholder="https://github.com/username/repository.git">
                            <div class="form-text">The Git repository URL (GitHub, GitLab, etc.)</div>
                        </div>
                        <div class="mb-3">
                            <label for="branch" class="form-label">Branch</label>
                            <input type="text" class="form-control" id="branch" name="branch" 
                                   value="{{ update_method_info.branch or 'main' }}" 
                                   placeholder="main">
                            <div class="form-text">The branch to pull updates from</div>
                        </div>
                    </div>

                    <!-- Direct Download Configuration -->
                    <div id="directDownloadConfig" class="update-config-section" {% if update_method_info.method != 'direct_download' %}style="display: none;"{% endif %}>
                        <div class="mb-3">
                            <label for="downloadUrl" class="form-label">Download URL</label>
                            <input type="url" class="form-control" id="downloadUrl" name="downloadUrl" 
                                   value="{{ update_method_info.download_url or '' }}" 
                                   placeholder="https://example.com/updates/latest.zip">
                            <div class="form-text">URL to download the latest version as a ZIP file</div>
                        </div>
                    </div>

                    <!-- Manual Updates Configuration -->
                    <div id="manualConfig" class="update-config-section" {% if update_method_info.method != 'manual' %}style="display: none;"{% endif %}>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Manual Updates:</strong> Place update files in the <code>manual_updates</code> directory. 
                            The directory should contain the same structure as the application root.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Manual Updates Directory</label>
                            <input type="text" class="form-control" value="{{ update_method_info.manual_dir }}" readonly>
                            <div class="form-text">This directory will be created automatically if it doesn't exist.</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="backupEnabled" name="backupEnabled" 
                                   {% if update_method_info.backup_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="backupEnabled">
                                Create backup before updating
                            </label>
                            <div class="form-text">Automatically create a backup of the current version before applying updates</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUpdateMethod">
                    <i class="fas fa-save me-2"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startUpdateBtn = document.getElementById('startUpdateBtn');
    const clearConsoleBtn = document.getElementById('clearConsoleBtn');
    const checkUpdatesBtn = document.getElementById('checkUpdatesBtn');
    const consoleElement = document.getElementById('console');
    const updateStatus = document.getElementById('updateStatus');
    const updateSuccess = document.getElementById('updateSuccess');
    const updateError = document.getElementById('updateError');
    
    let eventSource = null;

    // Function to check for updates
    function checkForUpdates() {
        checkUpdatesBtn.disabled = true;
        checkUpdatesBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Checking...';
        
        fetch('{{ url_for("admin.check_for_updates") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.update_available) {
                // Show latest version info
                if (data.latest_version) {
                    document.getElementById('latestVersionText').textContent = data.latest_version;
                    document.getElementById('latestVersionRow').style.display = 'block';
                }
                location.reload(); // Reload to show updated status
            } else {
                checkUpdatesBtn.innerHTML = '<i class="fas fa-check me-2"></i> Up to Date';
                setTimeout(() => {
                    checkUpdatesBtn.innerHTML = '<i class="fas fa-search me-2"></i> Check for Updates';
                    checkUpdatesBtn.disabled = false;
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error checking for updates:', error);
            checkUpdatesBtn.innerHTML = '<i class="fas fa-times me-2"></i> Error';
            setTimeout(() => {
                checkUpdatesBtn.innerHTML = '<i class="fas fa-search me-2"></i> Check for Updates';
                checkUpdatesBtn.disabled = false;
            }, 2000);
        });
    }

    // Function to start the update process
    function startUpdate() {
        // Clear previous output
        consoleElement.textContent = '';
        
        // Update UI
        startUpdateBtn.disabled = true;
        updateStatus.classList.remove('d-none');
        updateSuccess.classList.add('d-none');
        updateError.classList.add('d-none');
        
        // First, make a POST request to trigger the update
        fetch('{{ url_for("admin.run_update") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                // Include CSRF token if available
                'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
            },
            body: JSON.stringify({ start: true }),
            credentials: 'same-origin' // Include cookies for sessions
        })
        .then(response => {
            if (response.ok) {
                // Now create EventSource for Server-Sent Events to get the real-time output
                eventSource = new EventSource('{{ url_for("admin.run_update") }}');
                
                // Handle incoming messages
                eventSource.onmessage = function(event) {
                    const message = event.data;
                    
                    // Format the output with colors for better readability
                    let formattedMessage = message.replace(/\n/g, '<br>');
                    
                    if (message.includes('Error:') || message.includes('error') || message.includes('fail')) {
                        consoleElement.innerHTML += `<span class="text-danger">${formattedMessage}</span><br>`;
                    } else if (message.includes('Success') || message.includes('success') || message.includes('completed')) {
                        consoleElement.innerHTML += `<span class="text-success">${formattedMessage}</span><br>`;
                    } else if (message.includes('Warning')) {
                        consoleElement.innerHTML += `<span class="text-warning">${formattedMessage}</span><br>`;
                    } else {
                        consoleElement.innerHTML += `${formattedMessage}<br>`;
                    }
                    
                    consoleElement.scrollTop = consoleElement.scrollHeight; // Auto-scroll to bottom
                };
                
                // Handle end event
                eventSource.addEventListener('end', function(event) {
                    const status = event.data;
                    
                    // Close connection
                    eventSource.close();
                    eventSource = null;
                    
                    // Update UI based on status
                    updateStatus.classList.add('d-none');
                    
                    if (status === 'success') {
                        updateSuccess.classList.remove('d-none');
                    } else {
                        updateError.classList.remove('d-none');
                    }
                    
                    // Re-enable buttons
                    startUpdateBtn.disabled = false;
                    clearConsoleBtn.disabled = false;
                });
                
                // Handle connection errors
                eventSource.onerror = function() {
                    consoleElement.innerHTML += '<span class="text-danger">Connection to server lost.</span><br>';
                    consoleElement.scrollTop = consoleElement.scrollHeight;
                    
                    // Close connection
                    eventSource.close();
                    eventSource = null;
                    
                    // Update UI
                    updateStatus.classList.add('d-none');
                    updateError.classList.remove('d-none');
                    startUpdateBtn.disabled = false;
                    clearConsoleBtn.disabled = false;
                };
            } else {
                // Handle error response
                console.error('Failed to initiate update process');
                updateStatus.classList.add('d-none');
                updateError.classList.remove('d-none');
                updateError.textContent = 'Failed to initiate update process. Server returned: ' + response.status;
                startUpdateBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            updateStatus.classList.add('d-none');
            updateError.classList.remove('d-none');
            updateError.textContent = 'Network error occurred: ' + error.message;
            startUpdateBtn.disabled = false;
        });
    }
    
    // Attach click event handler to the Start Update button
    startUpdateBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to update the application? This will pull the latest code from Git and may restart services.')) {
            startUpdate();
        }
    });
    
    // Attach click event handler to the Check Updates button
    checkUpdatesBtn.addEventListener('click', checkForUpdates);
    
    // Attach click event handler to the Clear Console button
    clearConsoleBtn.addEventListener('click', function() {
        consoleElement.textContent = '';
        clearConsoleBtn.disabled = true;
    });
    
    // Clean up EventSource on page unload
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }
    });
    
    // Update Method Configuration
    const updateMethodSelect = document.getElementById('updateMethod');
    const updateConfigSections = document.querySelectorAll('.update-config-section');
    const saveUpdateMethodBtn = document.getElementById('saveUpdateMethod');
    
    // Show/hide configuration sections based on selected method
    function toggleConfigSections() {
        const selectedMethod = updateMethodSelect.value;
        
        updateConfigSections.forEach(section => {
            section.style.display = 'none';
        });
        
        if (selectedMethod === 'git') {
            document.getElementById('gitConfig').style.display = 'block';
        } else if (selectedMethod === 'direct_download') {
            document.getElementById('directDownloadConfig').style.display = 'block';
        } else if (selectedMethod === 'manual') {
            document.getElementById('manualConfig').style.display = 'block';
        }
    }
    
    // Handle method selection change
    updateMethodSelect.addEventListener('change', toggleConfigSections);
    
    // Handle save configuration
    saveUpdateMethodBtn.addEventListener('click', function() {
        const formData = new FormData(document.getElementById('updateMethodForm'));
        const config = {
            updateMethod: formData.get('updateMethod'),
            backupEnabled: formData.get('backupEnabled') === 'on'
        };
        
        // Add method-specific configuration
        if (config.updateMethod === 'git') {
            config.repositoryUrl = formData.get('repositoryUrl');
            config.branch = formData.get('branch');
        } else if (config.updateMethod === 'direct_download') {
            config.downloadUrl = formData.get('downloadUrl');
        }
        
        // Send configuration to server
        fetch('{{ url_for("admin.configure_update_method") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(config),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and reload page to show updated configuration
                const modal = bootstrap.Modal.getInstance(document.getElementById('updateMethodModal'));
                modal.hide();
                location.reload();
            } else {
                alert('Error saving configuration: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error saving configuration:', error);
            alert('Error saving configuration. Please try again.');
        });
    });
});
</script>
{% endblock %}
