{% extends 'base.html' %}

{% block title %}Team Trends{% endblock %}

{% block content %}
<div class="container">
  {% import '_help_icon.html' as help %}
  <h1>Team Trends {{ help.help_icon('Explore per-team metric trends across events. Use the filters to change event or timespan.', 'Team Trends') }}</h1>
  <p>Enter one or more team numbers (comma-separated) to overlay multiple teams for comparison.</p>
  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}
  <form method="post" action="{{ url_for('team_trends.analyze_post') }}">
    <div class="form-group">
      <label for="team_number">Select Team</label>
      <div class="input-group mb-1">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="search" id="team-search" class="form-control form-control-sm" placeholder="Search teams by number or name" aria-label="Search teams">
      </div>
      <div class="d-flex justify-content-between mb-2">
        <div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="team-select-all">Select all</button>
        </div>
        <div class="form-text text-end"><small>Tip: hold Ctrl/Cmd to select multiple. You can also paste comma-separated values into the search box and press Analyze.</small></div>
      </div>
      <select class="form-select team-select" id="teams" name="teams" multiple size="8">
        {% for t in teams %}
        <option value="{{ t.team_number }}" {% if selected_team_numbers and t.team_number in selected_team_numbers %}selected{% endif %}>{{ t.team_number }} - {{ t.team_name or 'Unknown' }}</option>
        {% endfor %}
      </select>
      <div class="form-text">Tip: hold Ctrl/Cmd to select multiple. You can also paste comma-separated values into the search box and press Analyze.</div>
    </div>
    <button class="btn btn-primary" type="submit">Analyze</button>
  </form>
</div>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
  const search = document.getElementById('team-search');
  const select = document.getElementById('teams');
    if (!search || !select) return;

    function normalize(s) { return (s || '').toString().toLowerCase().trim(); }

    function filterOptions() {
      const q = normalize(search.value);
      const options = Array.from(select.options);
      options.forEach(opt => {
        const txt = normalize(opt.textContent || opt.innerText);
        const parts = txt.split('-');
        const num = parts[0] ? parts[0].trim() : '';
        const name = parts[1] ? parts[1].trim() : '';
        const match = !q || num.includes(q) || name.includes(q) || txt.includes(q);
        opt.hidden = !match;
        opt.style.display = match ? '' : 'none';
      });

  // If selected option(s) were hidden by the filter, deselect them
  Array.from(select.options).forEach(o => { if (o.hidden) o.selected = false; });

      // Auto-select if exactly one visible option
      const visible = options.filter(o => o.value && !o.hidden);
      if (visible.length === 1) {
        select.value = visible[0].value;
      }

      // Update Select All button state
      try {
        const btn = document.getElementById('team-select-all');
        if (btn) {
          const allSelected = visible.length > 0 && visible.every(o => o.selected);
          btn.textContent = allSelected ? 'Clear selection' : 'Select all';
        }
      } catch (e) {}
    }

    // Select All / Clear selection behavior
    const selectAllBtn = document.getElementById('team-select-all');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', function() {
        const visible = Array.from(select.options).filter(o => o.value && !o.hidden);
        if (!visible.length) return;
        const allSelected = visible.every(o => o.selected);
        visible.forEach(o => { o.selected = !allSelected; });
        // Notify Select2 if initialized
        try { if (window.$ && typeof window.$ === 'function') { window.$('#teams').trigger('change'); } } catch (e) {}
        // Update button text
        selectAllBtn.textContent = allSelected ? 'Select all' : 'Clear selection';
      });
    }

    function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
    search.addEventListener('input', debounce(filterOptions, 150));

    // Allow pasted comma-separated values to pre-select options
    search.addEventListener('paste', function(e) {
      setTimeout(() => {
        const text = (search.value || '').trim();
        if (text.includes(',')) {
          const parts = text.split(',').map(s => s.trim()).filter(Boolean);
          const selectEl = document.getElementById('teams');
          if (!selectEl) return;
          Array.from(selectEl.options).forEach(opt => {
            opt.selected = parts.includes(String(opt.value));
          });
          // If Select2 is initialized, notify it of the change
          try { if (window.$ && typeof window.$ === 'function') { window.$(selectEl).trigger('change'); } } catch (e) {}
        }
      }, 50);
    });
  });
  </script>
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Select2 for #teams to match /graphs behavior (searchable, dropdown multi-select)
  try {
    const teamConfig = {
      placeholder: 'Search and select teams...',
      allowClear: true,
      closeOnSelect: false,
      dropdownCssClass: 'select2-dropdown-large',
      selectionCssClass: 'select2-selection-large',
      templateResult: function(team) {
        if (!team.id) return team.text;
        const parts = (team.text || '').split(' - ');
        return $('<span><strong class="text-primary">' + (parts[0] || '') + '</strong>' + (parts[1] ? ' - ' + parts[1] : '') + '</span>');
      },
      templateSelection: function(team) {
        if (!team.id) return team.text;
        const teamNumber = (team.text || '').split(' - ')[0];
        if (window.innerWidth < 768) return teamNumber;
        return team.text;
      },
      sorter: function(data) { return data.sort(function(a, b) { return (a.text > b.text) ? 1 : -1; }); }
    };

    if (typeof window.initSelect2Mobile === 'function') {
      window.initSelect2Mobile('#teams', teamConfig);
    } else if (window.$ && window.$.fn && window.$.fn.select2) {
      window.$('#teams').select2($.extend({theme: 'bootstrap-5', width: '100%'}, teamConfig));
    }
  } catch (e) {
    console.warn('Select2 init failed on team_trends:', e);
  }
});
</script>
{% endblock %}
{% endblock %}
