{% extends 'base.html' %}
{% import '_help_icon.html' as help %}

{% block title %}Matches{% endblock %}

{% block heading %}Matches{% endblock %}

{% block content %}

{% include '_alliance_mode_banner.html' %}

<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-0">Matches {{ help.help_icon('View and manage matches. Use filters to narrow by event and match type; you can add or sync matches for your event.', 'Matches') }}</h2>
            <p class="text-muted mb-0">View and manage matches for events.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('matches.sync_from_config') }}" class="btn btn-outline-success">
                <i class="fas fa-sync me-2"></i> Sync Matches
            </a>
            <a href="{{ url_for('matches.add') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i> Add Match
            </a>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-lg-4 col-md-12 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title">Total Matches {{ help.help_icon('Total number of matches currently in the system. Use Sync Matches to refresh from configured event data.', 'Total matches') }}</h6>
                <p class="display-6 mb-0">{{ matches|length if matches is not none else 0 }}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title">Events {{ help.help_icon('Number of events available to filter matches. Select an event to narrow match listings.', 'Events') }}</h6>
                <p class="display-6 mb-0">{{ events|length if events is not none else 0 }}</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title">Current Event Code {{ help.help_icon('The currently configured event code used for importing and mapping event data to matches and teams.', 'Current event code') }}</h6>
                <p class="mb-0">{% if game_config and game_config.get('current_event_code') %}<strong>{{ game_config.get('current_event_code') }}</strong>
                <a href="{{ url_for('main.edit_config') }}" class="ms-2">Change</a>
                {% else %}<span class="text-muted">Not configured</span>
                <a href="{{ url_for('main.edit_config') }}" class="ms-2">Set</a>{% endif %}</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Filter moved above the matches table so the table can use full width -->
    <div class="col-12 mb-3">
        <div class="card">
            <div class="card-body">
                <form id="match-filter-form" class="row gx-2 gy-2" method="get" action="{{ url_for('matches.index') }}">
                    <div class="col-12">
                        <input type="search" name="q" value="{{ request.args.get('q','') }}" class="form-control" placeholder="Search by match number or team">
                    </div>
                    <div class="col-12">
                        <label class="form-label mb-1 mt-2">Match Type {{ help.help_icon('Filter by practice/qualification/playoff match types.', 'Match Type') }}</label>
                        <select name="match_type" class="form-select">
                            <option value="" {% if not request.args.get('match_type') %}selected{% endif %}>All</option>
                            <option value="Practice" {% if request.args.get('match_type') == 'Practice' %}selected{% endif %}>Practice</option>
                            <option value="Qualification" {% if request.args.get('match_type') == 'Qualification' %}selected{% endif %}>Qualification</option>
                            <option value="Playoff" {% if request.args.get('match_type') == 'Playoff' %}selected{% endif %}>Playoff</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label mb-1 mt-2">Event {{ help.help_icon('Filter matches by event. Select "All" to include matches across events.', 'Event filter') }}</label>
                        <select name="event_id" class="form-select">
                            <option value="" {% if not request.args.get('event_id') and not selected_event %}selected{% endif %}>All Events</option>
                            {% for event in events|dedupe_events %}
                            {% set _req_eid = request.args.get('event_id') %}
                            <option value="{{ event.id }}" data-event-code="{{ event.code|upper if event.code else '' }}" {% if (_req_eid and (_req_eid|int == event.id or _req_eid == event.id)) or (selected_event and selected_event.id == event.id) %}selected{% endif %}>{{ event.name }} ({{ event.year }}){% if event.is_alliance %} (Alliance){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 mt-2">
                        <button class="btn btn-primary w-100" type="submit">Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-12 mb-3">
        <div class="card">
            <div class="card-body">
                <style>
                /* Ensure action buttons don't wrap text into multiple lines and stay horizontally aligned */
                .match-actions .btn {
                    white-space: nowrap;
                    display: inline-flex;
                    align-items: center;
                }
                .match-actions .btn i {
                    margin-right: 0.35rem;
                }
                .match-actions .delete-confirm-form { margin: 0; }
                </style>
                {% if matches %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th style="width:110px">Match #</th>
                                <th>Type</th>
                                <th>Event</th>
                                <th>Scheduled Time</th>
                                <th>Red</th>
                                <th>Blue</th>
                                <th style="width:160px">Score</th>
                                <th style="width:220px">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for match in matches %}
                            <tr>
                                <td class="fw-bold">{{ match.match_number }}</td>
                                <td>
                                    <span class="badge {% if match.match_type == 'Qualification' %}bg-primary{% elif match.match_type == 'Playoff' %}bg-danger{% elif match.match_type == 'Practice' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ match.match_type }}
                                    </span>
                                </td>
                                <td>
                                    {{ match.event.name if match.event else 'N/A' }}{% if match.event and match.event.is_alliance %} (Alliance){% endif %}
                                    {% if match.event and match.event.timezone %}
                                    <br><small class="text-muted">{{ match.event.timezone.split('/')[-1].replace('_', ' ') }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {# Consider a match 'played' ONLY if it has valid scores (not None and >= 0) #}
                                    {# Check if scores are available from display_scores dictionary #}
                                    {% set ds = display_scores.get(match.id) if display_scores is defined else None %}
                                    {# EPA/OPR-only scores are predictions â€” they must NOT count as a played match #}
                                    {% set has_played = (ds and ds.source != 'epa' and ds.red_score is not none and ds.red_score >= 0 and ds.blue_score is not none and ds.blue_score >= 0) or (match.actual_time is not none) %}
                                    {% if has_played %}
                                        {# Display both scheduled and actual (played) times where available #}
                                        {% set sched_dt = match.scheduled_time %}
                                        {% set actual_dt = match.actual_time %}
                                        {% if sched_dt %}
                                            {% if match.event and match.event.timezone %}
                                                <div class="text-nowrap"><small class="text-muted">Scheduled: {{ sched_dt | format_time_tz(match.event.timezone, '%I:%M %p') }}</small></div>
                                            {% else %}
                                                <div class="text-nowrap"><small class="text-muted">Scheduled: {{ sched_dt | format_time_tz(None, '%I:%M %p') }}</small></div>
                                            {% endif %}
                                        {% endif %}
                                        {% if actual_dt %}
                                            {% if match.event and match.event.timezone %}
                                                <div class="text-nowrap">
                                                    <span class="text-success fw-bold">Played at {{ actual_dt | format_time_tz(match.event.timezone, '%I:%M %p') }}</span>
                                                    <br><small class="text-muted">{{ actual_dt | format_time_tz(match.event.timezone, '%Y-%m-%d %I:%M %p %Z') }}</small>
                                                </div>
                                            {% else %}
                                                <div class="text-nowrap">
                                                    <span class="text-success fw-bold">Played at {{ actual_dt | format_time_tz(None, '%I:%M %p') }}</span>
                                                    <br><small class="text-muted">{{ actual_dt | format_time_tz(None, '%Y-%m-%d %I:%M %p') }}</small>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            {# No actual time recorded; fallback to display_time for compatibility #}
                                            {% set display_time = match.scheduled_time or match.predicted_time %}
                                            {% if display_time %}
                                                {% if match.event and match.event.timezone %}
                                                    <div class="text-nowrap">
                                                        <span class="text-success fw-bold">Played at {{ display_time | format_time_tz(match.event.timezone, '%I:%M %p') }}</span>
                                                        <br><small class="text-muted">{{ display_time | format_time_tz(match.event.timezone, '%Y-%m-%d %I:%M %p %Z') }}</small>
                                                    </div>
                                                {% else %}
                                                    <div class="text-nowrap">
                                                        <span class="text-success fw-bold">Played at {{ display_time | format_time_tz(None, '%I:%M %p') }}</span>
                                                        <br><small class="text-muted">{{ display_time | format_time_tz(None, '%Y-%m-%d %I:%M %p') }}</small>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Played</span>
                                            {% endif %}
                                        {% endif %}
                                    {% elif match.scheduled_time and match.predicted_time %}
                                        {# Show both scheduled and adjusted time when schedule offset exists #}
                                                {% if match.id == next_unplayed_match_id and is_starting_soon(match, match.event.timezone, adjusted_predictions.get(match.id) if adjusted_predictions is defined else None) %}
                                                    <div class="text-nowrap">
                                                        <span class="text-warning fw-bold">Starting soon</span>
                                                    </div>
                                                {% else %}
                                                        {% if match.event and match.event.timezone %}
                                                            <div class="text-nowrap">
                                                                <span class="text-muted" style="text-decoration: line-through; font-size: 0.85em;">{{ match.scheduled_time | format_time_tz(match.event.timezone, '%I:%M %p') }}</span>
                                                            </div>
                                                            <div class="text-nowrap">
                                                                <span class="text-warning fw-bold">~{{ match.predicted_time | format_time_tz(match.event.timezone, '%I:%M %p') }}</span>
                                                                {% if match.event.schedule_offset %}
                                                                <span class="badge bg-warning text-dark ms-1" title="Event is {{ match.event.schedule_offset|abs }} min {{ 'behind' if match.event.schedule_offset > 0 else 'ahead' }}">
                                                                    {{ match.event.schedule_offset|abs }}m {{ '' if match.event.schedule_offset > 0 else '' }}
                                                                </span>
                                                                {% endif %}
                                                            </div>
                                                        {% else %}
                                                            <div class="text-nowrap">
                                                                <span class="text-muted" style="text-decoration: line-through; font-size: 0.85em;">{{ match.scheduled_time | format_time_tz(None, '%I:%M %p') }}</span>
                                                            </div>
                                                            <div class="text-nowrap">
                                                                <span class="text-warning fw-bold">~{{ match.predicted_time | format_time_tz(None, '%I:%M %p') }}</span>
                                                            </div>
                                                        {% endif %}
                                                {% endif %}
                                    {% elif match.scheduled_time %}
                                        {# Only scheduled time, no adjustment #}
                                        {% if match.id == next_unplayed_match_id and is_starting_soon(match, match.event.timezone, adjusted_predictions.get(match.id) if adjusted_predictions is defined else None) %}
                                            <span class="text-warning fw-bold">Starting soon</span>
                                        {% else %}
                                            {% if match.event and match.event.timezone %}
                                                <span class="text-nowrap">{{ match.scheduled_time | format_time_tz(match.event.timezone, '%I:%M %p') }}</span>
                                            {% else %}
                                                <span class="text-nowrap">{{ match.scheduled_time | format_time_tz(None, '%I:%M %p') }}</span>
                                            {% endif %}
                                        {% endif %}
                                    {% elif match.predicted_time %}
                                        {# Only predicted time #}
                                        {% if match.id == next_unplayed_match_id and is_starting_soon(match, match.event.timezone, adjusted_predictions.get(match.id) if adjusted_predictions is defined else None) %}
                                            <span class="text-warning fw-bold">Starting soon</span>
                                        {% else %}
                                            {% if match.event and match.event.timezone %}
                                                    <span class="text-nowrap text-muted">~{{ match.predicted_time | format_time_tz(match.event.timezone, '%I:%M %p') }}</span>
                                                {% else %}
                                                    <span class="text-nowrap text-muted">~{{ match.predicted_time | format_time_tz(None, '%I:%M %p') }}</span>
                                                {% endif %}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">TBD</span>
                                    {% endif %}
                                </td>
                                <td>
                                        {% for team_number in match.red_alliance.split(',') if team_number %}
                                        {% set evcode = (match.event.event_code if match.event and match.event.event_code else (match.event.code if match.event and match.event.code else (game_config.get('current_event_code') if game_config else '')) ) %}
                                        <span class="badge bg-danger me-1"><span class="team-number" data-team-num="{{ team_number }}" data-event-key="{{ evcode }}">{{ team_number }}</span></span>
                                        {% endfor %}
                                </td>
                                <td>
                                        {% for team_number in match.blue_alliance.split(',') if team_number %}
                                        {% set evcode = (match.event.event_code if match.event and match.event.event_code else (match.event.code if match.event and match.event.code else (game_config.get('current_event_code') if game_config else '')) ) %}
                                        <span class="badge bg-primary me-1"><span class="team-number" data-team-num="{{ team_number }}" data-event-key="{{ evcode }}">{{ team_number }}</span></span>
                                        {% endfor %}
                                </td>
                                <td>
                                    {% set ds = display_scores.get(match.id) if display_scores is defined else None %}
                                    {% if ds and ds.red_score is not none and ds.red_score >= 0 and ds.blue_score is not none and ds.blue_score >= 0 %}
                                    <div>
                                        {% if ds.source == 'epa' %}
                                        <span class="text-muted"><em>{{ ds.red_score }}</em> - <em>{{ ds.blue_score }}</em></span>
                                        <small class="text-muted ms-2">(EPA/OPR prediction)</small>
                                        {% else %}
                                        <span class="fw-bold text-danger">{{ ds.red_score }}</span> - <span class="fw-bold text-primary">{{ ds.blue_score }}</span>
                                        {% if ds.source == 'local' %}<small class="text-muted ms-2">(from local scouting)</small>{% endif %}
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <span class="text-muted">Not scored</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group match-actions" role="group" aria-label="Match actions">
                                        <a href="{{ url_for('matches.view', match_id=match.id) }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-search me-1"></i> View
                                        </a>
                                        <a href="{{ url_for('matches.edit', match_id=match.id) }}" class="btn btn-sm btn-secondary">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </a>
                                        <form class="d-inline delete-confirm-form" action="{{ url_for('matches.delete', match_id=match.id) }}" method="post" data-match-number="{{ match.match_number }}">
                                            <button type="button" class="btn btn-sm btn-danger delete-confirm-btn" title="Click to confirm delete">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No matches found. 
                    <a href="{{ url_for('matches.add') }}" class="alert-link">Add your first match</a>.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global config reload handler
        if (typeof window.globalConfigReload === 'function') {
            window.globalConfigReload = function() {
                reloadMatchesWithNewConfig();
            };
        }
        
        // Match type filtering
        const filterButtons = document.querySelectorAll('.filter-btn');
        const matchRows = document.querySelectorAll('tbody tr');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Update active button styling
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                const filterValue = this.getAttribute('data-filter');
                
                // Filter the table rows
                matchRows.forEach(row => {
                    const matchType = row.querySelector('td:nth-child(2) .badge').textContent.trim();
                    
                    if (filterValue === 'all' || matchType === filterValue) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });
    });
        // Two-click inline delete confirmation (replaces modal flow)
        (function(){
            const CONFIRM_TIMEOUT = 5000; // ms to wait before canceling

            document.querySelectorAll('.delete-confirm-form').forEach(form => {
                const btn = form.querySelector('.delete-confirm-btn');
                if (!btn) return;

                let confirming = false;
                let timer = null;

                function enterConfirmState() {
                    confirming = true;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Confirm';
                    btn.setAttribute('aria-pressed', 'true');

                    // start timeout to revert
                    timer = setTimeout(() => {
                        exitConfirmState();
                    }, CONFIRM_TIMEOUT);
                }

                function exitConfirmState() {
                    confirming = false;
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                    btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                    btn.removeAttribute('aria-pressed');
                    if (timer) { clearTimeout(timer); timer = null; }
                }

                btn.addEventListener('click', function(e){
                    e.preventDefault();
                    // If not yet confirming, toggle to confirm state
                    if (!confirming) {
                        enterConfirmState();
                        // optional: announce to user
                        try { if (window.toasts && typeof window.toasts.info === 'function') window.toasts.info('Click the button again to confirm delete'); } catch(e) {}
                        return;
                    }

                    // Second click while confirming -> submit form
                    if (confirming) {
                        // Optionally add a small disabled state so user doesn't double-submit
                        btn.disabled = true;
                        form.submit();
                    }
                });

                // Clean up if user navigates away or focuses elsewhere
                form.addEventListener('mouseleave', function(){ if (confirming) exitConfirmState(); });
            });
        })();

    function reloadMatchesWithNewConfig() {
        console.log('Reloading matches with new configuration...');
        
        // Show loading indicator
        const cardBody = document.querySelector('.card-body');
        if (cardBody) {
            const loadingAlert = document.createElement('div');
            loadingAlert.className = 'alert alert-info text-center mb-3';
            loadingAlert.innerHTML = '<i class="fas fa-sync fa-spin me-2"></i>Updating matches with new configuration...';
            cardBody.insertBefore(loadingAlert, cardBody.firstChild);
        }
        
        // Fetch updated data via AJAX
        fetch('/matches/data', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch updated matches configuration');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // For matches, we need to reload the page to show updated event data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error reloading matches:', error);
            
            // Remove loading indicator and show error
            const loadingAlert = document.querySelector('.alert-info');
            if (loadingAlert) {
                loadingAlert.remove();
            }
            
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-warning alert-dismissible fade show';
            errorAlert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Failed to update matches configuration. Please refresh the page manually.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            if (cardBody) {
                cardBody.insertBefore(errorAlert, cardBody.firstChild);
            }
        });
    }
</script>
{% endblock %}