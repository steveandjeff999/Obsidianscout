{% extends 'base.html' %}

{% block title %}Live Strategy Monitor{% endblock %}

{% block heading %}Live Strategy Monitor{% endblock %}
{% block subheading %}Automatically tracks your team's next match and advances after the scheduled start time{% endblock %}

{% block content %}
<div class="container">
    <!-- ===== Controls Row ===== -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><strong>Select Event &amp; Team</strong></div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-6 mb-2">
                            <label for="event_select" class="form-label">Event</label>
                            <select id="event_select" class="form-select">
                                <option value="">-- Select event --</option>
                                {% for ev in events|dedupe_events %}
                                <option value="{{ ev.id }}" data-event-code="{{ ev.code|upper if ev.code else '' }}" {% if selected_event and ev.id == selected_event.id %}selected{% endif %}>{{ ev.name }} ({{ ev.year }}){% if ev.is_alliance %} (Alliance){% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label for="team_select" class="form-label">Team</label>
                            <select id="team_select" class="form-select">
                                <option value="">-- Select team --</option>
                                {% for t in teams %}
                                <option value="{{ t.team_number }}">{{ t.team_number }}{% if t.team_name %} — {{ t.team_name }}{% endif %}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button id="start_btn" class="btn btn-primary w-100" disabled>Start Live Strategy</button>

                    <div class="mt-3">
                        <label for="manual_match_select" class="form-label">Manual Match Override</label>
                        <div class="input-group">
                            <select id="manual_match_select" class="form-select">
                                <option value="">-- Select match manually --</option>
                            </select>
                            <button id="manual_select_btn" class="btn btn-outline-primary">Show Match</button>
                        </div>
                        <div class="mt-1 text-muted small">Manual selection pauses auto-advance for 5 minutes.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header"><strong>Status</strong></div>
                <div class="card-body">
                    <div id="status_box" class="fw-semibold">Idle — choose an event and team, then click Start.</div>
                    <div id="auto_advance_info" class="mt-2 text-muted small"></div>
                    <div id="schedule_summary" class="mt-2 text-muted small"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Current Match Card ===== -->
    <div id="current_match_card" class="row d-none">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <strong>Current Match for Team <span id="display_team"></span></strong>
                </div>
                <div class="card-body">
                    <div id="match_info">Loading...</div>
                    <div class="mt-3">
                        <button id="load_strategy_btn" class="btn btn-outline-primary">Reload Strategy</button>
                        <button id="force_next_btn" class="btn btn-outline-secondary ms-2">Force Advance &rarr;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Raw Strategy JSON (fallback display) ===== -->
    <div id="strategy_json" class="row mt-3 d-none">
        <div class="col-12">
            <div class="card">
                <div class="card-header"><strong>Strategy JSON (raw)</strong></div>
                <div class="card-body">
                    <pre id="strategy_pre" class="pre-wrap">-</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== Rich Strategy Results ===== -->
    <div id="strategyResults" class="row mt-3 d-none">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <strong>Strategy Overview</strong>
                    <span class="float-end">
                        <span id="redAllianceScore" class="badge bg-danger">--</span>
                        <span id="blueAllianceScore" class="badge bg-primary ms-1">--</span>
                    </span>
                </div>
                <div class="card-body">
                    <div id="matchOverview" class="row mb-3"></div>
                    <div id="predictedOutcome" class="mb-3"></div>
                    <div class="row">
                        <div class="col-md-6"><div id="redAllianceStrategy"></div></div>
                        <div class="col-md-6"><div id="blueAllianceStrategy"></div></div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4"><canvas id="allianceComparisonChart" class="chart-h-200"></canvas></div>
                        <div class="col-md-4"><canvas id="performanceRadarChart" class="chart-h-200"></canvas></div>
                    </div>
                    <div id="keyBattles" class="mt-3"></div>
                    <div id="matchupAnalysis" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart libraries -->
<script src="{{ url_for('static', filename='js/vendor/chart.umd.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/vendor/chartjs-adapter-date-fns.bundle.min.js') }}"></script>

<script>
/* ======================================================================
   LIVE STRATEGY MONITOR — Complete rewrite (Feb 2026)
   ---------------------------------------------------------------
   Key improvements over the previous version:
     1. Server-side match selection via /strategy/live/current-match
        → eliminates client-side clock-skew and complex timestamp logic
     2. Single 15-second poll loop (no more separate reconnect loop,
        auto-advance timers, or debounce hacks)
     3. Deterministic: given the same server state, always picks the
        same match — no mutable _advancedPastIds set that grew forever
     4. Force-advance sends skip IDs to the server so the server picks
        the NEXT match correctly
     5. Clean countdown display driven by server-provided advance_at_ms
   ====================================================================== */
(function () {
'use strict';

// ── Constants ──────────────────────────────────────────────────────────
var POLL_MS          = 15000;       // poll server every 15 seconds
var COUNTDOWN_MS     = 1000;        // update countdown every 1 second
var MANUAL_TIMEOUT   = 5 * 60000;   // manual override lasts 5 minutes
var STRATEGY_RETRIES = 2;           // retry strategy fetch up to 2 extra times

// ── State ──────────────────────────────────────────────────────────────
var S = {
    eventId:         null,
    teamNumber:      null,
    isRunning:       false,
    currentMatchId:  null,       // ID of currently displayed match
    currentMatch:    null,       // full match object currently displayed
    advanceAtMs:     null,       // server-provided epoch ms when we should advance
    serverTimeDelta: 0,          // (server_time - client_time) in ms for clock sync
    skipIds:         [],         // match IDs the user manually advanced past (array for easy serialization)
    manualUntil:     0,          // epoch ms when manual override expires (0 = not active)
    matchesCache:    [],         // all matches from /matches/data (for manual select & strategy)
    scheduleOffsetMs: 0,
    pollTimer:       null,
    countdownTimer:  null,
    strategyData:    null        // last loaded strategy data
};

// ── DOM helpers ────────────────────────────────────────────────────────
function $(id) { return document.getElementById(id); }

function setStatus(msg) {
    var el = $('status_box');
    if (el) el.textContent = msg;
}

function setAdvanceInfo(msg) {
    var el = $('auto_advance_info');
    if (el) el.textContent = msg;
}

function setScheduleSummary(msg) {
    var el = $('schedule_summary');
    if (el) el.textContent = msg;
}

// ── Match utilities ────────────────────────────────────────────────────
function getMatchTime(m) {
    if (!m) return null;
    return m.predicted_time || m.scheduled_time || m.start_time || null;
}

var MATCH_TYPE_ORDER = {
    practice:1, qualification:2, qualifier:2, quarterfinal:3, quarterfinals:3, qf:3,
    semifinal:4, semifinals:4, sf:4, playoff:5, elimination:5, final:6, finals:6, f:6
};

function matchSortKey(m) {
    var t = ((m.comp_level || m.match_type) || '').toLowerCase();
    var order = MATCH_TYPE_ORDER[t] || 99;
    var num = parseInt(String(m.match_number || 0), 10) || 0;
    return order * 100000 + num;
}

function compareMatches(a, b) {
    return matchSortKey(a) - matchSortKey(b);
}

function teamInMatch(tn, m) {
    var t = String(tn);
    try {
        var red  = (m.alliances && m.alliances.red  && m.alliances.red.teams)  || [];
        var blue = (m.alliances && m.alliances.blue && m.alliances.blue.teams) || [];
        return red.concat(blue).map(String).indexOf(t) >= 0;
    } catch (e) { return false; }
}

// ── Server Communication ───────────────────────────────────────────────

/** Fetch the current match from the dedicated server-side endpoint */
function fetchCurrentMatch() {
    if (!S.eventId || !S.teamNumber) return Promise.resolve(null);
    var skipParam = S.skipIds.join(',');
    var url = '/matches/strategy/live/current-match?event_id=' + encodeURIComponent(S.eventId)
            + '&team_number=' + encodeURIComponent(S.teamNumber)
            + '&skip_ids=' + encodeURIComponent(skipParam);

    return fetch(url, { credentials: 'same-origin' })
        .then(function (resp) {
            if (!resp.ok) throw new Error('Server error ' + resp.status);
            return resp.json();
        })
        .then(function (data) {
            if (!data.success) throw new Error(data.error || 'Unknown error');

            // Sync clocks
            if (data.server_time_ms) {
                S.serverTimeDelta = data.server_time_ms - Date.now();
            }
            S.advanceAtMs      = data.advance_at_ms || null;
            S.scheduleOffsetMs = data.schedule_offset_ms || 0;

            // Update schedule summary
            if (data.team_schedule) {
                var total    = data.total_team_matches || 0;
                var done     = data.team_schedule.filter(function(m){ return m.completed; }).length;
                var upcoming = total - done;
                setScheduleSummary(total + ' matches total \u00b7 ' + done + ' completed \u00b7 ' + upcoming + ' upcoming');
            }

            return data.current_match || null;
        })
        .catch(function (e) {
            console.warn('fetchCurrentMatch failed:', e);
            setStatus('Failed to fetch current match: ' + e.message);
            return null;
        });
}

/** Fetch full schedule for populating manual match selector */
function fetchFullSchedule() {
    var url = '/matches/data';
    if (S.eventId) url += '?event_id=' + encodeURIComponent(S.eventId);

    return fetch(url, { credentials: 'same-origin' })
        .then(function (resp) {
            if (!resp.ok) return;
            return resp.json();
        })
        .then(function (data) {
            if (data && data.success) {
                S.matchesCache = data.matches || [];
            }
        })
        .catch(function (e) {
            console.warn('fetchFullSchedule failed:', e);
        });
}

// ── Match Display ──────────────────────────────────────────────────────

function renderMatchInfo(m) {
    if (!m) return '<div class="text-muted">No upcoming match found for this team.</div>';
    var time = getMatchTime(m);
    var timeStr = time ? new Date(time).toLocaleTimeString() : 'Time TBD';
    var teamsRed  = (m.alliances && m.alliances.red  && m.alliances.red.teams)  ? m.alliances.red.teams.join(', ')  : '\u2014';
    var teamsBlue = (m.alliances && m.alliances.blue && m.alliances.blue.teams) ? m.alliances.blue.teams.join(', ') : '\u2014';
    var level = m.comp_level || '';
    return '<div class="row text-center">'
        + '<div class="col-md-3"><strong>Match</strong><div class="fs-5">' + (m.match_number || '--') + '</div><small class="text-muted">' + level + '</small></div>'
        + '<div class="col-md-3"><strong>Scheduled</strong><div>' + timeStr + '</div></div>'
        + '<div class="col-md-3"><strong class="text-danger">Red Alliance</strong><div>' + teamsRed + '</div></div>'
        + '<div class="col-md-3"><strong class="text-primary">Blue Alliance</strong><div>' + teamsBlue + '</div></div>'
        + '</div>';
}

function showMatch(match) {
    if (!match) {
        $('match_info').innerHTML = renderMatchInfo(null);
        $('current_match_card').classList.add('d-none');
        $('strategyResults').classList.add('d-none');
        $('strategy_json').classList.add('d-none');
        return;
    }

    S.currentMatchId = match.id;
    S.currentMatch   = match;

    $('current_match_card').classList.remove('d-none');
    $('display_team').textContent = S.teamNumber || '';
    $('match_info').innerHTML = renderMatchInfo(match);

    // Hide old strategy until new one loads
    $('strategyResults').classList.add('d-none');
    $('strategy_json').classList.add('d-none');

    setStatus('Showing match ' + (match.match_number || '') + ' (' + (match.comp_level || '') + ')');

    // Start countdown
    startCountdown();

    // Auto-load strategy analysis
    loadStrategy(match.id);
}

// ── Countdown & Auto-Advance ───────────────────────────────────────────

function stopCountdown() {
    if (S.countdownTimer) {
        clearInterval(S.countdownTimer);
        S.countdownTimer = null;
    }
}

function startCountdown() {
    stopCountdown();

    function tick() {
        // If manual override is active, show that
        if (S.manualUntil > Date.now()) {
            var remain = S.manualUntil - Date.now();
            var sec = Math.floor(remain / 1000) % 60;
            var min = Math.floor(remain / 60000);
            setAdvanceInfo('Manual mode \u2014 auto-advance resumes in ' + min + 'm ' + sec + 's');
            return;
        }

        if (!S.advanceAtMs) {
            setAdvanceInfo('No scheduled time for this match \u2014 will check on next poll.');
            return;
        }

        // Adjust for clock difference: approximate what the server thinks "now" is
        var serverNow = Date.now() + S.serverTimeDelta;
        var remain2 = S.advanceAtMs - serverNow;

        if (remain2 <= 0) {
            setAdvanceInfo('Match start + 2 min passed \u2014 advancing on next poll\u2026');
        } else {
            var s2 = Math.floor(remain2 / 1000) % 60;
            var m2 = Math.floor(remain2 / 60000);
            setAdvanceInfo('Auto-advance in ' + m2 + 'm ' + s2 + 's');
        }
    }

    tick();
    S.countdownTimer = setInterval(tick, COUNTDOWN_MS);
}

// ── Polling Loop ───────────────────────────────────────────────────────

function stopPolling() {
    if (S.pollTimer) {
        clearInterval(S.pollTimer);
        S.pollTimer = null;
    }
    stopCountdown();
}

function poll() {
    if (!S.isRunning || !S.teamNumber || !S.eventId) return Promise.resolve();

    // If manual override is still active, just refresh schedule but don't switch matches
    if (S.manualUntil > Date.now()) {
        return fetchFullSchedule().then(function () {
            populateManualSelect();
        });
    }

    // Fetch the server's opinion on which match to show
    return fetchCurrentMatch().then(function (match) {
        // Also refresh full schedule for manual selector
        return fetchFullSchedule().then(function () {
            populateManualSelect();
            return match;
        });
    }).then(function (match) {
        if (!match) {
            setStatus('No upcoming match found for team ' + S.teamNumber);
            setAdvanceInfo('');
            return;
        }

        // Did the match change?
        if (match.id !== S.currentMatchId) {
            showMatch(match);
        } else {
            // Same match — just update countdown info (advanceAtMs may have changed)
            startCountdown();
        }
    });
}

function startPolling() {
    S.isRunning = true;
    stopPolling();
    // Immediate first poll
    poll();
    // Then every POLL_MS
    S.pollTimer = setInterval(function () { poll(); }, POLL_MS);
}

// ── Strategy Loading ───────────────────────────────────────────────────

function loadStrategy(matchId) {
    if (!matchId) return;
    var url = '/matches/strategy/analyze/' + matchId;
    var attempt = 0;

    function doAttempt() {
        attempt++;
        setStatus('Loading strategy analysis' + (attempt > 1 ? ' (retry ' + (attempt-1) + ')' : '') + '\u2026');

        fetch(url, { credentials: 'same-origin' })
            .then(function (resp) {
                if (!resp.ok) {
                    return resp.text().then(function (txt) {
                        if (resp.status === 401 || resp.status === 403) {
                            setStatus('Strategy analysis: not authorized (' + resp.status + ')');
                            throw { done: true };
                        }
                        throw new Error(resp.status + ' ' + txt.substring(0, 200));
                    });
                }
                return resp.json();
            })
            .then(function (data) {
                S.strategyData = data;
                try {
                    displayStrategyResults(data);
                    $('strategyResults').classList.remove('d-none');
                    $('strategy_json').classList.add('d-none');
                    setStatus('Strategy loaded for match ' + (S.currentMatch ? S.currentMatch.match_number : matchId));
                } catch (renderErr) {
                    console.warn('Strategy render failed, showing raw JSON:', renderErr);
                    $('strategy_pre').textContent = JSON.stringify(data, null, 2);
                    $('strategy_json').classList.remove('d-none');
                    $('strategyResults').classList.add('d-none');
                }
            })
            .catch(function (e) {
                if (e && e.done) return; // auth error, already handled
                console.warn('Strategy fetch error (attempt ' + attempt + '):', e);
                if (attempt <= STRATEGY_RETRIES) {
                    setTimeout(doAttempt, 2000 * attempt);
                } else {
                    setStatus('Strategy analysis failed: ' + (e.message || e));
                    try {
                        $('strategy_pre').textContent = 'Error loading strategy:\n' + (e.message || String(e));
                        $('strategy_json').classList.remove('d-none');
                        $('strategyResults').classList.add('d-none');
                    } catch (_) {}
                }
            });
    }

    doAttempt();
}

// ── Manual Match Select ────────────────────────────────────────────────

function populateManualSelect() {
    var sel = $('manual_match_select');
    if (!sel) return;

    var prev = sel.value;
    sel.innerHTML = '<option value="">-- Select match manually --</option>';

    var list = S.matchesCache.slice();
    if (S.teamNumber) {
        var teamOnly = list.filter(function (m) { return teamInMatch(S.teamNumber, m); });
        if (teamOnly.length) list = teamOnly;
    }

    list.sort(compareMatches);

    list.forEach(function (m) {
        var red  = (m.alliances && m.alliances.red  && m.alliances.red.teams)  ? m.alliances.red.teams.join(',') : '';
        var blue = (m.alliances && m.alliances.blue && m.alliances.blue.teams) ? m.alliances.blue.teams.join(',') : '';
        var lbl = (m.comp_level || '') + ' ' + (m.match_number || '--') + ' \u2014 Red: ' + red + ' vs Blue: ' + blue;
        var opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = lbl;
        if (String(m.id) === String(prev)) opt.selected = true;
        sel.appendChild(opt);
    });
}

// ── Force Advance ──────────────────────────────────────────────────────

function forceNextMatch() {
    if (!S.currentMatchId) return;
    // Add current match to skip list so server won't pick it again
    if (S.skipIds.indexOf(S.currentMatchId) < 0) {
        S.skipIds.push(S.currentMatchId);
    }
    setStatus('Force advancing past match ' + (S.currentMatch ? S.currentMatch.match_number : S.currentMatchId) + '\u2026');
    // Immediately poll to find the next match
    poll();
}

// ── Manual Override ────────────────────────────────────────────────────

function manualSelectMatch() {
    var sel = $('manual_match_select');
    var matchId = sel ? parseInt(sel.value, 10) : NaN;
    if (!matchId || isNaN(matchId)) {
        alert('Choose a match to show manually.');
        return;
    }

    var match = null;
    for (var i = 0; i < S.matchesCache.length; i++) {
        if (S.matchesCache[i].id === matchId) { match = S.matchesCache[i]; break; }
    }
    if (!match) {
        alert('Match not found in cache. Try refreshing the page.');
        return;
    }

    // Activate manual override
    S.manualUntil = Date.now() + MANUAL_TIMEOUT;
    S.advanceAtMs = null;
    showMatch(match);
    setStatus('Manual mode \u2014 showing match ' + (match.match_number || matchId) + '. Auto-advance paused for 5 minutes.');
}

// ───────────────────────────────────────────────────────────────────────
// STRATEGY DISPLAY FUNCTIONS
// (Rendering strategy analysis results — fully functional, kept intact)
// ───────────────────────────────────────────────────────────────────────

var allianceChart = null;
var radarChart = null;

function normalizeTeamEntry(t) {
    if (!t) return null;
    if (typeof t === 'number' || typeof t === 'string') return { team: { team_number: Number(t) } };
    if (t.team) return t;
    if (t.team_number) return { team: { team_number: t.team_number, team_name: t.team_name } };
    return null;
}

function uniqTeamEntries(arr) {
    var map = {};
    (arr || []).forEach(function (item) {
        var e = normalizeTeamEntry(item);
        if (!e || !e.team) return;
        var key = String(e.team.team_number || '');
        if (!key) return;
        if (!map[key]) {
            map[key] = e;
        } else {
            var prev = map[key];
            var pMet = prev.metrics && Object.keys(prev.metrics).length > 0;
            var nMet = e.metrics && Object.keys(e.metrics).length > 0;
            if (!pMet && nMet) map[key] = e;
        }
    });
    var vals = [];
    for (var k in map) { if (map.hasOwnProperty(k)) vals.push(map[k]); }
    return vals;
}

function displayStrategyResults(data) {
    if (!data) return;
    displayMatchOverview(data.match);
    displayPredictedOutcome(data.predicted_outcome || {});
    displayAllianceStrategy(data.red_alliance || {}, 'red');
    displayAllianceStrategy(data.blue_alliance || {}, 'blue');
    displayKeyBattles(data.key_battles || []);
    displayMatchupAnalysis(data.matchup_analysis || {});
    createVisualizationCharts(data.graph_data || {});
    $('strategyResults').classList.remove('d-none');
}

function displayMatchOverview(matchData) {
    if (!matchData) matchData = {};
    var container = $('matchOverview');
    container.innerHTML = ''
        + '<div class="col-md-3">'
        + '  <div class="text-center">'
        + '    <h4>' + (matchData.type || matchData.match_type || '') + ' ' + (matchData.number || matchData.match_number || '') + '</h4>'
        + '    <p class="text-muted">' + (matchData.event || '') + '</p>'
        + '  </div>'
        + '</div>'
        + '<div class="col-md-9">'
        + '  <div class="row">'
        + '    <div class="col-md-6">'
        + '      <h6 class="text-danger">Red Alliance</h6>'
        + '      <div id="redTeamsList"></div>'
        + '    </div>'
        + '    <div class="col-md-6">'
        + '      <h6 class="text-primary">Blue Alliance</h6>'
        + '      <div id="blueTeamsList"></div>'
        + '    </div>'
        + '  </div>'
        + '</div>';

    try {
        var redList = $('redTeamsList');
        var blueList = $('blueTeamsList');
        var rawRed = matchData.red_teams || (S.strategyData && S.strategyData.red_alliance && S.strategyData.red_alliance.teams) || [];
        var rawBlue = matchData.blue_teams || (S.strategyData && S.strategyData.blue_alliance && S.strategyData.blue_alliance.teams) || [];
        uniqTeamEntries(rawRed).forEach(function (t) {
            var tn = (t.team && t.team.team_number) || t;
            var name = (t.team && t.team.team_name) || '';
            var div = document.createElement('div');
            div.innerHTML = '<div class="mb-1"><strong>Team ' + tn + '</strong>' + (name ? '<br><small class="text-muted">' + name + '</small>' : '') + '</div>';
            redList.appendChild(div);
        });
        uniqTeamEntries(rawBlue).forEach(function (t) {
            var tn = (t.team && t.team.team_number) || t;
            var name = (t.team && t.team.team_name) || '';
            var div = document.createElement('div');
            div.innerHTML = '<div class="mb-1"><strong>Team ' + tn + '</strong>' + (name ? '<br><small class="text-muted">' + name + '</small>' : '') + '</div>';
            blueList.appendChild(div);
        });
    } catch (e) { console.warn(e); }
}

function displayPredictedOutcome(prediction) {
    var container = $('predictedOutcome');
    function fmt(v) { return (v !== null && v !== undefined && !isNaN(Number(v))) ? Math.round(Number(v)) : '--'; }
    var winnerClass = prediction.predicted_winner === 'red' ? 'text-danger' : 'text-primary';
    var winnerText  = prediction.predicted_winner === 'red' ? 'Red Alliance' : 'Blue Alliance';
    container.innerHTML = ''
        + '<div class="row">'
        + '  <div class="col-md-4"><div class="text-center"><h2 class="' + winnerClass + '">' + winnerText + '</h2><p class="lead">Predicted Winner</p></div></div>'
        + '  <div class="col-md-4"><div class="text-center"><h2>' + fmt(prediction.red_score) + ' - ' + fmt(prediction.blue_score) + '</h2><p class="lead">Expected Score</p></div></div>'
        + '  <div class="col-md-4"><div class="text-center"><h2 class="text-info">' + (typeof prediction.confidence === 'number' ? Math.round(prediction.confidence * 100) + '%' : (prediction.confidence || '')) + '</h2><p class="lead">Confidence Level</p></div></div>'
        + '</div>'
        + '<div class="mt-3"><h6>Analysis Reasoning:</h6><ul class="mb-0">'
        + (prediction.reasoning || []).map(function(r){ return '<li>' + r + '</li>'; }).join('')
        + '</ul></div>';
}

function displayAllianceStrategy(allianceData, color) {
    var container = $(color + 'AllianceStrategy');
    try {
        var badge = $(color === 'red' ? 'redAllianceScore' : 'blueAllianceScore');
        var score = null;
        if (S.strategyData && S.strategyData.predicted_outcome) {
            score = S.strategyData.predicted_outcome[color + '_score'];
        }
        if (score === undefined || score === null) {
            score = allianceData.predicted_score;
        }
        badge.textContent = (score !== null && score !== undefined && !isNaN(Number(score))) ? Math.round(Number(score)) + ' pts' : '--';
    } catch (e) { console.warn(e); }

    var teams = uniqTeamEntries(allianceData.teams || []);
    var teamsHtml = teams.map(function (td) {
        var tn = (td.team && td.team.team_number) || '';
        var nm = (td.team && td.team.team_name) || '';
        var tot = (td.metrics && (td.metrics.tot || td.metrics.total_points)) || 0;
        return '<div class="col-md-4 mb-3"><div class="card"><div class="card-body p-2">'
            + '<h6 class="card-title">Team ' + tn + '</h6>'
            + '<small class="text-muted">' + nm + '</small>'
            + '<div class="mt-2"><small class="text-success">Total: ' + tot + ' pts</small></div>'
            + '</div></div></div>';
    }).join('');

    var strats = (allianceData.strategy && allianceData.strategy.key_strategies) || [];
    container.innerHTML = ''
        + '<div class="mb-4"><h6>Team Composition:</h6><div class="row">' + teamsHtml + '</div></div>'
        + '<div class="mb-4"><h6>Key Strategies:</h6><ul class="mb-0">' + strats.map(function(s){ return '<li>' + s + '</li>'; }).join('') + '</ul></div>';
}

function displayKeyBattles(battles) {
    var container = $('keyBattles');
    var filtered = (battles || []).filter(function (b) { return !/(Endgame Showdown|Autonomous Battle)/i.test(b.title || ''); });
    if (!filtered.length) { container.innerHTML = '<p class="text-muted">No key battles identified.</p>'; return; }
    container.innerHTML = filtered.map(function (b) {
        return '<div class="card mb-3"><div class="card-body">'
            + '<h6 class="card-title">' + b.title + '</h6><p>' + b.description + '</p>'
            + '<div class="row"><div class="col-md-6"><span class="badge bg-danger">Team ' + b.red_team + '</span></div>'
            + '<div class="col-md-6"><span class="badge bg-primary">Team ' + b.blue_team + '</span></div></div>'
            + '<small class="text-muted">Key Factor: ' + b.key_factor + '</small>'
            + '</div></div>';
    }).join('');
}

function displayMatchupAnalysis(matchupData) {
    var container = $('matchupAnalysis');
    if (!matchupData || !matchupData.overall_comparison) {
        container.innerHTML = '<p class="text-muted">No matchup analysis available.</p>';
        return;
    }
    var overall = matchupData.overall_comparison;
    var period  = matchupData.period_analysis || {};
    var pred    = (S.strategyData && S.strategyData.predicted_outcome) || null;

    var red_val  = (pred && pred.red_score  != null) ? Number(pred.red_score)  : Number(overall.red_alliance_total  || 0);
    var blue_val = (pred && pred.blue_score != null) ? Number(pred.blue_score) : Number(overall.blue_alliance_total || 0);
    var margin   = (pred && pred.margin != null)     ? Number(pred.margin)     : Math.abs(red_val - blue_val);
    var advantage = (pred && pred.predicted_winner) ? pred.predicted_winner : (overall.advantage || (red_val > blue_val ? 'red' : 'blue'));

    function periodBadge(p, name) {
        var adv = (p && p.advantage) || 'blue';
        return '<div class="mb-2"><div class="d-flex justify-content-between"><span>' + name + ':</span>'
            + '<span class="badge ' + (adv === 'red' ? 'bg-danger' : 'bg-primary') + '">' + (adv === 'red' ? 'Red' : 'Blue') + '</span></div></div>';
    }

    // Key insights (deduplicated)
    var insightsArr = matchupData.key_insights || [];
    var seen = {};
    var insightsHtml = '';
    insightsArr.forEach(function (s) {
        var k = String(s).trim().toLowerCase();
        if (!seen[k]) {
            seen[k] = true;
            insightsHtml += '<li>' + s + '</li>';
        }
    });

    container.innerHTML = ''
        + '<div class="row mb-4">'
        + '  <div class="col-md-6">'
        + '    <h6>Overall Comparison</h6>'
        + '    <div class="card"><div class="card-body">'
        + '      <div class="row">'
        + '        <div class="col-6 text-center"><h4 class="text-danger">' + red_val.toFixed(1) + '</h4><p class="mb-0">Red Alliance</p></div>'
        + '        <div class="col-6 text-center"><h4 class="text-primary">' + blue_val.toFixed(1) + '</h4><p class="mb-0">Blue Alliance</p></div>'
        + '      </div>'
        + '      <div class="text-center mt-3">'
        + '        <span class="badge ' + (advantage === 'red' ? 'bg-danger' : 'bg-primary') + '">' + (advantage === 'red' ? 'Red' : 'Blue') + ' Alliance Advantage</span>'
        + '        <br><small class="text-muted">Margin: ' + margin.toFixed(1) + ' points</small>'
        + '      </div>'
        + '    </div></div>'
        + '  </div>'
        + '  <div class="col-md-6">'
        + '    <h6>Period Analysis</h6>'
        + '    <div class="card"><div class="card-body">'
        + periodBadge(period.autonomous, 'Autonomous')
        + periodBadge(period.teleop, 'Teleop')
        + periodBadge(period.endgame, 'Endgame')
        + '    </div></div>'
        + '  </div>'
        + '</div>'
        + '<div class="row"><div class="col-12"><h6>Key Insights</h6><ul class="mb-0">' + insightsHtml + '</ul></div></div>';
}

function createVisualizationCharts(graphData) {
    try {
        if (!graphData) return;
        if (graphData.alliance_comparison) createAllianceComparisonChart(graphData.alliance_comparison);
        if (graphData.radar_chart_data)    createPerformanceRadarChart(graphData.radar_chart_data);
    } catch (e) { console.warn('Chart creation failed', e); }
}

function createAllianceComparisonChart(data) {
    try {
        var ctx = $('allianceComparisonChart').getContext('2d');
        if (allianceChart) allianceChart.destroy();
        allianceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.categories || [],
                datasets: [
                    { label: 'Red Alliance',  data: data.red_alliance  || [], backgroundColor: 'rgba(220,53,69,0.7)' },
                    { label: 'Blue Alliance', data: data.blue_alliance || [], backgroundColor: 'rgba(13,110,253,0.7)' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } catch (e) { console.warn(e); }
}

function createPerformanceRadarChart(data) {
    try {
        var ctx = $('performanceRadarChart').getContext('2d');
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: data.labels || [],
                datasets: [
                    { label: 'Red',  data: data.red_alliance  || [], backgroundColor: 'rgba(220,53,69,0.2)' },
                    { label: 'Blue', data: data.blue_alliance || [], backgroundColor: 'rgba(13,110,253,0.2)' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    } catch (e) { console.warn(e); }
}

// ───────────────────────────────────────────────────────────────────────
// INITIALIZATION
// ───────────────────────────────────────────────────────────────────────

document.addEventListener('DOMContentLoaded', function () {
    var eventSel = $('event_select');
    var teamSel  = $('team_select');
    var startBtn = $('start_btn');

    // Initialize event ID from current selection
    S.eventId = eventSel.value || null;

    // ── Event change: reload page so server populates teams for new event ──
    eventSel.addEventListener('change', function () {
        var v = eventSel.value;
        try { localStorage.setItem('strategy_live_selected_event', v || ''); } catch (_) {}
        if (v) {
            var url = new URL(window.location.href);
            url.searchParams.set('event_id', v);
            window.location.href = url.toString();
        }
    });

    // ── Team change: enable start button and auto-start ──
    teamSel.addEventListener('change', function () {
        var v = teamSel.value;
        try { localStorage.setItem('strategy_live_selected_team', v || ''); } catch (_) {}
        startBtn.disabled = !v;
        if (v) {
            S.teamNumber = v;
            // Auto-start after a short delay
            setTimeout(function () { startBtn.click(); }, 150);
        } else {
            S.teamNumber = null;
        }
    });

    // ── Start button: begin live tracking ──
    startBtn.addEventListener('click', function () {
        S.teamNumber = teamSel.value;
        S.eventId    = eventSel.value || null;
        if (!S.teamNumber) { alert('Select a team first.'); return; }

        try {
            localStorage.setItem('strategy_live_selected_team',  S.teamNumber || '');
            localStorage.setItem('strategy_live_selected_event', S.eventId || '');
        } catch (_) {}

        // Reset skip IDs on fresh start
        S.skipIds = [];
        S.manualUntil = 0;

        setStatus('Starting live strategy for team ' + S.teamNumber + '\u2026');
        startPolling();
    });

    // ── Load strategy button ──
    $('load_strategy_btn').addEventListener('click', function () {
        if (S.currentMatchId) loadStrategy(S.currentMatchId);
    });

    // ── Force next button ──
    $('force_next_btn').addEventListener('click', forceNextMatch);

    // ── Manual match select ──
    $('manual_select_btn').addEventListener('click', manualSelectMatch);

    // ── Restore cached selections ──
    try {
        var cachedEvent = localStorage.getItem('strategy_live_selected_event');
        var cachedTeam  = localStorage.getItem('strategy_live_selected_team');

        // If cached event differs from current, navigate to it
        if (cachedEvent && String(cachedEvent) !== String(eventSel.value)) {
            if (window.location.search.indexOf('event_id=' + cachedEvent) < 0) {
                var url = new URL(window.location.href);
                url.searchParams.set('event_id', cachedEvent);
                window.location.href = url.toString();
                return; // page will reload
            }
        }

        // Restore team selection
        if (cachedTeam && teamSel) {
            var opts = teamSel.options;
            for (var i = 0; i < opts.length; i++) {
                if (String(opts[i].value) === String(cachedTeam)) {
                    teamSel.value = cachedTeam;
                    S.teamNumber  = cachedTeam;
                    startBtn.disabled = false;
                    break;
                }
            }
        }
    } catch (_) {}

    // ── Initial schedule fetch for manual selector, then auto-start if team selected ──
    fetchFullSchedule().then(function () {
        populateManualSelect();
        if (teamSel.value) {
            startBtn.disabled = false;
            setTimeout(function () { startBtn.click(); }, 300);
        }
    });
});

})();
</script>

<style>
#strategy_pre { max-height: 50vh; overflow: auto; background: #f8f9fa; padding: 1rem; }
</style>
{% endblock %}
