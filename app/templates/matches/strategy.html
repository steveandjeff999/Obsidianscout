{% extends 'base.html' %}

{% block title %}Match Strategy Analysis{% endblock %}

{% block heading %}Match Strategy Analysis{% endblock %}
{% block subheading %}Comprehensive alliance strategy and matchup analysis{% endblock %}

{% block head %}
<!-- Use UMD build for compatibility with non-module usage in templates -->
<script src="{{ url_for('static', filename='js/vendor/chart.umd.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/vendor/chartjs-adapter-date-fns.bundle.min.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Event and Match Selection -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Select Event
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('matches.strategy') }}">
                        <div class="mb-3">
                            <label for="event_id" class="form-label">Event</label>
                            <select class="form-select" id="event_id" name="event_id" onchange="this.form.submit()">
                                <option value="">Select an event...</option>
                                {% for event in events|dedupe_events %}
                                <option value="{{ event.id }}" data-event-code="{{ event.code|upper if event.code else '' }}" {% if selected_event and event.id == selected_event.id %}selected{% endif %}>
                                    {{ event.name }} ({{ event.year }}){% if event.is_alliance %} (Alliance){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                    
                    <div class="mt-2">
                        <a href="{{ url_for('matches.strategy_all') }}?event_id={{ selected_event.id if selected_event else '' }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-th-large me-1"></i>View All Summaries
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        {% if selected_event %}
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-gamepad me-2"></i>Select Match
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="match_search" class="form-label">Search Matches</label>
                        <input type="text" class="form-control" id="match_search" placeholder="Search by match number, type, or team number..." onkeyup="filterMatches()">
                    </div>
                    <div class="mb-3">
                        <label for="match_id" class="form-label">Match</label>
                        <select class="form-select" id="match_id" name="match_id" onchange="loadMatchStrategy(this.value)">
                            <option value="">Select a match...</option>
                            {% for match in matches %}
                            <option value="{{ match.id }}" data-search="{{ match.match_type|lower }} {{ match.match_number }} {{ match.red_alliance|lower }} {{ match.blue_alliance|lower }}">
                                {{ match.match_type }} {{ match.match_number }} - 
                                Red: {{ match.red_alliance }} vs Blue: {{ match.blue_alliance }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary w-100" disabled id="analyzeBtn">
                        <i class="fas fa-chart-line me-2"></i>Analyze Match Strategy
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center py-5 d-none">
        <div class="spinner-border text-primary u-spinner-lg" role="status">
            <span class="visually-hidden">Loading strategy analysis...</span>
        </div>
        <div class="mt-3">
            <h5>Analyzing Match Strategy...</h5>
            <p class="text-muted">This may take a few moments</p>
        </div>
    </div>
    
    <!-- Strategy Analysis Results -->
    <div id="strategyResults" class="d-none">
        <!-- Match Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Match Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="matchOverview">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Predicted Outcome -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-crystal-ball me-2"></i>Predicted Outcome
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="predictedOutcome">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alliance Strategies -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-danger">
                        <div class="card-header bg-danger text-white d-flex align-items-center justify-content-between">
                            <h5 class="mb-0 d-flex align-items-center">
                                <i class="fas fa-chess-queen me-2"></i>Red Alliance Strategy
                            </h5>
                            <div>
                                <span id="redAllianceScore" class="badge bg-light text-dark">--</span>
                            </div>
                        </div>
                    <div class="card-body">
                        <div id="redAllianceStrategy">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card border-primary">
                        <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
                            <h5 class="mb-0 d-flex align-items-center">
                                <i class="fas fa-chess-king me-2"></i>Blue Alliance Strategy
                            </h5>
                            <div>
                                <span id="blueAllianceScore" class="badge bg-light text-dark">--</span>
                            </div>
                        </div>
                    <div class="card-body">
                        <div id="blueAllianceStrategy">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Key Battles -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Key Battles to Watch
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="keyBattles">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Strategy Visualizations -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Alliance Comparison
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="allianceComparisonChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-radar me-2"></i>Performance Radar
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceRadarChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team-by-Team Analysis removed per user request -->
        
        <!-- Matchup Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-purple text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-balance-scale me-2"></i>Detailed Matchup Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="matchupAnalysis">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export Options -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-download me-2"></i>Export Strategy Report
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="printStrategyReport()">
                                <i class="fas fa-print me-2"></i>Print Report
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf me-2"></i>Export to PDF
                            </button>
                            <button type="button" class="btn btn-outline-info d-none share-when-ready" onclick="shareStrategy()" id="shareBtn" data-share-scope="strategy">
                                <i class="fas fa-share me-2"></i>Share Strategy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentMatchId = null;
let strategyData = null;
let allianceChart = null;
let radarChart = null;

function loadMatchStrategy(matchId) {
    const analyzeBtn = document.getElementById('analyzeBtn');
    console.log('loadMatchStrategy called with matchId:', matchId);
    if (matchId) {
        currentMatchId = matchId;
        analyzeBtn.disabled = false;
        console.log('analyzeBtn enabled for matchId', matchId);
        analyzeBtn.textContent = 'Analyze Match Strategy';
        analyzeBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>Analyze Match Strategy';
    } else {
        currentMatchId = null;
        analyzeBtn.disabled = true;
        hideStrategyResults();
    }
}

function analyzeSelectedMatch() {
    console.log('analyzeSelectedMatch called; currentMatchId=', currentMatchId);
    // Prevent concurrent or duplicate analyzes
    if (window.analyzeInProgress) {
        console.warn('analyzeSelectedMatch ignored - already in progress');
        return;
    }
    window.analyzeInProgress = true;
    if (!currentMatchId) {
        alert('Please select a match first');
        return;
    }
    
    showLoadingSpinner();
    hideStrategyResults();
    // Disable analyze button to prevent duplicate requests
    try { document.getElementById('analyzeBtn').disabled = true; } catch (e) {}
    
    // If page was opened via a public share token, call the public analyze endpoint
    const publicToken = window.PUBLIC_SHARE_TOKEN || null;
    const analyzeUrl = publicToken ? `/matches/strategy/public/analyze/${publicToken}/${currentMatchId}` : `/matches/strategy/analyze/${currentMatchId}`;
    console.log('Fetching analyzeUrl:', analyzeUrl);
    fetch(analyzeUrl, { credentials: 'same-origin' })
        .then(response => {
            console.log('analyze response status:', response.status, response.statusText);
            if (!response.ok) {
                // Provide better error for auth failures
                if (response.status === 401 || response.status === 403) {
                    throw new Error(`Analyze request unauthorized: ${response.status}`);
                }
                throw new Error(`Analyze request failed with status ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('analyze returned data:', data);
            if (data.error) {
                throw new Error(data.error);
            }
            strategyData = data;
            try {
                displayStrategyResults(data);
            } catch (dsErr) {
                console.error('displayStrategyResults threw an error:', dsErr);
                // Show visible error
                try { document.getElementById('strategyResults').innerHTML = `<div class="alert alert-danger">Error displaying strategy results: ${dsErr.message}</div>`; } catch (ee) {}
            }
        })
        .catch(error => {
            console.error('Error:', error);
            try { alert('Error analyzing match strategy: ' + error.message); } catch (e) {}
            // Show inline message in the results container
            try {
                const results = document.getElementById('strategyResults');
                if (results) {
                    results.classList.remove('d-none');
                    results.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error analyzing match strategy: ${error.message}</div>`;
                }
            } catch (ee) { /* ignore */ }
        })
        .finally(() => {
            hideLoadingSpinner();
            window.analyzeInProgress = false;
            // Re-enable analyze button
            try { document.getElementById('analyzeBtn').disabled = false; } catch (e) {}
            console.log('analyzeSelectedMatch finished (finally)');
        });
}

function showLoadingSpinner() {
    document.getElementById('loadingSpinner').style.display = 'block';
}

function hideLoadingSpinner() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

function hideStrategyResults() {
    const el = document.getElementById('strategyResults');
    if (el) {
        el.classList.add('d-none');
        el.style.display = 'none';
    }
}

function displayStrategyResults(data) {
    console.log('displayStrategyResults called with data keys:', Object.keys(data || {}));
    // Deduplicate red/blue alliance teams at the top-level strategy data to avoid duplicates in charts
    try {
        if (strategyData && strategyData.red_alliance && Array.isArray(strategyData.red_alliance.teams)) {
            const seenR = new Set();
            strategyData.red_alliance.teams = strategyData.red_alliance.teams.filter(td => {
                const num = (td && td.team && td.team.team_number) || td.team_number || td.number;
                if (!num) return true;
                if (seenR.has(String(num))) return false;
                seenR.add(String(num));
                return true;
            });
        }
        if (strategyData && strategyData.blue_alliance && Array.isArray(strategyData.blue_alliance.teams)) {
            const seenB = new Set();
            strategyData.blue_alliance.teams = strategyData.blue_alliance.teams.filter(td => {
                const num = (td && td.team && td.team.team_number) || td.team_number || td.number;
                if (!num) return true;
                if (seenB.has(String(num))) return false;
                seenB.add(String(num));
                return true;
            });
        }
    } catch (e) { console.warn('Failed to dedupe top-level strategy teams', e); }

    // Display match overview
    try { displayMatchOverview(data.match); } catch (e) { console.error('displayMatchOverview error', e); }
    
    // Display predicted outcome
    try { displayPredictedOutcome(data.predicted_outcome); } catch (e) { console.error('displayPredictedOutcome error', e); }
    
    // Display alliance strategies
    try { displayAllianceStrategy(data.red_alliance, 'red'); } catch (e) { console.error('displayAllianceStrategy (red) error', e); }
    try { displayAllianceStrategy(data.blue_alliance, 'blue'); } catch (e) { console.error('displayAllianceStrategy (blue) error', e); }
    
    // Display key battles
    try { displayKeyBattles(data.key_battles); } catch (e) { console.error('displayKeyBattles error', e); }
    
    // Display matchup analysis
    try { displayMatchupAnalysis(data.matchup_analysis); } catch (e) { console.error('displayMatchupAnalysis error', e); }
    
    // Create visualizations
    try { createVisualizationCharts(data.graph_data); } catch (e) { console.error('createVisualizationCharts error', e); }
    
    // Show results (remove Bootstrap d-none which uses !important)
    const sr = document.getElementById('strategyResults');
    if (sr) {
        sr.classList.remove('d-none');
        sr.style.display = 'block';
    }
}

function displayMatchOverview(matchData) {
    const container = document.getElementById('matchOverview');
    container.innerHTML = `
        <div class="col-md-3">
            <div class="text-center">
                <h4>${matchData.type} ${matchData.number}</h4>
                <p class="text-muted">${matchData.event}</p>
            </div>
        </div>
        <div class="col-md-9">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-danger">Red Alliance</h6>
                    <div id="redTeamsList"></div>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary">Blue Alliance</h6>
                    <div id="blueTeamsList"></div>
                </div>
            </div>
        </div>
    `;
}

function displayPredictedOutcome(prediction) {
    const container = document.getElementById('predictedOutcome');
    const fmt = (v) => (v !== null && v !== undefined && !isNaN(Number(v))) ? Math.round(Number(v)) : '--';
    const winnerClass = prediction.predicted_winner === 'red' ? 'text-danger' : 'text-primary';
    const winnerText = prediction.predicted_winner === 'red' ? 'Red Alliance' : 'Blue Alliance';
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center">
                    <h2 class="${winnerClass}">${winnerText}</h2>
                    <p class="lead">Predicted Winner</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h2>${fmt(prediction.red_score)} - ${fmt(prediction.blue_score)}</h2>
                    <p class="lead">Expected Score</p>
                </div>
            </div>
                    <div class="col-md-4">
                <div class="text-center">
                    <h2 class="text-info">${typeof prediction.confidence === 'number' ? Math.round(prediction.confidence * 100) + '%' : (prediction.confidence || '')}</h2>
                    <p class="lead">Confidence Level</p>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <h6>Analysis Reasoning:</h6>
            <ul class="mb-0">
                ${((prediction && prediction.reasoning) ? prediction.reasoning : []).map(reason => `<li>${reason}</li>`).join('')}
            </ul>
        </div>
    `;
}

function displayAllianceStrategy(allianceData, color) {
    const container = document.getElementById(`${color}AllianceStrategy`);
    // Update alliance score badge if available
    try {
        if (color === 'red') {
            const redBadge = document.getElementById('redAllianceScore');
            let score = null;
            if (strategyData && strategyData.predicted_outcome && typeof strategyData.predicted_outcome.red_score !== 'undefined') {
                score = strategyData.predicted_outcome.red_score;
            } else if (allianceData && allianceData.predicted_score !== undefined && allianceData.predicted_score !== null) {
                score = allianceData.predicted_score;
            }
            if (score !== null && score !== undefined && !isNaN(Number(score))) {
                redBadge.textContent = `${Math.round(Number(score))} pts`;
            } else {
                redBadge.textContent = '--';
            }
        } else if (color === 'blue') {
            const blueBadge = document.getElementById('blueAllianceScore');
            let score = null;
            if (strategyData && strategyData.predicted_outcome && typeof strategyData.predicted_outcome.blue_score !== 'undefined') {
                score = strategyData.predicted_outcome.blue_score;
            } else if (allianceData && allianceData.predicted_score !== undefined && allianceData.predicted_score !== null) {
                score = allianceData.predicted_score;
            }
            if (score !== null && score !== undefined && !isNaN(Number(score))) {
                blueBadge.textContent = `${Math.round(Number(score))} pts`;
            } else {
                blueBadge.textContent = '--';
            }
        }
    } catch (e) {
        console.warn('Failed to update alliance score badge', e);
    }

    // Dedupe teams by team number to avoid duplicate display
    let teamsList = (allianceData && allianceData.teams) ? allianceData.teams.slice() : [];
    try {
        const s = new Set();
        teamsList = teamsList.filter(td => {
            const num = (td && td.team && td.team.team_number) || td.team_number || td.team?.team_number || td.number;
            if (!num) return true; // include if no numeric id found
            if (!s.has(String(num))) { s.add(String(num)); return true; }
            return false;
        });
    } catch (e) { console.warn('Failed to dedupe teamsList', e); }

    console.log(`displayAllianceStrategy(${color}) teams count before: ${(allianceData && allianceData.teams) ? allianceData.teams.length : 0}, after dedupe: ${teamsList.length}`);

    container.innerHTML = `
        <div class="mb-4">
            <h6>Team Composition:</h6>
            <div class="row">
                ${(teamsList || []).map(teamData => `
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-body p-2">
                                <h6 class="card-title">Team ${teamData.team.team_number}</h6>
                                <small class="text-muted">${teamData.team.team_name}</small>
                                <div class="mt-2">
                                    <small class="text-success">Total: ${teamData.metrics.tot || teamData.metrics.total_points || 0} pts</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <div class="mb-4">
            <h6>Key Strategies:</h6>
            <ul class="mb-0">
                    ${(() => { const arr = (((allianceData && allianceData.strategy) && allianceData.strategy.key_strategies) ? allianceData.strategy.key_strategies : []); const seen = new Set(); return arr.filter(s=>{ const k=( (s||'') + '').trim().toLowerCase(); if (seen.has(k)) return false; seen.add(k); return true; }).map(s=>`<li>${s}</li>`).join(''); })()}
            </ul>
        </div>
        
        <div class="mb-4">
            <h6>Strengths:</h6>
            <ul class="mb-0">
                ${((allianceData && allianceData.strengths) ? allianceData.strengths : []).map(strength => `<li class="text-success">${strength}</li>`).join('')}
            </ul>
        </div>
        
        <div class="mb-4">
            <h6>Weaknesses:</h6>
            <ul class="mb-0">
                ${((allianceData && allianceData.weaknesses) ? allianceData.weaknesses : []).map(weakness => `<li class="text-warning">${weakness}</li>`).join('')}
            </ul>
        </div>
        
        <div class="mb-0">
            <h6>Recommendations:</h6>
            <ul class="mb-0">
                ${(() => { const arr = ((allianceData && allianceData.recommendations) ? allianceData.recommendations : []); const seen = new Set(); return arr.filter(r=>{ const k=((r||'')+'').trim().toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; }).map(r=>`<li>${r}</li>`).join(''); })()}
            </ul>
        </div>
        
        <div class="mt-4">
            <h6>Endgame Analysis:</h6>
            <div class="card">
                <div class="card-body p-3">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Coordination Score:</strong> 
                            <span class="badge ${allianceData.endgame_analysis.coordination_score >= 70 ? 'bg-success' : 
                                                allianceData.endgame_analysis.coordination_score >= 40 ? 'bg-warning' : 'bg-danger'}">
                                ${allianceData.endgame_analysis.coordination_score}%
                            </span>
                        </div>
                        <div class="col-md-6">
                            ${allianceData.endgame_analysis.strategy_conflicts.length > 0 ? 
                                `<span class="badge bg-warning">Ô∏è Strategy Conflicts</span>` : 
                                `<span class="badge bg-success"> No Conflicts</span>`}
                        </div>
                    </div>
                    
                    ${((allianceData && allianceData.endgame_analysis) && (allianceData.endgame_analysis.strategy_conflicts && allianceData.endgame_analysis.strategy_conflicts.length > 0)) ? 
                        `<div class="mb-3">
                            <strong>Conflicts:</strong>
                            <ul class="mb-0 small">
                                ${(() => { const arr = ((allianceData.endgame_analysis && allianceData.endgame_analysis.strategy_conflicts) ? allianceData.endgame_analysis.strategy_conflicts : []); const seen = new Set(); return arr.filter(r=>{ const k=((r||'')+'').trim().toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; }).map(conflict => `<li class="text-warning">${conflict}</li>`).join(''); })()}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="mb-3">
                        <strong>Team Endgame Capabilities:</strong>
                        <div class="row mt-2">
                            ${(() => {
                                const arr = ((allianceData && allianceData.endgame_analysis && allianceData.endgame_analysis.team_capabilities) ? allianceData.endgame_analysis.team_capabilities : []);
                                const seen = new Set();
                                const unique = arr.filter(tc => {
                                    const num = (tc && (tc.team_number || (tc.team && tc.team.team_number))) || null;
                                    const id = num ? String(num) : JSON.stringify(tc);
                                    if (seen.has(id)) return false; seen.add(id); return true;
                                });
                                console.log('displayAllianceStrategy endgame team_capabilities dedupe before:', arr.length, 'after:', unique.length);
                                return unique.map(teamCap => `
                                    <div class="col-md-4 mb-2">
                                        <div class="card border-light">
                                            <div class="card-body p-2">
                                                <h6 class="card-title mb-1">Team ${teamCap.team_number || (teamCap.team && teamCap.team.team_number) || ''}</h6>
                                                <div class="small">
                                                    <div><strong>Position:</strong> ${teamCap.capabilities && teamCap.capabilities.primary_strategy ? teamCap.capabilities.primary_strategy : 'No Data'}</div>
                                                    <div><strong>Consistency:</strong> 
                                                        <span class="badge ${teamCap.capabilities && teamCap.capabilities.consistency === 'Very Consistent' ? 'bg-success' : 
                                                                            teamCap.capabilities && teamCap.capabilities.consistency === 'Consistent' ? 'bg-info' :
                                                                            teamCap.capabilities && teamCap.capabilities.consistency === 'Somewhat Consistent' ? 'bg-warning' : 'bg-secondary'} badge-sm">
                                                            ${teamCap.capabilities && teamCap.capabilities.consistency ? teamCap.capabilities.consistency : 'No Data'}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('');
                            })()}
                        </div>
                    </div>
                    
                    ${((allianceData && allianceData.endgame_analysis) && (allianceData.endgame_analysis.recommendations && allianceData.endgame_analysis.recommendations.length > 0)) ? `
                        <div class="mb-0">
                            <strong>Endgame Recommendations:</strong>
                            <ul class="mb-0 small">
                                ${(() => { const arr = ((allianceData.endgame_analysis && allianceData.endgame_analysis.recommendations) ? allianceData.endgame_analysis.recommendations : []); const seen = new Set(); return arr.filter(r=>{ const k=((r||'')+'').trim().toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; }).map(rec => `<li>${rec}</li>`).join(''); })()}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function displayKeyBattles(battles) {
    console.log('displayKeyBattles called', battles);
    const container = document.getElementById('keyBattles');
    // Dedupe battles by title to avoid duplicate entries
    let uniqueBattles = (battles || []).slice();
    try {
        const seen = new Set();
        uniqueBattles = uniqueBattles.filter(b => {
            const title = ((b && b.title) ? b.title : JSON.stringify(b) || '').trim().toLowerCase();
            if (!seen.has(title)) { seen.add(title); return true; }
            return false;
        });
    } catch (e) { console.warn('Failed to dedupe keyBattles', e); }
    
    if (!uniqueBattles || uniqueBattles.length === 0) {
        container.innerHTML = '<p class="text-muted">No key battles identified.</p>';
        return;
    }
    
    container.innerHTML = uniqueBattles.map(battle => `
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">${battle.title}</h6>
                <p class="card-text">${battle.description}</p>
                <div class="row">
                    <div class="col-md-6">
                        <span class="badge bg-danger">Team ${battle.red_team}</span>
                    </div>
                    <div class="col-md-6">
                        <span class="badge bg-primary">Team ${battle.blue_team}</span>
                    </div>
                </div>
                <small class="text-muted">Key Factor: ${battle.key_factor}</small>
            </div>
        </div>
    `).join('');
}

function displayMatchupAnalysis(matchupData) {
    console.log('displayMatchupAnalysis called', matchupData);
    const container = document.getElementById('matchupAnalysis');
    
    if (!matchupData || !matchupData.overall_comparison) {
        container.innerHTML = '<p class="text-muted">No matchup analysis available.</p>';
        return;
    }
    
    const overall = matchupData.overall_comparison;
    const period = matchupData.period_analysis;

    // Prefer predicted_outcome from the full strategy if available for consistency
    const pred = (strategyData && strategyData.predicted_outcome) ? strategyData.predicted_outcome : null;
    const red_val = (pred && typeof pred.red_score !== 'undefined' && pred.red_score !== null) ? Number(pred.red_score) : Number(overall.red_alliance_total || 0);
    const blue_val = (pred && typeof pred.blue_score !== 'undefined' && pred.blue_score !== null) ? Number(pred.blue_score) : Number(overall.blue_alliance_total || 0);
    const margin_val = (pred && typeof pred.margin !== 'undefined' && pred.margin !== null) ? Number(pred.margin) : Math.abs(red_val - blue_val);
    const advantage = (pred && pred.predicted_winner) ? pred.predicted_winner : (overall.advantage || (red_val > blue_val ? 'red' : 'blue'));

    container.innerHTML = `
        <div class="row mb-4">
            <div class="col-md-6">
                <h6>Overall Comparison</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="text-center">
                                    <h4 class="text-danger">${red_val.toFixed(1)}</h4>
                                    <p class="mb-0">Red Alliance</p>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h4 class="text-primary">${blue_val.toFixed(1)}</h4>
                                    <p class="mb-0">Blue Alliance</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="mb-0">
                                <span class="badge ${advantage === 'red' ? 'bg-danger' : 'bg-primary'}">
                                    ${advantage === 'red' ? 'Red' : 'Blue'} Alliance Advantage
                                </span>
                            </p>
                            <small class="text-muted">Margin: ${margin_val.toFixed(1)} points</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <h6>Period Analysis</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Autonomous:</span>
                                <span class="badge ${period.autonomous.advantage === 'red' ? 'bg-danger' : 'bg-primary'}">
                                    ${period.autonomous.advantage === 'red' ? 'Red' : 'Blue'}
                                </span>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Teleop:</span>
                                <span class="badge ${period.teleop.advantage === 'red' ? 'bg-danger' : 'bg-primary'}">
                                    ${period.teleop.advantage === 'red' ? 'Red' : 'Blue'}
                                </span>
                            </div>
                        </div>
                        <div class="mb-0">
                            <div class="d-flex justify-content-between">
                                <span>Endgame:</span>
                                <span class="badge ${period.endgame.advantage === 'red' ? 'bg-danger' : 'bg-primary'}">
                                    ${period.endgame.advantage === 'red' ? 'Red' : 'Blue'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <h6>Key Insights</h6>
                <ul class="mb-0">
                    ${(() => { const arr = ((matchupData && matchupData.key_insights) ? matchupData.key_insights : []); const seen = new Set(); return arr.filter(s=>{ const k=((s||'')+'').trim().toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; }).map(insight=>`<li>${insight}</li>`).join(''); })()}
                </ul>
            </div>
        </div>
    `;
}

function createVisualizationCharts(graphData) {
    if (!graphData) return;
    
    // Create Alliance Comparison Chart
    if (graphData.alliance_comparison) {
        createAllianceComparisonChart(graphData.alliance_comparison);
    }
    
    // Create Performance Radar Chart
    if (graphData.radar_chart_data) {
        createPerformanceRadarChart(graphData.radar_chart_data);
    }
    
    // Team comparison chart removed; not rendering team-by-team analysis
}

function createAllianceComparisonChart(data) {
    const ctx = document.getElementById('allianceComparisonChart').getContext('2d');
    
    if (allianceChart) {
        allianceChart.destroy();
    }
    
    allianceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.categories,
            datasets: [{
                label: 'Red Alliance',
                data: data.red_alliance,
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 1
            }, {
                label: 'Blue Alliance',
                data: data.blue_alliance,
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Average Points'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Alliance Performance by Period'
                }
            }
        }
    });
}

function createPerformanceRadarChart(data) {
    const ctx = document.getElementById('performanceRadarChart').getContext('2d');
    
    if (radarChart) {
        radarChart.destroy();
    }
    
    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Red Alliance',
                data: data.red_alliance,
                backgroundColor: 'rgba(220, 53, 69, 0.2)',
                borderColor: 'rgba(220, 53, 69, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(220, 53, 69, 1)'
            }, {
                label: 'Blue Alliance',
                data: data.blue_alliance,
                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(13, 110, 253, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Alliance Performance Comparison'
                }
            }
        }
    });
}

// Team-by-Team chart removed per user request

function printStrategyReport() {
    window.print();
}

function exportToPDF() {
    // Open the browser print dialog so user can select "Save as PDF"
    // If no strategy results are visible, warn the user.
    var element = document.getElementById('strategyResults');
    if (!element || element.style.display === 'none') {
        alert('No strategy report to export. Please analyze a match first.');
        return;
    }
    // Use the browser print dialog. The page has print-specific styles to improve output.
    window.print();
}

function shareStrategy() {
    // Create a public share token via the backend
    if (!currentMatchId) {
        alert('Select a match to share');
        return;
    }

    fetch('/matches/strategy/share', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({match_id: currentMatchId})
    }).then(r => r.json()).then(data => {
        if (data.error) {
            alert('Error creating share: ' + data.error);
            return;
        }
        // Server returns a path; client constructs full URL using its origin
        const path = data.path || '/';
        const origin = window.location.origin || (window.location.protocol + '//' + window.location.host);
        const url = origin.replace(/\/$/, '') + path;
        // Try Web Share API
        if (navigator.share) {
            navigator.share({title: 'Shared Match Strategy', text: 'View this shared match strategy', url});
        } else if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(() => alert('Public strategy URL copied to clipboard!'));
        } else {
            prompt('Copy this URL to share:', url);
        }
    }).catch(err => {
        console.error(err);
        alert('Error creating share token');
    })
}

function filterMatches() {
    const searchTerm = document.getElementById('match_search').value.toLowerCase();
    const matchSelect = document.getElementById('match_id');
    const options = matchSelect.options;
    
    for (let i = 1; i < options.length; i++) { // Start from 1 to skip the first "Select a match..." option
        const option = options[i];
        const searchData = option.getAttribute('data-search') || '';
        
        if (searchData.includes(searchTerm)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    }
    
    // Reset selection if current selection is now hidden
    if (matchSelect.value && matchSelect.selectedOptions[0].style.display === 'none') {
        matchSelect.value = '';
        loadMatchStrategy('');
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // If the server provided a public share token, expose it to JS (safe JSON serialization)
    {% if public_share_token is defined %}
    window.PUBLIC_SHARE_TOKEN = {{ public_share_token|tojson }};
    {% else %}
    window.PUBLIC_SHARE_TOKEN = null;
    {% endif %}

    {% if public_shared_match_id is defined %}
    window.PUBLIC_SHARED_MATCH_ID = {{ public_shared_match_id }};
    {% else %}
    window.PUBLIC_SHARED_MATCH_ID = null;
    {% endif %}

    // If the server provided precomputed strategy data for the public share, expose it
    {% if public_strategy_data is defined and public_strategy_data %}
    window.PUBLIC_STRATEGY_DATA = {{ public_strategy_data|tojson }};
    {% else %}
    window.PUBLIC_STRATEGY_DATA = null;
    {% endif %}

    // If preloaded strategy data exists for this public share, use it immediately
    if (window.PUBLIC_STRATEGY_DATA) {
        strategyData = window.PUBLIC_STRATEGY_DATA;
        // Try to set currentMatchId from provided values
        currentMatchId = window.PUBLIC_SHARED_MATCH_ID || (strategyData && strategyData.match && strategyData.match.id) || null;
        displayStrategyResults(strategyData);
    } else if (window.PUBLIC_SHARE_TOKEN && window.PUBLIC_SHARED_MATCH_ID) {
        // Otherwise, fall back to fetching the public analyze endpoint
        currentMatchId = window.PUBLIC_SHARED_MATCH_ID;
        analyzeSelectedMatch();
    }

    // If server provided a preselected match id, select it in the dropdown and analyze
    {% if preselected_match_id is defined and preselected_match_id %}
    try {
        const sel = document.getElementById('match_id');
        if (sel) {
            sel.value = {{ preselected_match_id }};
            loadMatchStrategy({{ preselected_match_id }});
            // auto-start analysis for authorized users
            analyzeSelectedMatch();
        }
    } catch (e) {
        console.warn('Failed to auto-select match:', e);
    }
    {% endif %}

    // Defensive: Attach a click handler for analyze button in case inline attribute isn't executed
    try {
        const analyzeBtn = document.getElementById('analyzeBtn');
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', function(e) {
                try {
                    // Avoid double-invocation when disabled
                    if (analyzeBtn.disabled) return;
                    analyzeSelectedMatch();
                } catch (err) { console.warn('analyzeBtn event handler error', err); }
            });
        }

        // Ensure match selection enables/disables the analyze button and attach resilient listeners
        const matchSelect = document.getElementById('match_id');
        if (matchSelect) {
            // On load, reflect current selection into the analyze button state
            try {
                if (analyzeBtn) analyzeBtn.disabled = !matchSelect.value;
                if (matchSelect.value) loadMatchStrategy(matchSelect.value);
            } catch (e) { /* ignore */ }

            // Prefer programmatic listeners instead of relying solely on inline attributes
            matchSelect.addEventListener('change', function(e) { loadMatchStrategy(e.target.value); });
            matchSelect.addEventListener('input', function(e) { loadMatchStrategy(e.target.value); });
        }
    } catch (e) { console.warn('Failed to initialize analyze button or match select listeners', e); }

    // Any additional initialization code here
    console.log('Matches strategy page script initialized');
});
</script>

<style>
.bg-purple {
    background-color: #6f42c1 !important;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

.badge {
    font-size: 0.875em;
}

.badge-sm {
    font-size: 0.75em;
    padding: 0.25em 0.5em;
}

#loadingSpinner {
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 10px;
    padding: 2rem;
    margin: 2rem 0;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 1rem 0;
}

.endgame-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.endgame-capability {
    font-size: 0.9em;
    line-height: 1.3;
}

@media print {
    .btn, .card-header, .navbar, .footer {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }
    
    .text-danger {
        color: #000 !important;
    }
    
    .text-primary {
        color: #000 !important;
    }
    
    .bg-danger, .bg-primary, .bg-success, .bg-warning {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
}
</style>
{% endblock %}
