{% extends 'base.html' %}

{% block title %}Simple Pit Configuration Editor{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title mb-2 mb-md-0">
                        <i class="fas fa-wrench"></i> <span class="d-none d-md-inline">Simple </span>Pit Config Editor
                    </h2>
                    <div class="card-tools d-flex flex-column flex-md-row gap-2 mt-2 mt-md-0">
                        <a href="{{ url_for('pit_scouting.config') }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> <span class="d-none d-sm-inline">Back</span>
                        </a>
                        <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#resetModal">
                            <i class="fas fa-undo me-1"></i> <span class="d-none d-sm-inline">Reset</span>
                        </button>
                    </div>
                </div>
                
                <div class="card-body">

                    {% include '_alliance_mode_banner.html' %}

                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Requirements</h5>
                            <button class="btn btn-sm btn-link d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#requirementsCollapse">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="collapse show d-md-block" id="requirementsCollapse">
                            <ul class="mb-0 mt-2 small">
                                <li><strong>Title</strong> is required</li>
                                <li>At least <strong>one section</strong> is required</li>
                                <li>Each section must have a unique <strong>Section ID</strong> and <strong>Section Name</strong></li>
                                <li>Each element must have a unique <strong>Element ID</strong>, <strong>Element Name</strong>, and <strong>Element Type</strong></li>
                                <li><strong>Select</strong> and <strong>Multiselect</strong> elements must have at least one option</li>
                                <li>Fields marked with <span class="text-danger">*</span> are required</li>
                            </ul>
                        </div>
                    </div>

                    <form method="POST" action="{{ url_for('pit_scouting.config_simple_save') }}" id="pitConfigForm">
                        <input type="hidden" name="simple_payload" id="simple_payload" value="">
                        <!-- Basic Settings -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h3>Basic Settings</h3>
                                <div class="form-group">
                                    <label for="title">Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="title" name="title" 
                                           value="{{ pit_config.pit_scouting.title }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <input type="text" class="form-control" id="description" name="description" 
                                           value="{{ pit_config.pit_scouting.description }}">
                                </div>
                            </div>
                        </div>

                        <!-- Sections -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h3>Sections</h3>
                                <div id="sectionsContainer">
                                    {% for section in pit_config.pit_scouting.sections %}
                                    <div class="section-item card mb-3" data-section-index="{{ loop.index0 }}">
                                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                                            <h4 class="mb-2 mb-md-0" style="font-size: 1.1rem;">
                                                <span class="move-section-controls me-2">
                                                    <button type="button" class="btn btn-sm btn-light move-section-up" title="Move section up"><i class="fas fa-arrow-up"></i></button>
                                                    <button type="button" class="btn btn-sm btn-light move-section-down" title="Move section down"><i class="fas fa-arrow-down"></i></button>
                                                </span>
                                                <button class="btn btn-sm btn-link p-0 me-2 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#sectionCollapse{{ loop.index0 }}">
                                                    <i class="fas fa-chevron-down"></i>
                                                </button>
                                                <span class="section-label">Section <span class="section-number">{{ loop.index }}</span></span>
                                            </h4>
                                            <button type="button" class="btn btn-sm btn-danger remove-section">
                                                <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">Remove</span>
                                            </button>
                                        </div>
                                        <div class="collapse show" id="sectionCollapse{{ loop.index0 }}">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="small">Section ID</label>
                                                        <input type="hidden" name="section_id_{{ loop.index0 }}" value="{{ section.id }}" data-auto="true">
                                                        <div class="form-control-plaintext small text-muted generated-section-id">{{ section.id }}</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label>Section Name <span class="text-danger">*</span></label>
                                                        <input type="text" class="form-control" name="section_name_{{ loop.index0 }}" 
                                                               value="{{ section.name }}" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Elements -->
                                            <h5>Elements</h5>
                                            <div class="elements-container" data-section-index="{{ loop.index0 }}">
                                                {% set section_index = loop.index0 %}
                                                {% for element in section.elements %}
                                                {% set element_index = loop.index0 %}
                                                <div class="element-item border p-2 p-md-3 mb-2" data-element-index="{{ loop.index0 }}">
                                                    <div class="row">
                                                        <div class="col-12 d-flex justify-content-between align-items-center mb-2">
                                                            <h6 class="mb-0" style="font-size: 0.95rem;"><span class="move-element-controls me-2">
                                                            <button type="button" class="btn btn-sm btn-light move-element-up" title="Move element up"><i class="fas fa-arrow-up"></i></button>
                                                            <button type="button" class="btn btn-sm btn-light move-element-down" title="Move element down"><i class="fas fa-arrow-down"></i></button>
                                                        </span><span class="element-label">Element <span class="element-number">{{ loop.index }}</span></span></h6>
                                                            <button type="button" class="btn btn-sm btn-danger remove-element">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-12 col-md-4 mb-2">
                                                            <div class="form-group mb-0">
                                                                <label class="small">Element ID</label>
                                                                <input type="hidden" class="form-control form-control-sm" 
                                                                       name="element_id_{{ section_index }}_{{ element_index }}" 
                                                                       value="{{ element.id }}" data-auto="true">
                                                                <div class="form-control-plaintext small text-muted generated-element-id">{{ element.id }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="col-12 col-md-4 mb-2">
                                                            <div class="form-group mb-0">
                                                                <label class="small">Element Name <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       name="element_name_{{ section_index }}_{{ element_index }}" 
                                                                       value="{{ element.name }}" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-12 col-md-4 mb-2">
                                                            <div class="form-group mb-0">
                                                                <label class="small">Element Type <span class="text-danger">*</span></label>
                                                                <select class="form-control form-control-sm element-type-select" 
                                                                        name="element_type_{{ section_index }}_{{ element_index }}" required>
                                                                    <option value="text" {% if element.type == 'text' %}selected{% endif %}>Text</option>
                                                                    <option value="textarea" {% if element.type == 'textarea' %}selected{% endif %}>Textarea</option>
                                                                    <option value="number" {% if element.type == 'number' %}selected{% endif %}>Number</option>
                                                                    <option value="boolean" {% if element.type == 'boolean' %}selected{% endif %}>Boolean</option>
                                                                    <option value="select" {% if element.type == 'select' %}selected{% endif %}>Select</option>
                                                                    <option value="multiselect" {% if element.type == 'multiselect' %}selected{% endif %}>Multi-select</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-12 col-md-4 mb-2">
                                                            <div class="form-group mb-0">
                                                                <label class="small">Default Value</label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       name="element_default_{{ section_index }}_{{ element_index }}" 
                                                                       value="{{ element.default or '' }}">
                                                            </div>
                                                        </div>
                                                        <div class="col-12 col-md-4 mb-2">
                                                            <div class="form-group mb-0">
                                                                <label class="small">Placeholder</label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       name="element_placeholder_{{ section_index }}_{{ element_index }}" 
                                                                       value="{{ element.placeholder or '' }}">
                                                            </div>
                                                        </div>
                                                        <div class="col-12 col-md-4 mb-2">
                                                            <div class="form-check pt-3">
                                                                <input type="checkbox" class="form-check-input" 
                                                                       name="element_required_{{ section_index }}_{{ element_index }}" 
                                                                       {% if element.required %}checked{% endif %}>
                                                                <label class="form-check-label small">Required</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Number validation fields -->
                                                    <div class="number-validation row {% if element.type != 'number' %}d-none{% endif %}">
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>Min Value</label>
                                                                <input type="number" class="form-control" 
                                                                       name="element_min_{{ section_index }}_{{ element_index }}" 
                                                                       value="{{ element.validation.min if element.validation else '' }}">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="form-group">
                                                                <label>Max Value</label>
                                                                <input type="number" class="form-control" 
                                                                       name="element_max_{{ section_index }}_{{ element_index }}" 
                                                                       value="{{ element.validation.max if element.validation else '' }}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Select/Multiselect options -->
                                                    <div class="select-options {% if element.type not in ['select', 'multiselect'] %}d-none{% endif %}">
                                                        <div class="form-group mb-0">
                                                            <label class="small">Options <span class="text-danger">*</span></label>
                                                            <small class="form-text text-muted d-block mb-2">Add option names; values are auto-generated and points default to 0</small>
                                                            <div class="table-responsive">
                                                            <table class="table table-bordered table-sm option-points-table">
                                                                <thead>
                                                                    <tr><th style="width:1%;"></th><th>Option Name</th><th></th></tr>
                                                                </thead>
                                                                <tbody>
                                                                {% for opt in element.options %}
                                                                <tr>
                                                                    <td class="move-option-cell text-center" style="width:1%;white-space:nowrap;">
                                                                        <button type="button" class="btn btn-sm btn-light move-option-up" title="Move option up"><i class="fas fa-arrow-up"></i></button>
                                                                        <button type="button" class="btn btn-sm btn-light move-option-down" title="Move option down"><i class="fas fa-arrow-down"></i></button>
                                                                    </td>
                                                                    <td><input type="text" class="form-control form-control-sm option-label" name="element_option_label_{{ section_index }}_{{ element_index }}_{{ loop.index0 }}" value="{{ opt.label if opt.label else opt.value }}" required></td>
                                                                    <td style="display:none;">
                                                                        <input type="hidden" name="element_option_value_{{ section_index }}_{{ element_index }}_{{ loop.index0 }}" value="{{ opt.value }}" data-auto="{{ 'true' if not opt.value else 'false' }}">
                                                                        <input type="hidden" name="element_option_points_{{ section_index }}_{{ element_index }}_{{ loop.index0 }}" value="{{ element.points[opt.value] if element.points and opt.value in element.points else 0 }}">
                                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-option" style="display:none;"><i class="fas fa-trash"></i></button>
                                                                    </td>
                                                                    <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-option"><i class="fas fa-trash"></i></button></td>
                                                                </tr>
                                                                {% endfor %}
                                                                </tbody>
                                                            </table>
                                                            </div>
                                                            <button type="button" class="btn btn-sm btn-success add-option" data-section-index="{{ section_index }}" data-element-index="{{ element_index }}">
                                                                <i class="fas fa-plus"></i> Add Option
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button type="button" class="btn btn-success add-element" data-section-index="{{ loop.index0 }}">
                                                <i class="fas fa-plus"></i> Add Element
                                            </button>
                                        </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-success" id="addSection">
                                    <i class="fas fa-plus"></i> Add Section
                                </button>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-grid gap-2 d-md-flex">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                    <a href="{{ url_for('pit_scouting.config') }}" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-times"></i> Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let sectionIndex = {{ pit_config.pit_scouting.sections|length }};
    let elementIndexes = {};
    
    // Initialize element indexes for each section
    {% for section in pit_config.pit_scouting.sections %}
    elementIndexes[{{ loop.index0 }}] = {{ section.elements|length }};
    {% endfor %}


    // Utility: slugify name -> id (lowercase, replace non-alnum -> underscore, collapse underscores, trim)
    function slugifyName(name) {
        if (!name) return '';
        return name.toString().toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/__+/g, '_').replace(/^_|_$/g, '');
    }

    function uniqueSectionId(base) {
        base = slugifyName(base) || 'section';
        let ids = Array.from(document.querySelectorAll('input[name^="section_id_"]')).map(i => i.value.trim()).filter(Boolean);
        if (!ids.includes(base)) return base;
        let i = 1;
        while (ids.includes(`${base}_${i}`)) i++;
        return `${base}_${i}`;
    }

    function uniqueElementId(sectionEl, base) {
        base = slugifyName(base) || 'elem';
        let ids = Array.from(sectionEl.querySelectorAll('input[name*="element_id_"]')).map(i => i.value.trim()).filter(Boolean);
        if (!ids.includes(base)) return base;
        let i = 1;
        while (ids.includes(`${base}_${i}`)) i++;
        return `${base}_${i}`;
    }

    // Reorder helpers using up/down arrows ---------------------------------
    function moveSection(section, direction) {
        const parent = section.parentNode;
        if (direction < 0) {
            const prev = section.previousElementSibling;
            if (prev) parent.insertBefore(section, prev);
        } else {
            const next = section.nextElementSibling;
            if (next) parent.insertBefore(next, section);
        }
        updateSectionIndexes();
    }

    function moveElement(element, direction) {
        const container = element.parentNode;
        if (direction < 0) {
            const prev = element.previousElementSibling;
            if (prev) container.insertBefore(element, prev);
        } else {
            const next = element.nextElementSibling;
            if (next) container.insertBefore(next, element);
        }
        updateSectionIndexes();
    }

    function moveOption(row, direction) {
        const tbody = row.parentNode;
        if (direction < 0) {
            const prev = row.previousElementSibling;
            if (prev) tbody.insertBefore(row, prev);
        } else {
            const next = row.nextElementSibling;
            if (next) tbody.insertBefore(next, row);
        }
        // reindex options in this element
        const elem = row.closest('.element-item');
        const sec = row.closest('.section-item');
        if (elem && sec) {
            reindexOptionRows(sec.dataset.sectionIndex, elem.dataset.elementIndex);
        }
    }

    // no drag/drop initialization needed; arrow clicks handled globally


    // Auto-generate IDs when names change, but do not overwrite if user typed their own ID
    document.addEventListener('input', function(e) {
        // Section name -> section id
        const secNameEl = e.target.closest && e.target.closest('input[name^="section_name_"]');
        if (secNameEl) {
            const section = secNameEl.closest('.section-item');
            if (!section) return;
            const idInput = section.querySelector('input[name^="section_id_"]');
            if (!idInput) return;
            if (idInput.dataset.auto === 'false') return; // user has edited id manually
            const candidate = uniqueSectionId(secNameEl.value||secNameEl.placeholder||'section');
            idInput.value = candidate;
            idInput.dataset.auto = 'true';
            const display = section.querySelector('.generated-section-id');
            if (display) display.textContent = candidate;
            return;
        }

        // Element name -> element id
        const elemNameEl = e.target.closest && e.target.closest('input[name*="_name_"]');
        if (elemNameEl) {
            const element = elemNameEl.closest('.element-item');
            if (!element) return;
            const section = element.closest('.section-item');
            if (!section) return;
            const idInput = element.querySelector('input[name*="_id_"]');
            if (!idInput) return;
            if (idInput.dataset.auto === 'false') return;
            const candidate = uniqueElementId(section, elemNameEl.value||elemNameEl.placeholder||'elem');
            idInput.value = candidate;
            idInput.dataset.auto = 'true';
            const display = element.querySelector('.generated-element-id');
            if (display) display.textContent = candidate;
            return;
        }

        // If user manually edits an ID field, mark it as user-edited
        const idField = e.target.closest && e.target.closest('input[name^="section_id_"]');
        if (idField) {
            idField.dataset.auto = 'false';
            return;
        }
        const elemIdField = e.target.closest && e.target.closest('input[name*="_id_"]');
        if (elemIdField) {
            elemIdField.dataset.auto = 'false';
            return;
        }
    });

    // Initialize auto-id flags for existing fields (true = auto-managed, false = user-edited)
    document.querySelectorAll('.section-item').forEach(section => {
        const secName = section.querySelector('input[name^="section_name_"]');
        const secId = section.querySelector('input[name^="section_id_"]');
        const secDisplay = section.querySelector('.generated-section-id');
        if (secId && secName) {
            const expected = slugifyName(secName.value || secName.placeholder || 'section');
            if (!secId.value || secId.value.trim() === expected) {
                secId.dataset.auto = 'true';
            } else {
                secId.dataset.auto = 'false';
            }
            if (secDisplay) secDisplay.textContent = secId.value || '';
        }

        section.querySelectorAll('.element-item').forEach(element => {
            const nameEl = element.querySelector('input[name*="_name_"]');
            const idEl = element.querySelector('input[name*="_id_"]');
            const elDisp = element.querySelector('.generated-element-id');
            if (nameEl && idEl) {
                const expectedElem = uniqueElementId(section, nameEl.value || nameEl.placeholder || 'elem');
                if (!idEl.value || idEl.value.trim() === expectedElem) {
                    idEl.dataset.auto = 'true';
                } else {
                    idEl.dataset.auto = 'false';
                }
                if (elDisp) elDisp.textContent = idEl.value || '';
            }
        });
    });

    // Helper: Build JSON payload from UI
    function ensureAllIds() {
        document.querySelectorAll('.section-item').forEach(section => {
            const secIdInput = section.querySelector('input[name^="section_id_"]');
            const secNameInput = section.querySelector('input[name^="section_name_"]');
            const secDisplay = section.querySelector('.generated-section-id');
            if (secIdInput && (!secIdInput.value || secIdInput.value.trim() === '')) {
                const candidate = uniqueSectionId((secNameInput && secNameInput.value) ? secNameInput.value : 'section');
                secIdInput.value = candidate;
                if (secDisplay) secDisplay.textContent = candidate;
            }

            section.querySelectorAll('.element-item').forEach((el, elIdx) => {
                const idEl = el.querySelector('input[name*="_id_"]');
                const nameEl = el.querySelector('input[name*="_name_"]');
                const disp = el.querySelector('.generated-element-id');
                if (idEl && (!idEl.value || idEl.value.trim() === '')) {
                    const candidate = uniqueElementId(section, (nameEl && nameEl.value) ? nameEl.value : 'elem');
                    idEl.value = candidate;
                    if (disp) disp.textContent = candidate;
                }
                // Reindex option rows for this element to ensure contiguous indices
                try {
                    const secIdx = section.dataset.sectionIndex;
                    reindexOptionRows(secIdx, elIdx);
                } catch (err) {
                    // ignore
                }
            });
        });
    }

    function buildSimplePitPayload() {
        const payload = { pit_scouting: { title: '', description: '', sections: [] } };
        payload.pit_scouting.title = document.getElementById('title').value.trim();
        payload.pit_scouting.description = document.getElementById('description').value.trim();

        const sections = document.querySelectorAll('.section-item');
        sections.forEach((section) => {
            const sid = section.querySelector('input[name^="section_id_"]')?.value.trim();
            const sname = section.querySelector('input[name^="section_name_"]')?.value.trim();
            if (!sid || !sname) return; // skip invalid
            const sectionObj = { id: sid, name: sname, elements: [] };

            const elements = section.querySelectorAll('.element-item');
            elements.forEach((el) => {
                const eid = el.querySelector('input[name*="_id_"]')?.value.trim();
                const ename = el.querySelector('input[name*="_name_"]')?.value.trim();
                const etype = el.querySelector('select[name*="_type_"]')?.value;
                if (!eid || !ename || !etype) return;
                const elem = { id: eid, perm_id: eid, name: ename, type: etype };

                const def = el.querySelector(`input[name^="element_default_"]`);
                if (def && def.value) elem.default = def.value;
                const ph = el.querySelector(`input[name^="element_placeholder_"]`);
                if (ph && ph.value) elem.placeholder = ph.value;
                const req = el.querySelector(`input[name^="element_required_"]`);
                if (req && req.checked) elem.required = true;

                if (etype === 'number') {
                    const min = el.querySelector(`input[name^="element_min_"]`);
                    const max = el.querySelector(`input[name^="element_max_"]`);
                    const v = {};
                    if (min && min.value) v.min = parseFloat(min.value);
                    if (max && max.value) v.max = parseFloat(max.value);
                    if (Object.keys(v).length) elem.validation = v;
                }

                if (etype === 'select' || etype === 'multiselect') {
                    // gather options from table rows
                    const options = [];
                    const points = {};
                    const rows = el.querySelectorAll('.option-points-table tbody tr');
                    rows.forEach((r) => {
                        const val = r.querySelector('input[name*="element_option_value_"]')?.value.trim();
                        const lab = r.querySelector('input[name*="element_option_label_"]')?.value.trim() || val;
                        const ptsStr = r.querySelector('input[name*="element_option_points_"]')?.value;
                        const pts = ptsStr ? parseFloat(ptsStr) : 0;
                        if (val) {
                            options.push({ value: val, label: lab });
                            points[val] = pts;
                        }
                    });
                    // fallback: textarea format
                    if (options.length === 0) {
                        const textarea = el.querySelector('textarea[name*="element_options_"]');
                        if (textarea && textarea.value.trim()) {
                            const lines = textarea.value.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
                            lines.forEach((ln, idx) => {
                                const parts = ln.split('|');
                                const raw = parts[0].trim();
                                const v = slugifyName(raw);
                                const l = parts[1] ? parts[1].trim() : raw;
                                if (v) {
                                    options.push({ value: v, label: l });
                                    points[v] = 0;
                                }
                            });
                        }
                    }
                    if (options.length) {
                        elem.options = options;
                        elem.points = points;
                    }
                }

                sectionObj.elements.push(elem);
            });

            payload.pit_scouting.sections.push(sectionObj);
        });

        return payload;
    }

    document.getElementById('pitConfigForm').addEventListener('submit', function(e) {
        // Ensure all IDs are present/generate from names
        ensureAllIds();
        const errors = [];
        
        // Validate title
        const title = document.getElementById('title').value.trim();
        if (!title) {
            errors.push('Title is required');
        }
        
        // Validate sections
        const sections = document.querySelectorAll('.section-item');
        if (sections.length === 0) {
            errors.push('At least one section is required');
        }
        
        const sectionIds = new Set();
        sections.forEach((section, secIdx) => {
            const sectionId = section.querySelector('input[name^="section_id_"]');
            const sectionName = section.querySelector('input[name^="section_name_"]');
            
            if (!sectionId || !sectionId.value.trim()) {
                errors.push(`Section #${secIdx + 1}: Section ID is required`);
            } else if (sectionIds.has(sectionId.value.trim())) {
                errors.push(`Section #${secIdx + 1}: Duplicate section ID "${sectionId.value.trim()}"`);
            } else {
                sectionIds.add(sectionId.value.trim());
            }
            
            if (!sectionName || !sectionName.value.trim()) {
                errors.push(`Section #${secIdx + 1}: Section Name is required`);
            }
            
            // Validate elements
            const elements = section.querySelectorAll('.element-item');
            const elementIds = new Set();
            
            elements.forEach((element, elemIdx) => {
                const elemId = element.querySelector('input[name*="_id_"]');
                const elemName = element.querySelector('input[name*="_name_"]');
                const elemType = element.querySelector('select[name*="_type_"]');
                
                const secName = sectionName && sectionName.value.trim() ? sectionName.value.trim() : `Section #${secIdx + 1}`;
                
                if (!elemId || !elemId.value.trim()) {
                    errors.push(`${secName}, Element #${elemIdx + 1}: Element ID is required`);
                } else if (elementIds.has(elemId.value.trim())) {
                    errors.push(`${secName}: Duplicate element ID "${elemId.value.trim()}"`);
                } else {
                    elementIds.add(elemId.value.trim());
                }
                
                if (!elemName || !elemName.value.trim()) {
                    errors.push(`${secName}, Element #${elemIdx + 1}: Element Name is required`);
                }
                
                if (!elemType || !elemType.value) {
                    errors.push(`${secName}, Element #${elemIdx + 1}: Element Type is required`);
                }
                
                // Validate select/multiselect have options
                if (elemType && (elemType.value === 'select' || elemType.value === 'multiselect')) {
                    const optionInputs = element.querySelectorAll('input[name*="_option_value_"]');
                    let hasValidOption = false;
                    optionInputs.forEach(opt => {
                        if (opt.value.trim()) {
                            hasValidOption = true;
                        }
                    });
                    
                    // Check textarea fallback for new elements
                    if (!hasValidOption) {
                        const optionText = element.querySelector('textarea[name*="_options_"]');
                        if (optionText && optionText.value.trim()) {
                            hasValidOption = true;
                        }
                    }
                    
                    if (!hasValidOption) {
                        const elemIdVal = elemId && elemId.value.trim() ? elemId.value.trim() : `Element #${elemIdx + 1}`;
                        errors.push(`${secName}, ${elemIdVal}: Select/Multiselect must have at least one option`);
                    }
                }
            });
        });
        
        if (errors.length > 0) {
            e.preventDefault();
            let errorHtml = '<strong>Please fix the following errors:</strong><ul>';
            errors.forEach(err => {
                errorHtml += `<li>${err}</li>`;
            });
            errorHtml += '</ul>';
            
            // Show errors at top of form
            let errorDiv = document.getElementById('validationErrors');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'validationErrors';
                errorDiv.className = 'alert alert-danger';
                document.querySelector('.card-body form').prepend(errorDiv);
            }
            errorDiv.innerHTML = errorHtml;
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            return false;
        }

        // No validation errors - build JSON payload and submit via simple_payload for robust backend handling
        try {
            const payload = buildSimplePitPayload();
            document.getElementById('simple_payload').value = JSON.stringify(payload);
            // Allow form to submit normally; backend will prefer simple_payload
        } catch (err) {
            e.preventDefault();
            alert('Failed to prepare configuration payload. Please try again.');
            console.error('Payload build error', err);
            return false;
        }
    });
    
    // Add section functionality
    document.getElementById('addSection').addEventListener('click', function() {
        const sectionsContainer = document.getElementById('sectionsContainer');
        const newSection = createSectionElement(sectionIndex);
        sectionsContainer.appendChild(newSection);
        elementIndexes[sectionIndex] = 0;
        // Auto-generate section id immediately
        const idInput = newSection.querySelector(`input[name^="section_id_"]`);
        const nameInput = newSection.querySelector(`input[name^="section_name_"]`);
        const display = newSection.querySelector('.generated-section-id');
        if (idInput) {
            const candidate = uniqueSectionId(nameInput && nameInput.value ? nameInput.value : `section_${sectionIndex}`);
            idInput.value = candidate;
            if (display) display.textContent = candidate;
        }
        sectionIndex++;
        // update indexes after adding
        updateSectionIndexes();
    });
    
    // Remove section functionality (use closest to handle clicks on icon or button reliably)
    document.addEventListener('click', function(e) {
        const removeSectionBtn = e.target.closest && e.target.closest('.remove-section');
        if (removeSectionBtn) {
            const sectionItem = removeSectionBtn.closest('.section-item');
            if (!sectionItem) return;
            if (confirm('Are you sure you want to remove this section?')) {
                sectionItem.remove();
                updateSectionIndexes();
            }
        }
    });
    
    // Add element functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-element') || (e.target.parentElement && e.target.parentElement.classList.contains('add-element'))) {
            const button = e.target.closest('.add-element');
            const sectionIdx = parseInt(button.dataset.sectionIndex);
            const elementsContainer = button.previousElementSibling;
            const newElement = createElementElement(sectionIdx, elementIndexes[sectionIdx]);
            elementsContainer.appendChild(newElement);
            // Auto-generate element id immediately
            const idInput = newElement.querySelector(`input[name*="_id_"]`);
            const nameInput = newElement.querySelector(`input[name*="_name_"]`);
            const display = newElement.querySelector('.generated-element-id');
            const parentSection = newElement.closest('.section-item');
            if (idInput && parentSection) {
                const candidate = uniqueElementId(parentSection, (nameInput && nameInput.value) ? nameInput.value : `elem_${elementIndexes[sectionIdx]}`);
                idInput.value = candidate;
                if (display) display.textContent = candidate;
            }
            elementIndexes[sectionIdx]++;
            updateSectionIndexes();
        }
    });
    
    // Remove element functionality (use closest to handle clicks on icon or button reliably)
    document.addEventListener('click', function(e) {
        const removeElementBtn = e.target.closest && e.target.closest('.remove-element');
        if (removeElementBtn) {
            const elementItem = removeElementBtn.closest('.element-item');
            if (!elementItem) return;
            if (confirm('Are you sure you want to remove this element?')) {
                elementItem.remove();
                updateSectionIndexes();
            }
        }
    });
    
    // Element type change functionality
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('element-type-select')) {
            const elementItem = e.target.closest('.element-item');
            const elementType = e.target.value;
            const numberValidation = elementItem.querySelector('.number-validation');
            const selectOptions = elementItem.querySelector('.select-options');
            
            if (elementType === 'number') {
                if (numberValidation) numberValidation.classList.remove('d-none');
            } else {
                if (numberValidation) numberValidation.classList.add('d-none');
            }
            
            if (elementType === 'select' || elementType === 'multiselect') {
                if (selectOptions) selectOptions.classList.remove('d-none');
            } else {
                if (selectOptions) selectOptions.classList.add('d-none');
            }
        }
    });

    // Helper: ensure option rows are reindexed to contiguous indices
    function reindexOptionRows(sectionIndex, elementIndex) {
        const container = document.querySelector(`.section-item[data-section-index="${sectionIndex}"] .element-item[data-element-index="${elementIndex}"] .option-points-table tbody`);
        if (!container) return;
        const rows = Array.from(container.querySelectorAll('tr'));
        rows.forEach((row, idx) => {
            const val = row.querySelector('input[name*="element_option_value_"]');
            const lab = row.querySelector('input[name*="element_option_label_"]');
            const pts = row.querySelector('input[name*="element_option_points_"]');
            if (val) val.name = `element_option_value_${sectionIndex}_${elementIndex}_${idx}`;
            if (lab) lab.name = `element_option_label_${sectionIndex}_${elementIndex}_${idx}`;
            if (pts) pts.name = `element_option_points_${sectionIndex}_${elementIndex}_${idx}`;
        });
    }

    document.addEventListener('click', function(e) {
        const addOptionBtn = e.target.closest && e.target.closest('.add-option');
        if (addOptionBtn) {
            const sectionIndex = addOptionBtn.dataset.sectionIndex;
            const elementIndex = addOptionBtn.dataset.elementIndex;
            const container = document.querySelector(`.section-item[data-section-index="${sectionIndex}"] .element-item[data-element-index="${elementIndex}"] .option-points-table tbody`);
            if (!container) {
                console.error(`Tbody for options not found for section ${sectionIndex} element ${elementIndex}`);
                return;
            }
            const newOptionIndex = container.querySelectorAll('tr').length;
            const template = createOptionTemplate(sectionIndex, elementIndex, newOptionIndex);
            container.insertAdjacentHTML('beforeend', template);
            reindexOptionRows(sectionIndex, elementIndex);
            // reinitialize option row drag handlers for this element
            initOptionDrag();
        }

        // Section move buttons
        const moveSecUp = e.target.closest && e.target.closest('.move-section-up');
        if (moveSecUp) {
            const sec = moveSecUp.closest('.section-item');
            if (sec) moveSection(sec, -1);
        }
        const moveSecDown = e.target.closest && e.target.closest('.move-section-down');
        if (moveSecDown) {
            const sec = moveSecDown.closest('.section-item');
            if (sec) moveSection(sec, 1);
        }

        // Element move buttons
        const moveElUp = e.target.closest && e.target.closest('.move-element-up');
        if (moveElUp) {
            const el = moveElUp.closest('.element-item');
            if (el) moveElement(el, -1);
        }
        const moveElDown = e.target.closest && e.target.closest('.move-element-down');
        if (moveElDown) {
            const el = moveElDown.closest('.element-item');
            if (el) moveElement(el, 1);
        }

        // Option move buttons
        const moveOptUp = e.target.closest && e.target.closest('.move-option-up');
        if (moveOptUp) {
            const row = moveOptUp.closest('tr');
            if (row) moveOption(row, -1);
        }
        const moveOptDown = e.target.closest && e.target.closest('.move-option-down');
        if (moveOptDown) {
            const row = moveOptDown.closest('tr');
            if (row) moveOption(row, 1);
        }

        // Remove option row
        const removeOpt = e.target.closest && e.target.closest('.remove-option');
        if (removeOpt) {
            const row = removeOpt.closest('tr');
            if (row) {
                const elem = row.closest('.element-item');
                const sec = row.closest('.section-item');
                row.remove();
                if (elem && sec) {
                    reindexOptionRows(sec.dataset.sectionIndex, elem.dataset.elementIndex);
                }
            }
        }

        // Initialize auto-values for existing option labels (set hidden value if data-auto)
        document.querySelectorAll('.option-label').forEach(el => {
            const row = el.closest('tr');
            if (!row) return;
            const val = row.querySelector('input[name*="element_option_value_"]');
            const pts = row.querySelector('input[name*="element_option_points_"]');
            if (val && val.dataset && val.dataset.auto === 'true') {
                val.value = slugifyName(el.value || '');
            }
            if (pts && (pts.value === '' || pts.value === null)) pts.value = '0';
        });

        // Update hidden value when label changes; ensure points default to 0
        document.addEventListener('input', function(e) {
            if (e.target && e.target.classList && e.target.classList.contains('option-label')) {
                const row = e.target.closest('tr');
                if (!row) return;
                const valInput = row.querySelector('input[name*="element_option_value_"]');
                const ptsInput = row.querySelector('input[name*="element_option_points_"]');
                const slug = slugifyName(e.target.value || '');
                if (valInput && valInput.dataset.auto !== 'false') valInput.value = slug;
                if (ptsInput && (ptsInput.value === '' || ptsInput.value === null)) ptsInput.value = '0';
            }
        });
    });
});
function createOptionTemplate(sectionIndex, elementIndex, optionIndex) {
    return `
        <tr>
            <td class="move-option-cell text-center" style="width:1%;white-space:nowrap;">
                <button type="button" class="btn btn-sm btn-light move-option-up" title="Move option up"><i class="fas fa-arrow-up"></i></button>
                <button type="button" class="btn btn-sm btn-light move-option-down" title="Move option down"><i class="fas fa-arrow-down"></i></button>
            </td>
            <td><input type="text" class="form-control option-label" name="element_option_label_${sectionIndex}_${elementIndex}_${optionIndex}" required></td>
            <td style="display:none;">
                <input type="hidden" name="element_option_value_${sectionIndex}_${elementIndex}_${optionIndex}" value="" data-auto="true">
                <input type="hidden" name="element_option_points_${sectionIndex}_${elementIndex}_${optionIndex}" value="0">
            </td>
            <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger remove-option"><i class="fas fa-trash"></i></button></td>
        </tr>
    `;
}
    
    function createSectionElement(sectionIdx) {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'section-item card mb-3';
        sectionDiv.dataset.sectionIndex = sectionIdx;
        
        sectionDiv.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                <h4 class="mb-2 mb-md-0" style="font-size: 1.1rem;">
                    <span class="move-section-controls me-2">
                        <button type="button" class="btn btn-sm btn-light move-section-up" title="Move section up"><i class="fas fa-arrow-up"></i></button>
                        <button type="button" class="btn btn-sm btn-light move-section-down" title="Move section down"><i class="fas fa-arrow-down"></i></button>
                    </span>
                    <button class="btn btn-sm btn-link p-0 me-2 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#sectionCollapse${sectionIdx}">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <span class="section-label">Section <span class="section-number">${sectionIdx + 1}</span></span>
                </h4>
                <button type="button" class="btn btn-sm btn-danger remove-section">
                    <i class="fas fa-trash"></i> <span class="d-none d-sm-inline">Remove</span>
                </button>
            </div>
            <div class="collapse show" id="sectionCollapse${sectionIdx}">
            <div class="card-body">
                <div class="row">
                    <div class="col-12 col-md-6 mb-2">
                        <div class="form-group mb-0">
                            <label class="small">Section ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" name="section_id_${sectionIdx}" data-auto="true" required>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 mb-2">
                        <div class="form-group mb-0">
                            <label class="small">Section Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" name="section_name_${sectionIdx}" required>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <small class="text-muted">Generated Section ID: <code class="generated-section-id"></code></small>
                    </div>
                </div>
                </div>
                <h5 class="mt-3 mb-2" style="font-size: 1rem;">Elements</h5>
                <div class="elements-container" data-section-index="${sectionIdx}">
                </div>
                <button type="button" class="btn btn-success add-element" data-section-index="${sectionIdx}">
                    <i class="fas fa-plus"></i> Add Element
                </button>
            </div>
            </div>
        `;
        
        return sectionDiv;
    }
    
    function createElementElement(sectionIdx, elementIdx) {
        const elementDiv = document.createElement('div');
        elementDiv.className = 'element-item border p-2 p-md-3 mb-2';
        elementDiv.dataset.elementIndex = elementIdx;
        
        elementDiv.innerHTML = `
            <div class="row">
                <div class="col-12 d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0" style="font-size: 0.95rem;"><span class="move-element-controls me-2">
                        <button type="button" class="btn btn-sm btn-light move-element-up" title="Move element up"><i class="fas fa-arrow-up"></i></button>
                        <button type="button" class="btn btn-sm btn-light move-element-down" title="Move element down"><i class="fas fa-arrow-down"></i></button>
                    </span><span class="element-label">Element <span class="element-number">${elementIdx + 1}</span></span></h6>
                    <button type="button" class="btn btn-sm btn-danger remove-element">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-4 mb-2">
                    <div class="form-group mb-0">
                        <label class="small">Element Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" name="element_name_${sectionIdx}_${elementIdx}" required>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-2">
                    <div class="form-group mb-0">
                        <small class="text-muted">Generated Element ID: <code class="generated-element-id"></code></small>
                        <input type="hidden" class="form-control form-control-sm" name="element_id_${sectionIdx}_${elementIdx}" data-auto="true" required>
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-2">
                    <div class="form-group mb-0">
                        <label class="small">Element Type <span class="text-danger">*</span></label>
                        <select class="form-control form-control-sm element-type-select" name="element_type_${sectionIdx}_${elementIdx}" required>
                            <option value="text">Text</option>
                            <option value="textarea">Textarea</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="select">Select</option>
                            <option value="multiselect">Multi-select</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 col-md-4 mb-2">
                    <div class="form-group mb-0">
                        <label class="small">Default Value</label>
                        <input type="text" class="form-control form-control-sm" name="element_default_${sectionIdx}_${elementIdx}">
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-2">
                    <div class="form-group mb-0">
                        <label class="small">Placeholder</label>
                        <input type="text" class="form-control form-control-sm" name="element_placeholder_${sectionIdx}_${elementIdx}">
                    </div>
                </div>
                <div class="col-12 col-md-4 mb-2">
                    <div class="form-check pt-4">
                        <input type="checkbox" class="form-check-input" name="element_required_${sectionIdx}_${elementIdx}">
                        <label class="form-check-label">Required</label>
                    </div>
                </div>
            </div>
            <div class="number-validation row d-none">
                <div class="col-12 col-md-6 mb-2">
                    <div class="form-group mb-0">
                        <label class="small">Min Value</label>
                        <input type="number" class="form-control form-control-sm" name="element_min_${sectionIdx}_${elementIdx}">
                    </div>
                </div>
                <div class="col-12 col-md-6 mb-2">
                    <div class="form-group mb-0">
                        <label class="small">Max Value</label>
                        <input type="number" class="form-control form-control-sm" name="element_max_${sectionIdx}_${elementIdx}">
                    </div>
                </div>
            </div>
            <div class="select-options d-none">
                <div class="form-group mb-0">
                    <label class="small">Options and Points <span class="text-danger">*</span></label>
                    <small class="form-text text-muted d-block mb-2">Add options below and set optional point values.</small>
                    <div class="table-responsive">
                    <table class="table table-bordered table-sm option-points-table">
                        <thead>
                            <tr><th>Option Name</th><th></th></tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    </div>
                    <button type="button" class="btn btn-sm btn-success add-option" data-section-index="${sectionIdx}" data-element-index="${elementIdx}">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
            </div>
        `;
        
        return elementDiv;
    }
    
    function updateSectionIndexes() {
        const sections = document.querySelectorAll('.section-item');
        sections.forEach((section, index) => {
            section.dataset.sectionIndex = index;
            
            // Update collapse IDs and targets for mobile compatibility
            const collapseDiv = section.querySelector('.collapse');
            const collapseButton = section.querySelector('[data-bs-toggle="collapse"]');
            if (collapseDiv) {
                collapseDiv.id = `sectionCollapse${index}`;
            }
            if (collapseButton) {
                collapseButton.setAttribute('data-bs-target', `#sectionCollapse${index}`);
            }
            
            // Update section header number
            const headerNum = section.querySelector('.section-number');
            if (headerNum) {
                headerNum.textContent = index + 1;
            }
            
            // Update form field names
            const sectionIdInput = section.querySelector('input[name^="section_id_"]');
            const sectionNameInput = section.querySelector('input[name^="section_name_"]');
            
            if (sectionIdInput) sectionIdInput.name = `section_id_${index}`;
            if (sectionNameInput) sectionNameInput.name = `section_name_${index}`;
            
            // Update elements container data attribute
            const elementsContainer = section.querySelector('.elements-container');
            if (elementsContainer) {
                elementsContainer.dataset.sectionIndex = index;
            }
            
            // Update element names
            const elements = section.querySelectorAll('.element-item');
            elements.forEach((element, elementIndex) => {
                element.dataset.elementIndex = elementIndex;
                const elementNum = element.querySelector('.element-number');
                if (elementNum) {
                    elementNum.textContent = elementIndex + 1;
                }
                
                // Update all form field names for this element
                const inputs = element.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    // Handle option inputs: element_option_<type>_<sec>_<elem>_<opt>
                    const optMatch = input.name.match(/^element_option_(value|label|points)_(\d+)_(\d+)_(\d+)$/);
                    if (optMatch) {
                        const optType = optMatch[1];
                        const optIdx = optMatch[4];
                        input.name = `element_option_${optType}_${index}_${elementIndex}_${optIdx}`;
                        return;
                    }

                    // Generic element fields: element_<field>_<sec>_<elem>
                    const fieldMatch = input.name.match(/^element_(\w+)_(\d+)_(\d+)$/);
                    if (fieldMatch) {
                        const fieldType = fieldMatch[1];
                        input.name = `element_${fieldType}_${index}_${elementIndex}`;
                    }
                });

                // Update add-option button dataset (if present)
                const addOptionBtn = element.querySelector('.add-option');
                if (addOptionBtn) {
                    addOptionBtn.dataset.sectionIndex = index;
                    addOptionBtn.dataset.elementIndex = elementIndex;
                }
            });
            
            // Update add element button
            const addElementBtn = section.querySelector('.add-element');
            if (addElementBtn) {
                addElementBtn.dataset.sectionIndex = index;
            }
        });
    }
    </script>
    <!-- Reset to Default Modal for simple pit editor -->
    <div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetModalLabel">Reset Pit Configuration to Default</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('pit_scouting.config_reset') }}" method="POST">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> This will replace the current pit config with the selected default and cannot be undone.
                        </div>
                        <div class="mb-3">
                            <label for="default_config" class="form-label">Select Default Configuration:</label>
                            <select name="default_config" id="default_config" class="form-select" required>
                                <option value="">-- Select a default configuration --</option>
                                {% if default_configs %}
                                    {% for config in default_configs %}
                                        {% if config.type == 'pit' %}
                                            <option value="{{ config.filename }}">{{ config.display_name }} ({{ config.basename or config.filename }})</option>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>No default configurations found</option>
                                {% endif %}
                            </select>
                            <small class="form-text text-muted">Choose from pre-configured pit setups for different seasons.</small>
                        </div>
                        <input type="hidden" name="config_type" value="pit">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Reset Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
<style>
/* Mobile-responsive improvements */
@media (max-width: 767px) {
    .card-header {
        flex-direction: column !important;
        align-items: flex-start !important;
    }
    
    .card-header .card-title {
        font-size: 1.1rem;
    }
    
    .card-tools {
        width: 100%;
    }
    
    .card-tools .btn {
        flex: 1;
    }
    
    .element-item {
        font-size: 0.9rem;
    }
    
    .form-control-sm {
        font-size: 0.875rem;
    }
    
    .section-item .card-header h4 {
        font-size: 1rem !important;
    }
    
    /* Make tables scrollable on mobile */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Larger touch targets for mobile */
    .btn {
        min-height: 44px;
        padding: 0.5rem 0.75rem;
    }
    
    .btn-sm {
        min-height: 38px;
        padding: 0.4rem 0.6rem;
    }
    
    /* Better spacing on mobile */
    .form-group {
        margin-bottom: 0.75rem;
    }
    
    .alert {
        font-size: 0.9rem;
    }
    
    /* Stack buttons full width */
    .d-grid .btn {
        width: 100%;
    }
}

@media (min-width: 768px) {
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
}

/* Dark mode improvements */
body.dark-mode .card { 
    background: var(--card-bg) !important; 
    color: var(--bs-body-color) !important; 
}

body.dark-mode .form-control, 
body.dark-mode .form-select,
body.dark-mode .form-control-sm { 
    background: #0f0f11; 
    border-color: rgba(255,255,255,0.05); 
    color: var(--bs-body-color); 
}

body.dark-mode .element-item {
    background: transparent;
    border-color: rgba(255,255,255,0.1);
}

.section-item .card-header { 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
}

.element-item { 
    background: transparent; 
}

.option-points-table input { 
    background: transparent; 
}

/* Collapsible chevron rotation */
.btn-link i.fa-chevron-down {
    transition: transform 0.3s ease;
}

.btn-link[aria-expanded="false"] i.fa-chevron-down {
    transform: rotate(-90deg);
}

/* Touch-friendly form controls */
@media (hover: none) and (pointer: coarse) {
    /* Mobile touch devices */
    input[type="text"],
    input[type="number"],
    select,
    textarea {
        font-size: 16px !important; /* Prevent zoom on iOS */
    }
    
    .form-control,
    .form-select {
        min-height: 44px;
    }
    
    .form-control-sm {
        min-height: 38px;
    }
}

/* Better mobile modal */
@media (max-width: 576px) {
    .modal-dialog {
        margin: 0.5rem;
    }
    
    .modal-title {
        font-size: 1rem;
    }
}

/* Reorderable items cursor/dragging appearance - arrows used instead */
.section-item, .element-item, .option-points-table tbody tr {
    /* cursor left as default */
}
.section-item.dragging, .element-item.dragging, .option-points-table tbody tr.dragging {
    /* no drag state */
}

/* Button spacing for move controls */
.move-section-controls .btn,
.move-element-controls .btn,
.move-option-cell .btn {
    padding: 0.25rem 0.4rem;
}
.move-option-cell {
    white-space: nowrap;
}

</style>
{% endblock %}
