{% extends 'base.html' %}

{% block title %}Scouting Dashboard{% endblock %}

{% block heading %}Scouting Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h2 class="mb-0">Scouting Dashboard</h2>
            <p class="text-muted mb-0">Quick access to scouting tools, offline data, and configuration.</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('scouting.scouting_form') }}" class="btn btn-lg btn-primary shadow-sm" id="start-scouting">
                <i class="fas fa-rocket me-2"></i> Start Scouting
            </a>
            <a href="{{ url_for('scouting.list_data') }}" class="btn btn-outline-secondary align-self-center d-none d-md-inline">
                <i class="fas fa-list me-2"></i> All Data
            </a>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-12 col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Offline Data</h5>
                    <p class="card-text text-muted">Manage data saved locally on this device. Sync when online to send saved forms to the server.</p>
                    <div id="offline-data-container">
                        <!-- Populated by setupOfflineDataManager -->
                        <div class="d-flex align-items-center justify-content-center py-4">
                            <div class="spinner-border me-3" role="status"><span class="visually-hidden">Loading...</span></div>
                            <div>Loading offline data…</div>
                        </div>
                    </div>
                </div>
                    <div class="card-footer bg-transparent d-flex justify-content-between">
                        <small class="text-muted">Local storage</small>
                        <div>
                            <button id="refresh-offline-data" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-sync"></i>
                            </button>
                            <!-- Generate QR removed from offline data card by request -->
                        </div>
                    </div>
            </div>
        </div>

        <div class="col-12 col-lg-8">
            <div class="row g-3">
                <div class="col-12">
                    <div class="card h-100 shadow-sm {% if current_user.has_role('scout') and not current_user.has_role('analytics') and not current_user.has_role('admin') %}border-secondary{% endif %}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Recent Scouting Data</h5>
                                {% if current_user.has_role('scout') and not current_user.has_role('analytics') and not current_user.has_role('admin') %}
                                <small class="text-muted"><i class="fas fa-lock me-1"></i> Limited access</small>
                                {% endif %}
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('scouting.view_text_elements') }}" class="btn btn-sm btn-outline-info">Text Elements</a>
                                <a href="{{ url_for('scouting.list_data') }}" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                        </div>
                        <div class="card-body">
                            {% set recent_data = scouting_data|default([]) %}
                            {% if recent_data %}
                            <div class="list-group">
                                {% for data in recent_data %}
                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold">Team {{ data.team.team_number }} <small class="text-muted">— {{ data.scout_name }}</small></div>
                                        <div class="small text-muted">
                                            <span class="badge {% if data.match.match_type == 'Qualification' %}bg-primary{% elif data.match.match_type == 'Playoff' %}bg-danger{% elif data.match.match_type == 'Practice' %}bg-success{% else %}bg-secondary{% endif %} me-2">{{ data.match.match_type }}</span>
                                            Match {{ data.match.match_number }} • {{ data.timestamp.strftime('%m/%d/%Y %H:%M') }}
                                        </div>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('scouting.view_data', id=data.id) }}" class="btn btn-outline-primary {% if current_user.has_role('scout') and not current_user.has_role('analytics') and not current_user.has_role('admin') %}disabled{% endif %}"><i class="fas fa-eye"></i></a>
                                        <a href="{{ url_for('scouting.scouting_form', team_id=data.team_id, match_id=data.match_id) }}" class="btn btn-outline-warning {% if current_user.has_role('scout') and not current_user.has_role('analytics') and not current_user.has_role('admin') %}disabled{% endif %}"><i class="fas fa-edit"></i></a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <p class="mb-1">No scouting data available yet.</p>
                                <a href="{{ url_for('scouting.scouting_form') }}" class="btn btn-primary">Create new scouting entry</a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Game Configuration card removed as requested -->
            </div>
        </div>
    </div>

    <!-- Connectivity Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="connectivity-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="2000">
            <div class="toast-header">
                <span id="connectivity-icon" class="me-2"></span>
                <strong class="me-auto" id="connectivity-status">Connection Status</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="connectivity-message">Your connection status changed</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle team and match selection
        const teamSelector = document.getElementById('team-selector');
        const matchSelector = document.getElementById('match-selector');
        const startButton = document.getElementById('start-scouting');
        
        // Style match type dropdown options
        const matchOptions = matchSelector?.querySelectorAll('option') || [];
        matchOptions.forEach(option => {
            if (option.value) {
                const matchType = option.getAttribute('data-match-type');
                let textClass = '';
                
                if (matchType === 'Qualification') {
                    textClass = 'text-primary';
                } else if (matchType === 'Playoff') {
                    textClass = 'text-danger';
                } else if (matchType === 'Practice') {
                    textClass = 'text-success';
                }
                
                if (textClass) {
                    option.classList.add(textClass, 'fw-bold');
                }
            }
        });
        
        // Enable/disable start button based on selections
        function checkSelections() {
            if (teamSelector && matchSelector && startButton) {
                if (teamSelector.value && matchSelector.value) {
                    startButton.disabled = false;
                } else {
                    startButton.disabled = true;
                }
            }
        }
        
        if (teamSelector && matchSelector) {
            teamSelector.addEventListener('change', checkSelections);
            matchSelector.addEventListener('change', checkSelections);
        }
        
        // Online/Offline status handling
        function updateConnectivityStatus() {
            const toast = document.getElementById('connectivity-toast');
            const bsToast = bootstrap.Toast.getOrCreateInstance(toast);
            const statusElem = document.getElementById('connectivity-status');
            const msgElem = document.getElementById('connectivity-message');
            const iconElem = document.getElementById('connectivity-icon');
            
            if (navigator.onLine) {
                statusElem.textContent = 'Online';
                msgElem.textContent = 'Connection restored. You can now sync your data.';
                iconElem.innerHTML = '<i class="fas fa-wifi text-success"></i>';
                document.getElementById('refresh-offline-data')?.click();
            } else {
                statusElem.textContent = 'Offline';
                msgElem.textContent = 'You are offline. Data will be stored locally.';
                iconElem.innerHTML = '<i class="fas fa-wifi-slash text-warning"></i>';
            }
            
            bsToast.show();
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateConnectivityStatus);
        window.addEventListener('offline', updateConnectivityStatus);
    });
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/scale-ui.css') }}">
<script src="{{ url_for('static', filename='js/scale-ui.js') }}"></script>
{% endblock %}