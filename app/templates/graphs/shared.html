<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ shared_graph.title }} - Shared Graphs</title>
    
    <!-- Bootstrap CSS -->
    <link href="{{ url_for('static', filename='css/vendor/bootstrap.min.css') }}" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vendor/fontawesome-all.min.css') }}">
    <!-- Plotly.js (local) -->
    <script src="{{ url_for('static', filename='js/vendor/plotly-latest.min.js') }}"></script>
    
    <style>
        .shared-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .graph-container {
            margin-bottom: 2rem;
        }
        .watermark {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.1);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: #6c757d;
        }
        .view-count {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .team-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .team-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="shared-header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1 class="mb-3">
                        <i class="fas fa-chart-line me-3"></i>{{ shared_graph.title }}
                    </h1>
                    {% if shared_graph.description %}
                    <p class="lead mb-3">{{ shared_graph.description }}</p>
                    {% endif %}
                    
                    <!-- Graph Information -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex flex-column gap-2">
                                <div>
                                    <i class="fas fa-users me-2"></i>
                                    <strong>Teams:</strong>
                                    {% if teams|length <= 10 %}
                                    <div class="team-list mt-1">
                                        {% for team in teams %}
                                        <span class="team-badge">Team {{ team.team_number }}</span>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="mt-1">
                                        <span class="badge bg-primary">{{ teams|length }} teams</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#teamList" aria-expanded="false">
                                            <i class="fas fa-list me-1"></i>View All Teams
                                        </button>
                                        <div class="collapse mt-2" id="teamList">
                                            <div class="team-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem;">
                                                {% for team in teams %}
                                                <span class="team-badge">Team {{ team.team_number }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if shared_graph.event %}
                                <div>
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    <strong>Event:</strong> {{ shared_graph.event.name }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column gap-2">
                                <div>
                                    <i class="fas fa-chart-bar me-2"></i>
                                    <strong>Metric:</strong> {{ shared_graph.metric|title if shared_graph.metric and shared_graph.metric != 'points' else 'Total Points' }}
                                </div>
                                <div>
                                    <i class="fas fa-eye me-2"></i>
                                    <strong>Data View:</strong> {{ shared_graph.data_view|title }}
                                </div>
                                <div>
                                    <i class="fas fa-chart-pie me-2"></i>
                                    <strong>Graph Types:</strong> {{ shared_graph.graph_types_list|join(', ')|title }}
                                </div>
                                {% if teams|length > 10 %}
                                <div>
                                    <i class="fas fa-database me-2"></i>
                                    <strong>Dataset:</strong> {{ teams|length }} teams analyzed
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Meta Information -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-light">
                                <i class="fas fa-user me-1"></i>Shared by Team {{ shared_graph.created_by_team }}
                                <span class="ms-3">
                                    <i class="fas fa-clock me-1"></i>{{ shared_graph.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                </span>
                                <span class="ms-3 view-count">
                                    <i class="fas fa-eye me-1"></i>{{ shared_graph.view_count }} view{{ 's' if shared_graph.view_count != 1 else '' }}
                                </span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Viewer Filters: allow selecting teams and graph types -->
        <div class="row mb-4">
            <div class="col-12">
                <form class="card p-3" method="get" action="">
                    <div class="row g-2 align-items-center">
                        <div class="col-12 col-md-6">
                            <label class="form-label"><i class="fas fa-users me-2"></i>Teams to show</label>
                            <!-- Dropdown checklist that works on mobile (tap to toggle). Updates hidden `teams` input. -->
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="teamsDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                    Select Teams
                                </button>
                                <div class="dropdown-menu p-2" aria-labelledby="teamsDropdownBtn" style="width:100%; max-height: 300px; overflow: hidden;">
                                    <div class="mb-2">
                                        <input type="search" id="teams_search" class="form-control form-control-sm" placeholder="Search teams...">
                                    </div>
                                    <div id="teams_checklist" class="list-group" style="max-height:220px; overflow-y: auto;">
                                        {% for team in teams %}
                                        <label class="list-group-item d-flex align-items-center">
                                            <input class="form-check-input me-2 teams-checkbox" type="checkbox" value="{{ team.team_number }}" checked>
                                            <span>Team {{ team.team_number }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                    <div class="mt-2 d-flex gap-2">
                                        <button type="button" id="teams_select_all" class="btn btn-sm btn-outline-primary">Select All</button>
                                        <button type="button" id="teams_clear_all" class="btn btn-sm btn-outline-secondary">Clear</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden input that stores comma-separated teams for the backend -->
                            <input type="hidden" name="teams" id="teams_hidden_input" value="{{ teams|map(attribute='team_number')|join(',') }}">
                            <div class="form-text">Tap teams to toggle selection. Use the search box to filter. Selected teams are submitted with the form.</div>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label"><i class="fas fa-chart-pie me-2"></i>Graph Types</label>
                            <div class="card p-2">
                                <div class="d-flex flex-wrap gap-2">
                                    {% for g in available_graph_types %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="graph_types" value="{{ g }}" id="graph_type_{{ g }}" {% if g in selected_graph_types %}checked{% endif %}>
                                        <label class="form-check-label" for="graph_type_{{ g }}">{{ g|title }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-text">Tap to toggle graph types. Leave all unchecked to use the original share settings.</div>
                        </div>
                        <div class="col-md-2 d-grid">
                            <label class="form-label d-block invisible">Apply</label>
                            <button type="submit" class="btn btn-primary">Apply Filters</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% if plots %}
        <!-- DEBUG: show selected graph types and plots keys -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card border-warning bg-light">
                    <div class="card-body small">
                        <strong>Debug Info:</strong>
                        <div>Selected graph types (backend): {{ selected_graph_types }}</div>
                        <div>Original share graph types: {{ shared_graph.graph_types_list }}</div>
                        <div>Available graph types: {{ available_graph_types }}</div>
                        <div>Plots generated: {{ plots.keys()|list }}</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Generated Graphs -->
        <div class="row">
            {% for plot_id, plot_json in plots.items() %}
            <div class="col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div id="{{ plot_id }}" class="plotly-graph" data-graph='{{ plot_json }}' style="height: 500px;"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Data Summary -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>Data Summary
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="border-end h-100 d-flex flex-column justify-content-center">
                                    <h4 class="text-primary mb-1">{{ teams|length }}</h4>
                                    <small class="text-muted">Team{{ 's' if teams|length != 1 else '' }} Analyzed</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end h-100 d-flex flex-column justify-content-center">
                                    <h4 class="text-success mb-1">{{ shared_graph.graph_types_list|length }}</h4>
                                    <small class="text-muted">Graph Type{{ 's' if shared_graph.graph_types_list|length != 1 else '' }}</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border-end h-100 d-flex flex-column justify-content-center">
                                    <h4 class="text-info mb-1">{{ shared_graph.metric|title if shared_graph.metric and shared_graph.metric != 'points' else 'Total Points' }}</h4>
                                    <small class="text-muted">Primary Metric</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="h-100 d-flex flex-column justify-content-center">
                                    <h4 class="text-warning mb-1">{{ shared_graph.data_view|title }}</h4>
                                    <small class="text-muted">Data View</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- No Data Message -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    No data is currently available for the teams and configuration specified in this shared graph.
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Info Section -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle me-2"></i>About This Shared Graph
                        </h5>
                        <p class="card-text">
                            This is a read-only view of scouting data graphs. The data shown reflects the configuration 
                            set by the sharing team at the time this link was created.
                        </p>
                        <p class="card-text">
                            <small class="text-muted">
                                Powered by Scout2026 Scouting System
                                {% if shared_graph.expires_at %}
                                <br>This link expires on {{ shared_graph.expires_at.strftime('%B %d, %Y') }}
                                {% endif %}
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Watermark -->
    <div class="watermark">
        <i class="fas fa-chart-line me-1"></i>Shared Graph
    </div>

    <!-- Bootstrap JS -->
    <script src="{{ url_for('static', filename='js/vendor/bootstrap.bundle.min.js') }}"></script>
    
    <!-- Plotly Graph Rendering -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Render all Plotly graphs
            document.querySelectorAll('.plotly-graph').forEach(function(element) {
                try {
                    const graphData = JSON.parse(element.getAttribute('data-graph'));
                    const config = {
                        responsive: true,
                        displayModeBar: true,
                        modeBarButtonsToRemove: ['sendDataToCloud', 'editInChartStudio'],
                        displaylogo: false,
                        toImageButtonOptions: {
                            format: 'png',
                            filename: 'shared_graph',
                            height: 500,
                            width: 800,
                            scale: 1
                        }
                    };
                    
                    // Ensure charts match the client's theme (card background / text color)
                    try {
                        const cardEl = element.closest('.card') || element.parentElement;
                        const computed = cardEl ? getComputedStyle(cardEl) : getComputedStyle(document.body);
                        // Fallback to body background if card background is transparent
                        let bg = computed.backgroundColor;
                        if (!bg || bg === 'rgba(0, 0, 0, 0)' || bg === 'transparent') {
                            bg = getComputedStyle(document.body).backgroundColor || 'rgba(0,0,0,0)';
                        }
                        const textColor = computed.color || getComputedStyle(document.body).color || '#000';

                        // Helper: convert rgb/rgba to rgba with new alpha
                        function rgbaWithAlpha(rgbString, alpha) {
                            if (!rgbString) return `rgba(128,128,128,${alpha})`;
                            const m = rgbString.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([0-9.]+))?\)/);
                            if (m) {
                                return `rgba(${m[1]}, ${m[2]}, ${m[3]}, ${alpha})`;
                            }
                            // hex fallback
                            const hex = rgbString.replace('#','');
                            if (hex.length === 6) {
                                const r = parseInt(hex.substr(0,2),16);
                                const g = parseInt(hex.substr(2,2),16);
                                const b = parseInt(hex.substr(4,2),16);
                                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                            }
                            return `rgba(128,128,128,${alpha})`;
                        }

                        // Apply theme-derived values to layout
                        graphData.layout = graphData.layout || {};
                        // Remove any Plotly template (e.g., plotly_dark) that can override colors
                        graphData.layout.template = null;
                        graphData.layout.plot_bgcolor = bg;
                        graphData.layout.paper_bgcolor = bg;
                        graphData.layout.font = graphData.layout.font || {};
                        graphData.layout.font.color = textColor;

                        // Axis grid/line colors (force-override any server template values)
                        const subtleGrid = rgbaWithAlpha(textColor, 0.12);
                        const faintLine = rgbaWithAlpha(textColor, 0.06);
                        if (!graphData.layout.xaxis) graphData.layout.xaxis = {};
                        if (!graphData.layout.yaxis) graphData.layout.yaxis = {};
                        graphData.layout.xaxis.gridcolor = subtleGrid;
                        graphData.layout.yaxis.gridcolor = subtleGrid;
                        graphData.layout.xaxis.zerolinecolor = faintLine;
                        graphData.layout.yaxis.zerolinecolor = faintLine;

                        // Axis tick colors
                        if (graphData.layout.xaxis) {
                            graphData.layout.xaxis.tickfont = graphData.layout.xaxis.tickfont || {};
                            graphData.layout.xaxis.tickfont.color = textColor;
                        }
                        if (graphData.layout.yaxis) {
                            graphData.layout.yaxis.tickfont = graphData.layout.yaxis.tickfont || {};
                            graphData.layout.yaxis.tickfont.color = textColor;
                        }

                        // Legend text
                        if (graphData.layout.legend) {
                            graphData.layout.legend.font = graphData.layout.legend.font || {};
                            graphData.layout.legend.font.color = textColor;
                        }

                        // Annotations default color
                        if (graphData.layout.annotations) {
                            graphData.layout.annotations.forEach(function(a) {
                                if (!a.font) a.font = {};
                                a.font.color = a.font.color || textColor;
                            });
                        }

                        // Polar charts (radar)
                        if (graphData.layout.polar) {
                            graphData.layout.polar.angularaxis = graphData.layout.polar.angularaxis || {};
                            graphData.layout.polar.radialaxis = graphData.layout.polar.radialaxis || {};
                            graphData.layout.polar.angularaxis.tickfont = graphData.layout.polar.angularaxis.tickfont || {};
                            graphData.layout.polar.radialaxis.tickfont = graphData.layout.polar.radialaxis.tickfont || {};
                            graphData.layout.polar.angularaxis.tickfont.color = textColor;
                            graphData.layout.polar.radialaxis.tickfont.color = textColor;
                            // Force polar radial grid to be subtle and visible in both themes
                            graphData.layout.polar.radialaxis.gridcolor = rgbaWithAlpha(textColor, 0.12);
                        }
                    } catch (e) {
                        console.warn('Failed to compute theme for Plotly chart:', e);
                    }

                    // Plot then force a relayout to override any server-provided template values
                    Promise.resolve(Plotly.newPlot(element.id, graphData.data, graphData.layout, config))
                        .then(function() {
                            try {
                                const relayout = {
                                    'template': null,
                                    'plot_bgcolor': graphData.layout.plot_bgcolor,
                                    'paper_bgcolor': graphData.layout.paper_bgcolor,
                                    'font.color': graphData.layout.font && graphData.layout.font.color || textColor,
                                    'legend.font.color': (graphData.layout.legend && graphData.layout.legend.font && graphData.layout.legend.font.color) || textColor,
                                    'xaxis.tickfont.color': (graphData.layout.xaxis && graphData.layout.xaxis.tickfont && graphData.layout.xaxis.tickfont.color) || textColor,
                                    'yaxis.tickfont.color': (graphData.layout.yaxis && graphData.layout.yaxis.tickfont && graphData.layout.yaxis.tickfont.color) || textColor,
                                    'xaxis.gridcolor': (graphData.layout.xaxis && graphData.layout.xaxis.gridcolor) || rgbaWithAlpha(textColor, 0.12),
                                    'yaxis.gridcolor': (graphData.layout.yaxis && graphData.layout.yaxis.gridcolor) || rgbaWithAlpha(textColor, 0.12),
                                    'xaxis.zerolinecolor': (graphData.layout.xaxis && graphData.layout.xaxis.zerolinecolor) || rgbaWithAlpha(textColor, 0.06),
                                    'yaxis.zerolinecolor': (graphData.layout.yaxis && graphData.layout.yaxis.zerolinecolor) || rgbaWithAlpha(textColor, 0.06)
                                };

                                // Polar-specific overrides (dot notation)
                                if (graphData.layout.polar) {
                                    relayout['polar.radialaxis.gridcolor'] = graphData.layout.polar.radialaxis.gridcolor || rgbaWithAlpha(textColor, 0.12);
                                    relayout['polar.angularaxis.tickfont.color'] = graphData.layout.polar.angularaxis.tickfont.color || textColor;
                                    relayout['polar.radialaxis.tickfont.color'] = graphData.layout.polar.radialaxis.tickfont.color || textColor;
                                }

                                Plotly.relayout(element.id, relayout);
                            } catch (e) {
                                console.warn('Failed to relayout Plotly chart to client theme:', e);
                            }
                        })
                        .catch(function(err){
                            console.warn('Plotly plot error or relayout skipped:', err);
                        });
                } catch (error) {
                    console.error('Error rendering graph:', error);
                    element.innerHTML = '<div class="alert alert-danger">Error loading graph</div>';
                }
            });
        });
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Select2 for the teams/graph_types/event selectors if present
        function initSharedSelects() {
            if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') return;

            // Teams: initialize Select2 on #teams_select (desktop). The textarea remains for mobile.
            const teamsSelectEl = $('#teams_select');
            if (teamsSelectEl.length) {
                try {
                    teamsSelectEl.select2({theme: 'bootstrap-5', width: '100%', placeholder: 'Select teams...'});
                } catch (e) {
                    console.warn('Select2 init failed for #teams_select', e);
                }
            }

            const graphTypesEl = $('select[name="graph_types"]');
            if (graphTypesEl.length) {
                try {
                    graphTypesEl.select2({theme: 'bootstrap-5', width: '100%'});
                } catch (e) {
                    console.warn('Select2 init failed for graph_types', e);
                }
            }

            const eventEl = $('#event_id');
            if (eventEl.length) {
                try { eventEl.select2({theme: 'bootstrap-5', width: '100%'}); } catch (e) {}
            }
        }

        initSharedSelects();

        // Quick-select handlers for graph types (mimic index page behavior)
        $('#select-basic-graphs').on('click', function() { $('select[name="graph_types"]').val(['bar','line','scatter','area']).trigger('change'); });
        $('#select-distribution-graphs').on('click', function() { $('select[name="graph_types"]').val(['box','violin','histogram']).trigger('change'); });
        $('#select-advanced-graphs').on('click', function() { $('select[name="graph_types"]').val(['radar','heatmap','bubble','sunburst','treemap']).trigger('change'); });
        $('#clear-graph-types').on('click', function() { $('select[name="graph_types"]').val(null).trigger('change'); });

        // When the filter form is submitted, if the desktop multi-select is visible, convert its selected values
        // into a single comma-separated `teams` query parameter so the backend can read it the same as textarea input.
        $('form').on('submit', function(e) {
            const select = $('#teams_select');
            if (select.length && select.is(':visible')) {
                const values = select.val() || [];
                // remove existing teams inputs to avoid duplicates, then append a single hidden input
                $(this).find('input[name="teams"]').remove();
                $(this).append($('<input>').attr({type: 'hidden', name: 'teams', value: values.join(',')}));
            }
            // If mobile textarea is used, it will be serialized automatically
        });

        // Teams dropdown checklist behavior (mobile-friendly, tap-to-select)
        function updateHiddenTeamsInput() {
            const vals = [];
            $('#teams_checklist .teams-checkbox:checked').each(function() { vals.push($(this).val()); });
            $('#teams_hidden_input').val(vals.join(','));
            // Update dropdown button label with count
            const btn = $('#teamsDropdownBtn');
            if (vals.length === 0) btn.text('Select Teams');
            else if (vals.length === 1) btn.text('1 team selected');
            else btn.text(vals.length + ' teams selected');
        }

        // Attach change handler
        $(document).on('change', '.teams-checkbox', function() { updateHiddenTeamsInput(); });

        // Select all / clear
        $('#teams_select_all').on('click', function() {
            $('#teams_checklist .teams-checkbox').prop('checked', true);
            updateHiddenTeamsInput();
        });
        $('#teams_clear_all').on('click', function() {
            $('#teams_checklist .teams-checkbox').prop('checked', false);
            updateHiddenTeamsInput();
        });

        // Search/filter inside dropdown
        $('#teams_search').on('input', function() {
            const q = $(this).val().toLowerCase().trim();
            $('#teams_checklist label').each(function() {
                const txt = $(this).text().toLowerCase();
                $(this).toggle(txt.indexOf(q) !== -1);
            });
        });

        // Initialize hidden input label
        updateHiddenTeamsInput();

        // Copy selected values into query params is handled by the form using GET; nothing more required.
    });
    </script>
</body>
</html>
