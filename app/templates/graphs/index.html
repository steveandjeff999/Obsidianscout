{% extends 'base.html' %}

{% block title %}Graphs Dashboard{% endblock %}

{% block heading %}Graphs Dashboard{% endblock %}

{% block content %}
{% set viewer_disabled = user_has_role('viewer') %}
<div class="graphs-page">

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card glass">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Graph Library</h5>
            </div>
            <div class="card-body">
                <p>Welcome to the Graph Library. This section provides specialized graphs and visualizations for scouting data.</p>
            </div>
        </div>
    </div>
</div>

{% if not viewer_disabled %}
<!-- Team Selection Form -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card glass">
            <div class="card-header bg-gradient-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Team Selection</h5>
                <span class="badge bg-light text-dark" id="selection-summary-badge">No teams selected</span>
            </div>
            <div class="card-body">
                <form action="{{ url_for('graphs.index') }}" method="get" id="team-selection-form">
                    <div class="row g-4">
                        <!-- LEFT COLUMN: Team Selection -->
                        <div class="col-12 col-lg-6">
                            <div class="team-selection-container">
                                <!-- Hidden select for form submission -->
                                <select name="teams" id="teams" class="d-none" multiple aria-label="Selected teams"></select>
                                
                                <!-- Team Selection Interface -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label fw-bold text-primary mb-0">
                                            <i class="fas fa-search me-2"></i>Search & Select Teams
                                        </label>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-team-list">
                                            <i class="fas fa-chevron-up" id="toggle-icon"></i>
                                            <span class="d-none d-md-inline ms-1">Collapse</span>
                                        </button>
                                    </div>
                                    
                                    <!-- Event Filter -->
                                    <div class="mb-3">
                                        <select id="event-filter" class="form-select">
                                            <option value="">All Events</option>
                                            {% for event in all_events %}
                                            <option value="{{ event.id }}" {% if event.id == selected_event_id %}selected{% endif %}>
                                                {{ event.name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <div class="small text-muted mt-1">
                                            <i class="fas fa-filter me-1"></i><span id="event-filter-status">Showing all teams</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Search Box -->
                                    <div class="input-group mb-3" id="team-search-section">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" 
                                               id="team-search-input" 
                                               class="form-control form-control-lg" 
                                               placeholder="Type team number or name..."
                                               autocomplete="off"
                                               aria-label="Search teams">
                                        <button class="btn btn-outline-secondary" type="button" id="clear-search-btn" title="Clear search">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>

                                    <!-- Quick Action Buttons -->
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="select-all-teams" title="Select all visible teams">
                                            <i class="fas fa-check-double me-1"></i>Select All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" id="select-top-teams" title="Select top 8 teams by points">
                                            <i class="fas fa-trophy me-1"></i>Top 8
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" id="add-event-teams" title="Add all teams from selected event">
                                            <i class="fas fa-calendar-plus me-1"></i>Add Event
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="clear-teams" title="Clear all selections">
                                            <i class="fas fa-times-circle me-1"></i>Clear All
                                        </button>
                                    </div>

                                    <!-- Selected Teams Pills Display -->
                                    <div class="selected-teams-display mb-3" id="selected-teams-pills">
                                        <div class="d-flex flex-wrap gap-2" id="selected-pills-container">
                                            <!-- Pills will be dynamically added here -->
                                        </div>
                                    </div>

                                    <!-- Scrollable Team List (Collapsible) -->
                                    <div class="team-list-scroll-container" id="team-list-container">
                                        <div class="list-group" id="team-list">
                                            {% for team in all_teams %}
                                            <label class="list-group-item list-group-item-action team-list-item" 
                                                   data-team-number="{{ team.team_number }}"
                                                   data-team-name="{{ team.team_name or 'Unknown' }}"
                                                   data-points="{{ team_metrics.get(team.team_number, {}).get('total_points', 0) }}">
                                                <div class="d-flex align-items-center">
                                                    <input class="form-check-input me-3 team-checkbox" 
                                                           type="checkbox" 
                                                           value="{{ team.team_number }}"
                                                           {% if team.team_number in selected_team_numbers %}checked{% endif %}
                                                           id="team-{{ team.team_number }}">
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <span class="fw-bold text-primary team-number">{{ team.team_number }}</span>
                                                                <span class="text-muted ms-2 team-name">{{ team.team_name or 'Unknown' }}</span>
                                                            </div>
                                                            <span class="badge bg-secondary team-points">
                                                                {{ "%.1f"|format(team_metrics.get(team.team_number, {}).get('total_points', 0)) }} pts
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- Status Text -->
                                    <div class="mt-2 small text-muted" id="team-selection-status">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <span id="status-text">0 teams selected from {{ all_teams|length }} available</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filters Column -->
                        <div class="col-12 col-lg-6">
                            <!-- Event Filter -->
                            <div class="mb-3">
                                <label for="event_id" class="form-label fw-semibold">
                                    <i class="fas fa-calendar-alt me-2 text-info"></i>Filter by Event
                                </label>
                                <select name="event_id" id="event_id" class="form-select event-select">
                                    <option value="">All Events</option>
                                    {% for event in all_events %}
                                    <option value="{{ event.id }}" {% if event.id == selected_event_id %}selected{% endif %}>
                                        {{ event.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Filter teams by event. Select "All Events" to see all teams.
                                </div>
                            </div>
                            
                            <!-- Metric Selection -->
                            <div class="mb-3">
                                <label for="metric" class="form-label fw-semibold">
                                    <i class="fas fa-chart-line me-2 text-success"></i>Select Metric
                                </label>
                                <select name="metric" id="metric" class="form-select">
                                    <option value="points" {% if selected_metric == 'points' %}selected{% endif %}>Default (Total Points)</option>
                                    <!-- Dynamic period-based metrics -->
                                    <option value="auto_points" {% if selected_metric == 'auto_points' %}selected{% endif %}>Auto Points</option>
                                    <option value="teleop_points" {% if selected_metric == 'teleop_points' %}selected{% endif %}>Teleop Points</option>
                                    <option value="endgame_points" {% if selected_metric == 'endgame_points' %}selected{% endif %}>Endgame Points</option>
                                    <option value="total_points" {% if selected_metric == 'total_points' %}selected{% endif %}>Total Points</option>
                                    <!-- Legacy key_metrics if they exist -->
                                    {% for metric in game_config.get('data_analysis', {}).get('key_metrics', []) %}
                                    {% if ('formula' in metric or metric.get('auto_generated', False)) and metric.id not in ['coral', 'algae', 'accuracy', 'matches_scouted', 'defence', 'caa', 'dr', 'ecp', 'tot'] %}
                                    <option value="{{ metric.id }}" {% if metric.id == selected_metric %}selected{% endif %}>
                                        {{ metric.name }}
                                    </option>
                                    {% endif %}
                                    {% endfor %}

                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Choose the metric to visualize across teams
                                </div>
                            </div>
                            
                            <!-- Data View Type Selection -->
                            <div class="mb-3">
                                <label for="data_view" class="form-label fw-semibold">
                                    <i class="fas fa-eye me-2 text-info"></i>Data View Type
                                </label>
                                <select name="data_view" id="data_view" class="form-select">
                                    <option value="averages" {% if selected_data_view == 'averages' %}selected{% endif %}>
                                        Team Averages (Recommended)
                                    </option>
                                    <option value="matches" {% if selected_data_view == 'matches' %}selected{% endif %}>
                                        Match-by-Match Data
                                    </option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Choose how to display the data - averages for comparison or individual matches for trends.
                                </div>
                            </div>

                            <!-- Sort Selection -->
                            <div class="mb-3">
                                <label for="sort" class="form-label fw-semibold">
                                    <i class="fas fa-sort me-2 text-secondary"></i>Sort Teams (left → right)
                                </label>
                                <select name="sort" id="sort" class="form-select">
                                    <option value="points_desc" {% if selected_sort == 'points_desc' %}selected{% endif %}>Points: High → Low (default)</option>
                                    <option value="points_asc" {% if selected_sort == 'points_asc' %}selected{% endif %}>Points: Low → High</option>
                                    <option value="team_asc" {% if selected_sort == 'team_asc' %}selected{% endif %}>Team #: Low → High</option>
                                    <option value="team_desc" {% if selected_sort == 'team_desc' %}selected{% endif %}>Team #: High → Low</option>
                                </select>
                                <div class="form-text">
                                    Choose how teams are ordered on the X axis for team-level charts.
                                </div>
                            </div>
                            
                            <!-- Graph Type Selection -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-chart-bar me-2 text-warning"></i>Select Graph Types
                                    <span id="graph-type-selected-count" class="badge bg-warning text-dark ms-2">{{ selected_graph_types|length }} selected</span>
                                </label>
                                <div class="card p-2">
                                    <div class="d-flex flex-wrap gap-2">
                                        <!-- Basic Charts -->
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="bar" id="graph_type_bar" {% if 'bar' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_bar">Bar Chart</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="line" id="graph_type_line" {% if 'line' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_line">Line Chart</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="scatter" id="graph_type_scatter" {% if 'scatter' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_scatter">Scatter Plot</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="area" id="graph_type_area" {% if 'area' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_area">Area Chart</label>
                                        </div>

                                        <!-- Distribution Charts -->
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="box" id="graph_type_box" {% if 'box' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_box">Box Plot</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="violin" id="graph_type_violin" {% if 'violin' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_violin">Violin Plot</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="histogram" id="graph_type_histogram" {% if 'histogram' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_histogram">Histogram</label>
                                        </div>

                                        <!-- Advanced Charts -->
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="radar" id="graph_type_radar" {% if 'radar' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_radar">Radar Chart</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="heatmap" id="graph_type_heatmap" {% if 'heatmap' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_heatmap">Heatmap</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="bubble" id="graph_type_bubble" {% if 'bubble' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_bubble">Bubble Chart</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="sunburst" id="graph_type_sunburst" {% if 'sunburst' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_sunburst">Sunburst Chart</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="treemap" id="graph_type_treemap" {% if 'treemap' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_treemap">Treemap</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="waterfall" id="graph_type_waterfall" {% if 'waterfall' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_waterfall">Waterfall Chart</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input graph-type-checkbox" type="checkbox" name="graph_types" value="sankey" id="graph_type_sankey" {% if 'sankey' in selected_graph_types %}checked{% endif %}>
                                            <label class="form-check-label" for="graph_type_sankey">Sankey Diagram</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="graph-types-select-all">Select All</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="graph-types-clear">Clear</button>
                                </div>

                                <div class="form-text mt-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Tap to toggle graph types. Leave all unchecked to use the default selection.
                                </div>

                                <!-- Quick selection buttons for graph types (keep existing IDs but handlers will use helper) -->
                                <div class="mt-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="select-basic-graphs">
                                            <i class="fas fa-chart-simple me-1"></i>Basic
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="select-distribution-graphs">
                                            <i class="fas fa-chart-area me-1"></i>Distribution
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="select-advanced-graphs">
                                            <i class="fas fa-chart-pie me-1"></i>Advanced
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="clear-graph-types">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button - Full width on mobile, centered on desktop -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-grid d-md-flex justify-content-md-center mt-3 gap-2">
                                <button type="submit" class="btn btn-primary btn-lg px-4" id="generate-graphs-btn">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span class="d-none d-sm-inline">Generate </span>Graphs
                                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="loading-spinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </button>
                                <button type="button" class="btn btn-success btn-lg px-4 {% if not plots %}d-none{% endif %}" data-bs-toggle="modal" data-bs-target="#shareModal" id="share-graphs-btn">
                                    <i class="fas fa-share-alt me-2"></i>
                                    <span class="d-none d-sm-inline">Share </span>Graphs
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info mb-4">
    <i class="fas fa-eye me-2"></i> You have read-only access. You can view graphs but cannot generate new ones or use interactive features.
</div>
{% endif %}

<!-- Generated Graphs -->
{% if plots %}
<div class="row">
    {% for plot_id, plot_json in plots.items() %}
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div id="{{ plot_id }}" class="plotly-graph" data-graph='{{ plot_json }}' style="height: 500px;"></div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% elif selected_team_numbers %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-circle me-2"></i> No data available for the selected teams and filters.
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Select teams above to generate graphs.
        </div>
    </div>
</div>
{% endif %}

<!-- Additional Graph Features -->
<div class="row">
    <div class="col-md-12 mb-4">
        <!-- Advanced Analysis Tools card removed -->
    </div>
</div>

<!-- Share Modal -->
{% if not viewer_disabled %}
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share-alt me-2"></i>Share Your Graphs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('graphs.create_share') }}" method="post">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Create a shareable link that allows others to view your graphs without needing to log in. 
                        The shared graphs will be read-only and non-password protected, similar to Google Docs viewer mode.
                    </div>
                    
                    <!-- Hidden fields to pass current graph configuration -->
                    {% for team_num in selected_team_numbers %}
                    <input type="hidden" name="teams" value="{{ team_num }}">
                    {% endfor %}
                    {% if selected_event_id %}
                    <input type="hidden" name="event_id" value="{{ selected_event_id }}">
                    {% endif %}
                    <input type="hidden" name="metric" value="{{ selected_metric }}">
                    <input type="hidden" name="sort" value="{{ request.args.get('sort','points_desc') }}">
                    {% for graph_type in selected_graph_types %}
                    <input type="hidden" name="graph_types" value="{{ graph_type }}">
                    {% endfor %}
                    <input type="hidden" name="data_view" value="{{ selected_data_view }}">
                    
                    <!-- Share configuration -->
                    <div class="mb-3">
                        <label for="share_title" class="form-label fw-semibold">
                            <i class="fas fa-heading me-2"></i>Title <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="share_title" name="share_title" 
                               placeholder="Enter a title for your shared graphs" required maxlength="200">
                        <div class="form-text">
                            This title will be displayed at the top of the shared page.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="share_description" class="form-label fw-semibold">
                            <i class="fas fa-align-left me-2"></i>Description (Optional)
                        </label>
                        <textarea class="form-control" id="share_description" name="share_description" 
                                  rows="3" placeholder="Add a description or notes about these graphs"></textarea>
                        <div class="form-text">
                            Provide context or explanation for viewers.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expires_in_days" class="form-label fw-semibold">
                            <i class="fas fa-clock me-2"></i>Expiration (Optional)
                        </label>
                        <select class="form-select" id="expires_in_days" name="expires_in_days">
                            <option value="">Never expires</option>
                            <option value="1">1 day</option>
                            <option value="7">1 week</option>
                            <option value="30">1 month</option>
                            <option value="90">3 months</option>
                            <option value="365">1 year</option>
                        </select>
                        <div class="form-text">
                            Choose when this shared link should expire.
                        </div>
                    </div>
                    
                    <!-- Simplified configuration summary -->
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Share Summary:
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted d-block">Teams:</small>
                                    <span class="badge bg-primary">
                                        {{ selected_team_numbers|length }} team{{ 's' if selected_team_numbers|length != 1 else '' }}
                                    </span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Event:</small>
                                    <span class="badge bg-info">
                                        {% if selected_event_id %}
                                            Event Selected
                                        {% else %}
                                            All Events
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Metric:</small>
                                    <span class="badge bg-success">{{ selected_metric|title or 'Points' }}</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Graph Types:</small>
                                    <span class="badge bg-warning text-dark">{{ selected_graph_types|length }} type{{ 's' if selected_graph_types|length != 1 else '' }}</span>
                                </div>
                            </div>
                            
                            <!-- Expandable details -->
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#shareDetails" aria-expanded="false">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                            </div>
                            
                            <div class="collapse mt-2" id="shareDetails">
                                <div class="border-top pt-2">
                                    <div class="row">
                                        <div class="col-12">
                                            <strong class="small">Teams:</strong>
                                            <div class="small text-muted" style="max-height: 100px; overflow-y: auto;">
                                                {% for team_num in selected_team_numbers %}
                                                Team {{ team_num }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-12 mt-2">
                                            <strong class="small">Graph Types:</strong>
                                            <div class="small text-muted">
                                                {% for graph_type in selected_graph_types %}
                                                {{ graph_type|title }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% if selected_event_id %}
                                        <div class="col-12 mt-2">
                                            <strong class="small">Event:</strong>
                                            <div class="small text-muted">
                                                {% for event in all_events %}
                                                    {% if event.id == selected_event_id %}{{ event.name }}{% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-share-alt me-2"></i>Create Share Link
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // @ts-nocheck - Disable TypeScript checking for Jinja templates
    // Team-event mapping for dynamic filtering
    const teamEventMapping = {{ team_event_mapping | tojson }};
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Select2 for team selection with mobile-friendly settings
        function initializeTeamSelect() {
            const teamConfig = {
                placeholder: 'Search and select teams...',
                allowClear: true,
                closeOnSelect: false,
                dropdownCssClass: 'select2-dropdown-large',
                selectionCssClass: 'select2-selection-large',
                templateResult: function(team) {
                    if (!team.id) return team.text;
                    
                    // Create custom template with team number highlighting
                    const teamNumber = team.text.split(' - ')[0];
                    const teamName = team.text.split(' - ')[1] || '';
                    
                    return $('<span><strong class="text-primary">' + teamNumber + '</strong> - ' + teamName + '</span>');
                },
                templateSelection: function(team) {
                    if (!team.id) return team.text;
                    
                    // Show just team number on mobile, full text on desktop
                    const teamNumber = team.text.split(' - ')[0];
                    const teamName = team.text.split(' - ')[1] || '';
                    
                    if (window.innerWidth < 768) {
                        return teamNumber;
                    } else {
                        return team.text;
                    }
                },
                sorter: function(data) {
                    return data.sort(function(a, b) {
                        return (a.text > b.text) ? 1 : -1;
                    });
                }
            };
            
            // Use mobile-friendly initialization
            if (typeof window.initSelect2Mobile === 'function') {
                window.initSelect2Mobile('#teams', teamConfig);
            } else {
                $('#teams').select2($.extend({theme: 'bootstrap-5', width: '100%'}, teamConfig));
            }
        }
        
        // Initialize Select2 for event selection
        function initializeEventSelect() {
            const eventConfig = {
                placeholder: 'Select an event...',
                allowClear: true
            };
            
            if (typeof window.initSelect2Mobile === 'function') {
                window.initSelect2Mobile('#event_id', eventConfig);
            } else {
                $('#event_id').select2($.extend({theme: 'bootstrap-5', width: '100%'}, eventConfig));
            }
        }
        
        // Initialize Select2 for graph types selection (only when the select element exists)
        function initializeGraphTypes() {
            if (!$('#graph_types') || $('#graph_types').length === 0) return;
            const graphTypesConfig = {
                placeholder: 'Select graph types...',
                allowClear: true,
                closeOnSelect: false,
                dropdownCssClass: 'select2-dropdown-large',
                selectionCssClass: 'select2-selection-large'
            };
            
            if (typeof window.initSelect2Mobile === 'function') {
                window.initSelect2Mobile('#graph_types', graphTypesConfig);
            } else {
                $('#graph_types').select2($.extend({theme: 'bootstrap-5', width: '100%'}, graphTypesConfig));
            }
    }
    initializeGraphTypes();
        
        // Initialize team select
        initializeTeamSelect();
        
        // Store all teams data for filtering
        // Convert the server-provided JSON string to a JavaScript object
        const allTeamsData = {{ all_teams_json|safe }};
        
        
        // Function to filter teams based on selected event
        function filterTeamsByEvent() {
            const selectedEventId = $('#event_id').val();
            const teamSelect = $('#teams');
            
            // Store currently selected teams
            const currentlySelected = teamSelect.val() || [];
            
            // Destroy existing Select2 instance
            if (teamSelect.hasClass('select2-hidden-accessible')) {
                teamSelect.select2('destroy');
            }
            
            // Clear existing options
            teamSelect.empty();
            
            let visibleCount = 0;
            let filteredSelectedTeams = [];
            
            if (!selectedEventId || selectedEventId === '') {
                // Show all teams if no event is selected
                allTeamsData.forEach(function(team) {
                    const option = new Option(team.displayText, team.teamNumber.toString(), false, false);
                    teamSelect.append(option);
                    
                    // Keep selection if this team was previously selected
                    if (currentlySelected.includes(team.teamNumber.toString())) {
                        filteredSelectedTeams.push(team.teamNumber.toString());
                    }
                    visibleCount++;
                });
                
                $('#team-count-indicator').text(`(${visibleCount} teams available)`);
            } else {
                // Show only teams in the selected event
                allTeamsData.forEach(function(team) {
                    const teamEvents = teamEventMapping[team.teamNumber] || [];
                    if (teamEvents.includes(parseInt(selectedEventId))) {
                        const option = new Option(team.displayText, team.teamNumber.toString(), false, false);
                        teamSelect.append(option);
                        
                        // Keep selection if this team was previously selected
                        if (currentlySelected.includes(team.teamNumber.toString())) {
                            filteredSelectedTeams.push(team.teamNumber.toString());
                        }
                        visibleCount++;
                    }
                });
                
                $('#team-count-indicator').text(`(${visibleCount} teams in this event)`);
            }
            
            // Set the filtered selected teams
            teamSelect.val(filteredSelectedTeams);
            
            // Reinitialize Select2
            initializeTeamSelect();
        }
        
        // Event listener for event selection change
        $('#event_id').on('change', function() {
            filterTeamsByEvent();
        });
        
        // Apply initial filter if an event is pre-selected
        if ($('#event_id').val()) {
            filterTeamsByEvent();
        } else {
            // Show initial team count for all teams
            const totalTeams = $('#teams option[value!=""]').length;
            $('#team-count-indicator').text(`(${totalTeams} teams available)`);
        }
        
        // Quick selection button handlers
        $('#select-all-teams').click(function() {
            // Select all currently visible teams (after filtering)
            const allVisibleValues = [];
            $('#teams option').each(function() {
                if ($(this).val()) { // Skip empty values
                    allVisibleValues.push($(this).val());
                }
            });
            $('#teams').val(allVisibleValues).trigger('change');
        });
        
        $('#add-all-event-teams').click(function() {
            const selectedEventId = $('#event_id').val();
            
            if (!selectedEventId || selectedEventId === '') {
                // If no event is selected, show a message
                alert('Please select an event first to add all teams from that event.');
                return;
            }
            
            // Get currently selected teams
            const currentlySelected = $('#teams').val() || [];
            const teamsToAdd = [];
            
            // Find all teams that belong to the selected event
            allTeamsData.forEach(function(team) {
                const teamEvents = teamEventMapping[team.teamNumber] || [];
                if (teamEvents.includes(parseInt(selectedEventId))) {
                    const teamNumberStr = team.teamNumber.toString();
                    // Only add if not already selected
                    if (!currentlySelected.includes(teamNumberStr)) {
                        teamsToAdd.push(teamNumberStr);
                    }
                }
            });
            
            // Combine currently selected teams with new teams
            const allSelectedTeams = currentlySelected.concat(teamsToAdd);
            $('#teams').val(allSelectedTeams).trigger('change');
            
            // Show feedback message
            if (teamsToAdd.length > 0) {
                const eventName = $('#event_id option:selected').text();
                console.log(`Added ${teamsToAdd.length} teams from ${eventName}`);
            } else {
                console.log('All teams from this event are already selected.');
            }
        });
        
        $('#clear-teams').click(function() {
            $('#teams').val(null).trigger('change');
        });
        
        $('#select-top-teams').click(function() {
            // Get the currently selected metric for sorting
            const selectedMetric = $('#metric').val();
            
            // Get all teams and their data
            const teamOptions = [];
            $('#teams option').each(function() {
                if ($(this).val()) {
                    teamOptions.push({
                        value: $(this).val(),
                        text: $(this).text(),
                        points: parseFloat($(this).data('points') || 0)
                    });
                }
            });
            
            // Sort teams by points (descending)
            teamOptions.sort((a, b) => b.points - a.points);
            
            // Select top 8 teams by points
            const topTeamValues = teamOptions.slice(0, 8).map(team => team.value);
            
            // Update selection
            $('#teams').val(topTeamValues).trigger('change');
        });
        
        // Graph Type helpers: support both checkbox-based UI and the original select2 fallback
        function getSelectedGraphTypes() {
            // Prefer checkbox UI if present
            const checked = document.querySelectorAll('.graph-type-checkbox:checked');
            if (checked && checked.length) {
                return Array.from(checked).map(function(cb) { return cb.value; });
            }
            // Fallback to select element
            if (typeof $ !== 'undefined' && $('#graph_types').length) {
                return $('#graph_types').val() || [];
            }
            return [];
        }

        function setGraphTypes(types) {
            // If checkboxes present, use them
            const checkboxes = document.querySelectorAll('.graph-type-checkbox');
            if (checkboxes && checkboxes.length) {
                checkboxes.forEach(function(cb) {
                    cb.checked = Array.isArray(types) && types.includes(cb.value);
                });
                updateGraphTypeCount();
            }

            // Also sync select2 if present
            if (typeof $ !== 'undefined' && $('#graph_types').length) {
                try {
                    $('#graph_types').val(types && types.length ? types : null).trigger('change');
                } catch (e) {
                    // ignore
                }
            }
        }

        function updateGraphTypeCount() {
            const count = getSelectedGraphTypes().length;
            const el = document.getElementById('graph-type-selected-count');
            if (el) el.textContent = `${count} selected`;
        }

        // Attach change listener to checkboxes so badge updates
        $(document).on('change', '.graph-type-checkbox', function() { updateGraphTypeCount(); });

        // Quick selection button handlers use the helper
        $('#select-basic-graphs').click(function() { setGraphTypes(['bar','line','scatter','area']); });
        $('#select-distribution-graphs').click(function() { setGraphTypes(['box','violin','histogram']); });
        $('#select-advanced-graphs').click(function() { setGraphTypes(['radar','heatmap','bubble','sunburst','treemap']); });

        // Clear buttons (both IDs used in UI)
        $('#clear-graph-types, #graph-types-clear').click(function() { setGraphTypes([]); });

        // Select all / Clear for the checkbox group
        $('#graph-types-select-all').click(function() {
            const all = Array.from(document.querySelectorAll('.graph-type-checkbox')).map(function(cb) { return cb.value; });
            setGraphTypes(all);
        });

        $('#graph-types-clear').click(function() { setGraphTypes([]); });
        

        
        // Form submission with loading state
        $('#team-selection-form').on('submit', function() {
            const selectedTeams = $('#teams').val();
            
            if (!selectedTeams || selectedTeams.length === 0) {
                alert('Please select at least one team to generate graphs.');
                return false;
            }
            
            // Show loading state
            const btn = $('#generate-graphs-btn');
            const spinner = $('#loading-spinner');
            const originalText = btn.html();
            
            btn.prop('disabled', true);
            spinner.removeClass('d-none');
            
            // Reset button after a timeout (in case of error)
            setTimeout(function() {
                btn.prop('disabled', false);
                spinner.addClass('d-none');
            }, 30000); // 30 seconds timeout
            
            return true;
        });
        
        // Show/hide share button based on whether graphs are generated
        function toggleShareButton() {
            const hasGraphs = $('.plotly-graph').length > 0;
            const selectedTeams = $('#teams').val();
            
            if (hasGraphs && selectedTeams && selectedTeams.length > 0) {
                $('#share-graphs-btn').removeClass('d-none');
            } else {
                $('#share-graphs-btn').addClass('d-none');
            }
        }
        
        // Check share button visibility on page load and form changes
        toggleShareButton();
        $('#teams').on('change', toggleShareButton);

        // When the Share modal opens, copy current selection values into hidden inputs
        // so the created share reflects the user's current configuration (teams, graph types, metric, etc.)
        $('#shareModal').on('show.bs.modal', function () {
            const modal = $(this);
            const form = modal.find('form');

            // Remove any previously-added dynamic hidden inputs
            form.find('input[name="teams"]').remove();
            form.find('input[name="event_id"]').remove();
            form.find('input[name="metric"]').remove();
            form.find('input[name="sort"]').remove();
            form.find('input[name="data_view"]').remove();
            form.find('input[name="graph_types"]').remove();

            // Copy current teams
            const teams = $('#teams').val() || [];
            teams.forEach(function(teamNum) {
                form.append($('<input>').attr({type: 'hidden', name: 'teams', value: teamNum}));
            });

            // Copy event if selected
            const eventId = $('#event_id').val();
            if (eventId && eventId !== '') {
                form.append($('<input>').attr({type: 'hidden', name: 'event_id', value: eventId}));
            }

            // Copy metric
            const metric = $('#metric').val() || 'points';
            form.append($('<input>').attr({type: 'hidden', name: 'metric', value: metric}));

            // Copy sort
            const sortVal = $('#sort').val() || 'points_desc';
            form.append($('<input>').attr({type: 'hidden', name: 'sort', value: sortVal}));

            // Copy data view
            const dataView = $('#data_view').val() || 'averages';
            form.append($('<input>').attr({type: 'hidden', name: 'data_view', value: dataView}));

            // Copy graph types - prefer checkbox UI, fallback to select options
            let graphTypes = getSelectedGraphTypes();
            if (!graphTypes || graphTypes.length === 0) {
                // gather all available graph types from checkboxes or select options
                const allCheckboxes = document.querySelectorAll('.graph-type-checkbox');
                if (allCheckboxes && allCheckboxes.length) {
                    graphTypes = Array.from(allCheckboxes).map(function(cb) { return cb.value; });
                } else if (typeof $ !== 'undefined' && $('#graph_types').length) {
                    graphTypes = [];
                    $('#graph_types option').each(function() { const v = $(this).val(); if (v) graphTypes.push(v); });
                }
            }
            graphTypes.forEach(function(gt) {
                form.append($('<input>').attr({type: 'hidden', name: 'graph_types', value: gt}));
            });
        });
        
        // Responsive handling for Select2
        $(window).on('resize', function() {
            // Reinitialize Select2 on resize to handle template changes
            if ($('#teams').hasClass('select2-hidden-accessible')) {
                $('#teams').select2('destroy');
                initializeTeamSelect();
            }

            if ($('#graph_types').hasClass('select2-hidden-accessible')) {
                $('#graph_types').select2('destroy');
                initializeGraphTypes();
            }
        });
        
        // Wait for Plotly to be available, then render graphs
        function waitForPlotly() {
            if (typeof Plotly !== 'undefined') {
                console.log('Plotly is loaded, rendering graphs...');
                renderPlotlyGraphs();
            } else {
                console.log('Waiting for Plotly to load...');
                setTimeout(waitForPlotly, 100);
            }
        }
        
        waitForPlotly();
    });
    
    // ======== REAL-TIME CONFIG UPDATE LISTENERS ========
    
    // Listen for game config updates that affect analytics
    window.addEventListener('gameConfigUpdated', function(event) {
        const newGameConfig = event.detail;
        console.log('Game config updated in analytics:', newGameConfig);
        
        // Show notification
        showAnalyticsConfigUpdateNotification('Analytics configuration updated due to alliance mode change.');
        
        // Automatically reload analytics data
        reloadAnalyticsWithNewConfig();
    });
    
    // Listen for global config reload events
    window.addEventListener('globalConfigReload', function(event) {
        const configData = event.detail;
        console.log('Global config reload in analytics:', configData);
        
        // Show notification
        showAnalyticsConfigUpdateNotification(`Configuration updated: ${configData.message}`);
        
        // Automatically reload analytics with new config
        reloadAnalyticsWithNewConfig();
    });
    
    // Listen for alliance status changes
    window.addEventListener('allianceStatusUpdated', function(event) {
        const allianceStatus = event.detail;
        console.log('Alliance status updated in analytics:', allianceStatus);
        
        let message;
        if (allianceStatus.is_active) {
            message = `Alliance mode activated. Analytics now use shared data configuration from ${allianceStatus.alliance_info?.alliance_name || 'alliance'}.`;
        } else {
            message = 'Alliance mode deactivated. Analytics now use individual team configuration.';
        }
        
        showAnalyticsConfigUpdateNotification(message);
        reloadAnalyticsWithNewConfig();
    });
    
    // Function to reload analytics content with new configuration
    window.reloadAnalyticsWithNewConfig = function() {
        console.log('Reloading analytics with new configuration...');
        
        try {
            // Get current state
            const currentState = {
                team: document.getElementById('team-filter')?.value || '',
                event: document.getElementById('event-filter')?.value || '',
                match_type: document.getElementById('match-type-filter')?.value || '',
                metric: document.getElementById('metric-selector')?.value || ''
            };
            
            // Reload the analytics data without full page reload
            fetch(window.location.pathname + '?' + new URLSearchParams(currentState))
                .then(response => response.json())
                .then(data => {
                    // Update charts and data tables
                    if (typeof updateAnalyticsCharts === 'function') {
                        updateAnalyticsCharts(data);
                    }
                    
                    // Update any metric selectors with new config
                    if (typeof updateMetricSelectors === 'function') {
                        updateMetricSelectors();
                    }
                    
                    console.log('Analytics reloaded successfully with new configuration');
                    showAnalyticsConfigUpdateNotification('Analytics updated with new configuration', 'success');
                })
                .catch(error => {
                    console.error('Error reloading analytics:', error);
                    showAnalyticsConfigUpdateNotification('Failed to reload analytics. Please refresh the page.', 'error');
                });
        } catch (error) {
            console.error('Error in analytics reload:', error);
            // Fallback to page reload
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    };
    
    // Function to show analytics-specific config update notifications
    function showAnalyticsConfigUpdateNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 450px;';
        notification.innerHTML = `
            <i class="fas fa-chart-line me-2"></i>
            <strong>Analytics Update:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 12 seconds (longer for analytics messages)
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 12000);
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mobile-friendly team selector: modal-driven UI that syncs with hidden #teams select
    try {
        const isMobile = window.innerWidth <= 900 || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const hiddenSelect = document.getElementById('teams');
        const openBtn = document.getElementById('open-team-selector');
        const modalEl = document.getElementById('teamSelectorModal');
        const modalList = document.getElementById('team-selector-list');
        const searchInput = document.getElementById('team-selector-search');
        const applyBtn = document.getElementById('team-selector-apply');
        const inlineCount = document.getElementById('team-count-indicator-inline');

        if (!hiddenSelect || !openBtn || !modalEl) return;

        // Helper: read currently selected team numbers from hidden select
        function getHiddenSelected() {
            return Array.from(hiddenSelect.options).filter(o => o.selected).map(o => o.value.toString());
        }

        function setHiddenSelected(values) {
            const vs = (values || []).map(String);
            Array.from(hiddenSelect.options).forEach(opt => {
                opt.selected = vs.includes(opt.value.toString());
            });
            // Update both indicators
            const totalSelected = getHiddenSelected().length;
            const mainIndicator = document.getElementById('team-count-indicator');
            if (mainIndicator) mainIndicator.textContent = `(${totalSelected} selected)`;
            if (inlineCount) inlineCount.textContent = `(${totalSelected} selected)`;
        }

        // Build checkbox list in modal for provided teams array
        function renderModalList(teams) {
            modalList.innerHTML = '';
            const selectedSet = new Set(getHiddenSelected());
            teams.forEach(team => {
                const id = `team-checkbox-${team.teamNumber}`;
                const wrapper = document.createElement('div');
                wrapper.className = 'form-check';
                const input = document.createElement('input');
                input.className = 'form-check-input team-checkbox';
                input.type = 'checkbox';
                input.id = id;
                input.dataset.teamNumber = team.teamNumber;
                input.value = team.teamNumber;
                if (selectedSet.has(String(team.teamNumber))) input.checked = true;

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = id;
                label.textContent = `${team.teamNumber} - ${team.teamName || 'Unknown'}`;

                wrapper.appendChild(input);
                wrapper.appendChild(label);
                modalList.appendChild(wrapper);
            });
        }

        // Get visible teams respecting selected event filter
        function getVisibleTeamsForModal() {
            const selectedEventId = document.getElementById('event_id') ? document.getElementById('event_id').value : '';
            if (!selectedEventId) return allTeamsData.slice();
            const ev = parseInt(selectedEventId);
            return allTeamsData.filter(t => {
                const evs = teamEventMapping[t.teamNumber] || [];
                return evs.includes(ev);
            });
        }

        // Open modal and populate list
        openBtn.addEventListener('click', function() {
            const teams = getVisibleTeamsForModal();
            renderModalList(teams);
            // show bootstrap modal
            const bsModal = new bootstrap.Modal(modalEl);
            bsModal.show();
            // focus search input shortly after open
            setTimeout(() => { try { searchInput && searchInput.focus(); } catch (e) {} }, 200);
        });

        // Search/filter inside modal
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const q = (this.value || '').trim().toLowerCase();
                const teams = getVisibleTeamsForModal().filter(t => {
                    return String(t.teamNumber).includes(q) || (t.teamName || '').toLowerCase().includes(q);
                });
                renderModalList(teams);
            });
        }

        // Modal quick buttons
        document.getElementById('modal-select-all').addEventListener('click', function() {
            document.querySelectorAll('#team-selector-list .team-checkbox').forEach(cb => cb.checked = true);
        });
        document.getElementById('modal-clear-selection').addEventListener('click', function() {
            document.querySelectorAll('#team-selector-list .team-checkbox').forEach(cb => cb.checked = false);
        });
        document.getElementById('modal-add-event-teams').addEventListener('click', function() {
            const visible = getVisibleTeamsForModal().map(t => String(t.teamNumber));
            document.querySelectorAll('#team-selector-list .team-checkbox').forEach(cb => {
                if (visible.includes(cb.value)) cb.checked = true;
            });
        });
        document.getElementById('modal-select-top').addEventListener('click', function() {
            // select top 8 by points among visible list
            const visibleTeams = getVisibleTeamsForModal();
            visibleTeams.sort((a,b) => (b.points||0) - (a.points||0));
            const top = new Set(visibleTeams.slice(0,8).map(t => String(t.teamNumber)));
            document.querySelectorAll('#team-selector-list .team-checkbox').forEach(cb => cb.checked = top.has(cb.value));
        });

        // Apply selection from modal to hidden select
        applyBtn.addEventListener('click', function() {
            const checked = Array.from(document.querySelectorAll('#team-selector-list .team-checkbox:checked')).map(cb => cb.value);
            setHiddenSelected(checked);
            // Close modal
            try { bootstrap.Modal.getInstance(modalEl).hide(); } catch (e) {}
        });

        // Keep inline indicator updated on load
        setHiddenSelected(getHiddenSelected());

        // Reconcile existing quick buttons (those outside modal) to operate on hidden select
        // Select all visible
        try {
            document.getElementById('select-all-teams').addEventListener('click', function() {
                const visible = Array.from(hiddenSelect.options).map(o=>o.value);
                setHiddenSelected(visible);
            });
        } catch (e) {}

        try {
            document.getElementById('add-all-event-teams').addEventListener('click', function() {
                const selectedEventId = document.getElementById('event_id') ? document.getElementById('event_id').value : '';
                if (!selectedEventId) { alert('Please select an event first to add all teams from that event.'); return; }
                const ev = parseInt(selectedEventId);
                const toAdd = allTeamsData.filter(t => (teamEventMapping[t.teamNumber]||[]).includes(ev)).map(t => String(t.teamNumber));
                const cur = new Set(getHiddenSelected());
                toAdd.forEach(v => cur.add(String(v)));
                setHiddenSelected(Array.from(cur));
            });
        } catch(e) {}

        try {
            document.getElementById('clear-teams').addEventListener('click', function() { setHiddenSelected([]); });
        } catch(e) {}

        try {
            document.getElementById('select-top-teams').addEventListener('click', function() {
                const opts = Array.from(hiddenSelect.options).map(o => ({ value: o.value, points: parseFloat(o.dataset.points||0) }));
                opts.sort((a,b) => b.points - a.points);
                setHiddenSelected(opts.slice(0,8).map(o=>o.value));
            });
        } catch(e) {}

        // When event filter changes, update inline indicator count for visible teams
        const eventEl = document.getElementById('event_id');
        if (eventEl) eventEl.addEventListener('change', function() {
            const visible = getVisibleTeamsForModal().length;
            if (inlineCount) inlineCount.textContent = `(${visible} teams in this event)`;
        });
    } catch (err) {
        // Don't break page on errors
        console.warn('Team selector modal initialization failed', err);
    }
});
</script>
<!-- Team Selection Styles -->
<style>
.team-selection-container {
    position: relative;
}

.team-list-scroll-container {
    max-height: 450px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: var(--bs-body-bg);
    transition: max-height 0.3s ease, opacity 0.3s ease;
}

.team-list-scroll-container.collapsed {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    border: none;
    margin: 0;
    padding: 0;
}

#team-search-section.collapsed,
#selected-teams-pills.collapsed {
    display: none;
}

.team-list-item {
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    border-bottom: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
}

.team-list-item:hover {
    background-color: rgba(13, 110, 253, 0.1);
}

.team-list-item.active,
.team-list-item:has(.team-checkbox:checked) {
    background-color: rgba(13, 110, 253, 0.15);
    border-left: 3px solid #0d6efd;
}

.team-checkbox {
    cursor: pointer;
    width: 1.25rem;
    height: 1.25rem;
}

.selected-teams-display {
    min-height: 60px;
    padding: 0.75rem;
    background: var(--bs-light);
    border-radius: 0.375rem;
    border: 1px dashed #dee2e6;
}

.selected-team-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    color: white;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.selected-team-pill:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.selected-team-pill .remove-team-btn {
    background: none;
    border: none;
    color: white;
    padding: 0;
    margin-left: 0.5rem;
    cursor: pointer;
    font-size: 1.1rem;
    line-height: 1;
    opacity: 0.8;
    transition: opacity 0.2s;
}

.selected-team-pill .remove-team-btn:hover {
    opacity: 1;
}

#selection-summary-badge {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.team-list-item.hidden {
    display: none;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .team-list-scroll-container {
        max-height: 350px;
    }
    
    .selected-teams-display {
        min-height: 50px;
    }
    
    .selected-team-pill {
        font-size: 0.75rem;
        padding: 0.4rem 0.6rem;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .team-list-scroll-container {
        border-color: #495057;
    }
    
    .team-list-item {
        border-bottom-color: #495057;
    }
    
    .selected-teams-display {
        background: #343a40;
        border-color: #495057;
    }
}
</style>

<!-- Enhanced Team Selection JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const teamCheckboxes = document.querySelectorAll('.team-checkbox');
    const hiddenSelect = document.getElementById('teams');
    const searchInput = document.getElementById('team-search-input');
    const clearSearchBtn = document.getElementById('clear-search-btn');
    const teamListItems = document.querySelectorAll('.team-list-item');
    const selectedPillsContainer = document.getElementById('selected-pills-container');
    const statusText = document.getElementById('status-text');
    const summaryBadge = document.getElementById('selection-summary-badge');
    const eventFilter = document.getElementById('event-filter');
    const eventFilterStatus = document.getElementById('event-filter-status');
    const teamEventMapping = {{ team_event_mapping | tojson }};
    
    // Initialize hidden select options
    teamListItems.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.dataset.teamNumber;
        opt.text = `${item.dataset.teamNumber} - ${item.dataset.teamName}`;
        hiddenSelect.appendChild(opt);
    });
    
    // Initialize
    updateSelection();
    applyEventFilter();
    
    // Collapse/Expand functionality
    const toggleBtn = document.getElementById('toggle-team-list');
    const toggleIcon = document.getElementById('toggle-icon');
    const teamListContainer = document.getElementById('team-list-container');
    const searchSection = document.getElementById('team-search-section');
    const pillsSection = document.getElementById('selected-teams-pills');
    
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            const isCollapsed = teamListContainer.classList.toggle('collapsed');
            searchSection.classList.toggle('collapsed');
            pillsSection.classList.toggle('collapsed');
            toggleIcon.className = isCollapsed ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            const label = this.querySelector('span');
            if (label) label.textContent = isCollapsed ? 'Expand' : 'Collapse';
        });
    }
    
    // Event filter functionality
    if (eventFilter) {
        eventFilter.addEventListener('change', function() {
            applyEventFilter();
        });
    }
    
    function applyEventFilter() {
        const selectedEventId = eventFilter ? eventFilter.value : '';
        let visibleCount = 0;
        
        teamListItems.forEach(item => {
            let showByEvent = true;
            
            if (selectedEventId) {
                const teamNumber = parseInt(item.dataset.teamNumber);
                const teamEvents = teamEventMapping[teamNumber] || [];
                showByEvent = teamEvents.includes(parseInt(selectedEventId));
            }
            
            // Apply search filter too
            const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const teamNumber = item.dataset.teamNumber;
            const teamName = item.dataset.teamName.toLowerCase();
            const matchesSearch = !query || teamNumber.includes(query) || teamName.includes(query);
            
            const shouldShow = showByEvent && matchesSearch;
            item.classList.toggle('hidden', !shouldShow);
            if (shouldShow) visibleCount++;
        });
        
        // Update status text
        if (eventFilterStatus) {
            if (selectedEventId) {
                const eventName = eventFilter.options[eventFilter.selectedIndex].text;
                eventFilterStatus.textContent = `Showing ${visibleCount} teams from ${eventName}`;
            } else {
                eventFilterStatus.textContent = `Showing all teams (${visibleCount} visible)`;
            }
        }
        
        updateSelection();
    }
    
    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            applyEventFilter();
        });
    }
    
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'));
            searchInput.focus();
        });
    }
    
    // Checkbox change handler
    teamCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelection();
        });
    });
    
    // Click on list item to toggle checkbox
    teamListItems.forEach(item => {
        item.addEventListener('click', function(e) {
            // Don't act if clicking the checkbox itself
            if (e.target.classList.contains('team-checkbox')) return;
            // Don't toggle if clicking a button or interactive control
            if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.tagName === 'A') return;

            // Prevent the native label-toggle behavior so we can toggle exactly once
            try { e.preventDefault(); } catch (err) {}

            const checkbox = this.querySelector('.team-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelection();
            }
        });
    });
    
    // Quick action buttons
    document.getElementById('select-all-teams')?.addEventListener('click', function() {
        const visibleCheckboxes = Array.from(teamCheckboxes).filter(cb => 
            !cb.closest('.team-list-item').classList.contains('hidden')
        );
        visibleCheckboxes.forEach(cb => cb.checked = true);
        updateSelection();
    });
    
    document.getElementById('clear-teams')?.addEventListener('click', function() {
        teamCheckboxes.forEach(cb => cb.checked = false);
        updateSelection();
    });
    
    document.getElementById('select-top-teams')?.addEventListener('click', function() {
        const sortedItems = Array.from(teamListItems)
            .filter(item => !item.classList.contains('hidden'))
            .sort((a, b) => parseFloat(b.dataset.points) - parseFloat(a.dataset.points))
            .slice(0, 8);
        
        teamCheckboxes.forEach(cb => cb.checked = false);
        sortedItems.forEach(item => {
            const checkbox = item.querySelector('.team-checkbox');
            if (checkbox) checkbox.checked = true;
        });
        updateSelection();
    });
    
    document.getElementById('add-event-teams')?.addEventListener('click', function() {
        const selectedEvent = eventFilter?.value;
        
        if (!selectedEvent) {
            alert('Please select an event filter first');
            eventFilter?.focus();
            return;
        }
        
        // Select all visible teams from the filtered event
        const visibleCheckboxes = Array.from(teamCheckboxes).filter(cb => 
            !cb.closest('.team-list-item').classList.contains('hidden')
        );
        visibleCheckboxes.forEach(cb => cb.checked = true);
        updateSelection();
    });
    
    // Update selection state
    function updateSelection() {
        const selectedTeams = Array.from(teamCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => ({
                number: cb.value,
                name: cb.closest('.team-list-item')?.dataset.teamName || 'Unknown',
                points: parseFloat(cb.closest('.team-list-item')?.dataset.points || 0)
            }));
        
        // Update hidden select
        if (hiddenSelect.options.length === 0) {
            // Create options if they don't exist
            teamListItems.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.dataset.teamNumber;
                opt.text = `${item.dataset.teamNumber} - ${item.dataset.teamName}`;
                hiddenSelect.appendChild(opt);
            });
        }
        
        const options = Array.from(hiddenSelect.options);
        options.forEach(opt => {
            opt.selected = selectedTeams.some(t => t.number == opt.value);
        });
        
        // Update pills display
        selectedPillsContainer.innerHTML = '';
        if (selectedTeams.length === 0) {
            selectedPillsContainer.innerHTML = '<div class="text-muted small"><i class="fas fa-info-circle me-2"></i>No teams selected. Click teams below to select them.</div>';
        } else {
            selectedTeams.forEach(team => {
                const pill = document.createElement('span');
                pill.className = 'selected-team-pill';
                pill.innerHTML = `
                    <i class="fas fa-robot me-2"></i>
                    <strong>${team.number}</strong>
                    <span class="ms-1">${team.name}</span>
                    <button class="remove-team-btn" data-team="${team.number}" title="Remove team">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                selectedPillsContainer.appendChild(pill);
                
                // Add remove handler
                pill.querySelector('.remove-team-btn').addEventListener('click', function() {
                    const teamNumber = this.dataset.team;
                    const checkbox = document.querySelector(`.team-checkbox[value="${teamNumber}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                        updateSelection();
                    }
                });
            });
        }
        
        // Update status text
        const total = teamListItems.length;
        const visible = Array.from(teamListItems).filter(item => !item.classList.contains('hidden')).length;
        statusText.textContent = `${selectedTeams.length} teams selected from ${visible} visible (${total} total)`;
        
        // Update summary badge
        if (selectedTeams.length === 0) {
            summaryBadge.textContent = 'No teams selected';
            summaryBadge.className = 'badge bg-light text-dark';
        } else if (selectedTeams.length === 1) {
            summaryBadge.textContent = '1 team selected';
            summaryBadge.className = 'badge bg-info text-white';
        } else {
            summaryBadge.textContent = `${selectedTeams.length} teams selected`;
            summaryBadge.className = 'badge bg-success text-white';
        }
        
        // Trigger change event on hidden select for other listeners
        hiddenSelect.dispatchEvent(new Event('change'));
    }
});
</script>

{% if viewer_disabled %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Disable all buttons for viewers
    document.querySelectorAll('button, a.btn').forEach(function(btn) {
        btn.setAttribute('disabled', 'disabled');
        btn.setAttribute('tabindex', '-1');
        btn.setAttribute('title', 'Disabled for viewer role');
        btn.classList.add('disabled');
        btn.onclick = function(e) { e.preventDefault(); return false; };
    });
});
</script>
{% endif %}
{% endblock %}