{% extends 'base.html' %}

{% block title %}Graphs Dashboard{% endblock %}

{% block heading %}Graphs Dashboard{% endblock %}

{% block content %}
{% set viewer_disabled = user_has_role('viewer') %}

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Graph Library</h5>
            </div>
            <div class="card-body">
                <p>Welcome to the Graph Library. This section provides specialized graphs and visualizations for scouting data.</p>
            </div>
        </div>
    </div>
</div>

{% if not viewer_disabled %}
<!-- Team Selection Form -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i> Select Teams to Graph</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('graphs.index') }}" method="get" id="team-selection-form">
                    <!-- Mobile-first responsive design -->
                    <div class="row g-3">
                        <!-- Team Selection Column -->
                        <div class="col-12 col-lg-6">
                            <label for="teams" class="form-label fw-semibold">
                                <i class="fas fa-users me-2 text-primary"></i>Select Teams
                            </label>
                            <select name="teams" id="teams" class="form-select team-select" multiple required>
                                {% for team in all_teams %}
                                <option value="{{ team.team_number }}" 
                                        {% if team.team_number in selected_team_numbers %}selected{% endif %}
                                        data-team-name="{{ team.team_name or 'Unknown' }}"
                                        data-points="{{ team_metrics.get(team.team_number, {}).get('total_points', 0) }}">
                                    {{ team.team_number }} - {{ team.team_name or 'Unknown' }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Search by team number or name. Multiple selections allowed.
                                <span id="team-count-indicator" class="text-muted ms-2"></span>
                            </div>
                            
                            <!-- Quick selection buttons -->
                            <div class="mt-2">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" id="select-all-teams">
                                        <i class="fas fa-check-double me-1"></i>All
                                    </button>
                                    <button type="button" class="btn btn-outline-info" id="add-all-event-teams">
                                        <i class="fas fa-plus-circle me-1"></i>Add Event Teams
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="clear-teams">
                                        <i class="fas fa-times me-1"></i>Clear
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="select-top-teams">
                                        <i class="fas fa-trophy me-1"></i>Top 8
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Filters Column -->
                        <div class="col-12 col-lg-6">
                            <!-- Event Filter -->
                            <div class="mb-3">
                                <label for="event_id" class="form-label fw-semibold">
                                    <i class="fas fa-calendar-alt me-2 text-info"></i>Filter by Event
                                </label>
                                <select name="event_id" id="event_id" class="form-select event-select">
                                    <option value="">All Events</option>
                                    {% for event in all_events %}
                                    <option value="{{ event.id }}" {% if event.id == selected_event_id %}selected{% endif %}>
                                        {{ event.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Filter teams by event. Select "All Events" to see all teams.
                                </div>
                            </div>
                            
                            <!-- Metric Selection -->
                            <div class="mb-3">
                                <label for="metric" class="form-label fw-semibold">
                                    <i class="fas fa-chart-line me-2 text-success"></i>Select Metric
                                </label>
                                <select name="metric" id="metric" class="form-select">
                                    <option value="">Default (Total Points)</option>
                                    <!-- Dynamic period-based metrics -->
                                    <option value="auto_points" {% if selected_metric == 'auto_points' %}selected{% endif %}>Auto Points</option>
                                    <option value="teleop_points" {% if selected_metric == 'teleop_points' %}selected{% endif %}>Teleop Points</option>
                                    <option value="endgame_points" {% if selected_metric == 'endgame_points' %}selected{% endif %}>Endgame Points</option>
                                    <option value="total_points" {% if selected_metric == 'total_points' %}selected{% endif %}>Total Points</option>
                                    <!-- Legacy key_metrics if they exist -->
                                    {% for metric in game_config.get('data_analysis', {}).get('key_metrics', []) %}
                                    {% if ('formula' in metric or metric.get('auto_generated', False)) and metric.id not in ['coral', 'algae', 'accuracy', 'matches_scouted', 'defence', 'caa', 'dr', 'ecp', 'tot'] %}
                                    <option value="{{ metric.id }}" {% if metric.id == selected_metric %}selected{% endif %}>
                                        {{ metric.name }}
                                    </option>
                                    {% endif %}
                                    {% endfor %}

                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Choose the metric to visualize across teams
                                </div>
                            </div>
                            
                            <!-- Data View Type Selection -->
                            <div class="mb-3">
                                <label for="data_view" class="form-label fw-semibold">
                                    <i class="fas fa-eye me-2 text-info"></i>Data View Type
                                </label>
                                <select name="data_view" id="data_view" class="form-select">
                                    <option value="averages" {% if selected_data_view == 'averages' %}selected{% endif %}>
                                        üìä Team Averages (Recommended)
                                    </option>
                                    <option value="matches" {% if selected_data_view == 'matches' %}selected{% endif %}>
                                        üìà Match-by-Match Data
                                    </option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Choose how to display the data - averages for comparison or individual matches for trends.
                                </div>
                            </div>
                            
                            <!-- Graph Type Selection -->
                            <div class="mb-3">
                                <label for="graph_types" class="form-label fw-semibold">
                                    <i class="fas fa-chart-bar me-2 text-warning"></i>Select Graph Types
                                </label>
                                <select name="graph_types" id="graph_types" class="form-select" multiple>
                                    <optgroup label="Basic Charts">
                                        <option value="bar" {% if 'bar' in selected_graph_types %}selected{% endif %}>
                                            üìä Bar Chart
                                        </option>
                                        <option value="line" {% if 'line' in selected_graph_types %}selected{% endif %}>
                                            üìà Line Chart
                                        </option>
                                        <option value="scatter" {% if 'scatter' in selected_graph_types %}selected{% endif %}>
                                            üîµ Scatter Plot
                                        </option>
                                        <option value="area" {% if 'area' in selected_graph_types %}selected{% endif %}>
                                            üìä Area Chart
                                        </option>
                                    </optgroup>
                                    <optgroup label="Distribution Charts">
                                        <option value="box" {% if 'box' in selected_graph_types %}selected{% endif %}>
                                            üì¶ Box Plot
                                        </option>
                                        <option value="violin" {% if 'violin' in selected_graph_types %}selected{% endif %}>
                                            üéª Violin Plot
                                        </option>
                                        <option value="histogram" {% if 'histogram' in selected_graph_types %}selected{% endif %}>
                                            üìä Histogram
                                        </option>
                                    </optgroup>
                                    <optgroup label="Advanced Charts">
                                        <option value="radar" {% if 'radar' in selected_graph_types %}selected{% endif %}>
                                            üï∏Ô∏è Radar Chart
                                        </option>
                                        <option value="heatmap" {% if 'heatmap' in selected_graph_types %}selected{% endif %}>
                                            üî• Heatmap
                                        </option>
                                        <option value="bubble" {% if 'bubble' in selected_graph_types %}selected{% endif %}>
                                            ü´ß Bubble Chart
                                        </option>
                                        <option value="sunburst" {% if 'sunburst' in selected_graph_types %}selected{% endif %}>
                                            ‚òÄÔ∏è Sunburst Chart
                                        </option>
                                        <option value="treemap" {% if 'treemap' in selected_graph_types %}selected{% endif %}>
                                            üå≥ Treemap
                                        </option>
                                        <option value="waterfall" {% if 'waterfall' in selected_graph_types %}selected{% endif %}>
                                            üíß Waterfall Chart
                                        </option>
                                        <option value="sankey" {% if 'sankey' in selected_graph_types %}selected{% endif %}>
                                            üåä Sankey Diagram
                                        </option>
                                    </optgroup>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select multiple graph types to display. Some charts work better with specific metrics and data views.
                                </div>
                                
                                <!-- Quick selection buttons for graph types -->
                                <div class="mt-2">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="select-basic-graphs">
                                            <i class="fas fa-chart-simple me-1"></i>Basic
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="select-distribution-graphs">
                                            <i class="fas fa-chart-area me-1"></i>Distribution
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="select-advanced-graphs">
                                            <i class="fas fa-chart-pie me-1"></i>Advanced
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="clear-graph-types">
                                            <i class="fas fa-times me-1"></i>Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Button - Full width on mobile, centered on desktop -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-grid d-md-flex justify-content-md-center mt-3 gap-2">
                                <button type="submit" class="btn btn-primary btn-lg px-4" id="generate-graphs-btn">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span class="d-none d-sm-inline">Generate </span>Graphs
                                    <div class="spinner-border spinner-border-sm ms-2 d-none" role="status" id="loading-spinner">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </button>
                                <button type="button" class="btn btn-success btn-lg px-4 {% if not plots %}d-none{% endif %}" data-bs-toggle="modal" data-bs-target="#shareModal" id="share-graphs-btn">
                                    <i class="fas fa-share-alt me-2"></i>
                                    <span class="d-none d-sm-inline">Share </span>Graphs
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-info mb-4">
    <i class="fas fa-eye me-2"></i> You have read-only access. You can view graphs but cannot generate new ones or use interactive features.
</div>
{% endif %}

<!-- Generated Graphs -->
{% if plots %}
<div class="row">
    {% for plot_id, plot_json in plots.items() %}
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div id="{{ plot_id }}" class="plotly-graph" data-graph='{{ plot_json }}' style="height: 500px;"></div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% elif selected_team_numbers %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-circle me-2"></i> No data available for the selected teams and filters.
        </div>
    </div>
</div>
{% else %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Select teams above to generate graphs.
        </div>
    </div>
</div>
{% endif %}

<!-- Additional Graph Features -->
<div class="row">
    <div class="col-md-12 mb-4">
        <!-- Advanced Analysis Tools card removed -->
    </div>
</div>

<!-- Share Modal -->
{% if not viewer_disabled %}
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share-alt me-2"></i>Share Your Graphs
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('graphs.create_share') }}" method="post">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Create a shareable link that allows others to view your graphs without needing to log in. 
                        The shared graphs will be read-only and non-password protected, similar to Google Docs viewer mode.
                    </div>
                    
                    <!-- Hidden fields to pass current graph configuration -->
                    {% for team_num in selected_team_numbers %}
                    <input type="hidden" name="teams" value="{{ team_num }}">
                    {% endfor %}
                    {% if selected_event_id %}
                    <input type="hidden" name="event_id" value="{{ selected_event_id }}">
                    {% endif %}
                    <input type="hidden" name="metric" value="{{ selected_metric }}">
                    {% for graph_type in selected_graph_types %}
                    <input type="hidden" name="graph_types" value="{{ graph_type }}">
                    {% endfor %}
                    <input type="hidden" name="data_view" value="{{ selected_data_view }}">
                    
                    <!-- Share configuration -->
                    <div class="mb-3">
                        <label for="share_title" class="form-label fw-semibold">
                            <i class="fas fa-heading me-2"></i>Title <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="share_title" name="share_title" 
                               placeholder="Enter a title for your shared graphs" required maxlength="200">
                        <div class="form-text">
                            This title will be displayed at the top of the shared page.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="share_description" class="form-label fw-semibold">
                            <i class="fas fa-align-left me-2"></i>Description (Optional)
                        </label>
                        <textarea class="form-control" id="share_description" name="share_description" 
                                  rows="3" placeholder="Add a description or notes about these graphs"></textarea>
                        <div class="form-text">
                            Provide context or explanation for viewers.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expires_in_days" class="form-label fw-semibold">
                            <i class="fas fa-clock me-2"></i>Expiration (Optional)
                        </label>
                        <select class="form-select" id="expires_in_days" name="expires_in_days">
                            <option value="">Never expires</option>
                            <option value="1">1 day</option>
                            <option value="7">1 week</option>
                            <option value="30">1 month</option>
                            <option value="90">3 months</option>
                            <option value="365">1 year</option>
                        </select>
                        <div class="form-text">
                            Choose when this shared link should expire.
                        </div>
                    </div>
                    
                    <!-- Simplified configuration summary -->
                    <div class="card bg-light">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Share Summary:
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted d-block">Teams:</small>
                                    <span class="badge bg-primary">
                                        {{ selected_team_numbers|length }} team{{ 's' if selected_team_numbers|length != 1 else '' }}
                                    </span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Event:</small>
                                    <span class="badge bg-info">
                                        {% if selected_event_id %}
                                            Event Selected
                                        {% else %}
                                            All Events
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Metric:</small>
                                    <span class="badge bg-success">{{ selected_metric|title or 'Points' }}</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Graph Types:</small>
                                    <span class="badge bg-warning text-dark">{{ selected_graph_types|length }} type{{ 's' if selected_graph_types|length != 1 else '' }}</span>
                                </div>
                            </div>
                            
                            <!-- Expandable details -->
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#shareDetails" aria-expanded="false">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                            </div>
                            
                            <div class="collapse mt-2" id="shareDetails">
                                <div class="border-top pt-2">
                                    <div class="row">
                                        <div class="col-12">
                                            <strong class="small">Teams:</strong>
                                            <div class="small text-muted" style="max-height: 100px; overflow-y: auto;">
                                                {% for team_num in selected_team_numbers %}
                                                Team {{ team_num }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="col-12 mt-2">
                                            <strong class="small">Graph Types:</strong>
                                            <div class="small text-muted">
                                                {% for graph_type in selected_graph_types %}
                                                {{ graph_type|title }}{% if not loop.last %}, {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% if selected_event_id %}
                                        <div class="col-12 mt-2">
                                            <strong class="small">Event:</strong>
                                            <div class="small text-muted">
                                                {% for event in all_events %}
                                                    {% if event.id == selected_event_id %}{{ event.name }}{% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-share-alt me-2"></i>Create Share Link
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // @ts-nocheck - Disable TypeScript checking for Jinja templates
    // Team-event mapping for dynamic filtering
    const teamEventMapping = {{ team_event_mapping | tojson }};
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Select2 for team selection with mobile-friendly settings
        function initializeTeamSelect() {
            $('#teams').select2({
                theme: 'bootstrap-5',
                placeholder: 'Search and select teams...',
                allowClear: true,
                closeOnSelect: false,
                width: '100%',
                // Append dropdown to body to avoid clipping by parent containers (more reliable on mobile)
                dropdownParent: $(document.body),
                dropdownCssClass: 'select2-dropdown-large', // Custom class for styling the dropdown
                selectionCssClass: 'select2-selection-large', // Custom class for the selection area
                templateResult: function(team) {
                    if (!team.id) return team.text;
                    
                    // Create custom template with team number highlighting
                    const teamNumber = team.text.split(' - ')[0];
                    const teamName = team.text.split(' - ')[1] || '';
                    
                    return $('<span><strong class="text-primary">' + teamNumber + '</strong> - ' + teamName + '</span>');
                },
                templateSelection: function(team) {
                    if (!team.id) return team.text;
                    
                    // Show just team number on mobile, full text on desktop
                    const teamNumber = team.text.split(' - ')[0];
                    const teamName = team.text.split(' - ')[1] || '';
                    
                    if (window.innerWidth < 768) {
                        return teamNumber;
                    } else {
                        return team.text;
                    }
                },
                // Fix for mobile devices
                sorter: function(data) {
                    return data.sort(function(a, b) {
                        return (a.text > b.text) ? 1 : -1;
                    });
                }
            });
        }
        
        // Initialize Select2 for event selection
        $('#event_id').select2({
            theme: 'bootstrap-5',
            placeholder: 'Select an event...',
            allowClear: true,
            width: '100%'
        });
        
        // Initialize Select2 for graph types selection (use dropdownParent to avoid clipping on mobile)
        function initializeGraphTypes() {
            $('#graph_types').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select graph types...',
                allowClear: true,
                closeOnSelect: false,
                width: '100%',
                // Ensure dropdown is appended to a container that won't clip it on small screens
                // Append dropdown to body to avoid clipping by parent containers (more reliable on mobile)
                dropdownParent: $(document.body),
                dropdownCssClass: 'select2-dropdown-large',
                selectionCssClass: 'select2-selection-large'
            });
        }
        initializeGraphTypes();
        
        // Initialize team select
        initializeTeamSelect();
        
        // Store all teams data for filtering
        // Convert the server-provided JSON string to a JavaScript object
        const allTeamsData = {{ all_teams_json|safe }};
        
        
        // Function to filter teams based on selected event
        function filterTeamsByEvent() {
            const selectedEventId = $('#event_id').val();
            const teamSelect = $('#teams');
            
            // Store currently selected teams
            const currentlySelected = teamSelect.val() || [];
            
            // Destroy existing Select2 instance
            if (teamSelect.hasClass('select2-hidden-accessible')) {
                teamSelect.select2('destroy');
            }
            
            // Clear existing options
            teamSelect.empty();
            
            let visibleCount = 0;
            let filteredSelectedTeams = [];
            
            if (!selectedEventId || selectedEventId === '') {
                // Show all teams if no event is selected
                allTeamsData.forEach(function(team) {
                    const option = new Option(team.displayText, team.teamNumber.toString(), false, false);
                    teamSelect.append(option);
                    
                    // Keep selection if this team was previously selected
                    if (currentlySelected.includes(team.teamNumber.toString())) {
                        filteredSelectedTeams.push(team.teamNumber.toString());
                    }
                    visibleCount++;
                });
                
                $('#team-count-indicator').text(`(${visibleCount} teams available)`);
            } else {
                // Show only teams in the selected event
                allTeamsData.forEach(function(team) {
                    const teamEvents = teamEventMapping[team.teamNumber] || [];
                    if (teamEvents.includes(parseInt(selectedEventId))) {
                        const option = new Option(team.displayText, team.teamNumber.toString(), false, false);
                        teamSelect.append(option);
                        
                        // Keep selection if this team was previously selected
                        if (currentlySelected.includes(team.teamNumber.toString())) {
                            filteredSelectedTeams.push(team.teamNumber.toString());
                        }
                        visibleCount++;
                    }
                });
                
                $('#team-count-indicator').text(`(${visibleCount} teams in this event)`);
            }
            
            // Set the filtered selected teams
            teamSelect.val(filteredSelectedTeams);
            
            // Reinitialize Select2
            initializeTeamSelect();
        }
        
        // Event listener for event selection change
        $('#event_id').on('change', function() {
            filterTeamsByEvent();
        });
        
        // Apply initial filter if an event is pre-selected
        if ($('#event_id').val()) {
            filterTeamsByEvent();
        } else {
            // Show initial team count for all teams
            const totalTeams = $('#teams option[value!=""]').length;
            $('#team-count-indicator').text(`(${totalTeams} teams available)`);
        }
        
        // Quick selection button handlers
        $('#select-all-teams').click(function() {
            // Select all currently visible teams (after filtering)
            const allVisibleValues = [];
            $('#teams option').each(function() {
                if ($(this).val()) { // Skip empty values
                    allVisibleValues.push($(this).val());
                }
            });
            $('#teams').val(allVisibleValues).trigger('change');
        });
        
        $('#add-all-event-teams').click(function() {
            const selectedEventId = $('#event_id').val();
            
            if (!selectedEventId || selectedEventId === '') {
                // If no event is selected, show a message
                alert('Please select an event first to add all teams from that event.');
                return;
            }
            
            // Get currently selected teams
            const currentlySelected = $('#teams').val() || [];
            const teamsToAdd = [];
            
            // Find all teams that belong to the selected event
            allTeamsData.forEach(function(team) {
                const teamEvents = teamEventMapping[team.teamNumber] || [];
                if (teamEvents.includes(parseInt(selectedEventId))) {
                    const teamNumberStr = team.teamNumber.toString();
                    // Only add if not already selected
                    if (!currentlySelected.includes(teamNumberStr)) {
                        teamsToAdd.push(teamNumberStr);
                    }
                }
            });
            
            // Combine currently selected teams with new teams
            const allSelectedTeams = currentlySelected.concat(teamsToAdd);
            $('#teams').val(allSelectedTeams).trigger('change');
            
            // Show feedback message
            if (teamsToAdd.length > 0) {
                const eventName = $('#event_id option:selected').text();
                console.log(`Added ${teamsToAdd.length} teams from ${eventName}`);
            } else {
                console.log('All teams from this event are already selected.');
            }
        });
        
        $('#clear-teams').click(function() {
            $('#teams').val(null).trigger('change');
        });
        
        $('#select-top-teams').click(function() {
            // Get the currently selected metric for sorting
            const selectedMetric = $('#metric').val();
            
            // Get all teams and their data
            const teamOptions = [];
            $('#teams option').each(function() {
                if ($(this).val()) {
                    teamOptions.push({
                        value: $(this).val(),
                        text: $(this).text(),
                        points: parseFloat($(this).data('points') || 0)
                    });
                }
            });
            
            // Sort teams by points (descending)
            teamOptions.sort((a, b) => b.points - a.points);
            
            // Select top 8 teams by points
            const topTeamValues = teamOptions.slice(0, 8).map(team => team.value);
            
            // Update selection
            $('#teams').val(topTeamValues).trigger('change');
        });
        
        // Graph Type Selection Button Handlers
        $('#select-basic-graphs').click(function() {
            $('#graph_types').val(['bar', 'line', 'scatter', 'area']).trigger('change');
        });
        
        $('#select-distribution-graphs').click(function() {
            $('#graph_types').val(['box', 'violin', 'histogram']).trigger('change');
        });
        
        $('#select-advanced-graphs').click(function() {
            $('#graph_types').val(['radar', 'heatmap', 'bubble', 'sunburst', 'treemap']).trigger('change');
        });
        
        $('#clear-graph-types').click(function() {
            $('#graph_types').val(null).trigger('change');
        });
        

        
        // Form submission with loading state
        $('#team-selection-form').on('submit', function() {
            const selectedTeams = $('#teams').val();
            
            if (!selectedTeams || selectedTeams.length === 0) {
                alert('Please select at least one team to generate graphs.');
                return false;
            }
            
            // Show loading state
            const btn = $('#generate-graphs-btn');
            const spinner = $('#loading-spinner');
            const originalText = btn.html();
            
            btn.prop('disabled', true);
            spinner.removeClass('d-none');
            
            // Reset button after a timeout (in case of error)
            setTimeout(function() {
                btn.prop('disabled', false);
                spinner.addClass('d-none');
            }, 30000); // 30 seconds timeout
            
            return true;
        });
        
        // Show/hide share button based on whether graphs are generated
        function toggleShareButton() {
            const hasGraphs = $('.plotly-graph').length > 0;
            const selectedTeams = $('#teams').val();
            
            if (hasGraphs && selectedTeams && selectedTeams.length > 0) {
                $('#share-graphs-btn').removeClass('d-none');
            } else {
                $('#share-graphs-btn').addClass('d-none');
            }
        }
        
        // Check share button visibility on page load and form changes
        toggleShareButton();
        $('#teams').on('change', toggleShareButton);
        
        // Responsive handling for Select2
        $(window).on('resize', function() {
            // Reinitialize Select2 on resize to handle template changes
            if ($('#teams').hasClass('select2-hidden-accessible')) {
                $('#teams').select2('destroy');
                initializeTeamSelect();
            }

            if ($('#graph_types').hasClass('select2-hidden-accessible')) {
                $('#graph_types').select2('destroy');
                initializeGraphTypes();
            }
        });
        
        // Wait for Plotly to be available, then render graphs
        function waitForPlotly() {
            if (typeof Plotly !== 'undefined') {
                console.log('Plotly is loaded, rendering graphs...');
                renderPlotlyGraphs();
            } else {
                console.log('Waiting for Plotly to load...');
                setTimeout(waitForPlotly, 100);
            }
        }
        
        waitForPlotly();
    });
    
    // ======== REAL-TIME CONFIG UPDATE LISTENERS ========
    
    // Listen for game config updates that affect analytics
    window.addEventListener('gameConfigUpdated', function(event) {
        const newGameConfig = event.detail;
        console.log('Game config updated in analytics:', newGameConfig);
        
        // Show notification
        showAnalyticsConfigUpdateNotification('Analytics configuration updated due to alliance mode change.');
        
        // Automatically reload analytics data
        reloadAnalyticsWithNewConfig();
    });
    
    // Listen for global config reload events
    window.addEventListener('globalConfigReload', function(event) {
        const configData = event.detail;
        console.log('Global config reload in analytics:', configData);
        
        // Show notification
        showAnalyticsConfigUpdateNotification(`Configuration updated: ${configData.message}`);
        
        // Automatically reload analytics with new config
        reloadAnalyticsWithNewConfig();
    });
    
    // Listen for alliance status changes
    window.addEventListener('allianceStatusUpdated', function(event) {
        const allianceStatus = event.detail;
        console.log('Alliance status updated in analytics:', allianceStatus);
        
        let message;
        if (allianceStatus.is_active) {
            message = `Alliance mode activated. Analytics now use shared data configuration from ${allianceStatus.alliance_info?.alliance_name || 'alliance'}.`;
        } else {
            message = 'Alliance mode deactivated. Analytics now use individual team configuration.';
        }
        
        showAnalyticsConfigUpdateNotification(message);
        reloadAnalyticsWithNewConfig();
    });
    
    // Function to reload analytics content with new configuration
    window.reloadAnalyticsWithNewConfig = function() {
        console.log('Reloading analytics with new configuration...');
        
        try {
            // Get current state
            const currentState = {
                team: document.getElementById('team-filter')?.value || '',
                event: document.getElementById('event-filter')?.value || '',
                match_type: document.getElementById('match-type-filter')?.value || '',
                metric: document.getElementById('metric-selector')?.value || ''
            };
            
            // Reload the analytics data without full page reload
            fetch(window.location.pathname + '?' + new URLSearchParams(currentState))
                .then(response => response.json())
                .then(data => {
                    // Update charts and data tables
                    if (typeof updateAnalyticsCharts === 'function') {
                        updateAnalyticsCharts(data);
                    }
                    
                    // Update any metric selectors with new config
                    if (typeof updateMetricSelectors === 'function') {
                        updateMetricSelectors();
                    }
                    
                    console.log('Analytics reloaded successfully with new configuration');
                    showAnalyticsConfigUpdateNotification('Analytics updated with new configuration', 'success');
                })
                .catch(error => {
                    console.error('Error reloading analytics:', error);
                    showAnalyticsConfigUpdateNotification('Failed to reload analytics. Please refresh the page.', 'error');
                });
        } catch (error) {
            console.error('Error in analytics reload:', error);
            // Fallback to page reload
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    };
    
    // Function to show analytics-specific config update notifications
    function showAnalyticsConfigUpdateNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 450px;';
        notification.innerHTML = `
            <i class="fas fa-chart-line me-2"></i>
            <strong>Analytics Update:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 12 seconds (longer for analytics messages)
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 12000);
    }
</script>
{% if viewer_disabled %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Disable all buttons for viewers
    document.querySelectorAll('button, a.btn').forEach(function(btn) {
        btn.setAttribute('disabled', 'disabled');
        btn.setAttribute('tabindex', '-1');
        btn.setAttribute('title', 'Disabled for viewer role');
        btn.classList.add('disabled');
        btn.onclick = function(e) { e.preventDefault(); return false; };
    });
});
</script>
{% endif %}
{% endblock %}