{% extends 'base.html' %}

{% block title %}Edit Game Configuration{% endblock %}

{% block heading %}Edit Game Configuration{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Edit {{ game_config.game_name }} Configuration</h5>
                <div>
                    <a href="{{ url_for('main.simple_edit_config') }}" class="btn btn-success btn-sm me-2">
                        <i class="fas fa-edit me-1"></i> Simple Editor
                    </a>
                    <a href="{{ url_for('main.config') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-eye me-1"></i> View Configuration
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> Editing the game configuration will affect all aspects of the scouting system. 
                    Make sure you understand the structure and impact of your changes.
                </div>
                
                <p>Edit the JSON configuration below. The system will validate your changes before saving.</p>
                
                <form id="configForm" action="{{ url_for('main.save_config') }}" method="POST">
                    <input type="hidden" name="skip_migration" id="skip_migration" value="">
                    <input type="hidden" name="mapping_confirmed" id="mapping_confirmed" value="">
                    <input type="hidden" name="mapping_suggestions" id="mapping_suggestions" value="">
                    <input type="hidden" name="skip_migration" id="skip_migration" value="">
                    <div class="mb-3">
                        <label for="configJsonEditor" class="form-label">Game Configuration JSON</label>
                        <div id="configJsonEditor" class="json-editor"></div>
                        <textarea id="config_json" name="config_json" hidden>{{ game_config | tojson }}</textarea>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-success me-2">
                                <i class="fas fa-save me-1"></i> Save Configuration
                            </button>
                            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#resetModal">
                                <i class="fas fa-undo me-1"></i> Reset to Default
                            </button>
                        </div>
                        <a href="{{ url_for('main.config') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reset to Default Modal - Moved outside main container to prevent positioning issues -->
<div class="modal fade z-high" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">
                    <i class="fas fa-undo me-2"></i>Reset Configuration to Default
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.reset_config') }}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will completely replace your current configuration with the selected default. This action cannot be undone!
                    </div>
                    
                    <div class="mb-3">
                        <label for="default_config" class="form-label">Select Default Configuration:</label>
                        <select name="default_config" id="default_config" class="form-select" required>
                            <option value="">-- Select a default configuration --</option>
                            {% if default_configs %}
                                {% for config in default_configs %}
                                        {% if config.type == 'game' %}
                                        <option value="{{ config.filename }}">{{ config.display_name }} ({{ config.basename or config.filename }})</option>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No default configurations found</option>
                            {% endif %}
                        </select>
                        <small class="form-text text-muted">
                            Choose from pre-configured game setups for different seasons.
                        </small>
                    </div>
                    
                    <input type="hidden" name="config_type" value="game">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-undo me-1"></i>Reset Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Configuration Structure Guide</h5>
            </div>
            <div class="card-body">
                <h6><i class="fas fa-cog me-2"></i>Basic Game Settings</h6>
                <ul>
                    <li><strong>season:</strong> The year of the FRC season</li>
                    <li><strong>game_name:</strong> The name of the FRC game</li>
                    <li><strong>alliance_size:</strong> Number of teams per alliance (typically 3)</li>
                    <li><strong>match_types:</strong> List of match types in the competition</li>
                    <li><strong>scouting_stations:</strong> Number of scouting stations available</li>
                </ul>
                
                <h6><i class="fas fa-server me-2"></i>FIRST API Settings</h6>
                <ul>
                    <li><strong>current_event_code:</strong> The code for the current event (e.g., "CALA", "NYRO") - used for automatic team/match syncing</li>
                    <li><strong>api_settings:</strong> FIRST API credentials and settings
                        <ul>
                            <li><strong>username:</strong> Your FIRST API username</li>
                            <li><strong>auth_token:</strong> Your FIRST API authorization token</li>
                            <li><strong>base_url:</strong> The base URL for FIRST API (usually https://frc-api.firstinspires.org)</li>
                        </ul>
                    </li>
                </ul>
                
                <h6><i class="fas fa-list-alt me-2"></i>Game Periods</h6>
                <p>Each period (auto_period, teleop_period, endgame_period) contains:</p>
                <ul>
                    <li><strong>duration_seconds:</strong> How long the period lasts</li>
                    <li><strong>scoring_elements:</strong> List of elements to track during this period</li>
                </ul>
                
                <h6><i class="fas fa-th-list me-2"></i>Scoring Elements</h6>
                <p>Each scoring element contains:</p>
                <ul>
                    <li><strong>id:</strong> Unique identifier used in formulas and data storage</li>
                    <li><strong>name:</strong> Display name shown on forms and reports</li>
                    <li><strong>type:</strong> Type of input (boolean, counter, select, rating, text)</li>
                    <li><strong>default:</strong> Default value for the element</li>
                    <li><strong>options:</strong> List of options for select elements</li>
                </ul>
                
                <h6><i class="fas fa-chart-line me-2"></i>Data Analysis</h6>
                <p>The data_analysis section contains:</p>
                <ul>
                    <li><strong>key_metrics:</strong> Formulas used to calculate performance metrics</li>
                    <li><strong>visualization:</strong> Configuration for charts and graphs</li>
                </ul>
                <div class="mt-3">
                    <a href="{{ url_for('main.analytics_config_averages') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-calculator me-1"></i> View All Averages
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/vendor/ace.js') }}"></script>

<style>
/* Ensure ACE editor visible in the game JSON editor */
#configJsonEditor {
    min-height: 600px;
    height: 600px;
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 4px;
}
body.dark-mode #configJsonEditor {
    border-color: rgba(255,255,255,0.1);
}
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the JSON editor
        const editor = ace.edit("configJsonEditor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/json");
        // Parse the config safely (already JSON from Jinja tojson)
        const configData = {{ game_config | tojson | safe }};
        editor.setValue(JSON.stringify(configData || window.GAME_CONFIG || {}, null, 2));
        editor.clearSelection();
        try { editor.gotoLine(1); } catch(e) { /* ignore */ }
        editor.setOptions({
            fontSize: "14px",
            showPrintMargin: false,
            showGutter: true
        });
        
        // Intercept form submit to check mapping first (ask user if they want to migrate old data)
        document.getElementById('configForm').addEventListener('submit', function(e) {
            // If mapping has been confirmed on client, bypass check
            if (document.getElementById('mapping_confirmed').value === 'true') {
                // Remove confirmation so future submits re-check
                document.getElementById('mapping_confirmed').value = '';
                return true;
            }
            e.preventDefault();
            // Validate JSON
            let configJson;
            try {
                configJson = JSON.parse(editor.getValue());
            } catch (err) {
                alert('Invalid JSON: ' + err.message);
                return false;
            }

            // Build payload for check-mapping endpoint
            const payload = { new_config: configJson, original_config: {{ game_config | tojson | safe }} };

            fetch('{{ url_for("main.check_mapping") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(data => {
                if (data.mapping_needed) {
                    // Show a confirmation modal
                    if (!document.getElementById('migrationConfirmModal')) {
                        const modalHtml = `
                            <div class="modal fade" id="migrationConfirmModal" tabindex="-1" aria-labelledby="migrationConfirmLabel" aria-hidden="true">
                              <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="migrationConfirmLabel">Remap Scoring Elements?</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                  <div class="modal-body">We detected changes to scoring elements. Would you like to remap existing scouting data to the new configuration?</div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" id="migrationSkipBtn">No, Skip Migration</button>
                                    <button type="button" class="btn btn-primary" id="migrationProceedBtn">Yes, Show Migration Options</button>
                                  </div>
                                </div>
                              </div>
                            </div>`;
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                    }
                    const migrationModal = new bootstrap.Modal(document.getElementById('migrationConfirmModal'));
                    migrationModal.show();
                    // Persist mapping suggestions on the form so the server can reuse them
                    document.getElementById('mapping_suggestions').value = JSON.stringify(data.mapping_suggestions || {});
                    document.getElementById('migrationSkipBtn').onclick = function() {
                        document.getElementById('skip_migration').value = 'true';
                        document.getElementById('config_json').value = JSON.stringify(configJson);
                        migrationModal.hide();
                        document.getElementById('configForm').submit();
                    };
                    document.getElementById('migrationProceedBtn').onclick = function() {
                        document.getElementById('mapping_confirmed').value = 'true';
                        document.getElementById('mapping_suggestions').value = JSON.stringify(data.mapping_suggestions || {});
                        // Post to the standard save path to render migration UI (no skip flag)
                        document.getElementById('config_json').value = JSON.stringify(configJson);
                        migrationModal.hide();
                        document.getElementById('configForm').submit();
                    };
                } else {
                    // no migration needed, just save
                    document.getElementById('config_json').value = JSON.stringify(configJson);
                    document.getElementById('configForm').submit();
                }
            }).catch(err => {
                console.error('check mapping failed', err);
                // fallback: submit normally
                document.getElementById('config_json').value = JSON.stringify(configJson);
                document.getElementById('configForm').submit();
            });
            return false;
        });

        // Validate and update the hidden form field on load
        try {
            JSON.parse(editor.getValue());
            document.getElementById('config_json').value = editor.getValue();
        } catch (e) {
            // If invalid on initial load, log the error and leave textarea empty so user can correct
            console.warn('Config editor initial JSON invalid:', e);
        }
    });
</script>
{% endblock %}
{% endblock %}