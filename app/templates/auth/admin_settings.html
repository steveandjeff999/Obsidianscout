{% extends "base.html" %}
{% import '_help_icon.html' as help %}
{% block title %}Admin Settings{% endblock %}

{% block head %}
<style>
/* Ensure admin settings page respects sidebar layout - backup for when JS fails */
@media (min-width: 992px) {
    /* Let JavaScript handle the dynamic margins, but ensure CSS doesn't interfere */
    body.with-sidebar main,
    body.with-sidebar footer,
    body.with-sidebar .topbar {
        /* Remove any static margins that might conflict */
        margin-left: auto !important;
        width: auto !important;
    }

    /* But ensure the layout classes are applied */
    body.with-sidebar:not(.sidebar-collapsed) main {
        /* CSS fallback - JS should override this */
        margin-left: var(--sidebar-width) !important;
    }

    body.with-sidebar.sidebar-collapsed main {
        /* CSS fallback for collapsed state */
        margin-left: 72px !important;
    }

    body.with-sidebar:not(.sidebar-collapsed) .topbar {
        width: calc(100% - var(--sidebar-width)) !important;
    }

    body.with-sidebar.sidebar-collapsed .topbar {
        width: calc(100% - 72px) !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>
                <i class="fas fa-cogs"></i> Admin Settings {{ help.help_icon('Administrative settings and system configuration options. Manage users, API keys, exports and more from here.', 'Admin settings') }}
            </h2>
            <p class="text-muted">Administrative settings and system configuration options.</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="adminSettingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-site-controls" data-bs-toggle="tab" data-bs-target="#pane-site-controls" type="button" role="tab" aria-controls="pane-site-controls" aria-selected="true">Site controls</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-integrations" data-bs-toggle="tab" data-bs-target="#pane-integrations" type="button" role="tab" aria-controls="pane-integrations" aria-selected="false">Integrations &amp; configuration</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-data" data-bs-toggle="tab" data-bs-target="#pane-data" type="button" role="tab" aria-controls="pane-data" aria-selected="false">Data &amp; maintenance</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-navigation" data-bs-toggle="tab" data-bs-target="#pane-navigation" type="button" role="tab" aria-controls="pane-navigation" aria-selected="false">Navigation</button>
                </li>
            </ul>

            <div class="tab-content mt-3" id="adminSettingsTabsContent">
                <div class="tab-pane fade show active" id="pane-site-controls" role="tabpanel" aria-labelledby="tab-site-controls">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-users"></i> User Management {{ help.help_icon('Create and manage user accounts and roles. Invite or revoke access and assign permissions.', 'User management') }}</h5></div>
                                <div class="card-body d-flex flex-column">
                                    <p class="mb-3">Manage user accounts, roles, and permissions.</p>
                                    <div class="mt-auto"><a href="{{ url_for('auth.manage_users') }}" class="btn btn-primary"><i class="fas fa-users"></i> Manage Users</a></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-user-lock"></i> Account Settings {{ help.help_icon('Control new account registration and lock/unlock account creation for your installation.', 'Account settings') }}</h5></div>
                                <div class="card-body d-flex flex-column">
                                    <p class="mb-3">Control new account registration for your team.</p>
                                    <div class="mt-auto">
                                        <form method="POST" action="{{ url_for('auth.toggle_account_lock') }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button id="accountLockBtn" type="submit" class="btn btn-secondary"><i id="accountLockIcon" class="fas fa-spinner fa-spin"></i> <span id="accountLockText">Loading...</span></button>
                                            <p id="accountLockStatus" class="mt-2 small text-muted">Checking server...</p>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-palette"></i> Appearance {{ help.help_icon('Manage site appearance settings and visual features that apply to all users on this installation.', 'Appearance') }}</h5></div>
                                <div class="card-body d-flex flex-column">
                                    <p class="mb-3">Toggle a modern 'liquid glass' frosted button appearance across the UI for your team's users.</p>
                                    <div class="mt-auto">
                                        <form method="POST" action="{{ url_for('auth.toggle_liquid_glass_buttons') }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button id="liquidGlassBtn" type="submit" class="btn btn-secondary"><i id="liquidGlassIcon" class="fas fa-spinner fa-spin"></i> <span id="liquidGlassText">Loading...</span></button>
                                            <p id="liquidGlassStatus" class="mt-2 small text-muted">Checking server...</p>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-pie"></i> Prediction Settings {{ help.help_icon('Control form predictions and leaderboard accuracy for your team.', 'Prediction settings') }}</h5></div>
                                <div class="card-body d-flex flex-column">
                                    <p class="mb-3">Show a prediction selector on the scouting form and optionally display accuracy on the scout leaderboard.</p>
                                    <div class="mt-auto">
                                        <form method="POST" action="{{ url_for('auth.toggle_predictions') }}" class="d-inline mb-2">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button id="predictionsBtn" type="submit" class="btn btn-secondary"><i id="predictionsIcon" class="fas fa-spinner fa-spin"></i> <span id="predictionsText">Loading...</span></button>
                                            <p id="predictionsStatus" class="mt-2 small text-muted">Checking server...</p>
                                        </form>
                                        <form method="POST" action="{{ url_for('auth.toggle_leaderboard_accuracy') }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                            <button id="leaderboardBtn" type="submit" class="btn btn-secondary"><i id="leaderboardIcon" class="fas fa-spinner fa-spin"></i> <span id="leaderboardText">Loading...</span></button>
                                            <p id="leaderboardStatus" class="mt-2 small text-muted">Checking server...</p>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pane-integrations" role="tabpanel" aria-labelledby="tab-integrations">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-cog"></i> Game Configuration {{ help.help_icon('Open the game configuration editor to manage scoring elements, match periods, and API settings. Changes affect the entire installation.', 'Game config') }}</h5></div>
                                <div class="card-body d-flex flex-column"><p class="mb-3">Configure game settings and scouting parameters.</p><div class="mt-auto"><a href="{{ url_for('main.config') }}" class="btn btn-info"><i class="fas fa-cog"></i> Game Config</a></div></div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-handshake"></i> Scouting Alliances {{ help.help_icon('Manage alliance collaboration settings for scouts. Configure shared dashboards, event participation, and data sharing preferences here.', 'Scouting alliances') }}</h5></div>
                                <div class="card-body d-flex flex-column"><p class="mb-3">Collaborate with other scouting teams by sharing data and resources.</p><div class="mt-auto"><a href="{{ url_for('scouting_alliances.dashboard') }}" class="btn btn-warning"><i class="fas fa-handshake"></i> Alliance Dashboard</a></div></div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-key"></i> API Keys {{ help.help_icon('Manage programmatic access via API keys. Revoke compromised keys and rotate periodically.', 'API keys') }}</h5></div>
                                <div class="card-body d-flex flex-column"><p class="mb-3">Manage API keys for programmatic access to your team's data.</p><div class="mt-auto"><a href="{{ url_for('api_keys.manage_api_keys') }}" class="btn btn-primary"><i class="fas fa-key"></i> Manage API Keys</a></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pane-data" role="tabpanel" aria-labelledby="tab-data">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-chart-line"></i> EPA Data Source {{ help.help_icon('Control how performance data is sourced for graphs and predictions. Choose between your scouted data, Statbotics EPA, or both.', 'EPA source') }}</h5></div>
                                <div class="card-body d-flex flex-column">
                                    <p class="mb-3">Configure Statbotics EPA integration for graphs &amp; predictions.</p>
                                    <p id="epaQuickStatus" class="small text-muted"><i class="fas fa-spinner fa-spin"></i> Loading&hellip;</p>
                                    <div class="mt-auto"><a href="{{ url_for('auth.epa_settings') }}" class="btn btn-info"><i class="fas fa-chart-line"></i> EPA Settings</a>
                                        <p class="small text-muted mt-2"><i class="fas fa-link"></i> Note: using <strong>TBA OPR</strong> modes requires a <strong>The Blue Alliance API key</strong> and a configured current event. Set the key under <a href="{{ url_for('api_keys.manage_api_keys') }}">API Keys</a> and the event in <a href="{{ url_for('main.config') }}">Game Config</a>.</p></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-database"></i> System Status {{ help.help_icon('View system health and monitoring information including recent integrity checks and background jobs.', 'System status') }}</h5></div>
                                <div class="card-body d-flex flex-column"><p class="mb-3">View system health and monitoring information.</p><div class="mt-auto"><a href="{{ url_for('integrity.status') }}" class="btn btn-success"><i class="fas fa-heartbeat"></i> System Status</a></div></div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="fas fa-download"></i> Data Export {{ help.help_icon('Export scouting data and system configurations to Excel or CSV for offline analysis or backups.', 'Data export') }}</h5></div>
                                <div class="card-body d-flex flex-column"><p class="mb-3">Export scouting data and system configurations.</p><div class="mt-auto"><a href="{{ url_for('data.export_excel') }}" class="btn btn-dark"><i class="fas fa-download"></i> Export Data</a></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                {# ---- Navigation Visibility pane ---- #}
                <div class="tab-pane fade" id="pane-navigation" role="tabpanel" aria-labelledby="tab-navigation">
                    <p class="text-muted mb-3">
                        <i class="fas fa-eye-slash me-1"></i>
                        Check items to <strong>show</strong> them in the sidebar. Uncheck to hide them from all users on your team. The Admin Settings button and core auth links are always visible.
                    </p>
                    <form method="POST" action="{{ url_for('auth.save_nav_visibility') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        {% set hni = scouting_team_settings.get_hidden_nav_items() if scouting_team_settings else [] %}
                        {% macro nav_toggle(key, label, icon) %}
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" name="visible_nav_items" value="{{ key }}" id="nav_{{ key }}"
                                {% if key not in hni %}checked{% endif %}>
                            <label class="form-check-label" for="nav_{{ key }}">
                                <i class="{{ icon }} me-1 text-muted" style="width:1.1em;text-align:center;"></i>{{ label }}
                            </label>
                        </div>
                        {% endmacro %}

                        <div class="row">
                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6 class="text-uppercase text-muted small fw-bold mb-3"><i class="fas fa-layer-group me-1"></i>Core</h6>
                                {{ nav_toggle('dashboard', 'Dashboard', 'fas fa-home') }}
                                {{ nav_toggle('scouting_dashboard', 'Scouting Dashboard', 'fas fa-clipboard') }}
                                {{ nav_toggle('start_scouting', 'Start Scouting', 'fas fa-rocket') }}
                                {{ nav_toggle('qualitative_scouting', 'Qualitative Scouting', 'fas fa-star') }}
                                {{ nav_toggle('pit_scouting', 'Pit Scouting', 'fas fa-wrench') }}
                                {{ nav_toggle('scouting_alliances_nav', 'Scouting Alliances', 'fas fa-users') }}
                                {{ nav_toggle('all_data', 'All Data', 'fas fa-list') }}
                                {{ nav_toggle('text_elements', 'Text Elements', 'fas fa-comment-alt') }}
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6 class="text-uppercase text-muted small fw-bold mb-3"><i class="fas fa-chart-bar me-1"></i>Analytics</h6>
                                {{ nav_toggle('teams', 'Teams', 'fas fa-users') }}
                                {{ nav_toggle('team_rankings', 'Team Rankings', 'fas fa-list-ol') }}
                                {{ nav_toggle('matches', 'Matches', 'fas fa-gamepad') }}
                                {{ nav_toggle('alliance_selection', 'Alliance Selection', 'fas fa-handshake') }}
                                {{ nav_toggle('graphs', 'Graphs', 'fas fa-chart-line') }}
                                {{ nav_toggle('comparison', 'Comparison', 'fas fa-columns') }}
                                {{ nav_toggle('config_averages', 'Config Averages', 'fas fa-calculator') }}
                                {{ nav_toggle('custom_pages', 'Custom Pages', 'fas fa-file-alt') }}
                                {{ nav_toggle('strategy', 'Strategy', 'fas fa-chess') }}
                                {{ nav_toggle('strategy_all', 'Strategy â€” All Matches', 'fas fa-th-large') }}
                                {{ nav_toggle('strategy_draw', 'Strategy Draw', 'fas fa-pen-ruler') }}
                                {{ nav_toggle('strategy_live', 'Live Strategy', 'fas fa-broadcast-tower') }}
                                {{ nav_toggle('my_graph_shares', 'My Graph Shares', 'fas fa-share-alt') }}
                                {{ nav_toggle('my_ranking_shares', 'My Ranking Shares', 'fas fa-trophy') }}
                                {{ nav_toggle('trends', 'Trends', 'fas fa-chart-line') }}
                                {{ nav_toggle('data', 'Data', 'fas fa-database') }}
                                {{ nav_toggle('simulations', 'Simulations', 'fas fa-dice') }}
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6 class="text-uppercase text-muted small fw-bold mb-3"><i class="fas fa-globe me-1"></i>Community</h6>
                                {{ nav_toggle('users', 'Users', 'fas fa-users') }}
                                {{ nav_toggle('chat', 'Chat', 'fas fa-comments') }}
                                {{ nav_toggle('assistant', 'Assistant', 'fas fa-robot') }}
                                {{ nav_toggle('notifications_nav', 'Notifications', 'fas fa-bell') }}
                                {{ nav_toggle('sponsors', 'Sponsors', 'fas fa-handshake') }}
                                {{ nav_toggle('contact', 'Contact', 'fas fa-envelope') }}
                                {{ nav_toggle('scout_leaderboard', 'Scout Leaderboard', 'fas fa-medal') }}
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <h6 class="text-uppercase text-muted small fw-bold mb-3"><i class="fas fa-question-circle me-1"></i>Help</h6>
                                {{ nav_toggle('documentation', 'Documentation', 'fas fa-book') }}
                                {{ nav_toggle('setup_tutorial', 'Setup &amp; Tutorial', 'fas fa-graduation-cap') }}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Save Navigation Settings</button>
                        <a href="{{ url_for('auth.admin_settings') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-database"></i> System Status {{ help.help_icon('View system health and monitoring information including recent integrity checks and background jobs.', 'System status') }}</h5>
                </div>
                <div class="card-body">
                    <p>View system health and monitoring information.</p>
                    <a href="{{ url_for('integrity.status') }}" class="btn btn-success">
                        <i class="fas fa-heartbeat"></i> System Status
                    </a>
                </div>
            </div>
        </div>

        

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> Data Export {{ help.help_icon('Export scouting data and system configurations to Excel or CSV for offline analysis or backups.', 'Data export') }}</h5>
                </div>
                <div class="card-body">
                    <p>Export scouting data and system configurations.</p>
                    <a href="{{ url_for('data.export_excel') }}" class="btn btn-dark">
                        <i class="fas fa-download"></i> Export Data
                    </a>
                </div>
            </div>
        </div>
    </div>



    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-info-circle"></i> Admin Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current User</h6>
                            <p><strong>Username:</strong> {{ current_user.username }}</p>
                            <p><strong>Roles:</strong> {{ current_user.get_role_names() | join(', ') }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>System Information</h6>
                            <p><strong>Application:</strong> ObsidianScout {{ game_config.season }}</p>
                            <p><strong>Version:</strong>
                                {% if app_version %}
                                    {{ app_version }}
                                {% else %}
                                    <span class="text-muted">unknown</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Admin settings page layout enforcement
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin settings page loaded - enforcing sidebar layout');

    // Function to apply sidebar margins using global function
    function enforceSidebarLayout() {
        if (typeof applySidebarMargin === 'function') {
            console.log('Applying sidebar margin via global function');
            applySidebarMargin();
        } else {
            console.warn('applySidebarMargin function not available, using fallback');
            // Fallback: manually calculate and apply margins
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('main');
            const footer = document.querySelector('footer');
            const topbar = document.querySelector('.topbar');

            if (sidebar && main) {
                const sidebarWidth = sidebar.offsetWidth;
                const isCollapsed = document.body.classList.contains('sidebar-collapsed');

                console.log('Fallback: sidebar width =', sidebarWidth, 'collapsed =', isCollapsed);

                // Apply margins based on sidebar state
                const marginLeft = isCollapsed ? '72px' : sidebarWidth + 'px';

                if (main) main.style.marginLeft = marginLeft;
                if (footer) footer.style.marginLeft = marginLeft;
                if (topbar) {
                    topbar.style.marginLeft = marginLeft;
                    topbar.style.width = `calc(100% - ${marginLeft})`;
                }
            }
        }
    }

    // Apply layout immediately
    enforceSidebarLayout();

    // Re-apply on window resize
    window.addEventListener('resize', function() {
        setTimeout(enforceSidebarLayout, 100);
    });

    // Watch for sidebar collapse/expand events
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                console.log('Body class changed - reapplying sidebar layout');
                setTimeout(enforceSidebarLayout, 50);
            }
        });
    });

    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class']
    });

    // Also watch for sidebar class changes
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        const sidebarObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    console.log('Sidebar class changed - reapplying layout');
                    setTimeout(enforceSidebarLayout, 50);
                }
            });
        });
        sidebarObserver.observe(sidebar, {
            attributes: true,
            attributeFilter: ['class']
        });
    }

    // Periodic check as backup
    setInterval(function() {
        enforceSidebarLayout();
    }, 2000);

    console.log('Admin settings layout enforcement initialized');
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusEl = document.getElementById('accountLockStatus');
    const btn = document.getElementById('accountLockBtn');
    const icon = document.getElementById('accountLockIcon');
    const text = document.getElementById('accountLockText');

    async function refreshStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.account_lock_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const locked = !!data.locked;
            if (locked) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-unlock';
                text.textContent = 'Unlock Account Creation';
                statusEl.className = 'mt-2 small text-warning';
                statusEl.textContent = 'Account creation is currently LOCKED';
            } else {
                btn.className = 'btn btn-warning';
                icon.className = 'fas fa-lock';
                text.textContent = 'Lock Account Creation';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Account creation is currently UNLOCKED';
            }
        } catch (e) {
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }

    // Refresh on load
    refreshStatus();

    // Optional: poll every 10s to keep UI in sync across devices
    setInterval(refreshStatus, 10000);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusEl = document.getElementById('liquidGlassStatus');
    const btn = document.getElementById('liquidGlassBtn');
    const icon = document.getElementById('liquidGlassIcon');
    const text = document.getElementById('liquidGlassText');

    async function refreshGlassStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.liquid_glass_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const enabled = !!data.enabled;
            if (enabled) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-toggle-on';
                text.textContent = 'Disable Liquid Glass Buttons';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Liquid glass buttons are ENABLED for your team';
            } else {
                btn.className = 'btn btn-secondary';
                icon.className = 'fas fa-toggle-off';
                text.textContent = 'Enable Liquid Glass Buttons';
                statusEl.className = 'mt-2 small text-muted';
                statusEl.textContent = 'Liquid glass buttons are DISABLED for your team';
            }
        } catch (e) {
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }

    refreshGlassStatus();
    setInterval(refreshGlassStatus, 10000);

    // Poll and refresh spinning-counter UI
    async function refreshSpinningCounterStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.spinning_counter_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const enabled = !!data.enabled;
            const btn = document.getElementById('spinningCounterBtn');
            const icon = document.getElementById('spinningCounterIcon');
            const text = document.getElementById('spinningCounterText');
            const statusEl = document.getElementById('spinningCounterStatus');
            if (enabled) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-toggle-on';
                text.textContent = 'Disable Spinning Counters';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Spinning counters are ENABLED for your team';
            } else {
                btn.className = 'btn btn-secondary';
                icon.className = 'fas fa-toggle-off';
                text.textContent = 'Enable Spinning Counters';
                statusEl.className = 'mt-2 small text-muted';
                statusEl.textContent = 'Spinning counters are DISABLED for your team';
            }
        } catch (e) {
            const statusEl = document.getElementById('spinningCounterStatus');
            const btn = document.getElementById('spinningCounterBtn');
            const icon = document.getElementById('spinningCounterIcon');
            const text = document.getElementById('spinningCounterText');
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }

    refreshSpinningCounterStatus();
    setInterval(refreshSpinningCounterStatus, 10000);

    // Prediction toggle status
    async function refreshPredictionStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.predictions_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const enabled = !!data.enabled;
            const btn = document.getElementById('predictionsBtn');
            const icon = document.getElementById('predictionsIcon');
            const text = document.getElementById('predictionsText');
            const statusEl = document.getElementById('predictionsStatus');
            if (enabled) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-toggle-on';
                text.textContent = 'Disable Form Predictions';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Predictions are ENABLED on the scouting form';
            } else {
                btn.className = 'btn btn-secondary';
                icon.className = 'fas fa-toggle-off';
                text.textContent = 'Enable Form Predictions';
                statusEl.className = 'mt-2 small text-muted';
                statusEl.textContent = 'Predictions are DISABLED on the scouting form';
            }
        } catch (e) {
            const statusEl = document.getElementById('predictionsStatus');
            const btn = document.getElementById('predictionsBtn');
            const icon = document.getElementById('predictionsIcon');
            const text = document.getElementById('predictionsText');
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }
    refreshPredictionStatus();
    setInterval(refreshPredictionStatus, 10000);

    // Leaderboard accuracy toggle status
    async function refreshLeaderboardStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.leaderboard_accuracy_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const enabled = !!data.enabled;
            const btn = document.getElementById('leaderboardBtn');
            const icon = document.getElementById('leaderboardIcon');
            const text = document.getElementById('leaderboardText');
            const statusEl = document.getElementById('leaderboardStatus');
            if (enabled) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-toggle-on';
                text.textContent = 'Hide Leaderboard Accuracy';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Leaderboard accuracy is VISIBLE for your team';
            } else {
                btn.className = 'btn btn-secondary';
                icon.className = 'fas fa-toggle-off';
                text.textContent = 'Show Leaderboard Accuracy';
                statusEl.className = 'mt-2 small text-muted';
                statusEl.textContent = 'Leaderboard accuracy is HIDDEN for your team';
            }
        } catch (e) {
            const statusEl = document.getElementById('leaderboardStatus');
            const btn = document.getElementById('leaderboardBtn');
            const icon = document.getElementById('leaderboardIcon');
            const text = document.getElementById('leaderboardText');
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }
    refreshLeaderboardStatus();
    setInterval(refreshLeaderboardStatus, 10000);

    // --- EPA quick-status badge on admin page ---
    async function refreshEpaQuickStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.epa_source_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const labels = {
                'scouted_only': '<span class="badge bg-primary">Scouted Only</span>',
                'scouted_with_statbotics': '<span class="badge bg-success">Scouted + Statbotics</span>',
                'statbotics_only': '<span class="badge bg-warning text-dark">Statbotics Only</span>'
            };
            const el = document.getElementById('epaQuickStatus');
            if (el) el.innerHTML = 'Mode: ' + (labels[data.epa_source] || '<span class="badge bg-secondary">Unknown</span>');
        } catch(e) {
            const el = document.getElementById('epaQuickStatus');
            if (el) el.textContent = 'Status unavailable';
        }
    }
    refreshEpaQuickStatus();

});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const storageKey = 'adminSettingsActiveTab';
    // Check URL fragment first (e.g. redirect after form save)
    const hash = window.location.hash;  // e.g. '#tab-navigation'
    let activated = false;
    if (hash) {
        const btn = document.querySelector('#adminSettingsTabs button[data-bs-target="' + hash.replace('#tab-', '#pane-') + '"]')
                 || document.getElementById(hash.replace('#', ''));
        if (btn && typeof btn.click === 'function') { btn.click(); activated = true; }
    }
    // Fall back to saved tab
    if (!activated) {
        const saved = localStorage.getItem(storageKey);
        if (saved) {
            const btn = document.getElementById(saved);
            if (btn && typeof btn.click === 'function') btn.click();
        }
    }

    // persist tab selection
    document.querySelectorAll('#adminSettingsTabs button[data-bs-toggle="tab"]').forEach(function(b) {
        b.addEventListener('shown.bs.tab', function(e) {
            try { localStorage.setItem(storageKey, e.target.id); } catch (err) { /* ignore */ }
        });
    });
});
</script>
<script>
// Page-specific sidebar normalization: ensure this admin page uses the same
// sidebar layout as other admin pages. This clears any transient mobile
// overlay state and triggers the global layout adjuster.
(function(){
    try {
        // Ensure body has the desktop layout classes
        if (!document.body.classList.contains('with-sidebar')) document.body.classList.add('with-sidebar');
        if (!document.body.classList.contains('topbar-fixed')) document.body.classList.add('topbar-fixed');

        // Clear mobile overlay state if present
        if (document.body.classList.contains('sidebar-open')) document.body.classList.remove('sidebar-open');

        // Dispatch the existing sidebar event so other scripts update
        document.dispatchEvent(new CustomEvent('obsidian:sidebar:toggled'));

        // Call the global adjuster multiple times to ensure it takes effect
        if (typeof applySidebarMargin === 'function') {
            try { 
                applySidebarMargin(); 
                // Call again after transitions complete
                setTimeout(applySidebarMargin, 300);
                setTimeout(applySidebarMargin, 600);
                setTimeout(applySidebarMargin, 1000);
            } catch(e) { console.warn('applySidebarMargin error:', e); }
        } else {
            // Fallback: trigger resize events
            window.dispatchEvent(new Event('resize'));
            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
            setTimeout(() => window.dispatchEvent(new Event('resize')), 600);
        }
    } catch (e) { /* ignore */ }
})();
</script>
{% endblock %}
