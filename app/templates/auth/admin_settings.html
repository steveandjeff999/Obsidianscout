{% extends "base.html" %}
{% import '_help_icon.html' as help %}
{% block title %}Admin Settings{% endblock %}

{% block head %}
<style>
/* Ensure admin settings page respects sidebar layout - backup for when JS fails */
@media (min-width: 992px) {
    /* Let JavaScript handle the dynamic margins, but ensure CSS doesn't interfere */
    body.with-sidebar main,
    body.with-sidebar footer,
    body.with-sidebar .topbar {
        /* Remove any static margins that might conflict */
        margin-left: auto !important;
        width: auto !important;
    }

    /* But ensure the layout classes are applied */
    body.with-sidebar:not(.sidebar-collapsed) main {
        /* CSS fallback - JS should override this */
        margin-left: var(--sidebar-width) !important;
    }

    body.with-sidebar.sidebar-collapsed main {
        /* CSS fallback for collapsed state */
        margin-left: 72px !important;
    }

    body.with-sidebar:not(.sidebar-collapsed) .topbar {
        width: calc(100% - var(--sidebar-width)) !important;
    }

    body.with-sidebar.sidebar-collapsed .topbar {
        width: calc(100% - 72px) !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>
                <i class="fas fa-cogs"></i> Admin Settings {{ help.help_icon('Administrative settings and system configuration options. Manage users, API keys, exports and more from here.', 'Admin settings') }}
            </h2>
            <p class="text-muted">Administrative settings and system configuration options.</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> User Management {{ help.help_icon('Create and manage user accounts and roles. Invite or revoke access and assign permissions.', 'User management') }}</h5>
                </div>
                <div class="card-body">
                    <p>Manage user accounts, roles, and permissions.</p>
                    <a href="{{ url_for('auth.manage_users') }}" class="btn btn-primary">
                        <i class="fas fa-users"></i> Manage Users
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-user-lock"></i> Account Settings {{ help.help_icon('Control new account registration and lock/unlock account creation for your installation.', 'Account settings') }}</h5>
                </div>
                <div class="card-body">
                    <p>Control new account registration for your team.</p>
                    <form method="POST" action="{{ url_for('auth.toggle_account_lock') }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button id="accountLockBtn" type="submit" class="btn btn-secondary">
                            <i id="accountLockIcon" class="fas fa-spinner fa-spin"></i>
                            <span id="accountLockText">Loading...</span>
                        </button>
                        <p id="accountLockStatus" class="mt-2 small text-muted">Checking server...</p>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-palette"></i> Appearance {{ help.help_icon('Manage site appearance settings and visual features that apply to all users on this installation.', 'Appearance') }}</h5>
                </div>
                <div class="card-body">
                    <p>Toggle a modern 'liquid glass' frosted button appearance across the UI for your team's users.</p>
                    <form method="POST" action="{{ url_for('auth.toggle_liquid_glass_buttons') }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button id="liquidGlassBtn" type="submit" class="btn btn-secondary">
                            <i id="liquidGlassIcon" class="fas fa-spinner fa-spin"></i>
                            <span id="liquidGlassText">Loading...</span>
                        </button>
                        <p id="liquidGlassStatus" class="mt-2 small text-muted">Checking server...</p>
                    </form>
                </div>
            </div>
        </div>


            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> Game Configuration {{ help.help_icon('Open the game configuration editor to manage scoring elements, match periods, and API settings. Changes affect the entire installation.', 'Game config') }}</h5>
                </div>
                <div class="card-body">
                    <p>Configure game settings and scouting parameters.</p>
                    <a href="{{ url_for('main.config') }}" class="btn btn-info">
                        <i class="fas fa-cog"></i> Game Config
                    </a>
                </div>
            </div>
        </div>

        <!-- Theme Management removed -->

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-handshake"></i> Scouting Alliances {{ help.help_icon('Manage alliance collaboration settings for scouts. Configure shared dashboards, event participation, and data sharing preferences here.', 'Scouting alliances') }}</h5>
                </div>
                <div class="card-body">
                    <p>Collaborate with other scouting teams by sharing data and resources.</p>
                    <a href="{{ url_for('scouting_alliances.dashboard') }}" class="btn btn-warning">
                        <i class="fas fa-handshake"></i> Alliance Dashboard
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-key"></i> API Keys {{ help.help_icon('Manage programmatic access via API keys. Revoke compromised keys and rotate periodically.', 'API keys') }}</h5>
                </div>
                <div class="card-body">
                    <p>Manage API keys for programmatic access to your team's data.</p>
                    <a href="{{ url_for('api_keys.manage_api_keys') }}" class="btn btn-primary">
                        <i class="fas fa-key"></i> Manage API Keys
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-database"></i> System Status {{ help.help_icon('View system health and monitoring information including recent integrity checks and background jobs.', 'System status') }}</h5>
                </div>
                <div class="card-body">
                    <p>View system health and monitoring information.</p>
                    <a href="{{ url_for('integrity.status') }}" class="btn btn-success">
                        <i class="fas fa-heartbeat"></i> System Status
                    </a>
                </div>
            </div>
        </div>

        

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-download"></i> Data Export {{ help.help_icon('Export scouting data and system configurations to Excel or CSV for offline analysis or backups.', 'Data export') }}</h5>
                </div>
                <div class="card-body">
                    <p>Export scouting data and system configurations.</p>
                    <a href="{{ url_for('data.export_excel') }}" class="btn btn-dark">
                        <i class="fas fa-download"></i> Export Data
                    </a>
                </div>
            </div>
        </div>
    </div>



    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-info-circle"></i> Admin Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current User</h6>
                            <p><strong>Username:</strong> {{ current_user.username }}</p>
                            <p><strong>Roles:</strong> {{ current_user.get_role_names() | join(', ') }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>System Information</h6>
                            <p><strong>Application:</strong> ObsidianScout {{ game_config.season }}</p>
                            <p><strong>Version:</strong>
                                {% if app_version %}
                                    {{ app_version }}
                                {% else %}
                                    <span class="text-muted">unknown</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Admin settings page layout enforcement
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin settings page loaded - enforcing sidebar layout');

    // Function to apply sidebar margins using global function
    function enforceSidebarLayout() {
        if (typeof applySidebarMargin === 'function') {
            console.log('Applying sidebar margin via global function');
            applySidebarMargin();
        } else {
            console.warn('applySidebarMargin function not available, using fallback');
            // Fallback: manually calculate and apply margins
            const sidebar = document.querySelector('.sidebar');
            const main = document.querySelector('main');
            const footer = document.querySelector('footer');
            const topbar = document.querySelector('.topbar');

            if (sidebar && main) {
                const sidebarWidth = sidebar.offsetWidth;
                const isCollapsed = document.body.classList.contains('sidebar-collapsed');

                console.log('Fallback: sidebar width =', sidebarWidth, 'collapsed =', isCollapsed);

                // Apply margins based on sidebar state
                const marginLeft = isCollapsed ? '72px' : sidebarWidth + 'px';

                if (main) main.style.marginLeft = marginLeft;
                if (footer) footer.style.marginLeft = marginLeft;
                if (topbar) {
                    topbar.style.marginLeft = marginLeft;
                    topbar.style.width = `calc(100% - ${marginLeft})`;
                }
            }
        }
    }

    // Apply layout immediately
    enforceSidebarLayout();

    // Re-apply on window resize
    window.addEventListener('resize', function() {
        setTimeout(enforceSidebarLayout, 100);
    });

    // Watch for sidebar collapse/expand events
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                console.log('Body class changed - reapplying sidebar layout');
                setTimeout(enforceSidebarLayout, 50);
            }
        });
    });

    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class']
    });

    // Also watch for sidebar class changes
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
        const sidebarObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    console.log('Sidebar class changed - reapplying layout');
                    setTimeout(enforceSidebarLayout, 50);
                }
            });
        });
        sidebarObserver.observe(sidebar, {
            attributes: true,
            attributeFilter: ['class']
        });
    }

    // Periodic check as backup
    setInterval(function() {
        enforceSidebarLayout();
    }, 2000);

    console.log('Admin settings layout enforcement initialized');
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusEl = document.getElementById('accountLockStatus');
    const btn = document.getElementById('accountLockBtn');
    const icon = document.getElementById('accountLockIcon');
    const text = document.getElementById('accountLockText');

    async function refreshStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.account_lock_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const locked = !!data.locked;
            if (locked) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-unlock';
                text.textContent = 'Unlock Account Creation';
                statusEl.className = 'mt-2 small text-warning';
                statusEl.textContent = 'Account creation is currently LOCKED';
            } else {
                btn.className = 'btn btn-warning';
                icon.className = 'fas fa-lock';
                text.textContent = 'Lock Account Creation';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Account creation is currently UNLOCKED';
            }
        } catch (e) {
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }

    // Refresh on load
    refreshStatus();

    // Optional: poll every 10s to keep UI in sync across devices
    setInterval(refreshStatus, 10000);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusEl = document.getElementById('liquidGlassStatus');
    const btn = document.getElementById('liquidGlassBtn');
    const icon = document.getElementById('liquidGlassIcon');
    const text = document.getElementById('liquidGlassText');

    async function refreshGlassStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.liquid_glass_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const enabled = !!data.enabled;
            if (enabled) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-toggle-on';
                text.textContent = 'Disable Liquid Glass Buttons';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Liquid glass buttons are ENABLED for your team';
            } else {
                btn.className = 'btn btn-secondary';
                icon.className = 'fas fa-toggle-off';
                text.textContent = 'Enable Liquid Glass Buttons';
                statusEl.className = 'mt-2 small text-muted';
                statusEl.textContent = 'Liquid glass buttons are DISABLED for your team';
            }
        } catch (e) {
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }

    refreshGlassStatus();
    setInterval(refreshGlassStatus, 10000);

    // Poll and refresh spinning-counter UI
    async function refreshSpinningCounterStatus() {
        try {
            const resp = await fetch("{{ url_for('auth.spinning_counter_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
            const data = await resp.json();
            const enabled = !!data.enabled;
            const btn = document.getElementById('spinningCounterBtn');
            const icon = document.getElementById('spinningCounterIcon');
            const text = document.getElementById('spinningCounterText');
            const statusEl = document.getElementById('spinningCounterStatus');
            if (enabled) {
                btn.className = 'btn btn-success';
                icon.className = 'fas fa-toggle-on';
                text.textContent = 'Disable Spinning Counters';
                statusEl.className = 'mt-2 small text-success';
                statusEl.textContent = 'Spinning counters are ENABLED for your team';
            } else {
                btn.className = 'btn btn-secondary';
                icon.className = 'fas fa-toggle-off';
                text.textContent = 'Enable Spinning Counters';
                statusEl.className = 'mt-2 small text-muted';
                statusEl.textContent = 'Spinning counters are DISABLED for your team';
            }
        } catch (e) {
            const statusEl = document.getElementById('spinningCounterStatus');
            const btn = document.getElementById('spinningCounterBtn');
            const icon = document.getElementById('spinningCounterIcon');
            const text = document.getElementById('spinningCounterText');
            statusEl.className = 'mt-2 small text-muted';
            statusEl.textContent = 'Could not fetch server status';
            btn.className = 'btn btn-secondary';
            icon.className = 'fas fa-exclamation-triangle';
            text.textContent = 'Retry';
        }
    }

    refreshSpinningCounterStatus();
    setInterval(refreshSpinningCounterStatus, 10000);

});
</script>
<script>
// Page-specific sidebar normalization: ensure this admin page uses the same
// sidebar layout as other admin pages. This clears any transient mobile
// overlay state and triggers the global layout adjuster.
(function(){
    try {
        // Ensure body has the desktop layout classes
        if (!document.body.classList.contains('with-sidebar')) document.body.classList.add('with-sidebar');
        if (!document.body.classList.contains('topbar-fixed')) document.body.classList.add('topbar-fixed');

        // Clear mobile overlay state if present
        if (document.body.classList.contains('sidebar-open')) document.body.classList.remove('sidebar-open');

        // Dispatch the existing sidebar event so other scripts update
        document.dispatchEvent(new CustomEvent('obsidian:sidebar:toggled'));

        // Call the global adjuster multiple times to ensure it takes effect
        if (typeof applySidebarMargin === 'function') {
            try { 
                applySidebarMargin(); 
                // Call again after transitions complete
                setTimeout(applySidebarMargin, 300);
                setTimeout(applySidebarMargin, 600);
                setTimeout(applySidebarMargin, 1000);
            } catch(e) { console.warn('applySidebarMargin error:', e); }
        } else {
            // Fallback: trigger resize events
            window.dispatchEvent(new Event('resize'));
            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
            setTimeout(() => window.dispatchEvent(new Event('resize')), 600);
        }
    } catch (e) { /* ignore */ }
})();
</script>
{% endblock %}
