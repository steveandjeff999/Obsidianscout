{% extends 'base.html' %}
{% import '_help_icon.html' as help %}

{% block title %}Settings{% endblock %}

{% block heading %}Settings{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Display Preferences</h5>
                <p class="text-muted">Choose how offseason placeholder team numbers are shown in the UI. This setting is stored in your browser.</p>
                <p class="text-muted">Control how offseason teams with letter suffixes are shown in the UI. This preference is saved in your browser only.</p>

                <div class="mb-3">
                    <label class="form-label">Team number display {{ help.help_icon('Choose how offseason teams are displayed: numeric placeholder (99xx), original letter suffix when available, or both. This setting only affects your local browser.', 'Team number display') }}</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="display_pref" id="pref_99xx" value="99xx">
                        <label class="form-check-label" for="pref_99xx">Show numeric 99xx placeholder (default)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="display_pref" id="pref_letter" value="letter">
                        <label class="form-check-label" for="pref_letter">Show original letter-suffixed team IDs (when available)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="display_pref" id="pref_both" value="both">
                        <label class="form-check-label" for="pref_both">Show both: numeric 99xx (and letter in parentheses when available)</label>
                    </div>
                </div>

                <div class="mt-3">
                    <button id="saveSettingsBtn" class="btn btn-primary">Save</button>
                    <button id="resetSettingsBtn" class="btn btn-outline-secondary">Reset to default</button>
                    <div id="settingsStatus" class="mt-2 d-none"></div>
                </div>

                <hr />
                <h5 class="card-title mt-3">UI Animations</h5>
                <p class="text-muted">Control whether numeric count-up animations run on this device. This preference is saved in your browser.</p>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="countupEnabledToggle">
                    <label class="form-check-label" for="countupEnabledToggle">Enable numeric count-up animations {{ help.help_icon('When enabled, numbers animate from 0 to their final values on certain dashboards for a visual effect. Disable for performance or accessibility.', 'Count-up animations') }}</label>
                </div>

                <hr />
                <h5 class="card-title mt-3">Appearance &amp; Layout</h5>
                <p class="text-muted">Additional per-user preferences stored locally in your browser.</p>

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="darkModeToggle">
                    <label class="form-check-label" for="darkModeToggle">Enable dark mode {{ help.help_icon('Toggle dark mode for the UI. This is stored locally and affects charts, forms, and popovers for readability in low-light environments.', 'Dark mode') }}</label>
                </div>

                <!-- Theme selection removed: controlled via system or server-side theme manager -->

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="sidebarCollapsedToggle">
                    <label class="form-check-label" for="sidebarCollapsedToggle">Collapse sidebar by default on desktop {{ help.help_icon('Collapse the sidebar on wide screens to increase content area. You can still toggle it manually.', 'Sidebar collapse') }}</label>
                </div>

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="compactDensityToggle">
                    <label class="form-check-label" for="compactDensityToggle">Use compact layout density {{ help.help_icon('Compress spacing across the UI for more content per screen; may reduce readability on small devices.', 'Compact density') }}</label>
                </div>

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="liquidGlassToggle">
                    <label class="form-check-label" for="liquidGlassToggle">Enable Liquid Glass Buttons (requires server) {{ help.help_icon('A visual appearance option that gives buttons a frosted, glass-like look. Requires server enablement for your team.', 'Liquid glass buttons') }}</label>
                </div>

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="showHelpIconsToggle">
                    <label class="form-check-label" for="showHelpIconsToggle">Show inline help icons {{ help.help_icon('Show or hide the small question-mark help icons across the site. This preference is stored in your browser and affects popovers and inline hints.', 'Show help icons') }}</label>
                </div>

                <!-- Rounded UI toggle removed from settings (sitewide control preserved) -->

                <!-- Button shape customization removed -->

                <!-- Accent color setting removed - site uses theme defaults -->

                <!-- Border radius slider removed from user settings (managed globally) -->

                <!-- Button size customization removed -->

                <!-- Card elevation customization removed -->

                <!-- Glass control removed from Settings (controlled sitewide) -->

                <div class="mb-3">
                    <label class="form-label">Font size {{ help.help_icon('Adjust the base font size (in pixels). This helps make the UI easier to read on different devices; changes apply immediately and are stored locally.', 'Font size') }} <span id="fontSizeLabel" class="small text-muted ms-2"></span></label>
                    <input type="range" id="fontSizeSlider" class="form-range" min="14" max="20" step="1" title="Adjust base font size" aria-label="Adjust base font size" />
                    <div class="form-text">Drag to adjust the base font size (px). Changes apply immediately.</div>
                </div>

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="reducedMotionToggle">
                    <label class="form-check-label" for="reducedMotionToggle">Reduce motion / disable animations {{ help.help_icon('Reduce non-essential motion for accessibility or device performance. This disables animated transitions and count-up effects where possible.', 'Reduce motion') }}</label>
                </div>

                <hr />
                <h5 class="card-title mt-3">Topbar & Accent Theme</h5>
                <p class="text-muted">Choose a color theme for the top navigation bar and accent highlights across the site. Notifications, the user dropdown, buttons, badges, and other interactive elements will adopt the theme color.</p>
                <div class="mb-3">
                    <label for="navbarThemeSelect" class="form-label">Topbar theme</label>
                    <select id="navbarThemeSelect" class="form-select">
                        <option value="primary">Primary (blue)</option>
                        <option value="neutral">Neutral (light)</option>
                        <option value="indigo">Indigo (accent)</option>
                        <option value="green">Green (success)</option>
                    </select>
                    <div class="form-text">Primary theme uses blue accents on Notifications and User dropdowns; topbar stays neutral.</div>
                </div>

                <!-- 24-hour time preference removed -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
    function readPref(){ try{ return localStorage.getItem('display_offseason_preference') || '99xx'; } catch(e){ return '99xx'; } }
    function writePref(v){ try{ localStorage.setItem('display_offseason_preference', v); }catch(e){} }

    // Generic helpers for boolean prefs
    function readBool(key, def){ try{ const v = localStorage.getItem(key); if(v === null) return def; return v === 'true' || v === '1'; }catch(e){ return def; } }
    function writeBool(key, val){ try{ localStorage.setItem(key, val ? 'true' : 'false'); }catch(e){} }

    document.addEventListener('DOMContentLoaded', function(){
        // Display pref
        var current = readPref();
        try{ document.getElementById('pref_99xx').checked = (current === '99xx'); }catch(e){}
        try{ document.getElementById('pref_letter').checked = (current === 'letter'); }catch(e){}
        try{ var prefBothEl = document.getElementById('pref_both'); if(prefBothEl) prefBothEl.checked = (current === 'both'); }catch(e){}

        // Countup toggle
        var toggle = document.getElementById('countupEnabledToggle');
        try{ if(toggle) toggle.checked = readBool('countup_enabled', true); }catch(e){}

        // Appearance / layout controls
        var darkToggle = document.getElementById('darkModeToggle');
        try{ if(darkToggle) darkToggle.checked = (localStorage.getItem('darkMode') === 'true'); }catch(e){}
        // Wire the settings page dark mode toggle to update the stored preference and page classes
        try {
            if (darkToggle) {
                darkToggle.addEventListener('change', function(evt){
                    try {
                        var now = !!evt.target.checked;
                        try { localStorage.setItem('darkMode', now ? 'true' : 'false'); } catch(e) {}
                        // Keep both html and body in sync so observers react
                        try { if (now) { document.documentElement.classList.add('dark-mode'); document.body.classList.add('dark-mode'); } else { document.documentElement.classList.remove('dark-mode'); document.body.classList.remove('dark-mode'); } } catch(e) {}
                        // Retheme charts and widgets through existing observers
                        try { if (window.rethemePlotlyCharts) window.rethemePlotlyCharts(); } catch(e) {}
                        try { if (window.updateChartJsTheme) window.updateChartJsTheme ? window.updateChartJsTheme() : null; } catch(e) {}
                    } catch(e) {}
                });
            }
        } catch(e) {}

        var themeSelect = document.getElementById('themeSelect');
        try{ if(themeSelect){ var t = localStorage.getItem('obsidian_theme'); if(t) themeSelect.value = t; } }catch(e){}

        var sidebarToggle = document.getElementById('sidebarCollapsedToggle');
        try{ if(sidebarToggle) sidebarToggle.checked = (localStorage.getItem('obsidian_sidebar_collapsed') === '1' || localStorage.getItem('obsidian_sidebar_collapsed') === 'true'); }catch(e){}

        var compactToggle = document.getElementById('compactDensityToggle');
        try{ if(compactToggle) compactToggle.checked = readBool('compact_density', false); }catch(e){}

        var fontSlider = document.getElementById('fontSizeSlider');
        var fontLabel = document.getElementById('fontSizeLabel');
        function updateFontLabel(v){ try{ if(!fontLabel) return; var friendly = (String(v) === '14' ? 'Small' : (String(v) === '16' ? 'Normal' : (String(v) === '18' ? 'Large' : 'Custom'))); fontLabel.textContent = v + 'px ('+friendly+')'; }catch(e){} }
        try{
            var storedFont = localStorage.getItem('font_size');
            var initialPx = 16;
            if(storedFont){
                if(/^[0-9]+$/.test(storedFont)) initialPx = parseInt(storedFont,10);
                else if(storedFont === 'small') initialPx = 14;
                else if(storedFont === 'large') initialPx = 18;
                else initialPx = 16;
            }
            if(fontSlider){ fontSlider.value = initialPx; updateFontLabel(initialPx); }
        }catch(e){}

        var reducedToggle = document.getElementById('reducedMotionToggle');
        try{ if(reducedToggle) reducedToggle.checked = readBool('reduced_motion', false); }catch(e){}
        var navbarThemeSelect = document.getElementById('navbarThemeSelect');
        try{ if(navbarThemeSelect) navbarThemeSelect.value = localStorage.getItem('navbar_theme') || 'neutral'; }catch(e){}

        // Liquid glass button control (per-user preference, honored only if server enabled)
        var liquidToggle = document.getElementById('liquidGlassToggle');
        // Show-help-icons toggle
        var showHelpToggle = document.getElementById('showHelpIconsToggle');
        async function refreshLiquidGlassStatus() {
            try {
                const resp = await fetch("{{ url_for('auth.liquid_glass_status') }}", {headers: {'X-Requested-With':'XMLHttpRequest'}});
                const data = await resp.json();
                const serverEnabled = !!data.enabled;
                if(!liquidToggle) return;
                if(!serverEnabled) {
                    liquidToggle.checked = false;
                    liquidToggle.disabled = true;
                    // Clear any locally-stored preference and remove class
                    try { localStorage.removeItem('liquid_glass_buttons'); } catch(e) {}
                    document.body.classList.remove('liquid-glass-buttons');
                    // Add a title to explain why it's disabled
                    liquidToggle.parentNode.querySelector('label').title = 'This appearance feature is disabled by your team admin.';
                } else {
                    // Server allows liquid glass — use local preference to determine state
                    var pref = localStorage.getItem('liquid_glass_buttons');
                    if(pref === null) pref = 'true'; // default on when allowed
                    liquidToggle.checked = pref === 'true';
                    liquidToggle.disabled = false;
                    if(liquidToggle.checked) document.body.classList.add('liquid-glass-buttons'); else document.body.classList.remove('liquid-glass-buttons');
                }
            } catch(e) {
                console.warn('Failed to fetch liquid glass status', e);
                if(liquidToggle) liquidToggle.disabled = true;
            }
        }
        if(liquidToggle){
            liquidToggle.addEventListener('change', function(evt){
                try{ localStorage.setItem('liquid_glass_buttons', evt.target.checked ? 'true' : 'false') }catch(e){}
                if(evt.target.checked) document.body.classList.add('liquid-glass-buttons'); else document.body.classList.remove('liquid-glass-buttons');
            });
            refreshLiquidGlassStatus();
        }

        // Initialize show-help-icons toggle state and apply preference
        try {
            if (showHelpToggle) {
                showHelpToggle.checked = readBool('show_help_icons', true);
                // Apply class when preference indicates hiding
                var showHelp = readBool('show_help_icons', true);
                if (!showHelp) {
                    document.documentElement.classList.add('hide-help-icons');
                    document.body.classList.add('hide-help-icons');
                } else {
                    document.documentElement.classList.remove('hide-help-icons');
                    document.body.classList.remove('hide-help-icons');
                }
                showHelpToggle.addEventListener('change', function(e){
                    try { writeBool('show_help_icons', e.target.checked); if(!e.target.checked){ document.documentElement.classList.add('hide-help-icons'); document.body.classList.add('hide-help-icons'); } else { document.documentElement.classList.remove('hide-help-icons'); document.body.classList.remove('hide-help-icons'); } showStatus('Help icon preference updated locally.','success'); } catch(e){}
                });
            }
        } catch(e) {}


        // Accent color control
        // Accent color controls removed from UI
        // Accent color feature removed; site uses theme defaults.

        // border radius slider and helpers
        var borderRadiusSlider = document.getElementById('borderRadiusSlider');
        var borderRadiusLabel = document.getElementById('borderRadiusLabel');
        function applyBorderRadius(px){ try{ document.documentElement.style.setProperty('--border-radius', px+'px'); document.body.style.setProperty('--border-radius', px+'px'); // also update modern theme card/control radii
            try{ document.documentElement.style.setProperty('--card-radius', Math.max(px,4)+'px'); document.body.style.setProperty('--card-radius', Math.max(px,4)+'px'); }catch(e){}
            try{ var ctrl = Math.max(px - 4, 4); document.documentElement.style.setProperty('--control-radius', ctrl+'px'); document.body.style.setProperty('--control-radius', ctrl+'px'); }catch(e){}
            // Ensure rounded-ui class is enabled so rounded rules take effect
            try { document.documentElement.classList.add('rounded-ui'); document.body.classList.add('rounded-ui'); localStorage.setItem('rounded_ui','true'); } catch(e){}
            if(borderRadiusLabel) borderRadiusLabel.textContent = px; }catch(e){} }
        try{ var storedBR = parseInt(localStorage.getItem('border_radius')||'8',10); if(borderRadiusSlider){ borderRadiusSlider.value = storedBR; applyBorderRadius(storedBR);} }catch(e){}
        try{ if(borderRadiusSlider){ borderRadiusSlider.addEventListener('input', function(){ try{ var v = parseInt(this.value,10); applyBorderRadius(v); try{ localStorage.setItem('border_radius', String(v)); // toggle rounded-ui when user customizes radius
                try{ localStorage.setItem('rounded_ui','true'); document.documentElement.classList.add('rounded-ui'); document.body.classList.add('rounded-ui'); }catch(e){} }catch(e){} }catch(e){} }); } }catch(e){}

        /* Button size customization removed */

        /* Card elevation customization removed */

        /* Glass toggle removed from Settings UI - sitewide handling remains in base.html */
        // Rounded UI preference removed from Settings UI
            /* Button shape customization removed */

        // 24-hour time preference removed; default to 12-hour throughout app
        try{ document.getElementById('pref_99xx').checked = (current === '99xx'); }catch(e){}
        try{ document.getElementById('pref_letter').checked = (current === 'letter'); }catch(e){}
        try{ var prefBothEl2 = document.getElementById('pref_both'); if(prefBothEl2) prefBothEl2.checked = (current === 'both'); }catch(e){}

        var status = document.getElementById('settingsStatus');
        function showStatus(msg, cls){ if(!status) return; status.className = 'mt-2 text-'+(cls||'success'); status.textContent = msg; status.classList.remove('d-none'); setTimeout(function(){ status.classList.add('d-none'); }, 2500); }

        document.getElementById('saveSettingsBtn').addEventListener('click', function(){
            try{
                var v = document.querySelector('input[name="display_pref"]:checked').value;
                writePref(v);
            }catch(e){}

            try{ if (toggle) writeBool('countup_enabled', toggle.checked); } catch(e) {}
            try{ if (showHelpToggle) writeBool('show_help_icons', showHelpToggle.checked); } catch(e) {}

            // Appearance options
            try{ if(darkToggle){ writeBool('darkMode', darkToggle.checked); if(darkToggle.checked){ document.documentElement.classList.add('dark-mode'); document.body.classList.add('dark-mode'); } else { document.documentElement.classList.remove('dark-mode'); document.body.classList.remove('dark-mode'); } } }catch(e){}
            try{ if(themeSelect && themeSelect.value){ localStorage.setItem('obsidian_theme', themeSelect.value); } }catch(e){}
            try{ if(navbarThemeSelect && navbarThemeSelect.value){ localStorage.setItem('navbar_theme', navbarThemeSelect.value); try{ document.documentElement.classList.remove('nav-theme-primary','nav-theme-neutral','nav-theme-indigo','nav-theme-green'); document.body.classList.remove('nav-theme-primary','nav-theme-neutral','nav-theme-indigo','nav-theme-green'); document.documentElement.classList.add('nav-theme-'+navbarThemeSelect.value); document.body.classList.add('nav-theme-'+navbarThemeSelect.value); }catch(e){} } }catch(e){}
            try{ if(sidebarToggle){ localStorage.setItem('obsidian_sidebar_collapsed', sidebarToggle.checked ? '1' : '0'); if(typeof setSidebarCollapsed === 'function') setSidebarCollapsed(sidebarToggle.checked); } }catch(e){}
            try{ if(compactToggle) writeBool('compact_density', compactToggle.checked); }catch(e){}
            try{ if(fontSlider){ localStorage.setItem('font_size', String(fontSlider.value)); try{ window.dispatchEvent(new Event('storage')); }catch(e){} } }catch(e){}
            try{ if(reducedToggle) writeBool('reduced_motion', reducedToggle.checked); }catch(e){}
                /* Button shape customization removed; no-op */
            // Accent color removed — nothing to save here.
            try{ var br = document.getElementById('borderRadiusSlider') && document.getElementById('borderRadiusSlider').value; if(br){ try{ localStorage.setItem('border_radius', String(br)); try{ localStorage.setItem('rounded_ui','true'); document.documentElement.classList.add('rounded-ui'); document.body.classList.add('rounded-ui'); }catch(e){} }catch(e){} } }catch(e){}
            /* Button size and card elevation customization removed; no-op */
            // Glass preference is managed globally; settings page no longer writes it here
            // Rounded UI preference removal: handled sitewide via early script and not user-configurable here

            // Broadcast storage event where browsers permit constructing StorageEvent
            try{ window.dispatchEvent(new Event('storage')); }catch(e){}

            // Apply team-number mapping immediately
            try{ var tv = document.querySelector('input[name="display_pref"]:checked').value; writePref(tv); }catch(e){}
            try{ if (typeof window.setTeamNumberDisplayPreference === 'function') window.setTeamNumberDisplayPreference(tv); else if (typeof window.applyTeamNumberDisplayPreference === 'function') window.applyTeamNumberDisplayPreference(); } catch(e){}

            showStatus('Preferences saved locally. These are stored in your browser.', 'success');
        });

        document.getElementById('resetSettingsBtn').addEventListener('click', function(){
            try{ localStorage.removeItem('display_offseason_preference'); } catch(e){}
            try{ document.getElementById('pref_99xx').checked = true; }catch(e){}

            // Reset newly added settings to defaults
            try{ localStorage.removeItem('countup_enabled'); if (toggle) toggle.checked = true; } catch(e) {}
            try{ localStorage.removeItem('show_help_icons'); if(showHelpToggle) { showHelpToggle.checked = true; document.documentElement.classList.remove('hide-help-icons'); document.body.classList.remove('hide-help-icons'); } }catch(e){}
            try{ localStorage.removeItem('darkMode'); if(darkToggle) darkToggle.checked = false; document.documentElement.classList.remove('dark-mode'); document.body.classList.remove('dark-mode'); }catch(e){}
            try{ localStorage.removeItem('obsidian_theme'); if(themeSelect) themeSelect.value = ''; }catch(e){}
            try{ localStorage.removeItem('obsidian_sidebar_collapsed'); if(sidebarToggle) sidebarToggle.checked = false; if(typeof setSidebarCollapsed === 'function') setSidebarCollapsed(false); }catch(e){}
            try{ localStorage.removeItem('compact_density'); if(compactToggle) compactToggle.checked = false; document.body.classList.remove('compact-density'); }catch(e){}
            // Accent color removed — no stored value exists to clear.
            try{ localStorage.removeItem('border_radius'); try{ localStorage.removeItem('rounded_ui'); }catch(e){} if(borderRadiusSlider) { borderRadiusSlider.value = 8; // clear inline overrides and remove rounded-ui class
                document.documentElement.style.removeProperty('--border-radius'); document.body.style.removeProperty('--border-radius'); document.documentElement.style.removeProperty('--card-radius'); document.body.style.removeProperty('--card-radius'); document.documentElement.style.removeProperty('--control-radius'); document.body.style.removeProperty('--control-radius'); document.documentElement.classList.remove('rounded-ui'); document.body.classList.remove('rounded-ui'); } }catch(e){}
            /* Button size and card elevation customization removed; no-op */
            try{ localStorage.removeItem('glass_effect'); }catch(e){}
            try{ localStorage.removeItem('font_size'); if(fontSlider){ fontSlider.value = 16; updateFontLabel(16); } document.documentElement.style.fontSize = ''; document.body.style.fontSize = ''; try{ document.documentElement.style.removeProperty('--obsidian-base-font-size'); }catch(e){} try{ window.dispatchEvent(new Event('storage')); }catch(e){} }catch(e){}
            try{ localStorage.removeItem('reduced_motion'); if(reducedToggle) reducedToggle.checked = false; var id='reducedMotionStyle'; var s=document.getElementById(id); if(s && s.parentNode) s.parentNode.removeChild(s); document.documentElement.classList.remove('reduced-motion'); }catch(e){}
            // No longer stored via settings UI
                /* Button shape customization removed; no-op */
            try{ localStorage.removeItem('time_format_24h'); window.TIME_FORMAT_24H = false; }catch(e){}
            try{ localStorage.removeItem('navbar_theme'); if(navbarThemeSelect) navbarThemeSelect.value = 'neutral'; document.documentElement.classList.remove('nav-theme-primary','nav-theme-indigo','nav-theme-green'); document.documentElement.classList.add('nav-theme-neutral'); document.body.classList.remove('nav-theme-primary','nav-theme-indigo','nav-theme-green'); document.body.classList.add('nav-theme-neutral'); }catch(e){}

            try{ if (typeof window.setTeamNumberDisplayPreference === 'function') window.setTeamNumberDisplayPreference('99xx'); else if (typeof window.applyTeamNumberDisplayPreference === 'function') window.applyTeamNumberDisplayPreference(); } catch(e){}

            showStatus('Preferences reset to defaults.', 'secondary');
        });

        // Live handlers for some toggles
        try{ if (darkToggle) darkToggle.addEventListener('change', function(){ try{ writeBool('darkMode', darkToggle.checked); if(darkToggle.checked){ document.documentElement.classList.add('dark-mode'); document.body.classList.add('dark-mode'); } else { document.documentElement.classList.remove('dark-mode'); document.body.classList.remove('dark-mode'); } showStatus('Dark mode preference saved locally.','success'); }catch(e){} }); }catch(e){}
        try{ if (sidebarToggle) sidebarToggle.addEventListener('change', function(){ try{ localStorage.setItem('obsidian_sidebar_collapsed', sidebarToggle.checked ? '1' : '0'); if(typeof setSidebarCollapsed === 'function') setSidebarCollapsed(sidebarToggle.checked); showStatus('Sidebar collapse preference saved locally.','success'); }catch(e){} }); }catch(e){}
        try{ if (compactToggle) compactToggle.addEventListener('change', function(){ try{ writeBool('compact_density', compactToggle.checked); if(compactToggle.checked) document.body.classList.add('compact-density'); else document.body.classList.remove('compact-density'); showStatus('Layout density preference saved locally.','success'); }catch(e){} }); }catch(e){}
        try{ if (reducedToggle) reducedToggle.addEventListener('change', function(){ try{ writeBool('reduced_motion', reducedToggle.checked); // apply immediately
                var id='reducedMotionStyle'; var s=document.getElementById(id);
                if(reducedToggle.checked){ if(!s){ s=document.createElement('style'); s.id=id; s.textContent='* { transition-duration: 0s !important; animation-duration: 0s !important; animation-delay: 0s !important; }'; document.head.appendChild(s); } document.documentElement.classList.add('reduced-motion'); }
                else { if(s && s.parentNode) s.parentNode.removeChild(s); document.documentElement.classList.remove('reduced-motion'); }
                showStatus('Reduced-motion preference saved locally.','success'); }catch(e){} }); }catch(e){}

        // Live font-size slider handler: save and broadcast so applyUserPreferences picks it up
        try{ if (fontSlider) fontSlider.addEventListener('input', function(){ try{ var v = this.value; updateFontLabel(v); try{ localStorage.setItem('font_size', String(v)); }catch(e){} try{ window.dispatchEvent(new Event('storage')); }catch(e){} showStatus('Font size saved locally.','success'); }catch(e){} }); }catch(e){}

        try{ if (navbarThemeSelect) navbarThemeSelect.addEventListener('change', function(){ try{ var v = navbarThemeSelect.value; try{ localStorage.setItem('navbar_theme', v); }catch(e){} // apply immediately
            document.documentElement.classList.remove('nav-theme-primary','nav-theme-neutral','nav-theme-indigo','nav-theme-green');
            document.body.classList.remove('nav-theme-primary','nav-theme-neutral','nav-theme-indigo','nav-theme-green');
            document.documentElement.classList.add('nav-theme-'+v);
            document.body.classList.add('nav-theme-'+v);
            showStatus('Navbar theme preference saved locally.','success'); }catch(e){} }); }catch(e){}

        // Rounded UI toggle removed - no change listener required

    });
})();
</script>
{% endblock %}
