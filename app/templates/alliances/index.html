{% extends 'base.html' %}

{% block title %}Alliance Selection{% endblock %}

{% block heading %}Alliance Selection{% endblock %}
{% block subheading %}Build competitive alliances for {{ current_event.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- Hidden holder for server-side values to avoid embedding Jinja directly in JS -->
    <div id="current-event-id-holder" data-event-id="{{ current_event.id }}" style="display:none"></div>
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-handshake me-2"></i>Alliance Selection - {{ current_event.name }}
                </h5>
                <div class="d-flex align-items-center">
                    <!-- Real-time connection indicator -->
                    <span id="socketStatus" class="badge bg-secondary me-2" style="font-size: 0.7rem;" title="Socket.IO connection status">
                        <i class="fas fa-circle"></i> Connecting...
                    </span>
                </div>
                <div class="btn-group" role="group">
                    <div class="dropdown d-inline-block me-2">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="eventDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-calendar-alt me-1"></i> Select Event
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="eventDropdown">
                            {% for event in events %}
                            <li><a class="dropdown-item {% if event.id == current_event.id %}active{% endif %}" 
                                href="{{ url_for('events.set_current_event', event_id=event.id, redirect_to='alliances.index') }}">
                                {{ event.name }} ({{ event.year }})
                            </a></li>
                            {% endfor %}
                        </ul>
                    </div>
                    <button class="btn btn-light btn-sm" id="refresh-recommendations">
                        <i class="fas fa-sync me-1"></i> Refresh
                    </button>
                    <!-- Trend toggle: default ON -->
                    <div class="form-check form-switch align-self-center ms-2">
                        <input class="form-check-input" type="checkbox" id="trend-toggle" checked>
                        <label class="form-check-label small text-muted" for="trend-toggle">Use recent trends</label>
                    </div>
                    <a href="{{ url_for('alliances.manage_lists', event_id=current_event.id) }}" 
                       class="btn btn-info btn-sm">
                        <i class="fas fa-list me-1"></i> Manage Lists
                    </a>
                    <a href="{{ url_for('alliances.reset_alliances', event_id=current_event.id) }}" 
                       class="btn btn-warning btn-sm" 
                       onclick="return confirm('Are you sure you want to reset all alliance selections?')">
                        <i class="fas fa-undo me-1"></i> Reset All
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Alliance Grid -->
                <div class="row g-3">
                    {% for alliance in alliances %}
                    <div class="col-lg-6">
                        <div class="card border-primary alliance-card" data-alliance-id="{{ alliance.id }}" data-alliance-number="{{ alliance.alliance_number }}">
                            <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold">Alliance {{ alliance.alliance_number }}</h6>
                                <div class="alliance-strength">
                                    <span class="badge bg-secondary" id="alliance-{{ alliance.id }}-strength">0.0 pts</span>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <!-- Captain -->
                                <div class="team-slot mb-2" data-position="captain">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="team-role">
                                            <i class="fas fa-crown text-warning me-2"></i>
                                            <strong>Captain</strong>
                                        </div>
                                        <div class="team-assignment">
                                            {% if alliance.captain_team %}
                                            <div class="team-info">
                                                <span class="badge bg-warning text-dark">{{ alliance.captain_team.team_number }}</span>
                                                <small class="text-muted">{{ alliance.captain_team.team_name[:20] }}...</small>
                                                <button class="btn btn-sm btn-outline-danger ms-2 remove-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="captain">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% else %}
                                            <div class="team-slot-empty">
                                                <span class="text-muted">Click to assign</span>
                                                <button class="btn btn-sm btn-outline-primary assign-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="captain">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- First Pick -->
                                <div class="team-slot mb-2" data-position="first_pick">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="team-role">
                                            <i class="fas fa-medal text-silver me-2"></i>
                                            <strong>1st Pick</strong>
                                        </div>
                                        <div class="team-assignment">
                                            {% if alliance.first_pick_team %}
                                            <div class="team-info">
                                                <span class="badge bg-info">{{ alliance.first_pick_team.team_number }}</span>
                                                <small class="text-muted">{{ alliance.first_pick_team.team_name[:20] }}...</small>
                                                <button class="btn btn-sm btn-outline-danger ms-2 remove-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="first_pick">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% else %}
                                            <div class="team-slot-empty">
                                                <span class="text-muted">Click to assign</span>
                                                <button class="btn btn-sm btn-outline-primary assign-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="first_pick">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Second Pick -->
                                <div class="team-slot mb-2" data-position="second_pick">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="team-role">
                                            <i class="fas fa-medal text-bronze me-2"></i>
                                            <strong>2nd Pick</strong>
                                        </div>
                                        <div class="team-assignment">
                                            {% if alliance.second_pick_team %}
                                            <div class="team-info">
                                                <span class="badge bg-success">{{ alliance.second_pick_team.team_number }}</span>
                                                <small class="text-muted">{{ alliance.second_pick_team.team_name[:20] }}...</small>
                                                <button class="btn btn-sm btn-outline-danger ms-2 remove-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="second_pick">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% else %}
                                            <div class="team-slot-empty">
                                                <span class="text-muted">Click to assign</span>
                                                <button class="btn btn-sm btn-outline-primary assign-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="second_pick">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Third Pick (Backup) -->
                                <div class="team-slot" data-position="third_pick">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="team-role">
                                            <i class="fas fa-user-shield text-secondary me-2"></i>
                                            <strong>Backup</strong>
                                        </div>
                                        <div class="team-assignment">
                                            {% if alliance.third_pick_team %}
                                            <div class="team-info">
                                                <span class="badge bg-secondary">{{ alliance.third_pick_team.team_number }}</span>
                                                <small class="text-muted">{{ alliance.third_pick_team.team_name[:20] }}...</small>
                                                <button class="btn btn-sm btn-outline-danger ms-2 remove-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="third_pick">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% else %}
                                            <div class="team-slot-empty">
                                                <span class="text-muted">Click to assign</span>
                                                <button class="btn btn-sm btn-outline-primary assign-team" 
                                                        data-alliance-id="{{ alliance.id }}" 
                                                        data-position="third_pick">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 alliances-sidebar">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Team Recommendations
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Teams ranked by average total points scored</p>
                <div id="team-recommendations">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading recommendations...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Selection Modal -->
<div class="modal fade" id="teamSelectionModal" tabindex="-1" aria-labelledby="teamSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="teamSelectionModalLabel"><i class="fas fa-robot me-2"></i>Select Team</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control form-control-lg" id="teamSearchInput" 
                               placeholder="Search by team number or name..." autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearchButton">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <small class="text-muted">Press Enter to select if only one team matches</small>
                </div>
                <div id="teamSelectionList" class="list-group" style="max-height: 400px; overflow-y: auto;">
                    <!-- Teams will be populated here -->
                </div>
                <div id="noTeamsFound" class="alert alert-info d-none mt-3">
                    <i class="fas fa-search me-2"></i>No teams found matching your search.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// @ts-nocheck - Disable TypeScript checking for Jinja templates
let currentAllianceId = null;
let currentPosition = null;
let teamRecommendations = [];
// Full list used for selection modal (includes declined teams)
let allTeamsForSelection = [];
// Expose current event id for client-side metric queries (read from DOM to avoid inline Jinja in script)
const currentEventId = (function(){
    const holder = document.getElementById('current-event-id-holder');
    return holder ? holder.dataset.eventId : null;
})();

// Reliable polling mechanism - checks database every 2 seconds
let pollingInterval = null;
const POLLING_INTERVAL_MS = 2000; // Poll every 2 seconds for real-time feel
let lastAllianceState = {};
let isPolling = false;

document.addEventListener('DOMContentLoaded', function() {
    loadRecommendations();
    loadAlliances();
    setupEventListeners();
    startPolling();
});

function startPolling() {
    console.log('Starting database polling (every 2 seconds)');
    updateSocketStatus(true); // Show as "Live" since polling is active
    
    // Poll immediately, then every 2 seconds
    pollingInterval = setInterval(() => {
        if (!isPolling) {
            pollForUpdates();
        }
    }, POLLING_INTERVAL_MS);
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('Polling stopped');
        updateSocketStatus(false);
    }
}

async function pollForUpdates() {
    isPolling = true;
    try {
        // Poll for alliance changes
        await loadAlliancesQuietly();
        // Poll for recommendations (less frequently - only if visible changes)
    } catch (error) {
        console.error('Error polling for updates:', error);
    } finally {
        isPolling = false;
    }
}

// Load alliance data from server
async function loadAlliances() {
    try {
    const response = await fetch(`/alliances/api/get_alliances/${currentEventId}`);
        const data = await response.json();
        
        if (data.success) {
            // Update UI with alliance data
            updateAlliancesUI(data.alliances);
            // Store current state for comparison
            lastAllianceState = JSON.stringify(data.alliances);
        }
    } catch (error) {
        console.error('Error loading alliances:', error);
    }
}

// Quietly load alliances without showing loading indicators (for polling)
async function loadAlliancesQuietly() {
    try {
    const response = await fetch(`/alliances/api/get_alliances/${currentEventId}`);
        const data = await response.json();
        
        if (data.success) {
            const newState = JSON.stringify(data.alliances);
            
            // Only update UI if something changed
            if (newState !== lastAllianceState) {
                console.log('Alliance changes detected, updating UI');
                updateAlliancesUI(data.alliances);
                lastAllianceState = newState;
                
                // Also refresh recommendations when alliances change
                loadRecommendations();
            }
        }
    } catch (error) {
        console.error('Error polling alliances:', error);
    }
}

function updateAlliancesUI(alliances) {
    alliances.forEach(alliance => {
        const allianceCard = document.querySelector(`[data-alliance-id="${alliance.id}"]`);
        if (!allianceCard) return;
        
        // Update each position
        ['captain', 'first_pick', 'second_pick', 'third_pick'].forEach(position => {
            const teamSlot = allianceCard.querySelector(`[data-position="${position}"]`);
            if (!teamSlot) return;
            
            const teamAssignment = teamSlot.querySelector('.team-assignment');
            const teamData = alliance[position];
            
            if (teamData && teamData.team_number) {
                // Team is assigned
                teamAssignment.innerHTML = `
                    <div class="team-info">
                        <span class="badge ${getPositionBadgeClass(position)}">${teamData.team_number}</span>
                        <small class="text-muted">${(teamData.team_name || '').substring(0, 20)}...</small>
                        <button class="btn btn-sm btn-outline-danger ms-2 remove-team" 
                                data-alliance-id="${alliance.id}" 
                                data-position="${position}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                // Add event listener to remove button
                const removeBtn = teamAssignment.querySelector('.remove-team');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        if (confirm('Are you sure you want to remove this team from the alliance?')) {
                            removeTeamFromAlliance(this.dataset.allianceId, this.dataset.position);
                        }
                    });
                }
            } else {
                // Slot is empty
                teamAssignment.innerHTML = `
                    <div class="team-slot-empty">
                        <span class="text-muted">Click to assign</span>
                        <button class="btn btn-sm btn-outline-primary assign-team" 
                                data-alliance-id="${alliance.id}" 
                                data-position="${position}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                
                // Add event listener to assign button
                const assignBtn = teamAssignment.querySelector('.assign-team');
                if (assignBtn) {
                    assignBtn.addEventListener('click', function() {
                        currentAllianceId = this.dataset.allianceId;
                        currentPosition = this.dataset.position;
                        showTeamSelectionModal();
                    });
                }
            }
        });
        
        // Update alliance strength
        updateAllianceStrength(alliance.id);
    });
}

function updateAllianceStrength(allianceId) {
    const allianceCard = document.querySelector(`[data-alliance-id="${allianceId}"]`);
    if (!allianceCard) return;
    
    const strengthBadge = document.getElementById(`alliance-${allianceId}-strength`);
    if (!strengthBadge) return;
    
    // Calculate total points from assigned teams
    let total = 0;
    const assignedBadges = allianceCard.querySelectorAll('.team-info .badge');
    
    assignedBadges.forEach(badge => {
        const teamNumber = badge.textContent.trim();
        const teamInfo = teamRecommendations.find(t => t.team_number == teamNumber);
        if (teamInfo) {
            total += parseFloat(teamInfo.total_points) || 0;
        }
    });
    
    strengthBadge.textContent = `${total.toFixed(1)} pts`;
}

function updateSocketStatus(connected) {
    const statusElement = document.getElementById('socketStatus');
    if (!statusElement) return;
    
    if (connected) {
        statusElement.className = 'badge bg-success me-2';
        statusElement.style.fontSize = '0.7rem';
        statusElement.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Live';
        statusElement.title = 'Auto-refreshing every 2 seconds';
    } else {
        statusElement.className = 'badge bg-danger text-white me-2';
        statusElement.style.fontSize = '0.7rem';
        statusElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Paused';
        statusElement.title = 'Auto-refresh paused';
    }
}

// No longer needed - polling handles all UI updates

function getPositionBadgeClass(position) {
    switch(position) {
        case 'captain': return 'bg-warning text-dark';
        case 'first_pick': return 'bg-info';
        case 'second_pick': return 'bg-success';
        case 'third_pick': return 'bg-secondary';
        default: return 'bg-primary';
    }
}

function showNotification(data) {
    const message = data.action === 'assign' 
        ? `Team ${data.team_number} assigned to Alliance ${data.alliance_number}`
        : `Team removed from Alliance ${data.alliance_number}`;
    
    // Create toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white ${data.action === 'assign' ? 'bg-success' : 'bg-warning'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${data.action === 'assign' ? 'fa-check' : 'fa-minus'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Add to toast container (create if it doesn't exist)
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Initialize and show the toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function setupEventListeners() {
    // Assign team buttons
    document.querySelectorAll('.assign-team').forEach(button => {
        button.addEventListener('click', function() {
            currentAllianceId = this.dataset.allianceId;
            currentPosition = this.dataset.position;
            showTeamSelectionModal();
        });
    });
    
    // Remove team buttons
    document.querySelectorAll('.remove-team').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to remove this team from the alliance?')) {
                removeTeamFromAlliance(this.dataset.allianceId, this.dataset.position);
            }
        });
    });
    
    // Refresh button - refresh both alliances AND recommendations
    document.getElementById('refresh-recommendations').addEventListener('click', function() {
        console.log('Manual refresh triggered');
        loadAlliances();
        loadRecommendations();
    });
    
    // When the trend toggle changes, refresh recommendations
    const trendToggle = document.getElementById('trend-toggle');
    if (trendToggle) {
        trendToggle.addEventListener('change', function() {
            loadRecommendations();
        });
    }
}

function loadRecommendations() {
    // Read the toggle state and send as query param
    const useTrends = document.getElementById('trend-toggle') ? document.getElementById('trend-toggle').checked : true;
    fetch(`/alliances/recommendations/${currentEventId}?use_trends=${useTrends ? 1 : 0}`)
        .then(response => response.json())
        .then(data => {
            teamRecommendations = data.recommendations || [];
            // Keep a separate full copy for the team selection modal so we can show declined teams there
            allTeamsForSelection = Array.isArray(data.recommendations) ? data.recommendations.slice() : [];
            displayRecommendations();
            updateAllianceStrengths();
        })
        .catch(error => {
            console.error('Error loading recommendations:', error);
            document.getElementById('team-recommendations').innerHTML = 
                '<div class="alert alert-danger">Error loading recommendations</div>';
        });
}

function displayRecommendations() {
    const container = document.getElementById('team-recommendations');
    
    if (teamRecommendations.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No available teams for this event</div>';
        return;
    }
    
    // Separate teams into those with data and those without, excluding declined teams from recommendations
    const teamsWithData = teamRecommendations.filter(team => !team.has_no_data && !team.is_declined);
    const teamsWithoutData = teamRecommendations.filter(team => team.has_no_data && !team.is_declined);
    
    // Build HTML for teams with data (ranked)
    let html = teamsWithData.map((team, index) => {
        let badgeClass = 'text-primary';
        let warningIcon = '';
        let rankText = `#${index + 1}`;
        
        if (team.is_do_not_pick) {
            badgeClass = 'text-danger';
            warningIcon = '<i class="fas fa-ban text-danger me-1" title="Do Not Pick"></i>';
            rankText = 'DNP';
        } else if (team.is_avoided) {
            badgeClass = 'text-warning';
            warningIcon = '<i class="fas fa-exclamation-triangle text-warning me-1" title="Avoid"></i>';
        }
        
        // Trend arrow and predicted score
        let trendHtml = '';
        if (team.trend_direction === 'up') {
            trendHtml = '<i class="fas fa-arrow-up text-success me-1" title="Trending up"></i>';
        } else if (team.trend_direction === 'down') {
            trendHtml = '<i class="fas fa-arrow-down text-danger me-1" title="Trending down"></i>';
        } else {
            trendHtml = '<i class="fas fa-minus text-muted me-1" title="No recent trend"></i>';
        }
        const predictedHtml = team.predicted_points ? `<small class="text-muted d-block">Next: ${team.predicted_points} pts</small>` : '';
        return `
            <div class="recommendation-item border-bottom pb-2 mb-2" data-team-id="${team.team_id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold ${badgeClass}">${warningIcon}${rankText} - Team ${team.team_number}</div>
                        <div class="small text-muted">${team.team_name}</div>
                    </div>
                    <div class="text-end">                    <div class="fw-bold">${trendHtml}${team.total_points} pts</div>
                    ${predictedHtml}
                    <div class="small text-muted">
                        ${team.component_metrics_display}
                    </div>
                    </div>
                    <div class="ms-2">
                        <button class="btn btn-sm btn-outline-secondary" title="Decline" onclick="declineTeam(${team.team_number})">
                            <i class="fas fa-user-times d-inline d-md-none"></i>
                            <span class="d-none d-md-inline"><i class="fas fa-user-times me-1"></i>Declined</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // Add separator if we have both types of teams
    if (teamsWithData.length > 0 && teamsWithoutData.length > 0) {
        html += `
            <div class="alert alert-secondary mt-3 mb-3">
                <i class="fas fa-info-circle me-2"></i>Teams without scouting data
            </div>
        `;
    }
    
    // Add teams without data at the end
    html += teamsWithoutData.map(team => {
        let badgeClass = 'text-secondary';
        let warningIcon = '';
        
        if (team.is_do_not_pick) {
            badgeClass = 'text-danger';
            warningIcon = '<i class="fas fa-ban text-danger me-1" title="Do Not Pick"></i>';
        } else if (team.is_avoided) {
            badgeClass = 'text-warning';
            warningIcon = '<i class="fas fa-exclamation-triangle text-warning me-1" title="Avoid"></i>';
        }
        
        // Show flat trend for no-data teams (unless slope provided)
        let trendHtml = '';
        if (team.trend_direction === 'up') {
            trendHtml = '<i class="fas fa-arrow-up text-success me-1" title="Trending up"></i>';
        } else if (team.trend_direction === 'down') {
            trendHtml = '<i class="fas fa-arrow-down text-danger me-1" title="Trending down"></i>';
        } else {
            trendHtml = '<i class="fas fa-minus text-muted me-1" title="No recent trend"></i>';
        }
        const predictedHtml = team.predicted_points ? `<div class="small text-muted mt-1">Next: ${team.predicted_points} pts</div>` : '';
        return `
            <div class="recommendation-item border-bottom pb-2 mb-2" data-team-id="${team.team_id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="fw-bold ${badgeClass}">${warningIcon}${trendHtml}Team ${team.team_number}</div>
                        <div class="small text-muted">${team.team_name}</div>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-secondary">No Data</div>
                        ${predictedHtml}
                    </div>
                    <div class="ms-2">
                        <button class="btn btn-sm btn-outline-secondary" title="Decline" onclick="declineTeam(${team.team_number})">
                            <i class="fas fa-user-times d-inline d-md-none"></i>
                            <span class="d-none d-md-inline"><i class="fas fa-user-times me-1"></i>Declined</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

function showTeamSelectionModal() {
    const modal = new bootstrap.Modal(document.getElementById('teamSelectionModal'));
    
    // Clear search input
    document.getElementById('teamSearchInput').value = '';
    
    // Populate the team list
    populateTeamSelectionList();
    
    // Show the modal
    modal.show();
    
    // Focus on search input after modal is shown and set up event listeners
    document.getElementById('teamSelectionModal').addEventListener('shown.bs.modal', function() {
        const searchInput = document.getElementById('teamSearchInput');
        
        // Reset the search input and filter
        searchInput.value = '';
        filterTeams(); // Call once to reset any filtering
        
        // Set focus after a brief delay to ensure mobile keyboard appears
        setTimeout(() => {
            searchInput.focus();
        }, 300);
        
        // Set up real-time search filtering (remove any existing listeners first)
        searchInput.removeEventListener('input', filterTeams);
        searchInput.removeEventListener('keyup', handleSearchKeyup);
        
        // Use both input and keyup events for more reliable filtering
        searchInput.addEventListener('input', filterTeams);
        searchInput.addEventListener('keyup', handleSearchKeyup);
        
        // Handle search on modal shown - clear any previous search
        const items = document.querySelectorAll('.team-selection-item');
        items.forEach(item => {
            item.classList.remove('filtered-out');
            item.style.display = 'flex';
        });
        
        // Hide "no teams found" message
        document.getElementById('noTeamsFound').classList.add('d-none');
        
        // Ensure any click outside the search doesn't hide the keyboard
        const modalBody = document.querySelector('.modal-body');
        if (modalBody) {
            modalBody.addEventListener('click', function(e) {
                // Don't refocus if clicking on a team item
                if (!e.target.closest('.team-selection-item')) {
                    searchInput.focus();
                }
            });
        }
        
        // Add clear button functionality with forced UI update
        document.getElementById('clearSearchButton').addEventListener('click', function() {
            searchInput.value = '';
            searchInput.focus();
            
            // Show all teams immediately when clearing
            const items = document.querySelectorAll('.team-selection-item');
            items.forEach(item => {
                item.classList.remove('filtered-out');
                item.style.display = 'flex';
            });
            
            // Hide "no teams found" message
            document.getElementById('noTeamsFound').classList.add('d-none');
            
            console.log("Search cleared - showing all teams");
        });
    }, { once: true });
}

function handleSearchKeyup(event) {
    filterTeams();
    
    // Handle Enter key to select first visible team
    if (event.key === 'Enter') {
        const visibleItems = Array.from(document.querySelectorAll('.team-selection-item'))
            .filter(item => item.style.display !== 'none');
        if (visibleItems.length === 1) {
            visibleItems[0].click();
        }
    }
    
    // Handle Escape key to close modal
    if (event.key === 'Escape') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('teamSelectionModal'));
        if (modal) modal.hide();
    }
}

function populateTeamSelectionList() {
    const list = document.getElementById('teamSelectionList');
    
    if (allTeamsForSelection.length === 0) {
        list.innerHTML = '<div class="alert alert-warning">No teams available for selection</div>';
        return;
    }
    
    const html = allTeamsForSelection.map(team => {
        let warningIcon = '';
        let badgeClass = 'bg-primary';
        
        if (team.is_do_not_pick) {
            warningIcon = '<i class="fas fa-ban text-danger me-2"></i>';
            badgeClass = 'bg-danger';
        } else if (team.is_avoided) {
            warningIcon = '<i class="fas fa-exclamation-triangle text-warning me-2"></i>';
            badgeClass = 'bg-warning text-dark';
        }
        
        return `
            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start team-selection-item"
                    data-team-id="${team.team_id}" data-team-number="${team.team_number}" data-team-name="${team.team_name}">
                <div>
                    <div class="fw-bold">${warningIcon}Team ${team.team_number}</div>
                    <div class="small text-muted">${team.team_name}</div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary">${team.total_points} pts</div>
                    ${team.predicted_points ? `<div class="small text-muted">Next: ${team.predicted_points} pts</div>` : ''}
                    <div class="small text-muted">${team.component_metrics_display}</div>
                    ${team.is_avoided || team.is_do_not_pick || team.is_declined ? `<span class="badge ${badgeClass} mt-1">${team.is_declined ? 'Declined' : (team.is_do_not_pick ? 'Do Not Pick' : 'Avoid')}</span>` : ''}
                </div>
            </button>
        `;
    }).join('');
    
    list.innerHTML = html;
    
    // Add click handlers
    document.querySelectorAll('.team-selection-item').forEach(item => {
        item.addEventListener('click', function() {
            const teamNumber = this.dataset.teamNumber;
            assignTeamToAlliance(currentAllianceId, currentPosition, teamNumber);
            bootstrap.Modal.getInstance(document.getElementById('teamSelectionModal')).hide();
        });
    });
    
    // Reset search state
    document.getElementById('noTeamsFound').classList.add('d-none');
}

function filterTeams() {
    const searchTerm = document.getElementById('teamSearchInput').value.toLowerCase().trim();
    const items = document.querySelectorAll('.team-selection-item');
    const noTeamsFound = document.getElementById('noTeamsFound');
    let visibleCount = 0;
    
    // Force a style refresh by removing all items from display first
    items.forEach(item => {
        item.classList.add('filtered-out');
        item.style.display = 'none';
    });
    
    // Small delay to ensure DOM updates
    setTimeout(() => {
        // Apply filtering
        items.forEach(item => {
            const teamNumber = (item.dataset.teamNumber || '').toLowerCase();
            const teamName = (item.dataset.teamName || '').toLowerCase();
            
            // Check if either team number or name contains the search term
            if (teamNumber.includes(searchTerm) || teamName.includes(searchTerm)) {
                item.style.display = 'flex';
                item.classList.remove('filtered-out');
                visibleCount++;
            }
        });
        
        // Show/hide "no teams found" message
        if (visibleCount === 0 && searchTerm.length > 0) {
            noTeamsFound.classList.remove('d-none');
        } else {
            noTeamsFound.classList.add('d-none');
        }
        
        console.log(`Search: "${searchTerm}" - Found ${visibleCount} teams (UI updated)`);
    }, 10);
    
    // Update visible count for debugging/feedback
    console.log(`Search: "${searchTerm}" - Found ${visibleCount} teams`);
}

function assignTeamToAlliance(allianceId, position, teamNumber) {
    console.log('Assigning team', teamNumber, 'to alliance', allianceId, 'position', position);
    
    fetch('/alliances/api/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            alliance_id: allianceId,
            position: position,
            team_id: teamNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Server response:', data);
        
        if (!data.success) {
            alert('Error: ' + data.message);
            return;
        }

        // Force immediate refresh after assignment
        console.log('Assignment successful, refreshing data');
        loadAlliancesQuietly();
        loadRecommendations();
    })
    .catch(error => {
        console.error('Error assigning team:', error);
        alert('Network error occurred: ' + error.message);
    });
}

function removeTeamFromAlliance(allianceId, position) {
    console.log('Removing team from alliance', allianceId, 'position', position);
    
    fetch('/alliances/api/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            alliance_id: allianceId,
            position: position
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Server response:', data);
        
        if (!data.success) {
            alert('Error: ' + data.message);
            return;
        }

        // Force immediate refresh after removal
        console.log('Removal successful, refreshing data');
        loadAlliancesQuietly();
        loadRecommendations();
    })
    .catch(error => {
        console.error('Error removing team:', error);
        alert('Network error occurred: ' + error.message);
    });
}

function updateAllianceStrengths() {
    try {
        // Build a lookup of team_number -> total_points from the loaded recommendations
        const scoreByTeamNumber = {};
        teamRecommendations.forEach(t => {
            const key = String(t.team_number);
            scoreByTeamNumber[key] = Number(t.total_points) || 0;
        });

        // For each alliance card, sum assigned teams' scores and update the badge
        document.querySelectorAll('.alliance-card').forEach(card => {
            const allianceId = card.dataset.allianceId;
            const strengthBadge = document.getElementById(`alliance-${allianceId}-strength`);
            if (!strengthBadge) return;

            // Find assigned team badges inside this card
            const assignedBadges = card.querySelectorAll('.team-info .badge');
            let total = 0;
            const missingTeamNumbers = [];

            assignedBadges.forEach(b => {
                const txt = (b.textContent || '').trim();
                const teamNumMatch = txt.match(/\d+/);
                const teamNum = teamNumMatch ? String(teamNumMatch[0]) : txt;
                if (teamNum) {
                    const val = scoreByTeamNumber[teamNum];
                    if (typeof val !== 'undefined') {
                        total += Number(val) || 0;
                    } else {
                        missingTeamNumbers.push(teamNum);
                    }
                }
            });

            if (missingTeamNumbers.length === 0) {
                strengthBadge.textContent = `${total.toFixed(1)} pts`;
            } else {
                // Fetch metrics for missing teams in parallel
                const fetches = missingTeamNumbers.map(tn => fetch(`/alliances/api/team_metrics?team_number=${encodeURIComponent(tn)}&event_id=${currentEventId}`)
                    .then(r => r.json()).catch(() => null));

                Promise.all(fetches).then(results => {
                    results.forEach(res => {
                        if (res && typeof res.total_points !== 'undefined') {
                            total += Number(res.total_points) || 0;
                        }
                    });

                    strengthBadge.textContent = `${total.toFixed(1)} pts`;
                }).catch(e => {
                    console.warn('Failed to fetch team metrics for alliance badge:', e);
                    strengthBadge.textContent = `${total.toFixed(1)} pts`;
                });
            }
        });
    } catch (e) {
        console.warn('Failed to build recommendations lookup for alliance strengths:', e);
    }
}

function declineTeam(teamNumber) {
    if (!confirm(`Decline Team ${teamNumber} from recommendations?`)) return;

    fetch('/alliances/api/add_to_list', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ team_number: teamNumber, event_id: currentEventId, list_type: 'declined', reason: '' })
    })
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            alert('Error: ' + data.message);
            return;
        }
        // Refresh recommendations to remove the declined team
        loadRecommendations();
    })
    .catch(e => { console.error('Error declining team:', e); alert('Network error'); });
}
</script>

<style>
.text-silver {
    color: #c0c0c0;
}

.text-bronze {
    color: #cd7f32;
}

.alliance-card {
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.2s ease-in-out;
}

.team-slot {
    background-color: rgba(0, 0, 0, 0.03);
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease-in-out;
}

.team-slot:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.team-slot-empty {
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.team-info {
    display: flex;
    align-items: center;
}

/* This ensures filtered teams are truly hidden */
.filtered-out {
    display: none !important;
    height: 0 !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
}

/* Make sure active teams are visible */
.team-selection-item:not(.filtered-out) {
    display: flex !important;
}

/* Improve visibility of search results */
#teamSelectionList {
    max-height: 400px;
    overflow-y: auto;
    transition: all 0.3s ease;
}


/* Add comfortable spacing between team rows in dark mode only.
   Use high-specificity selectors so this wins over global dark-mode rules. */
.dark-mode #teamSelectionList .team-selection-item,
body.modern-layout.dark-mode #teamSelectionList .team-selection-item {
    display: flex !important; /* keep layout consistent */
    align-items: flex-start !important;
    padding: 0.95rem 1rem !important; /* increase tappable area (more vertical room) */
    margin: 0.45rem 0 !important; /* vertical gap between items */
    border-radius: 0.5rem !important; /* slight rounding for separated cards */
    border: 1px solid rgba(255,255,255,0.06) !important; /* subtle separation in dark mode */
    background-clip: padding-box !important;
    min-height: 76px !important; /* Increased for mobile - prevents text cutoff */
}

/* Mobile-specific fixes for team selection items - ensure adequate height on all screen sizes */
.team-selection-item {
    min-height: 76px !important; /* Ensure enough height for all content */
    padding: 1rem !important; /* Comfortable padding for mobile */
    display: flex !important;
    align-items: flex-start !important; /* Align to top to prevent vertical centering issues */
    flex-wrap: nowrap !important; /* Prevent wrapping */
}

/* Ensure the content containers within team items have proper spacing */
.team-selection-item > div {
    display: flex;
    flex-direction: column;
    gap: 0.25rem; /* Space between lines */
    overflow: visible !important; /* Prevent content from being hidden */
    min-height: fit-content !important;
}

/* Fix for the specific data display in team items */
.team-selection-item .text-end {
    text-align: right;
    white-space: normal !important; /* Allow wrapping if needed */
    overflow: visible !important;
}

.team-selection-item .small {
    line-height: 1.4 !important; /* Better line spacing for readability */
    display: block !important; /* Ensure proper block display */
    margin-top: 0.15rem !important;
}

/* Trend icon sizing and alignment for recommendation list */
.recommendation-item .fa-arrow-up,
.recommendation-item .fa-arrow-down,
.recommendation-item .fa-minus {
    width: 1.1em;
    text-align: center;
}

/* Slightly larger for modal list to increase tap target */
.team-selection-item .fa-arrow-up,
.team-selection-item .fa-arrow-down,
.team-selection-item .fa-minus {
    font-size: 1.05rem;
}

/* Mobile-specific adjustments for smaller screens */
@media (max-width: 768px) {
    .team-selection-item {
        min-height: 80px !important; /* Extra height for mobile to prevent any cutoff */
        padding: 1.1rem 0.9rem !important;
    }
    
    #teamSelectionList {
        max-height: 60vh !important; /* Ensure scrollable on mobile */
    }
    
    /* Make text slightly smaller on very small screens if needed */
    @media (max-width: 380px) {
        .team-selection-item .small {
            font-size: 0.8rem !important;
        }
    }
}

/* Remove old full-width bottom borders that visually merged items when we use spacing */
body.modern-layout.dark-mode .modal-content .list-group-item,
body.modern-layout.dark-mode .modal-content .team-selection-item {
    border-bottom: none !important;
}

/* Improve focus indicator for search input */
#teamSearchInput:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    border-color: #86b7fe;
}

/* Remove dark-mode overrides for alliance selection cards and modal items
   so team selection remains light/consistent regardless of global theme. */
.dark-mode .alliance-card,
.dark-mode .alliance-card .card-header,
.dark-mode .alliance-card .card-body,
.dark-mode .team-slot,
.dark-mode .team-slot-empty,
.dark-mode .team-selection-item,
.dark-mode #teamSelectionList .list-group-item {
    background-color: #2d3338 !important;
    color: #e6e6e6 !important;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.35) !important;
}

.dark-mode .alliance-card .team-role i,
.dark-mode .alliance-card .team-info .badge {
    color: inherit !important;
}

.dark-mode .team-selection-item .small.text-muted,
.dark-mode .alliance-card .small.text-muted {
    color: #6c757d !important;
}

/* Modal-specific dark-mode fixes for the team selection modal */
.dark-mode .modal-content {
    background-color: #2d3338 !important;
    color: #e6e6e6 !important;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.35) !important;
}

.dark-mode .modal-header.bg-primary {
    background-color: #1976d2 !important; /* keep a strong blue header */
    color: #ffffff !important;
}

.dark-mode .input-group .form-control,
.dark-mode .input-group .input-group-text,
.dark-mode .input-group .btn {
    background-color: rgba(255,255,255,0.03) !important;
    color: #e6e6e6 !important;
    border-color: rgba(255,255,255,0.06) !important;
}

.dark-mode .team-selection-item {
    background-color: #2d3338 !important;
    color: #e6e6e6 !important;
    border-bottom: 1px solid rgba(255,255,255,0.04) !important;
}

.dark-mode .team-selection-item .fw-bold.text-primary {
    color: #3d8bfd !important; /* keep the blue score color */
}

.dark-mode .team-selection-item .small.text-muted {
    color: #6c757d !important;
}

.dark-mode .team-selection-item:hover {
    background-color: #3a4147 !important;
}

/* Scrollbar styling for modal list to be visible on dark backgrounds */
.dark-mode #teamSelectionList::-webkit-scrollbar {
    width: 10px;
}
.dark-mode #teamSelectionList::-webkit-scrollbar-thumb {
    background-color: #bfc7ce;
    border-radius: 10px;
}
.dark-mode #teamSelectionList::-webkit-scrollbar-track {
    background: #f1f3f5;
}

/* Ensure cancel button is visible */
.dark-mode .modal-footer .btn-secondary {
    background-color: #6c757d !important;
    color: #fff !important;
    border-color: #6c757d !important;
}

/* High-specificity dark-mode overrides to ensure modal/list stay dark and
   our spaced team items render correctly (avoid forcing white panels). */
body.modern-layout.dark-mode .modal-content {
    background-color: #2d3338 !important;
    color: #e6e6e6 !important;
    opacity: 1 !important;
}

/* Make sure list items inside the modal (except our spaced .team-selection-item)
   use subtle separators appropriate for dark backgrounds. We intentionally
   exclude #teamSelectionList .team-selection-item here so our spacing/borders
   apply without being overridden. */
body.modern-layout.dark-mode .modal-content .list-group-item {
    background-color: transparent !important;
    color: inherit !important;
    border-bottom: 1px solid rgba(255,255,255,0.04) !important;
}

/* Sticky/scrolling sidebar for recommendations on wide screens.
   Keeps the Team Recommendations card visible while the alliance list scrolls. */
@media (min-width: 992px) {
    .alliances-sidebar .card {
        position: sticky;
        top: 80px; /* leave room for fixed header / spacing */
        max-height: calc(100vh - 96px);
        overflow: hidden; /* hide overflow on the card itself */
    }

    /* Make only the card-body scrollable so header stays visible */
    .alliances-sidebar .card .card-body {
        max-height: calc(100vh - 160px);
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
}

/* Make the recommendations list itself scrollable so users can reach items
   further down regardless of screen size. Keep a reasonable max-height so
   it doesn't push page content on small screens. */
#team-recommendations {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 0.25rem; /* slight spacing to avoid overlaying scrollbar */
}

/* On very small screens, allow the recommendations area to expand naturally
   but keep internal scrolling if the list gets long. */
@media (max-width: 576px) {
    #team-recommendations {
        max-height: 50vh;
    }
}

body.modern-layout.dark-mode .modal-content .list-group-item .small.text-muted,
body.modern-layout.dark-mode .modal-content .team-selection-item .small.text-muted {
    color: #9aa1a6 !important;
    opacity: 1 !important;
}

/* Ensure header remains visible and buttons are correctly colored */
body.modern-layout.dark-mode .modal-header.bg-primary {
    background-color: #1976d2 !important;
    color: #fff !important;
}

/* Make sure list hover/focus states are light and clear */
body.modern-layout.dark-mode .modal-content .list-group-item-action:hover,
body.modern-layout.dark-mode .modal-content .list-group-item-action:focus {
    background-color: #f8f9fa !important;
}
</style>
{% endblock %}
