{% extends 'base.html' %}

{% block title %}Simple Configuration Editor{% endblock %}

{% block heading %}Simple Configuration Editor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Edit {{ game_config.game_name }} Configuration</h5>
                <div>
                    <a href="{{ url_for('main.edit_config') }}" class="btn btn-warning btn-sm me-2">
                        <i class="fas fa-code me-1"></i> Advanced JSON Editor
                    </a>
                    <a href="{{ url_for('main.config') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-eye me-1"></i> View Configuration
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.save_config') }}" id="config-form">
                    <input type="hidden" name="simple_edit" value="true">
                    
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="configTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="basic-tab" data-bs-toggle="tab" href="#basic" role="tab">Basic Settings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="periods-tab" data-bs-toggle="tab" href="#periods" role="tab">Game Periods</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="gamepieces-tab" data-bs-toggle="tab" href="#gamepieces" role="tab">Game Pieces</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="postmatch-tab" data-bs-toggle="tab" href="#postmatch" role="tab">Post Match</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="metrics-tab" data-bs-toggle="tab" href="#metrics" role="tab">Analytics</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="api-tab" data-bs-toggle="tab" href="#api" role="tab">API Settings</a>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="configTabsContent">
                        <!-- Basic Settings Tab -->
                        <div class="tab-pane fade show active" id="basic" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h4>Game Information</h4>
                                    <div class="form-group mb-3">
                                        <label for="game_name">Game Name</label>
                                        <input type="text" class="form-control" id="game_name" name="game_name" 
                                               value="{{ game_config.game_name }}" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="season">Season</label>
                                        <input type="number" class="form-control" id="season" name="season" 
                                               value="{{ game_config.season }}" min="2020" max="2030" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="version">Version</label>
                                        <input type="text" class="form-control" id="version" name="version" 
                                               value="{{ game_config.version }}" placeholder="e.g., 1.0.0">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="alliance_size">Alliance Size</label>
                                        <input type="number" class="form-control" id="alliance_size" name="alliance_size" 
                                               value="{{ game_config.alliance_size }}" min="1" max="6" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="scouting_stations">Scouting Stations</label>
                                        <input type="number" class="form-control" id="scouting_stations" name="scouting_stations" 
                                               value="{{ game_config.scouting_stations }}" min="1" max="12" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="current_event_code">Current Event Code</label>
                                        <input type="text" class="form-control" id="current_event_code" name="current_event_code" 
                                               value="{{ game_config.current_event_code }}" placeholder="e.g., ARLI">
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h4>Match Types</h4>
                                    <div class="form-group mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="match_type_practice" 
                                                   name="match_type_practice" value="1"
                                                   {{ 'checked' if 'Practice' in game_config.match_types }}>
                                            <label class="form-check-label" for="match_type_practice">Practice</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="match_type_qualification" 
                                                   name="match_type_qualification" value="1"
                                                   {{ 'checked' if 'Qualification' in game_config.match_types }}>
                                            <label class="form-check-label" for="match_type_qualification">Qualification</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="match_type_playoff" 
                                                   name="match_type_playoff" value="1"
                                                   {{ 'checked' if 'Playoff' in game_config.match_types }}>
                                            <label class="form-check-label" for="match_type_playoff">Playoff</label>
                                        </div>
                                    </div>
                                    
                                    <h5>Period Durations</h5>
                                    <div class="form-group mb-3">
                                        <label for="auto_duration">Auto Period (seconds)</label>
                                        <input type="number" class="form-control" id="auto_duration" name="auto_duration" 
                                               value="{{ game_config.auto_period.duration_seconds }}" min="0" max="60" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="teleop_duration">Teleop Period (seconds)</label>
                                        <input type="number" class="form-control" id="teleop_duration" name="teleop_duration" 
                                               value="{{ game_config.teleop_period.duration_seconds }}" min="60" max="180" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="endgame_duration">Endgame Period (seconds)</label>
                                        <input type="number" class="form-control" id="endgame_duration" name="endgame_duration" 
                                               value="{{ game_config.endgame_period.duration_seconds }}" min="0" max="60" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Game Periods Tab -->
                        <div class="tab-pane fade" id="periods" role="tabpanel">
                            <div class="mt-3">
                                <!-- Auto Period -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5>Auto Period Scoring Elements</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="auto-elements">
                                            {% for element in game_config.auto_period.scoring_elements %}
                                            <div class="scoring-element border p-3 mb-3 rounded" data-period="auto" data-index="{{ loop.index0 }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label>Element ID</label>
                                                        <input type="text" class="form-control" name="auto_element_id_{{ loop.index0 }}" 
                                                               value="{{ element.id }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label>Name</label>
                                                        <input type="text" class="form-control" name="auto_element_name_{{ loop.index0 }}" 
                                                               value="{{ element.name }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Type</label>
                                                        <select class="form-control element-type" name="auto_element_type_{{ loop.index0 }}">
                                                            <option value="boolean" {{ 'selected' if element.type == 'boolean' }}>Boolean</option>
                                                            <option value="counter" {{ 'selected' if element.type == 'counter' }}>Counter</option>
                                                            <option value="select" {{ 'selected' if element.type == 'select' }}>Select</option>
                                                            <option value="rating" {{ 'selected' if element.type == 'rating' }}>Rating</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Points</label>
                                                        <input type="number" class="form-control" name="auto_element_points_{{ loop.index0 }}" 
                                                               value="{{ element.points if element.points is number else 0 }}" step="0.1">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Actions</label>
                                                        <button type="button" class="btn btn-danger btn-sm remove-element">Remove</button>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <label>Default Value</label>
                                                        <input type="text" class="form-control" name="auto_element_default_{{ loop.index0 }}" 
                                                               value="{{ element.default }}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>Game Piece ID (optional)</label>
                                                        <input type="text" class="form-control" name="auto_element_game_piece_{{ loop.index0 }}" 
                                                               value="{{ element.game_piece_id if element.game_piece_id is defined else '' }}">
                                                    </div>
                                                </div>
                                                
                                                {% if element.type == 'select' %}
                                                <div class="row mt-2 select-options">
                                                    <div class="col-md-12">
                                                        <label>Options (one per line)</label>
                                                        <textarea class="form-control" name="auto_element_options_{{ loop.index0 }}" rows="3">{{ element.options | join('\n') if element.options else '' }}</textarea>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-success add-element" data-period="auto">Add Auto Element</button>
                                    </div>
                                </div>
                                
                                <!-- Teleop Period -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5>Teleop Period Scoring Elements</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="teleop-elements">
                                            {% for element in game_config.teleop_period.scoring_elements %}
                                            <div class="scoring-element border p-3 mb-3 rounded" data-period="teleop" data-index="{{ loop.index0 }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label>Element ID</label>
                                                        <input type="text" class="form-control" name="teleop_element_id_{{ loop.index0 }}" 
                                                               value="{{ element.id }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label>Name</label>
                                                        <input type="text" class="form-control" name="teleop_element_name_{{ loop.index0 }}" 
                                                               value="{{ element.name }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Type</label>
                                                        <select class="form-control element-type" name="teleop_element_type_{{ loop.index0 }}">
                                                            <option value="boolean" {{ 'selected' if element.type == 'boolean' }}>Boolean</option>
                                                            <option value="counter" {{ 'selected' if element.type == 'counter' }}>Counter</option>
                                                            <option value="select" {{ 'selected' if element.type == 'select' }}>Select</option>
                                                            <option value="rating" {{ 'selected' if element.type == 'rating' }}>Rating</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Points</label>
                                                        <input type="number" class="form-control" name="teleop_element_points_{{ loop.index0 }}" 
                                                               value="{{ element.points if element.points is number else 0 }}" step="0.1">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Actions</label>
                                                        <button type="button" class="btn btn-danger btn-sm remove-element">Remove</button>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <label>Default Value</label>
                                                        <input type="text" class="form-control" name="teleop_element_default_{{ loop.index0 }}" 
                                                               value="{{ element.default }}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>Game Piece ID (optional)</label>
                                                        <input type="text" class="form-control" name="teleop_element_game_piece_{{ loop.index0 }}" 
                                                               value="{{ element.game_piece_id if element.game_piece_id is defined else '' }}">
                                                    </div>
                                                </div>
                                                
                                                {% if element.type == 'select' %}
                                                <div class="row mt-2 select-options">
                                                    <div class="col-md-12">
                                                        <label>Options (one per line)</label>
                                                        <textarea class="form-control" name="teleop_element_options_{{ loop.index0 }}" rows="3">{{ element.options | join('\n') if element.options else '' }}</textarea>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-success add-element" data-period="teleop">Add Teleop Element</button>
                                    </div>
                                </div>
                                
                                <!-- Endgame Period -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5>Endgame Period Scoring Elements</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="endgame-elements">
                                            {% for element in game_config.endgame_period.scoring_elements %}
                                            <div class="scoring-element border p-3 mb-3 rounded" data-period="endgame" data-index="{{ loop.index0 }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label>Element ID</label>
                                                        <input type="text" class="form-control" name="endgame_element_id_{{ loop.index0 }}" 
                                                               value="{{ element.id }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label>Name</label>
                                                        <input type="text" class="form-control" name="endgame_element_name_{{ loop.index0 }}" 
                                                               value="{{ element.name }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Type</label>
                                                        <select class="form-control element-type" name="endgame_element_type_{{ loop.index0 }}">
                                                            <option value="boolean" {{ 'selected' if element.type == 'boolean' }}>Boolean</option>
                                                            <option value="counter" {{ 'selected' if element.type == 'counter' }}>Counter</option>
                                                            <option value="select" {{ 'selected' if element.type == 'select' }}>Select</option>
                                                            <option value="rating" {{ 'selected' if element.type == 'rating' }}>Rating</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Points</label>
                                                        <input type="number" class="form-control" name="endgame_element_points_{{ loop.index0 }}" 
                                                               value="{{ element.points if element.points is number else 0 }}" step="0.1">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Actions</label>
                                                        <button type="button" class="btn btn-danger btn-sm remove-element">Remove</button>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <label>Default Value</label>
                                                        <input type="text" class="form-control" name="endgame_element_default_{{ loop.index0 }}" 
                                                               value="{{ element.default }}">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label>Game Piece ID (optional)</label>
                                                        <input type="text" class="form-control" name="endgame_element_game_piece_{{ loop.index0 }}" 
                                                               value="{{ element.game_piece_id if element.game_piece_id is defined else '' }}">
                                                    </div>
                                                </div>
                                                
                                                {% if element.type == 'select' %}
                                                <div class="row mt-2 select-options">
                                                    <div class="col-md-12">
                                                        <label>Options (one per line)</label>
                                                        <textarea class="form-control" name="endgame_element_options_{{ loop.index0 }}" rows="3">{{ element.options | join('\n') if element.options else '' }}</textarea>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-success add-element" data-period="endgame">Add Endgame Element</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Game Pieces Tab -->
                        <div class="tab-pane fade" id="gamepieces" role="tabpanel">
                            <div class="mt-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Game Pieces</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="game-pieces">
                                            {% for piece in game_config.game_pieces %}
                                            <div class="game-piece border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label>ID</label>
                                                        <input type="text" class="form-control" name="game_piece_id_{{ loop.index0 }}" 
                                                               value="{{ piece.id }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label>Name</label>
                                                        <input type="text" class="form-control" name="game_piece_name_{{ loop.index0 }}" 
                                                               value="{{ piece.name }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Auto Points</label>
                                                        <input type="number" class="form-control" name="game_piece_auto_points_{{ loop.index0 }}" 
                                                               value="{{ piece.auto_points }}" step="0.1">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Teleop Points</label>
                                                        <input type="number" class="form-control" name="game_piece_teleop_points_{{ loop.index0 }}" 
                                                               value="{{ piece.teleop_points }}" step="0.1">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Actions</label>
                                                        <button type="button" class="btn btn-danger btn-sm remove-game-piece">Remove</button>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <label>Bonus Points</label>
                                                        <input type="number" class="form-control" name="game_piece_bonus_points_{{ loop.index0 }}" 
                                                               value="{{ piece.bonus_points if piece.bonus_points is defined else 0 }}" step="0.1">
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-success" id="add-game-piece">Add Game Piece</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Post Match Tab -->
                        <div class="tab-pane fade" id="postmatch" role="tabpanel">
                            <div class="mt-3">
                                <!-- Rating Elements -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5>Rating Elements</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="rating-elements">
                                            {% for element in game_config.post_match.rating_elements %}
                                            <div class="rating-element border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label>ID</label>
                                                        <input type="text" class="form-control" name="rating_element_id_{{ loop.index0 }}" 
                                                               value="{{ element.id }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label>Name</label>
                                                        <input type="text" class="form-control" name="rating_element_name_{{ loop.index0 }}" 
                                                               value="{{ element.name }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Min</label>
                                                        <input type="number" class="form-control" name="rating_element_min_{{ loop.index0 }}" 
                                                               value="{{ element.min }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Max</label>
                                                        <input type="number" class="form-control" name="rating_element_max_{{ loop.index0 }}" 
                                                               value="{{ element.max }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Actions</label>
                                                        <button type="button" class="btn btn-danger btn-sm remove-rating-element">Remove</button>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <label>Default</label>
                                                        <input type="number" class="form-control" name="rating_element_default_{{ loop.index0 }}" 
                                                               value="{{ element.default }}">
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-success" id="add-rating-element">Add Rating Element</button>
                                    </div>
                                </div>
                                
                                <!-- Text Elements -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5>Text Elements</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="text-elements">
                                            {% for element in game_config.post_match.text_elements %}
                                            <div class="text-element border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <label>ID</label>
                                                        <input type="text" class="form-control" name="text_element_id_{{ loop.index0 }}" 
                                                               value="{{ element.id }}" required>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label>Name</label>
                                                        <input type="text" class="form-control" name="text_element_name_{{ loop.index0 }}" 
                                                               value="{{ element.name }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="form-check mt-4">
                                                            <input class="form-check-input" type="checkbox" name="text_element_multiline_{{ loop.index0 }}" 
                                                                   value="1" {{ 'checked' if element.multiline }}>
                                                            <label class="form-check-label">Multiline</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Actions</label>
                                                        <button type="button" class="btn btn-danger btn-sm remove-text-element">Remove</button>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-success" id="add-text-element">Add Text Element</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics Tab -->
                        <div class="tab-pane fade" id="metrics" role="tabpanel">
                            <div class="mt-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>Key Metrics</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="key-metrics">
                                            {% for metric in game_config.data_analysis.key_metrics %}
                                            <div class="key-metric border p-3 mb-3 rounded" data-index="{{ loop.index0 }}">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label>ID</label>
                                                        <input type="text" class="form-control" name="metric_id_{{ loop.index0 }}" 
                                                               value="{{ metric.id }}" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label>Name</label>
                                                        <input type="text" class="form-control" name="metric_name_{{ loop.index0 }}" 
                                                               value="{{ metric.name }}" required>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Aggregate</label>
                                                        <select class="form-control" name="metric_aggregate_{{ loop.index0 }}">
                                                            <option value="average" {{ 'selected' if metric.aggregate == 'average' }}>Average</option>
                                                            <option value="sum" {{ 'selected' if metric.aggregate == 'sum' }}>Sum</option>
                                                            <option value="max" {{ 'selected' if metric.aggregate == 'max' }}>Max</option>
                                                            <option value="min" {{ 'selected' if metric.aggregate == 'min' }}>Min</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="form-check mt-4">
                                                            <input class="form-check-input" type="checkbox" name="metric_display_predictions_{{ loop.index0 }}" 
                                                                   value="1" {{ 'checked' if metric.display_in_predictions }}>
                                                            <label class="form-check-label">Show in Predictions</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label>Actions</label>
                                                        <button type="button" class="btn btn-danger btn-sm remove-metric">Remove</button>
                                                    </div>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <label>Formula</label>
                                                        <input type="text" class="form-control" name="metric_formula_{{ loop.index0 }}" 
                                                               value="{{ metric.formula if metric.formula is string else '' }}" 
                                                               placeholder="e.g., (ans + ana) / 2">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-check mt-4">
                                                            <input class="form-check-input" type="checkbox" name="metric_auto_generated_{{ loop.index0 }}" 
                                                                   value="1" {{ 'checked' if metric.auto_generated }}>
                                                            <label class="form-check-label">Auto Generated</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-check mt-4">
                                                            <input class="form-check-input" type="checkbox" name="metric_total_component_{{ loop.index0 }}" 
                                                                   value="1" {{ 'checked' if metric.is_total_component }}>
                                                            <label class="form-check-label">Total Component</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button" class="btn btn-success" id="add-metric">Add Metric</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- API Settings Tab -->
                        <div class="tab-pane fade" id="api" role="tabpanel">
                            <div class="mt-3">
                                <!-- API Source Selection -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5><i class="fas fa-cogs me-2"></i>API Source Configuration</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="preferred_api_source" class="form-label">Preferred API Source</label>
                                            <select class="form-select" id="preferred_api_source" name="preferred_api_source">
                                                <option value="first" {% if game_config.preferred_api_source == 'first' %}selected{% endif %}>FIRST API (Official)</option>
                                                <option value="tba" {% if game_config.preferred_api_source == 'tba' %}selected{% endif %}>The Blue Alliance API</option>
                                            </select>
                                            <div class="form-text">
                                                Choose which API to use as primary source. The system will automatically fall back to the other API if the primary fails.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- FIRST API Settings -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5><i class="fas fa-server me-2"></i>FIRST API Settings</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info mb-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            FIRST API credentials are required for official event data. Get your credentials from the FIRST API portal.
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label for="api_username">API Username</label>
                                                    <input type="text" class="form-control" id="api_username" name="api_username" 
                                                           value="{{ game_config.api_settings.username if game_config.api_settings else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label for="api_auth_token">API Auth Token</label>
                                                    <input type="text" class="form-control" id="api_auth_token" name="api_auth_token" 
                                                           value="{{ game_config.api_settings.auth_token if game_config.api_settings else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group mb-3">
                                                    <label for="api_base_url">API Base URL</label>
                                                    <input type="url" class="form-control" id="api_base_url" name="api_base_url" 
                                                           value="{{ game_config.api_settings.base_url if game_config.api_settings else 'https://frc-api.firstinspires.org' }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- TBA API Settings -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5><i class="fas fa-database me-2"></i>The Blue Alliance API Settings</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info mb-3">
                                            <i class="fas fa-info-circle me-2"></i>
                                            The Blue Alliance API provides comprehensive FRC data. Get your API key from your 
                                            <a href="https://www.thebluealliance.com/account" target="_blank">TBA Account Dashboard</a>.
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="tba_auth_key">TBA API Auth Key</label>
                                                    <input type="text" class="form-control" id="tba_auth_key" name="tba_auth_key" 
                                                           value="{{ game_config.tba_api_settings.auth_key if game_config.tba_api_settings else '' }}" 
                                                           placeholder="Enter your TBA API key">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group mb-3">
                                                    <label for="tba_base_url">TBA API Base URL</label>
                                                    <input type="url" class="form-control" id="tba_base_url" name="tba_base_url" 
                                                           value="{{ game_config.tba_api_settings.base_url if game_config.tba_api_settings else 'https://www.thebluealliance.com/api/v3' }}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6><i class="fas fa-lightbulb me-2"></i>TBA API Benefits:</h6>
                                                        <ul class="mb-0">
                                                            <li>No authentication required for basic data (optional auth key for rate limiting)</li>
                                                            <li>Comprehensive historical data dating back to 1992</li>
                                                            <li>Real-time updates during events</li>
                                                            <li>Detailed match breakdowns and statistics</li>
                                                            <li>Team photos, awards, and social media information</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group text-end mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Dynamic form management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    let elementCounters = {
        auto: {{ game_config.auto_period.scoring_elements|length }},
        teleop: {{ game_config.teleop_period.scoring_elements|length }},
        endgame: {{ game_config.endgame_period.scoring_elements|length }},
        gamepiece: {{ game_config.game_pieces|length }},
        rating: {{ game_config.post_match.rating_elements|length }},
        text: {{ game_config.post_match.text_elements|length }},
        metric: {{ game_config.data_analysis.key_metrics|length }}
    };
    
    // Add element handlers
    document.querySelectorAll('.add-element').forEach(button => {
        button.addEventListener('click', function() {
            const period = this.dataset.period;
            const container = document.getElementById(period + '-elements');
            const index = elementCounters[period]++;
            
            const template = createElementTemplate(period, index);
            container.insertAdjacentHTML('beforeend', template);
        });
    });
    
    // Remove element handlers
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-element') || 
            e.target.classList.contains('remove-game-piece') ||
            e.target.classList.contains('remove-rating-element') ||
            e.target.classList.contains('remove-text-element') ||
            e.target.classList.contains('remove-metric')) {
            
            const elementToRemove = e.target.closest('.scoring-element, .game-piece, .rating-element, .text-element, .key-metric');
            if (elementToRemove) {
                elementToRemove.remove();
            }
        }
    });
    
    // Add game piece
    document.getElementById('add-game-piece').addEventListener('click', function() {
        const container = document.getElementById('game-pieces');
        const index = elementCounters.gamepiece++;
        
        const template = createGamePieceTemplate(index);
        container.insertAdjacentHTML('beforeend', template);
    });
    
    // Add rating element
    document.getElementById('add-rating-element').addEventListener('click', function() {
        const container = document.getElementById('rating-elements');
        const index = elementCounters.rating++;
        
        const template = createRatingElementTemplate(index);
        container.insertAdjacentHTML('beforeend', template);
    });
    
    // Add text element
    document.getElementById('add-text-element').addEventListener('click', function() {
        const container = document.getElementById('text-elements');
        const index = elementCounters.text++;
        
        const template = createTextElementTemplate(index);
        container.insertAdjacentHTML('beforeend', template);
    });
    
    // Add metric
    document.getElementById('add-metric').addEventListener('click', function() {
        const container = document.getElementById('key-metrics');
        const index = elementCounters.metric++;
        
        const template = createMetricTemplate(index);
        container.insertAdjacentHTML('beforeend', template);
    });
    
    // Template creation functions
    function createElementTemplate(period, index) {
        return `
            <div class="scoring-element border p-3 mb-3 rounded" data-period="${period}" data-index="${index}">
                <div class="row">
                    <div class="col-md-3">
                        <label>Element ID</label>
                        <input type="text" class="form-control" name="${period}_element_id_${index}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Name</label>
                        <input type="text" class="form-control" name="${period}_element_name_${index}" required>
                    </div>
                    <div class="col-md-2">
                        <label>Type</label>
                        <select class="form-control element-type" name="${period}_element_type_${index}">
                            <option value="boolean">Boolean</option>
                            <option value="counter">Counter</option>
                            <option value="select">Select</option>
                            <option value="rating">Rating</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Points</label>
                        <input type="number" class="form-control" name="${period}_element_points_${index}" value="0" step="0.1">
                    </div>
                    <div class="col-md-2">
                        <label>Actions</label>
                        <button type="button" class="btn btn-danger btn-sm remove-element">Remove</button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Default Value</label>
                        <input type="text" class="form-control" name="${period}_element_default_${index}" value="0">
                    </div>
                    <div class="col-md-6">
                        <label>Game Piece ID (optional)</label>
                        <input type="text" class="form-control" name="${period}_element_game_piece_${index}">
                    </div>
                </div>
            </div>
        `;
    }
    
    function createGamePieceTemplate(index) {
        return `
            <div class="game-piece border p-3 mb-3 rounded" data-index="${index}">
                <div class="row">
                    <div class="col-md-3">
                        <label>ID</label>
                        <input type="text" class="form-control" name="game_piece_id_${index}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Name</label>
                        <input type="text" class="form-control" name="game_piece_name_${index}" required>
                    </div>
                    <div class="col-md-2">
                        <label>Auto Points</label>
                        <input type="number" class="form-control" name="game_piece_auto_points_${index}" value="0" step="0.1">
                    </div>
                    <div class="col-md-2">
                        <label>Teleop Points</label>
                        <input type="number" class="form-control" name="game_piece_teleop_points_${index}" value="0" step="0.1">
                    </div>
                    <div class="col-md-2">
                        <label>Actions</label>
                        <button type="button" class="btn btn-danger btn-sm remove-game-piece">Remove</button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Bonus Points</label>
                        <input type="number" class="form-control" name="game_piece_bonus_points_${index}" value="0" step="0.1">
                    </div>
                </div>
            </div>
        `;
    }
    
    function createRatingElementTemplate(index) {
        return `
            <div class="rating-element border p-3 mb-3 rounded" data-index="${index}">
                <div class="row">
                    <div class="col-md-3">
                        <label>ID</label>
                        <input type="text" class="form-control" name="rating_element_id_${index}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Name</label>
                        <input type="text" class="form-control" name="rating_element_name_${index}" required>
                    </div>
                    <div class="col-md-2">
                        <label>Min</label>
                        <input type="number" class="form-control" name="rating_element_min_${index}" value="1" required>
                    </div>
                    <div class="col-md-2">
                        <label>Max</label>
                        <input type="number" class="form-control" name="rating_element_max_${index}" value="5" required>
                    </div>
                    <div class="col-md-2">
                        <label>Actions</label>
                        <button type="button" class="btn btn-danger btn-sm remove-rating-element">Remove</button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Default</label>
                        <input type="number" class="form-control" name="rating_element_default_${index}" value="3">
                    </div>
                </div>
            </div>
        `;
    }
    
    function createTextElementTemplate(index) {
        return `
            <div class="text-element border p-3 mb-3 rounded" data-index="${index}">
                <div class="row">
                    <div class="col-md-4">
                        <label>ID</label>
                        <input type="text" class="form-control" name="text_element_id_${index}" required>
                    </div>
                    <div class="col-md-4">
                        <label>Name</label>
                        <input type="text" class="form-control" name="text_element_name_${index}" required>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="text_element_multiline_${index}" value="1">
                            <label class="form-check-label">Multiline</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label>Actions</label>
                        <button type="button" class="btn btn-danger btn-sm remove-text-element">Remove</button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function createMetricTemplate(index) {
        return `
            <div class="key-metric border p-3 mb-3 rounded" data-index="${index}">
                <div class="row">
                    <div class="col-md-3">
                        <label>ID</label>
                        <input type="text" class="form-control" name="metric_id_${index}" required>
                    </div>
                    <div class="col-md-3">
                        <label>Name</label>
                        <input type="text" class="form-control" name="metric_name_${index}" required>
                    </div>
                    <div class="col-md-2">
                        <label>Aggregate</label>
                        <select class="form-control" name="metric_aggregate_${index}">
                            <option value="average">Average</option>
                            <option value="sum">Sum</option>
                            <option value="max">Max</option>
                            <option value="min">Min</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="metric_display_predictions_${index}" value="1">
                            <label class="form-check-label">Show in Predictions</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label>Actions</label>
                        <button type="button" class="btn btn-danger btn-sm remove-metric">Remove</button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <label>Formula</label>
                        <input type="text" class="form-control" name="metric_formula_${index}" placeholder="e.g., (ans + ana) / 2">
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="metric_auto_generated_${index}" value="1">
                            <label class="form-check-label">Auto Generated</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="metric_total_component_${index}" value="1">
                            <label class="form-check-label">Total Component</label>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
});
</script>
{% endblock %}
